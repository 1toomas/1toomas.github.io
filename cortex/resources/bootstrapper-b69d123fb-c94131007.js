!function(e){"use strict";function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}sm.siteId=sm.conf.engagement.site_id,sm.rxVersion=6;var n=t(e);function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){c(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function u(e,t,n){return t&&a(e.prototype,t),n&&a(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&p(e,t)}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){return(p=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function d(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function h(e,t,n){return(h=d()?Reflect.construct.bind():function(e,t,n){var r=[null];r.push.apply(r,t);var i=new(Function.bind.apply(e,r));return n&&p(i,n.prototype),i}).apply(null,arguments)}function v(e){var t="function"==typeof Map?new Map:void 0;return(v=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return h(e,arguments,f(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),p(r,e)})(e)}function b(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function m(e){var t=d();return function(){var n,r=f(e);if(t){var i=f(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return b(this,n)}}function g(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=f(e)););return e}function y(){return(y="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,n){var r=g(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(arguments.length<3?e:n):i.value}}).apply(this,arguments)}function _(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var r,i,o=[],s=!0,a=!1;try{for(n=n.call(e);!(s=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);s=!0);}catch(e){a=!0,i=e}finally{try{s||null==n.return||n.return()}finally{if(a)throw i}}return o}(e,t)||E(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function w(e){return function(e){if(Array.isArray(e))return O(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||E(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function E(e,t){if(e){if("string"==typeof e)return O(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?O(e,t):void 0}}function O(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var S="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function T(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function k(e,t,n){return e(n={path:t,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&n.path)}},n.exports),n.exports}function A(e){if(e.__esModule)return e;var t=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(e).forEach((function(n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})})),t}var x=k((function(e){
/*!
     * EventEmitter v4.2.5 - git.io/ee
     * Oliver Caldwell
     * MIT license
     * @preserve
     */
(function(){function t(){}var n=t.prototype,r=this,i=r.EventEmitter;function s(e,t){for(var n=e.length;n--;)if(e[n].listener===t)return n;return-1}function a(e){return function(){return this[e].apply(this,arguments)}}n.getListeners=function(e){var t,n,r=this._getEvents();if("object"===o(e))for(n in t={},r)r.hasOwnProperty(n)&&e.test(n)&&(t[n]=r[n]);else t=r[e]||(r[e]=[]);return t},n.flattenListeners=function(e){var t,n=[];for(t=0;t<e.length;t+=1)n.push(e[t].listener);return n},n.getListenersAsObject=function(e){var t,n=this.getListeners(e);return n instanceof Array&&((t={})[e]=n),t||n},n.addListener=function(e,t){var n,r=this.getListenersAsObject(e),i="object"===o(t);for(n in r)r.hasOwnProperty(n)&&-1===s(r[n],t)&&r[n].push(i?t:{listener:t,once:!1});return this},n.on=a("addListener"),n.addOnceListener=function(e,t){return this.addListener(e,{listener:t,once:!0})},n.once=a("addOnceListener"),n.defineEvent=function(e){return this.getListeners(e),this},n.defineEvents=function(e){for(var t=0;t<e.length;t+=1)this.defineEvent(e[t]);return this},n.removeListener=function(e,t){var n,r,i=this.getListenersAsObject(e);for(r in i)i.hasOwnProperty(r)&&-1!==(n=s(i[r],t))&&i[r].splice(n,1);return this},n.off=a("removeListener"),n.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},n.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)},n.manipulateListeners=function(e,t,n){var r,i,s=e?this.removeListener:this.addListener,a=e?this.removeListeners:this.addListeners;if("object"!==o(t)||t instanceof RegExp)for(r=n.length;r--;)s.call(this,t,n[r]);else for(r in t)t.hasOwnProperty(r)&&(i=t[r])&&("function"==typeof i?s.call(this,r,i):a.call(this,r,i));return this},n.removeEvent=function(e){var t,n=o(e),r=this._getEvents();if("string"===n)delete r[e];else if("object"===n)for(t in r)r.hasOwnProperty(t)&&e.test(t)&&delete r[t];else delete this._events;return this},n.removeAllListeners=a("removeEvent"),n.emitEvent=function(e,t){var n,r,i,o=this.getListenersAsObject(e);for(i in o)if(o.hasOwnProperty(i))for(r=o[i].length;r--;)!0===(n=o[i][r]).once&&this.removeListener(e,n.listener),n.listener.apply(this,t||[])===this._getOnceReturnValue()&&this.removeListener(e,n.listener);return this},n.trigger=a("emitEvent"),n.emit=function(e){var t=Array.prototype.slice.call(arguments,1);return this.emitEvent(e,t)},n.setOnceReturnValue=function(e){return this._onceReturnValue=e,this},n._getOnceReturnValue=function(){return!this.hasOwnProperty("_onceReturnValue")||this._onceReturnValue},n._getEvents=function(){return this._events||(this._events={})},t.noConflict=function(){return r.EventEmitter=i,t},e.exports?e.exports=t:this.EventEmitter=t}).call(S)})),I=k((function(e,t){(function(){var t,n,r,i,s,a,u,c={"@@functional/placeholder":!0},l=function(e,t){switch(e){case 0:return function(){return t.apply(this,arguments)};case 1:return function(e){return t.apply(this,arguments)};case 2:return function(e,n){return t.apply(this,arguments)};case 3:return function(e,n,r){return t.apply(this,arguments)};case 4:return function(e,n,r,i){return t.apply(this,arguments)};case 5:return function(e,n,r,i,o){return t.apply(this,arguments)};case 6:return function(e,n,r,i,o,s){return t.apply(this,arguments)};case 7:return function(e,n,r,i,o,s,a){return t.apply(this,arguments)};case 8:return function(e,n,r,i,o,s,a,u){return t.apply(this,arguments)};case 9:return function(e,n,r,i,o,s,a,u,c){return t.apply(this,arguments)};case 10:return function(e,n,r,i,o,s,a,u,c,l){return t.apply(this,arguments)};default:throw new Error("First argument to _arity must be a non-negative integer no greater than ten")}},f=function(e){for(var t,n=[];!(t=e.next()).done;)n.push(t.value);return n},p=function(e){return new RegExp(e.source,(e.global?"g":"")+(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.sticky?"y":"")+(e.unicode?"u":""))},d=function(e){return function(){return!e.apply(this,arguments)}},h=function(e,t){var n;t=t||[];var r=(e=e||[]).length,i=t.length,o=[];for(n=0;n<r;)o[o.length]=e[n],n+=1;for(n=0;n<i;)o[o.length]=t[n],n+=1;return o},v=function(e,t,n){for(var r=0,i=n.length;r<i;){if(e(t,n[r]))return!0;r+=1}return!1},b=function(e,t){for(var n=0,r=t.length,i=[];n<r;)e(t[n])&&(i[i.length]=t[n]),n+=1;return i},m=function(e,t){return Object.prototype.hasOwnProperty.call(t,e)},g=function(e){return e},y=function(){var e=Object.prototype.toString;return"[object Arguments]"===e.call(arguments)?function(t){return"[object Arguments]"===e.call(t)}:function(e){return m("callee",e)}}(),_=Array.isArray||function(e){return null!=e&&e.length>=0&&"[object Array]"===Object.prototype.toString.call(e)},w=Number.isInteger||function(e){return e<<0===e},E=function(e){return"[object Number]"===Object.prototype.toString.call(e)},O=function(e){return"[object Object]"===Object.prototype.toString.call(e)},S=function(e){return null!=e&&"object"===o(e)&&!0===e["@@functional/placeholder"]},T=function(e){return"[object String]"===Object.prototype.toString.call(e)},k=function(e){return"function"==typeof e["@@transducer/step"]},A=function(e,t){for(var n=0,r=t.length,i=Array(r);n<r;)i[n]=e(t[n]),n+=1;return i},x=function(e,t){return function(){return t.call(this,e.apply(this,arguments))}},I=function(e,t){return function(){var n=this;return e.apply(n,arguments).then((function(e){return t.call(n,e)}))}},N=function(e){return'"'+e.replace(/\\/g,"\\\\").replace(/[\b]/g,"\\b").replace(/\f/g,"\\f").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t").replace(/\v/g,"\\v").replace(/\0/g,"\\0").replace(/"/g,'\\"')+'"'},M=function(e){return e&&e["@@transducer/reduced"]?e:{"@@transducer/value":e,"@@transducer/reduced":!0}},R=function e(t,n,r){switch(arguments.length){case 1:return e(t,0,t.length);case 2:return e(t,n,t.length);default:for(var i=[],o=0,s=Math.max(0,Math.min(t.length,r)-n);o<s;)i[o]=t[n+o],o+=1;return i}},C=(t=function(e){return(e<10?"0":"")+e},"function"==typeof Date.prototype.toISOString?function(e){return e.toISOString()}:function(e){return e.getUTCFullYear()+"-"+t(e.getUTCMonth()+1)+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+"."+(e.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"}),P={init:function(){return this.xf["@@transducer/init"]()},result:function(e){return this.xf["@@transducer/result"](e)}},j=function(){function e(e){this.f=e}return e.prototype["@@transducer/init"]=function(){throw new Error("init not implemented on XWrap")},e.prototype["@@transducer/result"]=function(e){return e},e.prototype["@@transducer/step"]=function(e,t){return this.f(e,t)},function(t){return new e(t)}}(),L=function(e,t){return function(){var n=arguments.length;if(0===n)return t();var r=arguments[n-1];return _(r)||"function"!=typeof r[e]?t.apply(this,arguments):r[e].apply(r,R(arguments,0,n-1))}},q=function(e){return function t(n){return 0===arguments.length||S(n)?t:e.apply(this,arguments)}},U=function(e){return function t(n,r){switch(arguments.length){case 0:return t;case 1:return S(n)?t:q((function(t){return e(n,t)}));default:return S(n)&&S(r)?t:S(n)?q((function(t){return e(t,r)})):S(r)?q((function(t){return e(n,t)})):e(n,r)}}},D=function(e){return function t(n,r,i){switch(arguments.length){case 0:return t;case 1:return S(n)?t:U((function(t,r){return e(n,t,r)}));case 2:return S(n)&&S(r)?t:S(n)?U((function(t,n){return e(t,r,n)})):S(r)?U((function(t,r){return e(n,t,r)})):q((function(t){return e(n,r,t)}));default:return S(n)&&S(r)&&S(i)?t:S(n)&&S(r)?U((function(t,n){return e(t,n,i)})):S(n)&&S(i)?U((function(t,n){return e(t,r,n)})):S(r)&&S(i)?U((function(t,r){return e(n,t,r)})):S(n)?q((function(t){return e(t,r,i)})):S(r)?q((function(t){return e(n,t,i)})):S(i)?q((function(t){return e(n,r,t)})):e(n,r,i)}}},V=function e(t,n,r){return function(){for(var i=[],o=0,s=t,a=0;a<n.length||o<arguments.length;){var u;a<n.length&&(!S(n[a])||o>=arguments.length)?u=n[a]:(u=arguments[o],o+=1),i[a]=u,S(u)||(s-=1),a+=1}return s<=0?r.apply(this,i):l(s,e(t,i,r))}},F=function(e,t,n){return function(){var r=arguments.length;if(0===r)return n();var i=arguments[r-1];if(!_(i)){var o=R(arguments,0,r-1);if("function"==typeof i[e])return i[e].apply(i,o);if(k(i)){var s=t.apply(null,o);return s(i)}}return n.apply(this,arguments)}},B=function(){function e(e,t){this.xf=t,this.f=e,this.all=!0}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=function(e){return this.all&&(e=this.xf["@@transducer/step"](e,!0)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)||(this.all=!1,e=M(this.xf["@@transducer/step"](e,!1))),e},U((function(t,n){return new e(t,n)}))}(),H=function(){function e(e,t){this.xf=t,this.f=e,this.any=!1}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=function(e){return this.any||(e=this.xf["@@transducer/step"](e,!1)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)&&(this.any=!0,e=M(this.xf["@@transducer/step"](e,!0))),e},U((function(t,n){return new e(t,n)}))}(),W=function(){function e(e,t){this.xf=t,this.pos=0,this.full=!1,this.acc=new Array(e)}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=function(e){return this.acc=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.store(t),this.full?this.xf["@@transducer/step"](e,this.getCopy()):e},e.prototype.store=function(e){this.acc[this.pos]=e,this.pos+=1,this.pos===this.acc.length&&(this.pos=0,this.full=!0)},e.prototype.getCopy=function(){return h(R(this.acc,this.pos),R(this.acc,0,this.pos))},U((function(t,n){return new e(t,n)}))}(),G=function(){function e(e,t){this.xf=t,this.n=e}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=P.result,e.prototype["@@transducer/step"]=function(e,t){return this.n>0?(this.n-=1,e):this.xf["@@transducer/step"](e,t)},U((function(t,n){return new e(t,n)}))}(),z=function(){function e(e,t){this.xf=t,this.pos=0,this.full=!1,this.acc=new Array(e)}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=function(e){return this.acc=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.full&&(e=this.xf["@@transducer/step"](e,this.acc[this.pos])),this.store(t),e},e.prototype.store=function(e){this.acc[this.pos]=e,this.pos+=1,this.pos===this.acc.length&&(this.pos=0,this.full=!0)},U((function(t,n){return new e(t,n)}))}(),J=function(){function e(e,t){this.xf=t,this.pred=e,this.lastValue=void 0,this.seenFirstValue=!1}return e.prototype["@@transducer/init"]=function(){return this.xf["@@transducer/init"]()},e.prototype["@@transducer/result"]=function(e){return this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){var n=!1;return this.seenFirstValue?this.pred(this.lastValue,t)&&(n=!0):this.seenFirstValue=!0,this.lastValue=t,n?e:this.xf["@@transducer/step"](e,t)},U((function(t,n){return new e(t,n)}))}(),Y=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=P.result,e.prototype["@@transducer/step"]=function(e,t){if(this.f){if(this.f(t))return e;this.f=null}return this.xf["@@transducer/step"](e,t)},U((function(t,n){return new e(t,n)}))}(),Q=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=P.result,e.prototype["@@transducer/step"]=function(e,t){return this.f(t)?this.xf["@@transducer/step"](e,t):e},U((function(t,n){return new e(t,n)}))}(),K=function(){function e(e,t){this.xf=t,this.f=e,this.found=!1}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=function(e){return this.found||(e=this.xf["@@transducer/step"](e,void 0)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)&&(this.found=!0,e=M(this.xf["@@transducer/step"](e,t))),e},U((function(t,n){return new e(t,n)}))}(),X=function(){function e(e,t){this.xf=t,this.f=e,this.idx=-1,this.found=!1}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=function(e){return this.found||(e=this.xf["@@transducer/step"](e,-1)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.idx+=1,this.f(t)&&(this.found=!0,e=M(this.xf["@@transducer/step"](e,this.idx))),e},U((function(t,n){return new e(t,n)}))}(),$=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=function(e){return this.xf["@@transducer/result"](this.xf["@@transducer/step"](e,this.last))},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)&&(this.last=t),e},U((function(t,n){return new e(t,n)}))}(),Z=function(){function e(e,t){this.xf=t,this.f=e,this.idx=-1,this.lastIdx=-1}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=function(e){return this.xf["@@transducer/result"](this.xf["@@transducer/step"](e,this.lastIdx))},e.prototype["@@transducer/step"]=function(e,t){return this.idx+=1,this.f(t)&&(this.lastIdx=this.idx),e},U((function(t,n){return new e(t,n)}))}(),ee=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=P.result,e.prototype["@@transducer/step"]=function(e,t){return this.xf["@@transducer/step"](e,this.f(t))},U((function(t,n){return new e(t,n)}))}(),te=function(){function e(e,t){this.xf=t,this.n=e}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=P.result,e.prototype["@@transducer/step"]=function(e,t){return 0===this.n?M(e):(this.n-=1,this.xf["@@transducer/step"](e,t))},U((function(t,n){return new e(t,n)}))}(),ne=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=P.result,e.prototype["@@transducer/step"]=function(e,t){return this.f(t)?this.xf["@@transducer/step"](e,t):M(e)},U((function(t,n){return new e(t,n)}))}(),re=U((function(e,t){return e+t})),ie=D((function(e,t,n){if(t>=n.length||t<-n.length)return n;var r=(t<0?n.length:0)+t,i=h(n);return i[r]=e(n[r]),i})),oe=U(F("all",B,(function(e,t){for(var n=0;n<t.length;){if(!e(t[n]))return!1;n+=1}return!0}))),se=q((function(e){return function(){return e}})),ae=U((function(e,t){return e&&t})),ue=U(F("any",H,(function(e,t){for(var n=0;n<t.length;){if(e(t[n]))return!0;n+=1}return!1}))),ce=U(F("aperture",W,(function(e,t){for(var n=0,r=t.length-(e-1),i=new Array(r>=0?r:0);n<r;)i[n]=R(t,n,n+e),n+=1;return i}))),le=U((function(e,t){return h(t,[e])})),fe=U((function(e,t){return e.apply(this,t)})),pe=D((function(e,t,n){var r={};for(var i in n)r[i]=n[i];return r[e]=t,r})),de=D((function e(t,n,r){switch(t.length){case 0:return n;case 1:return pe(t[0],n,r);default:return pe(t[0],e(R(t,1),n,Object(r[t[0]])),r)}})),he=U((function(e,t){return l(e.length,(function(){return e.apply(t,arguments)}))})),ve=U((function(e,t){return function(){return e.apply(this,arguments)&&t.apply(this,arguments)}})),be=q((function(e){return function(t,n){return e(t,n)?-1:e(n,t)?1:0}})),me=q((function(e){return function(){for(var t=0;t<e.length;){if(e[t][0].apply(this,arguments))return e[t][1].apply(this,arguments);t+=1}}})),ge=U((function(e,t){for(var n={},r=t.length,i=0;i<r;){var o=e(t[i]);n[o]=(m(o,n)?n[o]:0)+1,i+=1}return n})),ye=U((function(e,t){return 1===e?q(t):l(e,V(e,[],t))})),_e=re(-1),we=U((function(e,t){return null==t||t!=t?e:t})),Ee=D((function(e,t,n){for(var r=[],i=0,o=t.length;i<o;)v(e,t[i],n)||v(e,t[i],r)||r.push(t[i]),i+=1;return r})),Oe=U((function(e,t){var n={};for(var r in t)r!==e&&(n[r]=t[r]);return n})),Se=U((function e(t,n){switch(t.length){case 0:return n;case 1:return Oe(t[0],n);default:var r=t[0],i=R(t,1);return null==n[r]?n:pe(r,e(i,n[r]),n)}})),Te=U((function(e,t){return e/t})),ke=U(F("dropWhile",Y,(function(e,t){for(var n=0,r=t.length;n<r&&e(t[n]);)n+=1;return R(t,n)}))),Ae=U((function(e,t){return function(){return e.apply(this,arguments)||t.apply(this,arguments)}})),xe=q((function(e){return null!=e&&"function"==typeof e.empty?e.empty():null!=e&&null!=e.constructor&&"function"==typeof e.constructor.empty?e.constructor.empty():_(e)?[]:T(e)?"":O(e)?{}:y(e)?function(){return arguments}():void 0})),Ie=U((function e(t,n){var r,i,s,a={};for(i in n)s=o(r=t[i]),a[i]="function"===s?r(n[i]):"object"===s?e(t[i],n[i]):n[i];return a})),Ne=U(F("find",K,(function(e,t){for(var n=0,r=t.length;n<r;){if(e(t[n]))return t[n];n+=1}}))),Me=U(F("findIndex",X,(function(e,t){for(var n=0,r=t.length;n<r;){if(e(t[n]))return n;n+=1}return-1}))),Re=U(F("findLast",$,(function(e,t){for(var n=t.length-1;n>=0;){if(e(t[n]))return t[n];n-=1}}))),Ce=U(F("findLastIndex",Z,(function(e,t){for(var n=t.length-1;n>=0;){if(e(t[n]))return n;n-=1}return-1}))),Pe=U(L("forEach",(function(e,t){for(var n=t.length,r=0;r<n;)e(t[r]),r+=1;return t}))),je=q((function(e){for(var t=0,n=e.length,r={};t<n;)_(e[t])&&e[t].length&&(r[e[t][0]]=e[t][1]),t+=1;return r})),Le=U((function(e,t){return e>t})),qe=U((function(e,t){return e>=t})),Ue=U(m),De=U((function(e,t){return e in t})),Ve=U((function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t})),Fe=q(g),Be=D((function(e,t,n){return ye(Math.max(e.length,t.length,n.length),(function(){return e.apply(this,arguments)?t.apply(this,arguments):n.apply(this,arguments)}))})),He=re(1),We=D((function(e,t,n){e=e<n.length&&e>=0?e:n.length;var r=R(n);return r.splice(e,0,t),r})),Ge=D((function(e,t,n){return e=e<n.length&&e>=0?e:n.length,h(h(R(n,0,e),t),R(n,e))})),ze=U(L("intersperse",(function(e,t){for(var n=[],r=0,i=t.length;r<i;)r===i-1?n.push(t[r]):n.push(t[r],e),r+=1;return n}))),Je=U((function(e,t){return null!=t&&t.constructor===e||t instanceof e})),Ye=q((function(e){return!!_(e)||!!e&&("object"===o(e)&&(!(e instanceof String)&&(1===e.nodeType?!!e.length:0===e.length||e.length>0&&(e.hasOwnProperty(0)&&e.hasOwnProperty(e.length-1)))))})),Qe=q((function(e){return null==e})),Ke=function(){var e=!{toString:null}.propertyIsEnumerable("toString"),t=["constructor","valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],n=function(){return arguments.propertyIsEnumerable("length")}(),r=function(e,t){for(var n=0;n<e.length;){if(e[n]===t)return!0;n+=1}return!1};return"function"!=typeof Object.keys||n?q((function(i){if(Object(i)!==i)return[];var o,s,a=[],u=n&&y(i);for(o in i)!m(o,i)||u&&"length"===o||(a[a.length]=o);if(e)for(s=t.length-1;s>=0;)m(o=t[s],i)&&!r(a,o)&&(a[a.length]=o),s-=1;return a})):q((function(e){return Object(e)!==e?[]:Object.keys(e)}))}(),Xe=q((function(e){var t,n=[];for(t in e)n[n.length]=t;return n})),$e=q((function(e){return null!=e&&Je(Number,e.length)?e.length:NaN})),Ze=U((function(e,t){return e<t})),et=U((function(e,t){return e<=t})),tt=D((function(e,t,n){for(var r=0,i=n.length,o=[],s=[t];r<i;)s=e(s[0],n[r]),o[r]=s[1],r+=1;return[s[0],o]})),nt=D((function(e,t,n){for(var r=n.length-1,i=[],o=[t];r>=0;)o=e(o[0],n[r]),i[r]=o[1],r-=1;return[o[0],i]})),rt=U((function(e,t){return t.match(e)||[]})),it=U((function(e,t){return w(e)?!w(t)||t<1?NaN:(e%t+t)%t:NaN})),ot=U((function(e,t){return t>e?t:e})),st=D((function(e,t,n){return e(n)>e(t)?n:t})),at=D((function(e,t,n){var r,i={};for(r in t)m(r,t)&&(i[r]=m(r,n)?e(r,t[r],n[r]):t[r]);for(r in n)m(r,n)&&!m(r,i)&&(i[r]=n[r]);return i})),ut=U((function(e,t){return t<e?t:e})),ct=D((function(e,t,n){return e(n)<e(t)?n:t})),lt=U((function(e,t){return e%t})),ft=U((function(e,t){return e*t})),pt=U((function(e,t){switch(e){case 0:return function(){return t.call(this)};case 1:return function(e){return t.call(this,e)};case 2:return function(e,n){return t.call(this,e,n)};case 3:return function(e,n,r){return t.call(this,e,n,r)};case 4:return function(e,n,r,i){return t.call(this,e,n,r,i)};case 5:return function(e,n,r,i,o){return t.call(this,e,n,r,i,o)};case 6:return function(e,n,r,i,o,s){return t.call(this,e,n,r,i,o,s)};case 7:return function(e,n,r,i,o,s,a){return t.call(this,e,n,r,i,o,s,a)};case 8:return function(e,n,r,i,o,s,a,u){return t.call(this,e,n,r,i,o,s,a,u)};case 9:return function(e,n,r,i,o,s,a,u,c){return t.call(this,e,n,r,i,o,s,a,u,c)};case 10:return function(e,n,r,i,o,s,a,u,c,l){return t.call(this,e,n,r,i,o,s,a,u,c,l)};default:throw new Error("First argument to nAry must be a non-negative integer no greater than ten")}})),dt=q((function(e){return-e})),ht=U(d(F("any",H,ue))),vt=q((function(e){return!e})),bt=U((function(e,t){var n=e<0?t.length+e:e;return T(t)?t.charAt(n):t[n]})),mt=q((function(e){return function(){return bt(e,arguments)}})),gt=U((function(e,t){var n={};return n[e]=t,n})),yt=q((function(e){return[e]})),_t=q((function(e){var t,n=!1;return l(e.length,(function(){return n?t:(n=!0,t=e.apply(this,arguments))}))})),wt=U((function(e,t){return e||t})),Et=(n=function e(t){return{value:t,map:function(n){return e(n(t))}}},D((function(e,t,r){return e((function(e){return n(t(e))}))(r).value}))),Ot=U((function(e,t){return[e,t]})),St=U((function(e,t){for(var n=t,r=0;r<e.length;){if(null==n)return;n=n[e[r]],r+=1}return n})),Tt=D((function(e,t,n){return we(e,St(t,n))})),kt=D((function(e,t,n){return t.length>0&&e(St(t,n))})),At=U((function(e,t){for(var n={},r=0;r<e.length;)e[r]in t&&(n[e[r]]=t[e[r]]),r+=1;return n})),xt=U((function(e,t){for(var n={},r=0,i=e.length;r<i;){var o=e[r];n[o]=t[o],r+=1}return n})),It=U((function(e,t){var n={};for(var r in t)e(t[r],r,t)&&(n[r]=t[r]);return n})),Nt=U((function(e,t){return h([e],t)})),Mt=U((function(e,t){return t[e]})),Rt=D((function(e,t,n){return null!=n&&m(t,n)?n[t]:e})),Ct=D((function(e,t,n){return e(n[t])})),Pt=U((function(e,t){for(var n=e.length,r=[],i=0;i<n;)r[i]=t[e[i]],i+=1;return r})),jt=U((function(e,t){if(!E(e)||!E(t))throw new TypeError("Both arguments to range must be numbers");for(var n=[],r=e;r<t;)n.push(r),r+=1;return n})),Lt=D((function(e,t,n){for(var r=n.length-1;r>=0;)t=e(t,n[r]),r-=1;return t})),qt=q(M),Ut=D((function(e,t,n){return h(R(n,0,Math.min(e,n.length)),R(n,Math.min(n.length,e+t)))})),Dt=D((function(e,t,n){return n.replace(e,t)})),Vt=q((function(e){return T(e)?e.split("").reverse().join(""):R(e).reverse()})),Ft=D((function(e,t,n){for(var r=0,i=n.length,o=[t];r<i;)t=e(t,n[r]),o[r+1]=t,r+=1;return o})),Bt=D((function(e,t,n){return Et(e,se(t),n)})),Ht=D(L("slice",(function(e,t,n){return Array.prototype.slice.call(n,e,t)}))),Wt=U((function(e,t){return R(t).sort(e)})),Gt=U((function(e,t){return R(t).sort((function(t,n){var r=e(t),i=e(n);return r<i?-1:r>i?1:0}))})),zt=U((function(e,t){return[Ht(0,e,t),Ht(e,$e(t),t)]})),Jt=U((function(e,t){if(e<=0)throw new Error("First argument to splitEvery must be a positive integer");for(var n=[],r=0;r<t.length;)n.push(Ht(r,r+=e,t));return n})),Yt=U((function(e,t){for(var n=0,r=t.length,i=[];n<r&&!e(t[n]);)i.push(t[n]),n+=1;return[i,R(t,n)]})),Qt=U((function(e,t){return e-t})),Kt=L("tail",Ht(1,1/0)),Xt=U(F("take",te,(function(e,t){return Ht(0,e<0?1/0:e,t)}))),$t=U((function(e,t){for(var n=t.length-1;n>=0&&e(t[n]);)n-=1;return R(t,n+1,1/0)})),Zt=U(F("takeWhile",ne,(function(e,t){for(var n=0,r=t.length;n<r&&e(t[n]);)n+=1;return R(t,0,n)}))),en=U((function(e,t){return e(t),t})),tn=U((function(e,t){var n,r=Number(t),i=0;if(r<0||isNaN(r))throw new RangeError("n must be a non-negative number");for(n=new Array(r);i<r;)n[i]=e(i),i+=1;return n})),nn=q((function(e){var t=[];for(var n in e)m(n,e)&&(t[t.length]=[n,e[n]]);return t})),rn=q((function(e){var t=[];for(var n in e)t[t.length]=[n,e[n]];return t})),on=q((function(e){for(var t=0,n=[];t<e.length;){for(var r=e[t],i=0;i<r.length;)void 0===n[i]&&(n[i]=[]),n[i].push(r[i]),i+=1;t+=1}return n})),sn=(r="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff","function"==typeof String.prototype.trim&&!r.trim()&&"​".trim()?q((function(e){return e.trim()})):q((function(e){var t=new RegExp("^["+r+"]["+r+"]*"),n=new RegExp("["+r+"]["+r+"]*$");return e.replace(t,"").replace(n,"")}))),an=q((function(e){return null===e?"Null":void 0===e?"Undefined":Object.prototype.toString.call(e).slice(8,-1)})),un=q((function(e){return function(){return e(R(arguments))}})),cn=q((function(e){return pt(1,e)})),ln=U((function(e,t){return ye(e,(function(){for(var n,r=1,i=t,o=0;r<=e&&"function"==typeof i;)n=r===e?arguments.length:o+i.length,i=i.apply(this,R(arguments,o,n)),r+=1,o=n;return i}))})),fn=U((function(e,t){for(var n=e(t),r=[];n&&n.length;)r[r.length]=n[0],n=e(n[1]);return r})),pn=U((function(e,t){for(var n,r=0,i=t.length,o=[];r<i;)n=t[r],v(e,n,o)||(o[o.length]=n),r+=1;return o})),dn=D((function(e,t,n){return e(n)?n:t(n)})),hn=D((function(e,t,n){return ie(se(t),e,n)})),vn=U((function(e,t){return ye(t.length,(function(){for(var n=[],r=0;r<t.length;)n.push(t[r].call(this,arguments[r])),r+=1;return e.apply(this,n.concat(R(arguments,t.length)))}))})),bn=q((function(e){for(var t=Ke(e),n=t.length,r=[],i=0;i<n;)r[i]=e[t[i]],i+=1;return r})),mn=q((function(e){var t,n=[];for(t in e)n[n.length]=e[t];return n})),gn=(i=function(e){return{value:e,map:function(){return this}}},U((function(e,t){return e(i)(t).value}))),yn=D((function(e,t,n){return e(n)?t(n):n})),_n=U((function(e,t){for(var n in e)if(m(n,e)&&!e[n](t[n]))return!1;return!0})),wn=U((function(e,t){return ye(e.length,(function(){return t.apply(this,h([e],arguments))}))})),En=U((function(e,t){for(var n,r=0,i=e.length,o=t.length,s=[];r<i;){for(n=0;n<o;)s[s.length]=[e[r],t[n]],n+=1;r+=1}return s})),On=U((function(e,t){for(var n=[],r=0,i=Math.min(e.length,t.length);r<i;)n[r]=[e[r],t[r]],r+=1;return n})),Sn=U((function(e,t){for(var n=0,r=e.length,i={};n<r;)i[e[n]]=t[n],n+=1;return i})),Tn=D((function(e,t,n){for(var r=[],i=0,o=Math.min(t.length,n.length);i<o;)r[i]=e(t[i],n[i]),i+=1;return r})),kn=se(!1),An=se(!0),xn=function e(t,n,r){var i=function(i){for(var o=n.length,s=0;s<o;){if(t===n[s])return r[s];s+=1}for(var a in n[s+1]=t,r[s+1]=i,t)i[a]=e(t[a],n,r);return i};switch(an(t)){case"Object":return i({});case"Array":return i([]);case"Date":return new Date(t.valueOf());case"RegExp":return p(t);default:return t}},In=function(e){return U((function(t,n){return l(Math.max(0,t.length-n.length),(function(){return t.apply(this,e(n,arguments))}))}))},Nn=function e(t,n,r,i){if(Ve(t,n))return!0;if(an(t)!==an(n))return!1;if(null==t||null==n)return!1;if("function"==typeof t.equals||"function"==typeof n.equals)return"function"==typeof t.equals&&t.equals(n)&&"function"==typeof n.equals&&n.equals(t);switch(an(t)){case"Arguments":case"Array":case"Object":break;case"Boolean":case"Number":case"String":if(o(t)!==o(n)||!Ve(t.valueOf(),n.valueOf()))return!1;break;case"Date":if(!Ve(t.valueOf(),n.valueOf()))return!1;break;case"Error":return t.name===n.name&&t.message===n.message;case"RegExp":if(t.source!==n.source||t.global!==n.global||t.ignoreCase!==n.ignoreCase||t.multiline!==n.multiline||t.sticky!==n.sticky||t.unicode!==n.unicode)return!1;break;case"Map":case"Set":if(!e(f(t.entries()),f(n.entries()),r,i))return!1;break;case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"ArrayBuffer":break;default:return!1}var s=Ke(t);if(s.length!==Ke(n).length)return!1;for(var a=r.length-1;a>=0;){if(r[a]===t)return i[a]===n;a-=1}for(r.push(t),i.push(n),a=s.length-1;a>=0;){var u=s[a];if(!m(u,n)||!e(n[u],t[u],r,i))return!1;a-=1}return r.pop(),i.pop(),!0},Mn=function(e){return function t(n){for(var r,i,o,s=[],a=0,u=n.length;a<u;){if(Ye(n[a]))for(o=0,i=(r=e?t(n[a]):n[a]).length;o<i;)s[s.length]=r[o],o+=1;else s[s.length]=n[a];a+=1}return s}},Rn=function(){function e(e,t,n){for(var r=n.next();!r.done;){if((t=e["@@transducer/step"](t,r.value))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}r=n.next()}return e["@@transducer/result"](t)}var t="undefined"!=typeof Symbol?Symbol.iterator:"@@iterator";return function(n,r,i){if("function"==typeof n&&(n=j(n)),Ye(i))return function(e,t,n){for(var r=0,i=n.length;r<i;){if((t=e["@@transducer/step"](t,n[r]))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}r+=1}return e["@@transducer/result"](t)}(n,r,i);if("function"==typeof i.reduce)return function(e,t,n){return e["@@transducer/result"](n.reduce(he(e["@@transducer/step"],e),t))}(n,r,i);if(null!=i[t])return e(n,r,i[t]());if("function"==typeof i.next)return e(n,r,i);throw new TypeError("reduce: list must be array or iterable")}}(),Cn=function(){function e(e,t){this.f=e,this.retained=[],this.xf=t}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=function(e){return this.retained=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)?this.retain(e,t):this.flush(e,t)},e.prototype.flush=function(e,t){return e=Rn(this.xf["@@transducer/step"],e,this.retained),this.retained=[],this.xf["@@transducer/step"](e,t)},e.prototype.retain=function(e,t){return this.retained.push(t),e},U((function(t,n){return new e(t,n)}))}(),Pn=function(){function e(e,t){this.xf=t,this.f=e,this.inputs={}}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=function(e){var t;for(t in this.inputs)if(m(t,this.inputs)&&(e=this.xf["@@transducer/step"](e,this.inputs[t]))["@@transducer/reduced"]){e=e["@@transducer/value"];break}return this.inputs=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){var n=this.f(t);return this.inputs[n]=this.inputs[n]||[n,[]],this.inputs[n][1]=le(t,this.inputs[n][1]),e},U((function(t,n){return new e(t,n)}))}(),jn=q((function(e){return ye(e.length,(function(){var t=0,n=arguments[0],r=arguments[arguments.length-1],i=R(arguments);return i[0]=function(){var e=n.apply(this,h(arguments,[t,r]));return t+=1,e},e.apply(this,i)}))})),Ln=q((function(e){return pt(2,e)})),qn=q((function(e){return null!=e&&"function"==typeof e.clone?e.clone():xn(e,[],[])})),Un=q((function(e){return ye(e.length,e)})),Dn=U(F("drop",G,(function(e,t){return Ht(Math.max(0,e),1/0,t)}))),Vn=U(F("dropLast",z,(function(e,t){return Xt(e<t.length?t.length-e:0,t)}))),Fn=U(F("dropLastWhile",Cn,(function(e,t){for(var n=t.length-1;n>=0&&e(t[n]);)n-=1;return R(t,0,n+1)}))),Bn=U((function(e,t){return Nn(e,t,[],[])})),Hn=U(F("filter",Q,(function(e,t){return O(t)?Rn((function(n,r){return e(t[r])&&(n[r]=t[r]),n}),{},Ke(t)):b(e,t)}))),Wn=q(Mn(!0)),Gn=q((function(e){return Un((function(t,n){var r=R(arguments);return r[0]=n,r[1]=t,e.apply(this,r)}))})),zn=U(F("groupBy",Pn,(function(e,t){return Rn((function(t,n){var r=e(n);return t[r]=le(n,t[r]||(t[r]=[])),t}),{},t)}))),Jn=bt(0),Yn=U((function(e,t){return Rn((function(t,n){return t[e(n)]=n,t}),{},t)})),Qn=Ht(0,-1),Kn=D((function(e,t,n){for(var r=[],i=0;i<t.length;)v(e,t[i],n)&&(r[r.length]=t[i]),i+=1;return pn(e,r)})),Xn=q((function(e){for(var t=Ke(e),n=t.length,r=0,i={};r<n;){var o=t[r],s=e[o],a=m(s,i)?i[s]:i[s]=[];a[a.length]=o,r+=1}return i})),$n=q((function(e){for(var t=Ke(e),n=t.length,r=0,i={};r<n;){var o=t[r];i[e[o]]=o,r+=1}return i})),Zn=q((function(e){return null!=e&&Bn(e,xe(e))})),er=bt(-1),tr=U((function(e,t){if("function"!=typeof t.lastIndexOf||_(t)){for(var n=t.length-1;n>=0;){if(Bn(t[n],e))return n;n-=1}return-1}return t.lastIndexOf(e)})),nr=U(F("map",ee,(function(e,t){switch(Object.prototype.toString.call(t)){case"[object Function]":return ye(t.length,(function(){return e.call(this,t.apply(this,arguments))}));case"[object Object]":return Rn((function(n,r){return n[r]=e(t[r]),n}),{},Ke(t));default:return A(e,t)}}))),rr=U((function(e,t){return Rn((function(n,r){return n[r]=e(t[r],r,t),n}),{},Ke(t))})),ir=D((function(e,t,n){return at((function(t,n,r){return e(n,r)}),t,n)})),or=In(h),sr=In(Gn(h)),ar=U((function(e,t){return Rn((function(t,n){var r=t[e(n)?0:1];return r[r.length]=n,t}),[[],[]],t)})),ur=D((function(e,t,n){return Bn(St(e,n),t)})),cr=U((function(e,t){return nr(Mt(e),t)})),lr=vn(A,[xt,Fe]),fr=D((function(e,t,n){return Ct(Bn(t),e,n)})),pr=D((function(e,t,n){return Ct(Je(e),t,n)})),dr=D(Rn),hr=U((function(e,t){return Hn(d(e),t)})),vr=U((function(e,t){return tn(se(e),t)})),br=dr(re,0),mr=U((function(e,t){return Dn(e>=0?t.length-e:0,t)})),gr=ye(4,(function(e,t,n,r){return Rn(e("function"==typeof t?j(t):t),n,r)})),yr=D((function(e,t,n){return pn(e,h(t,n))})),_r=U((function(e,t){return _n(nr(Bn,e),t)})),wr=function(e){var t=function(e){return{"@@transducer/init":P.init,"@@transducer/result":function(t){return e["@@transducer/result"](t)},"@@transducer/step":function(t,n){var r=e["@@transducer/step"](t,n);return r["@@transducer/reduced"]?{"@@transducer/value":r,"@@transducer/reduced":!0}:r}}}(e);return{"@@transducer/init":P.init,"@@transducer/result":function(e){return t["@@transducer/result"](e)},"@@transducer/step":function(e,n){return Ye(n)?Rn(t,e,n):Rn(t,e,[n])}}},Er=function(e,t,n){var r,i;if("function"==typeof e.indexOf)switch(o(t)){case"number":if(0===t){for(r=1/t;n<e.length;){if(0===(i=e[n])&&1/i===r)return n;n+=1}return-1}if(t!=t){for(;n<e.length;){if("number"==typeof(i=e[n])&&i!=i)return n;n+=1}return-1}return e.indexOf(t,n);case"string":case"boolean":case"function":case"undefined":return e.indexOf(t,n);case"object":if(null===t)return e.indexOf(t,n)}for(;n<e.length;){if(Bn(e[n],t))return n;n+=1}return-1},Or=U((function(e,t){return nr(e,wr(t))})),Sr=q((function(e){return ye(dr(ot,0,cr("length",e)),(function(){for(var t=0,n=e.length;t<n;){if(!e[t].apply(this,arguments))return!1;t+=1}return!0}))})),Tr=q((function(e){for(var t=e.length,n=0;n<t;){if(Er(e,e[n],n+1)>=0)return!1;n+=1}return!0})),kr=q((function(e){return ye(dr(ot,0,cr("length",e)),(function(){for(var t=0,n=e.length;t<n;){if(e[t].apply(this,arguments))return!0;t+=1}return!1}))})),Ar=U((function(e,t){return"function"==typeof e.ap?e.ap(t):"function"==typeof e?ye(Math.max(e.length,t.length),(function(){return e.apply(this,arguments)(t.apply(this,arguments))})):Rn((function(e,n){return h(e,nr(n,t))}),[],e)})),xr=Un((function(e){return e.apply(this,R(arguments,1))})),Ir=U(F("chain",Or,(function(e,t){return"function"==typeof t?function(){return t.call(this,e.apply(this,arguments)).apply(this,arguments)}:Mn(!1)(nr(e,t))}))),Nr=D((function(e,t,n){return Lt((function(t,n){return Ar(nr(Nt,e(n)),t)}),t([]),n)})),Mr=U((function(e,t){if(e>10)throw new Error("Constructor with greater than ten arguments");return 0===e?function(){return new t}:Un(pt(e,(function(e,n,r,i,o,s,a,u,c,l){switch(arguments.length){case 1:return new t(e);case 2:return new t(e,n);case 3:return new t(e,n,r);case 4:return new t(e,n,r,i);case 5:return new t(e,n,r,i,o);case 6:return new t(e,n,r,i,o,s);case 7:return new t(e,n,r,i,o,s,a);case 8:return new t(e,n,r,i,o,s,a,u);case 9:return new t(e,n,r,i,o,s,a,u,c);case 10:return new t(e,n,r,i,o,s,a,u,c,l)}})))})),Rr=U((function(e,t){return ye(Math.max.apply(Math,cr("length",t)),(function(){var n=arguments,r=this;return e.apply(r,A((function(e){return e.apply(r,n)}),t))}))})),Cr=U(F("dropRepeatsWith",J,(function(e,t){var n=[],r=1,i=t.length;if(0!==i)for(n[0]=t[0];r<i;)e(er(n),t[r])||(n[n.length]=t[r]),r+=1;return n}))),Pr=D((function(e,t,n){return Bn(e(t),e(n))})),jr=D((function(e,t,n){return Bn(t[e],n[e])})),Lr=U((function(e,t){return"function"!=typeof t.indexOf||_(t)?Er(t,e,0):t.indexOf(e)})),qr=q((function(e){return function(){return nr(fe(c,arguments),e)}})),Ur=U((function(e,t){return function(n){return function(r){return nr((function(e){return t(e,r)}),n(e(r)))}}})),Dr=q((function(e){return Ur(bt(e),hn(e))})),Vr=q((function(e){return Ur(St(e),de(e))})),Fr=q((function(e){return Ur(Mt(e),pe(e))})),Br=U((function(e,t){var n=ye(e,t);return ye(e,(function(){return Rn(Ar,nr(n,arguments[0]),R(arguments,1))}))})),Hr=q((function(e){return br(e)/e.length})),Wr=q((function(e){var t=e.length;if(0===t)return NaN;var n=2-t%2,r=(t-n)/2;return Hr(R(e).sort((function(e,t){return e<t?-1:e>t?1:0})).slice(r,r+n))})),Gr=ir((function(e,t){return t})),zr=q((function(e){return dr(Gr,{},e)})),Jr=function(){if(0===arguments.length)throw new Error("pipe requires at least one argument");return l(arguments[0].length,dr(x,arguments[0],Kt(arguments)))},Yr=function(){if(0===arguments.length)throw new Error("pipeP requires at least one argument");return l(arguments[0].length,dr(I,arguments[0],Kt(arguments)))},Qr=dr(ft,1),Kr=U((function(e,t){return"function"==typeof t.sequence?t.sequence(e):Lt((function(e,t){return Ar(nr(Nt,t),e)}),e([]),t)})),Xr=D((function(e,t,n){return Kr(e,nr(t,n))})),$r=Ir(g),Zr=function(e,t){return Er(t,e,0)>=0},ei=(s={"@@transducer/init":Array,"@@transducer/step":function(e,t){return h(e,[t])},"@@transducer/result":g},a={"@@transducer/init":String,"@@transducer/step":function(e,t){return e+t},"@@transducer/result":g},u={"@@transducer/init":Object,"@@transducer/step":function(e,t){return Gr(e,Ye(t)?gt(t[0],t[1]):t)},"@@transducer/result":g},function(e){if(k(e))return e;if(Ye(e))return s;if("string"==typeof e)return a;if("object"===o(e))return u;throw new Error("Cannot create transformer for "+e)}),ti=function e(t,n){var r=function(r){var i=n.concat([t]);return Zr(r,i)?"<Circular>":e(r,i)},i=function(e,t){return A((function(t){return N(t)+": "+r(e[t])}),t.slice().sort())};switch(Object.prototype.toString.call(t)){case"[object Arguments]":return"(function() { return arguments; }("+A(r,t).join(", ")+"))";case"[object Array]":return"["+A(r,t).concat(i(t,hr((function(e){return/^\d+$/.test(e)}),Ke(t)))).join(", ")+"]";case"[object Boolean]":return"object"===o(t)?"new Boolean("+r(t.valueOf())+")":t.toString();case"[object Date]":return"new Date("+(isNaN(t.valueOf())?r(NaN):N(C(t)))+")";case"[object Null]":return"null";case"[object Number]":return"object"===o(t)?"new Number("+r(t.valueOf())+")":1/t==-1/0?"-0":t.toString(10);case"[object String]":return"object"===o(t)?"new String("+r(t.valueOf())+")":N(t);case"[object Undefined]":return"undefined";default:if("function"==typeof t.toString){var s=t.toString();if("[object Object]"!==s)return s}return"{"+i(t,Ke(t)).join(", ")+"}"}},ni=Nr(Fe),ri=function(){if(0===arguments.length)throw new Error("compose requires at least one argument");return Jr.apply(this,Vt(arguments))},ii=function(){return ri.apply(this,Nt(Fe,nr(Ir,arguments)))},oi=q((function(e){return Mr(e.length,e)})),si=U(Zr),ai=U((function(e,t){for(var n=[],r=0,i=e.length;r<i;)Zr(e[r],t)||Zr(e[r],n)||(n[n.length]=e[r]),r+=1;return n})),ui=q(F("dropRepeats",J(Bn),Cr(Bn))),ci=D((function(e,t,n){return k(e)?Rn(t(e),e["@@transducer/init"](),n):Rn(t(ei(e)),e,n)})),li=q((function(e){return Br(e.length,e)})),fi=U((function(e,t){var n={};for(var r in t)Zr(r,e)||(n[r]=t[r]);return n})),pi=q((function(e){return ti(e,[])})),di=U("undefined"==typeof Set?function(e,t){for(var n,r,i=0,o=[],s=[];i<t.length;)n=e(r=t[i]),Zr(n,o)||(s.push(r),o.push(n)),i+=1;return s}:function(e,t){for(var n,r,i,s=new Set,a=[],u=0,c=[],l=!1,f=!1,p=0;p<t.length;){switch(o(n=e(r=t[p]))){case"number":if(0===n&&!f&&1/n==-1/0){f=!0,c.push(r);break}case"string":case"boolean":case"function":case"undefined":s.add(n),(i=s.size)>u&&(c.push(r),u=i);break;case"object":if(null===n){l||(l=!0,c.push(null));break}default:Zr(n,a)||(a.push(n),c.push(r))}p+=1}return c}),hi=U((function(e,t){return hr(Gn(Zr)(e),t)})),vi=li(vt),bi=U((function(e,t){return ye(e+1,(function(){var n=arguments[e];if(null!=n&&Je(Function,n[t]))return n[t].apply(n,R(arguments,0,e));throw new TypeError(pi(n)+' does not have a method named "'+t+'"')}))})),mi=bi(1,"join"),gi=q((function(e){var t={};return l(e.length,(function(){var n=pi(arguments);return m(n,t)||(t[n]=e.apply(this,arguments)),t[n]}))})),yi=bi(1,"split"),_i=U((function(e,t){if(n=e,"[object RegExp]"!==Object.prototype.toString.call(n))throw new TypeError("‘test’ requires a value of type RegExp as its first argument; received "+pi(e));var n;return p(e).test(t)})),wi=bi(0,"toLowerCase"),Ei=bi(0,"toUpperCase"),Oi=di(Fe),Si=Gn(bi(1,"concat")),Ti=U((function(e,t){return Oi(b(Gn(Zr)(e),t))})),ki=U((function(e,t){return Si(ai(e,t),ai(t,e))})),Ai=D((function(e,t,n){return Si(Ee(e,t,n),Ee(e,n,t))})),xi=U(ri(Oi,h)),Ii={F:kn,T:An,__:c,add:re,addIndex:jn,adjust:ie,all:oe,allPass:Sr,allUniq:Tr,always:se,and:ae,any:ue,anyPass:kr,ap:Ar,aperture:ce,append:le,apply:fe,assoc:pe,assocPath:de,binary:Ln,bind:he,both:ve,call:xr,chain:Ir,clone:qn,commute:ni,commuteMap:Nr,comparator:be,complement:vi,compose:ri,composeK:ii,composeP:function(){if(0===arguments.length)throw new Error("composeP requires at least one argument");return Yr.apply(this,Vt(arguments))},concat:Si,cond:me,construct:oi,constructN:Mr,contains:si,converge:Rr,countBy:ge,curry:Un,curryN:ye,dec:_e,defaultTo:we,difference:ai,differenceWith:Ee,dissoc:Oe,dissocPath:Se,divide:Te,drop:Dn,dropLast:Vn,dropLastWhile:Fn,dropRepeats:ui,dropRepeatsWith:Cr,dropWhile:ke,either:Ae,empty:xe,eqBy:Pr,eqProps:jr,equals:Bn,evolve:Ie,filter:Hn,find:Ne,findIndex:Me,findLast:Re,findLastIndex:Ce,flatten:Wn,flip:Gn,forEach:Pe,fromPairs:je,groupBy:zn,gt:Le,gte:qe,has:Ue,hasIn:De,head:Jn,identical:Ve,identity:Fe,ifElse:Be,inc:He,indexBy:Yn,indexOf:Lr,init:Qn,insert:We,insertAll:Ge,intersection:Ti,intersectionWith:Kn,intersperse:ze,into:ci,invert:Xn,invertObj:$n,invoker:bi,is:Je,isArrayLike:Ye,isEmpty:Zn,isNil:Qe,join:mi,juxt:qr,keys:Ke,keysIn:Xe,last:er,lastIndexOf:tr,length:$e,lens:Ur,lensIndex:Dr,lensPath:Vr,lensProp:Fr,lift:li,liftN:Br,lt:Ze,lte:et,map:nr,mapAccum:tt,mapAccumRight:nt,mapObjIndexed:rr,match:rt,mathMod:it,max:ot,maxBy:st,mean:Hr,median:Wr,memoize:gi,merge:Gr,mergeAll:zr,mergeWith:ir,mergeWithKey:at,min:ut,minBy:ct,modulo:lt,multiply:ft,nAry:pt,negate:dt,none:ht,not:vt,nth:bt,nthArg:mt,objOf:gt,of:yt,omit:fi,once:_t,or:wt,over:Et,pair:Ot,partial:or,partialRight:sr,partition:ar,path:St,pathEq:ur,pathOr:Tt,pathSatisfies:kt,pick:At,pickAll:xt,pickBy:It,pipe:Jr,pipeK:function(){return ii.apply(this,Vt(arguments))},pipeP:Yr,pluck:cr,prepend:Nt,product:Qr,project:lr,prop:Mt,propEq:fr,propIs:pr,propOr:Rt,propSatisfies:Ct,props:Pt,range:jt,reduce:dr,reduceRight:Lt,reduced:qt,reject:hr,remove:Ut,repeat:vr,replace:Dt,reverse:Vt,scan:Ft,sequence:Kr,set:Bt,slice:Ht,sort:Wt,sortBy:Gt,split:yi,splitAt:zt,splitEvery:Jt,splitWhen:Yt,subtract:Qt,sum:br,symmetricDifference:ki,symmetricDifferenceWith:Ai,tail:Kt,take:Xt,takeLast:mr,takeLastWhile:$t,takeWhile:Zt,tap:en,test:_i,times:tn,toLower:wi,toPairs:nn,toPairsIn:rn,toString:pi,toUpper:Ei,transduce:gr,transpose:on,traverse:Xr,trim:sn,type:an,unapply:un,unary:cn,uncurryN:ln,unfold:fn,union:xi,unionWith:yr,uniq:Oi,uniqBy:di,uniqWith:pn,unless:dn,unnest:$r,update:hn,useWith:vn,values:bn,valuesIn:mn,view:gn,when:yn,where:_n,whereEq:_r,without:hi,wrap:wn,xprod:En,zip:On,zipObj:Sn,zipWith:Tn};e.exports=Ii}).call(S)})),N={enabled:!0},M=function(e,t,n,r,i){t||(t=6e4),void 0===n&&(n=2),void 0===r&&(r=.5),i||(i=Math.random);var o=null,s=function(s){if(!N.enabled)return 6048e5;var a=e*Math.pow(n,s);o&&(a=Math.max(a,o),o=null);var u=i(),c=Math.floor(u*r*a),l=Math.floor(10*u)%2==0?a-c:a+c;return a=Math.min(l,t),N.maxDelay&&a>N.maxDelay?N.maxDelay:N.minDelay&&a<=N.minDelay?N.minDelay:a};return s.setNextDelayMinimum=function(e){o=e},s.maximizeNextDelay=function(){return s.setNextDelayMinimum(t)},s},R=function e(t){var n=t.calculateAttemptDelay,r=t.attempt,i=t.onGiveUp,o=t.retryLimit,s=t.retryCount,a=function(t){return r({context:{retryLimit:o,retryCount:s,delay:t},repeat:function(t){return 0===o||s<o?e({calculateAttemptDelay:n,attempt:r,onGiveUp:i,retryLimit:o,retryCount:s+1}):i(t)}})};if(0===s)a(0);else{var u=n(s);setTimeout((function(){return a(u)}),u)}},C=function(e){var t=e.calculateAttemptDelay,n=e.attempt,r=e.onGiveUp,i=e.retryLimit;if(0!==i&&!r)throw new Error("Must define onGiveUp if retryLimit is not 0");return R({calculateAttemptDelay:t,attempt:n,onGiveUp:r,retryLimit:i,retryCount:0})},P=function(){return sm.conf.integrities_enabled},j=function(e){if(P()||e.force){var t=e.name?I.propEq("name",e.name):I.propEq("versioned_name",e.versionedName),n=I.find(t,sm.conf.integrities);if(n)return I.prop("integrity",n);sm.logger.error("Could not find expected integrity for module",e)}},L=function(e){var t=e.beforeLoad,n=e.onAttempt,r=e.onLoad,i=e.onError,o=e.onGiveUp,s=e.integrity,a=e.fileUrl,u=e.retryLimit,c=void 0===u?5:u,l=e.backoffDelay;C({calculateAttemptDelay:M(void 0===l?1e3:l),attempt:function(e){var o=e.repeat;"function"==typeof n&&n();var u=document.createElement("script");return u.type="text/javascript",u.onload=function(){"function"==typeof r&&r()},u.onerror=function(){"function"==typeof i&&i(),document.head.removeChild(u),o()},u.src=a,s&&(u.setAttribute("integrity",s),u.setAttribute("crossorigin","*")),"function"==typeof t&&t(u),document.head.appendChild(u),u},onGiveUp:function(){"function"==typeof o&&o()},retryLimit:c})},q=function(e){var t=e.integrity,n=e.fileUrl,r=e.onAttempt,i=e.onError,o=e.onGiveUp;return C({calculateAttemptDelay:M(1e3),attempt:function(e){var o=e.repeat;"function"==typeof r&&r();var s=document.createElement("link");return s.type="text/css",s.rel="stylesheet",s.onerror=function(){"function"==typeof i&&i(),document.head.removeChild(s),o()},s.href=n,t&&(s.setAttribute("integrity",t),s.setAttribute("crossorigin","*")),document.head.appendChild(s),s},onGiveUp:function(){"function"==typeof o&&o()},retryLimit:5})};function U(e){return(U="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function D(e){return function(e){if(Array.isArray(e))return F(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||V(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function V(e,t){if(e){if("string"==typeof e)return F(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?F(e,t):void 0}}function F(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function B(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=V(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==n.return||n.return()}finally{if(a)throw o}}}}function H(){var e=this;this.list=[],this.add=function(t){10===e.list.length&&(e.list=e.list.slice(1)),e.list.push(t)}}var W=function(e,t){var n={};for(var r in e)n[r]=e[r];for(var i in t)n[i]=t[i];return n},G=function(e){var t={};for(var n in e){var r=e[n];t[n]="function"==typeof r?r():r}return t},z=function(e,t){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n)},J=["string","number","boolean","null","undefined"];var Y=function(e){return Object.keys(e).map((function(t){return e[t]}))};var Q={CustomTransport:function(e){if(!e)throw new Error("processFn must be specificed when using CustomTransport");this.process=e},HttpTransport:function(e){var t=e.url,n=e.method,r=e.headers,i=e.encode;if(!t)throw new Error("url must be specificed when using HttpTransport");n||(n="POST"),r||(r={}),i||(i=function(e){return JSON.stringify(e)}),this.process=window.fetch?function(e){var o=e.payload;return window.fetch(t,{method:n,headers:r,keepalive:!0,body:i(o)})}:function(e){var o=e.payload;return new Promise((function(e,s){var a=new XMLHttpRequest;a.open(n,t),Object.keys(r).forEach((function(e){a.setRequestHeader(e,r[e])})),a.onload=function(){a.status<200||status>=300?s():e()},a.onerror=function(){return s()},a.send(i(o))}))}}},K=function(e){return function(t){var n=t.namespace;return{attempted:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.tags,i=void 0===r?[]:r,o=Date.now(),s=!1,a=function(t){var r=t.action,o=t.reason,s=["action:".concat(r)];return o&&s.push("reason:".concat(o)),e.increment("sm.lib.".concat(n),I.concat(i,s))},u=function(e){return a({action:"failed",reason:e})},c=function(t){var r=t.action;s=!0;var a=Date.now()-o;e.histogram("sm.timing.lib.".concat(n),a,I.concat(i,["client:browser","action:".concat(r)]))};return a({action:"attempted"}),{succeeded:function(){a({action:"succeeded"}),c({action:"succeeded"})},failed:function(e){u(e),c({action:"failed"})},timedOut:function(){u("timed_out"),c({action:"failed"})},failedUnknown:function(){u("unknown"),c({action:"failed"})},isFinished:function(){return s}}}}}},X=["timing","increment","decrement","gauge","histogram","set"],$=function(){function e(){var t=this;s(this,e),this.withTags=this.withTags.bind(this),this.instrument=function(){return{attempted:function(){return{succeeded:function(){},failed:function(){},timedOut:function(){},failedUnknown:function(){},isFinished:function(){}}}}},X.forEach((function(e){t[e]=function(){}}))}return u(e,[{key:"recordMessageHubConnectionEstablished",value:function(){}},{key:"recordBaseDomCaching",value:function(){}},{key:"clientHandlerError",value:function(){}},{key:"statApiUsage",value:function(e){e.resource;return function(e){return{attempted:function(){return{succeeded:function(){},failed:function(){},timedOut:function(){},failedUnknown:function(){},isFinished:function(){}}}}}}},{key:"statScreenShareUsage",value:function(e,t){return{attempted:function(){return{succeeded:function(){},failed:function(){},timedOut:function(){},failedUnknown:function(){},isFinished:function(){}}}}}},{key:"withTags",value:function(){return this}}]),e}(),Z=function(){function e(t,n){var r=this;s(this,e),this.statApiUsage=this.statApiUsage.bind(this),this.statScreenShareUsage=this.statScreenShareUsage.bind(this),this.withTags=this.withTags.bind(this),this.statsClient=t,this.latencyMeasurer=n,this.instrument=K(this.statsClient),X.forEach((function(e){r.statsClient[e]&&(r[e]=r.statsClient[e].bind(r.statsClient))}))}return u(e,[{key:"recordBaseDomCaching",value:function(e){var t=e.result;this.statsClient.increment("sm.app.visitor.api.cached_base_dom",["action:save","result:".concat(t)])}},{key:"clientHandlerError",value:function(e){this.statsClient.increment("sm.app.visitor.api.client_handler",["action:failed","executor:".concat(e)])}},{key:"statApiUsage",value:function(e){var t=this,n=e.protocol,r=e.resource;return function(e){return K(t.statsClient.withTags(["protocol:".concat(n),"method:".concat(e)]))({namespace:r})}}},{key:"statScreenShareUsage",value:function(e){var t=e.stage,n=e.resource;return K(this.statsClient.withTags(["stage:".concat(t)]))({namespace:n})}},{key:"withTags",value:function(t){return new e(this.statsClient.withTags(t))}}],[{key:"createDummy",value:function(){return new $}}]),e}(),ee=function(e,t){return(ee=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function te(e,t){function n(){this.constructor=e}ee(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var ne=function(){return(ne=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function re(e){return"function"==typeof e}var ie=!1,oe={Promise:void 0,set useDeprecatedSynchronousErrorHandling(e){e&&(new Error).stack;ie=e},get useDeprecatedSynchronousErrorHandling(){return ie}};function se(e){setTimeout((function(){throw e}),0)}var ae={closed:!0,next:function(e){},error:function(e){if(oe.useDeprecatedSynchronousErrorHandling)throw e;se(e)},complete:function(){}},ue=function(){return Array.isArray||function(e){return e&&"number"==typeof e.length}}();function ce(e){return null!==e&&"object"===o(e)}var le=function(){function e(e){return Error.call(this),this.message=e?e.length+" errors occurred during unsubscription:\n"+e.map((function(e,t){return t+1+") "+e.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=e,this}return e.prototype=Object.create(Error.prototype),e}(),fe=function(){function e(e){this.closed=!1,this._parentOrParents=null,this._subscriptions=null,e&&(this._ctorUnsubscribe=!0,this._unsubscribe=e)}return e.prototype.unsubscribe=function(){var t;if(!this.closed){var n=this,r=n._parentOrParents,i=n._ctorUnsubscribe,o=n._unsubscribe,s=n._subscriptions;if(this.closed=!0,this._parentOrParents=null,this._subscriptions=null,r instanceof e)r.remove(this);else if(null!==r)for(var a=0;a<r.length;++a){r[a].remove(this)}if(re(o)){i&&(this._unsubscribe=void 0);try{o.call(this)}catch(e){t=e instanceof le?pe(e.errors):[e]}}if(ue(s)){a=-1;for(var u=s.length;++a<u;){var c=s[a];if(ce(c))try{c.unsubscribe()}catch(e){t=t||[],e instanceof le?t=t.concat(pe(e.errors)):t.push(e)}}}if(t)throw new le(t)}},e.prototype.add=function(t){var n=t;if(!t)return e.EMPTY;switch(o(t)){case"function":n=new e(t);case"object":if(n===this||n.closed||"function"!=typeof n.unsubscribe)return n;if(this.closed)return n.unsubscribe(),n;if(!(n instanceof e)){var r=n;(n=new e)._subscriptions=[r]}break;default:throw new Error("unrecognized teardown "+t+" added to Subscription.")}var i=n._parentOrParents;if(null===i)n._parentOrParents=this;else if(i instanceof e){if(i===this)return n;n._parentOrParents=[i,this]}else{if(-1!==i.indexOf(this))return n;i.push(this)}var s=this._subscriptions;return null===s?this._subscriptions=[n]:s.push(n),n},e.prototype.remove=function(e){var t=this._subscriptions;if(t){var n=t.indexOf(e);-1!==n&&t.splice(n,1)}},e.EMPTY=function(e){return e.closed=!0,e}(new e),e}();function pe(e){return e.reduce((function(e,t){return e.concat(t instanceof le?t.errors:t)}),[])}var de=function(){return"function"==typeof Symbol?Symbol("rxSubscriber"):"@@rxSubscriber_"+Math.random()}(),he=function(e){function t(n,r,i){var s=e.call(this)||this;switch(s.syncErrorValue=null,s.syncErrorThrown=!1,s.syncErrorThrowable=!1,s.isStopped=!1,arguments.length){case 0:s.destination=ae;break;case 1:if(!n){s.destination=ae;break}if("object"===o(n)){n instanceof t?(s.syncErrorThrowable=n.syncErrorThrowable,s.destination=n,n.add(s)):(s.syncErrorThrowable=!0,s.destination=new ve(s,n));break}default:s.syncErrorThrowable=!0,s.destination=new ve(s,n,r,i)}return s}return te(t,e),t.prototype[de]=function(){return this},t.create=function(e,n,r){var i=new t(e,n,r);return i.syncErrorThrowable=!1,i},t.prototype.next=function(e){this.isStopped||this._next(e)},t.prototype.error=function(e){this.isStopped||(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this))},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){this.destination.error(e),this.unsubscribe()},t.prototype._complete=function(){this.destination.complete(),this.unsubscribe()},t.prototype._unsubscribeAndRecycle=function(){var e=this._parentOrParents;return this._parentOrParents=null,this.unsubscribe(),this.closed=!1,this.isStopped=!1,this._parentOrParents=e,this},t}(fe),ve=function(e){function t(t,n,r,i){var o,s=e.call(this)||this;s._parentSubscriber=t;var a=s;return re(n)?o=n:n&&(o=n.next,r=n.error,i=n.complete,n!==ae&&(re((a=Object.create(n)).unsubscribe)&&s.add(a.unsubscribe.bind(a)),a.unsubscribe=s.unsubscribe.bind(s))),s._context=a,s._next=o,s._error=r,s._complete=i,s}return te(t,e),t.prototype.next=function(e){if(!this.isStopped&&this._next){var t=this._parentSubscriber;oe.useDeprecatedSynchronousErrorHandling&&t.syncErrorThrowable?this.__tryOrSetError(t,this._next,e)&&this.unsubscribe():this.__tryOrUnsub(this._next,e)}},t.prototype.error=function(e){if(!this.isStopped){var t=this._parentSubscriber,n=oe.useDeprecatedSynchronousErrorHandling;if(this._error)n&&t.syncErrorThrowable?(this.__tryOrSetError(t,this._error,e),this.unsubscribe()):(this.__tryOrUnsub(this._error,e),this.unsubscribe());else if(t.syncErrorThrowable)n?(t.syncErrorValue=e,t.syncErrorThrown=!0):se(e),this.unsubscribe();else{if(this.unsubscribe(),n)throw e;se(e)}}},t.prototype.complete=function(){var e=this;if(!this.isStopped){var t=this._parentSubscriber;if(this._complete){var n=function(){return e._complete.call(e._context)};oe.useDeprecatedSynchronousErrorHandling&&t.syncErrorThrowable?(this.__tryOrSetError(t,n),this.unsubscribe()):(this.__tryOrUnsub(n),this.unsubscribe())}else this.unsubscribe()}},t.prototype.__tryOrUnsub=function(e,t){try{e.call(this._context,t)}catch(e){if(this.unsubscribe(),oe.useDeprecatedSynchronousErrorHandling)throw e;se(e)}},t.prototype.__tryOrSetError=function(e,t,n){if(!oe.useDeprecatedSynchronousErrorHandling)throw new Error("bad call");try{t.call(this._context,n)}catch(t){return oe.useDeprecatedSynchronousErrorHandling?(e.syncErrorValue=t,e.syncErrorThrown=!0,!0):(se(t),!0)}return!1},t.prototype._unsubscribe=function(){var e=this._parentSubscriber;this._context=null,this._parentSubscriber=null,e.unsubscribe()},t}(he);function be(e){for(;e;){var t=e,n=t.closed,r=t.destination,i=t.isStopped;if(n||i)return!1;e=r&&r instanceof he?r:null}return!0}function me(e,t,n){if(e){if(e instanceof he)return e;if(e[de])return e[de]()}return e||t||n?new he(e,t,n):new he(ae)}var ge=function(){return"function"==typeof Symbol&&Symbol.observable||"@@observable"}();function ye(e){return e}function _e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return we(e)}function we(e){return 0===e.length?ye:1===e.length?e[0]:function(t){return e.reduce((function(e,t){return t(e)}),t)}}var Ee=function(){function e(e){this._isScalar=!1,e&&(this._subscribe=e)}return e.prototype.lift=function(t){var n=new e;return n.source=this,n.operator=t,n},e.prototype.subscribe=function(e,t,n){var r=this.operator,i=me(e,t,n);if(r?i.add(r.call(i,this.source)):i.add(this.source||oe.useDeprecatedSynchronousErrorHandling&&!i.syncErrorThrowable?this._subscribe(i):this._trySubscribe(i)),oe.useDeprecatedSynchronousErrorHandling&&i.syncErrorThrowable&&(i.syncErrorThrowable=!1,i.syncErrorThrown))throw i.syncErrorValue;return i},e.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){oe.useDeprecatedSynchronousErrorHandling&&(e.syncErrorThrown=!0,e.syncErrorValue=t),be(e)?e.error(t):console.warn(t)}},e.prototype.forEach=function(e,t){var n=this;return new(t=Oe(t))((function(t,r){var i;i=n.subscribe((function(t){try{e(t)}catch(e){r(e),i&&i.unsubscribe()}}),r,t)}))},e.prototype._subscribe=function(e){var t=this.source;return t&&t.subscribe(e)},e.prototype[ge]=function(){return this},e.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 0===e.length?this:we(e)(this)},e.prototype.toPromise=function(e){var t=this;return new(e=Oe(e))((function(e,n){var r;t.subscribe((function(e){return r=e}),(function(e){return n(e)}),(function(){return e(r)}))}))},e.create=function(t){return new e(t)},e}();function Oe(e){if(e||(e=oe.Promise||Promise),!e)throw new Error("no Promise impl found");return e}var Se=function(){function e(){return Error.call(this),this.message="object unsubscribed",this.name="ObjectUnsubscribedError",this}return e.prototype=Object.create(Error.prototype),e}(),Te=function(e){function t(t,n){var r=e.call(this)||this;return r.subject=t,r.subscriber=n,r.closed=!1,r}return te(t,e),t.prototype.unsubscribe=function(){if(!this.closed){this.closed=!0;var e=this.subject,t=e.observers;if(this.subject=null,t&&0!==t.length&&!e.isStopped&&!e.closed){var n=t.indexOf(this.subscriber);-1!==n&&t.splice(n,1)}}},t}(fe),ke=function(e){function t(t){var n=e.call(this,t)||this;return n.destination=t,n}return te(t,e),t}(he),Ae=function(e){function t(){var t=e.call(this)||this;return t.observers=[],t.closed=!1,t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return te(t,e),t.prototype[de]=function(){return new ke(this)},t.prototype.lift=function(e){var t=new xe(this,this);return t.operator=e,t},t.prototype.next=function(e){if(this.closed)throw new Se;if(!this.isStopped)for(var t=this.observers,n=t.length,r=t.slice(),i=0;i<n;i++)r[i].next(e)},t.prototype.error=function(e){if(this.closed)throw new Se;this.hasError=!0,this.thrownError=e,this.isStopped=!0;for(var t=this.observers,n=t.length,r=t.slice(),i=0;i<n;i++)r[i].error(e);this.observers.length=0},t.prototype.complete=function(){if(this.closed)throw new Se;this.isStopped=!0;for(var e=this.observers,t=e.length,n=e.slice(),r=0;r<t;r++)n[r].complete();this.observers.length=0},t.prototype.unsubscribe=function(){this.isStopped=!0,this.closed=!0,this.observers=null},t.prototype._trySubscribe=function(t){if(this.closed)throw new Se;return e.prototype._trySubscribe.call(this,t)},t.prototype._subscribe=function(e){if(this.closed)throw new Se;return this.hasError?(e.error(this.thrownError),fe.EMPTY):this.isStopped?(e.complete(),fe.EMPTY):(this.observers.push(e),new Te(this,e))},t.prototype.asObservable=function(){var e=new Ee;return e.source=this,e},t.create=function(e,t){return new xe(e,t)},t}(Ee),xe=function(e){function t(t,n){var r=e.call(this)||this;return r.destination=t,r.source=n,r}return te(t,e),t.prototype.next=function(e){var t=this.destination;t&&t.next&&t.next(e)},t.prototype.error=function(e){var t=this.destination;t&&t.error&&this.destination.error(e)},t.prototype.complete=function(){var e=this.destination;e&&e.complete&&this.destination.complete()},t.prototype._subscribe=function(e){return this.source?this.source.subscribe(e):fe.EMPTY},t}(Ae);function Ie(){return function(e){return e.lift(new Ne(e))}}var Ne=function(){function e(e){this.connectable=e}return e.prototype.call=function(e,t){var n=this.connectable;n._refCount++;var r=new Me(e,n),i=t.subscribe(r);return r.closed||(r.connection=n.connect()),i},e}(),Me=function(e){function t(t,n){var r=e.call(this,t)||this;return r.connectable=n,r}return te(t,e),t.prototype._unsubscribe=function(){var e=this.connectable;if(e){this.connectable=null;var t=e._refCount;if(t<=0)this.connection=null;else if(e._refCount=t-1,t>1)this.connection=null;else{var n=this.connection,r=e._connection;this.connection=null,!r||n&&r!==n||r.unsubscribe()}}else this.connection=null},t}(he),Re=function(e){function t(t,n){var r=e.call(this)||this;return r.source=t,r.subjectFactory=n,r._refCount=0,r._isComplete=!1,r}return te(t,e),t.prototype._subscribe=function(e){return this.getSubject().subscribe(e)},t.prototype.getSubject=function(){var e=this._subject;return e&&!e.isStopped||(this._subject=this.subjectFactory()),this._subject},t.prototype.connect=function(){var e=this._connection;return e||(this._isComplete=!1,(e=this._connection=new fe).add(this.source.subscribe(new Pe(this.getSubject(),this))),e.closed&&(this._connection=null,e=fe.EMPTY)),e},t.prototype.refCount=function(){return Ie()(this)},t}(Ee),Ce=function(){var e=Re.prototype;return{operator:{value:null},_refCount:{value:0,writable:!0},_subject:{value:null,writable:!0},_connection:{value:null,writable:!0},_subscribe:{value:e._subscribe},_isComplete:{value:e._isComplete,writable:!0},getSubject:{value:e.getSubject},connect:{value:e.connect},refCount:{value:e.refCount}}}(),Pe=function(e){function t(t,n){var r=e.call(this,t)||this;return r.connectable=n,r}return te(t,e),t.prototype._error=function(t){this._unsubscribe(),e.prototype._error.call(this,t)},t.prototype._complete=function(){this.connectable._isComplete=!0,this._unsubscribe(),e.prototype._complete.call(this)},t.prototype._unsubscribe=function(){var e=this.connectable;if(e){this.connectable=null;var t=e._connection;e._refCount=0,e._subject=null,e._connection=null,t&&t.unsubscribe()}},t}(ke);function je(e,t,n,r){return function(i){return i.lift(new Le(e,t,n,r))}}var Le=function(){function e(e,t,n,r){this.keySelector=e,this.elementSelector=t,this.durationSelector=n,this.subjectSelector=r}return e.prototype.call=function(e,t){return t.subscribe(new qe(e,this.keySelector,this.elementSelector,this.durationSelector,this.subjectSelector))},e}(),qe=function(e){function t(t,n,r,i,o){var s=e.call(this,t)||this;return s.keySelector=n,s.elementSelector=r,s.durationSelector=i,s.subjectSelector=o,s.groups=null,s.attemptedToUnsubscribe=!1,s.count=0,s}return te(t,e),t.prototype._next=function(e){var t;try{t=this.keySelector(e)}catch(e){return void this.error(e)}this._group(e,t)},t.prototype._group=function(e,t){var n=this.groups;n||(n=this.groups=new Map);var r,i=n.get(t);if(this.elementSelector)try{r=this.elementSelector(e)}catch(e){this.error(e)}else r=e;if(!i){i=this.subjectSelector?this.subjectSelector():new Ae,n.set(t,i);var o=new De(t,i,this);if(this.destination.next(o),this.durationSelector){var s=void 0;try{s=this.durationSelector(new De(t,i))}catch(e){return void this.error(e)}this.add(s.subscribe(new Ue(t,i,this)))}}i.closed||i.next(r)},t.prototype._error=function(e){var t=this.groups;t&&(t.forEach((function(t,n){t.error(e)})),t.clear()),this.destination.error(e)},t.prototype._complete=function(){var e=this.groups;e&&(e.forEach((function(e,t){e.complete()})),e.clear()),this.destination.complete()},t.prototype.removeGroup=function(e){this.groups.delete(e)},t.prototype.unsubscribe=function(){this.closed||(this.attemptedToUnsubscribe=!0,0===this.count&&e.prototype.unsubscribe.call(this))},t}(he),Ue=function(e){function t(t,n,r){var i=e.call(this,n)||this;return i.key=t,i.group=n,i.parent=r,i}return te(t,e),t.prototype._next=function(e){this.complete()},t.prototype._unsubscribe=function(){var e=this.parent,t=this.key;this.key=this.parent=null,e&&e.removeGroup(t)},t}(he),De=function(e){function t(t,n,r){var i=e.call(this)||this;return i.key=t,i.groupSubject=n,i.refCountSubscription=r,i}return te(t,e),t.prototype._subscribe=function(e){var t=new fe,n=this.refCountSubscription,r=this.groupSubject;return n&&!n.closed&&t.add(new Ve(n)),t.add(r.subscribe(e)),t},t}(Ee),Ve=function(e){function t(t){var n=e.call(this)||this;return n.parent=t,t.count++,n}return te(t,e),t.prototype.unsubscribe=function(){var t=this.parent;t.closed||this.closed||(e.prototype.unsubscribe.call(this),t.count-=1,0===t.count&&t.attemptedToUnsubscribe&&t.unsubscribe())},t}(fe),Fe=function(e){function t(t){var n=e.call(this)||this;return n._value=t,n}return te(t,e),Object.defineProperty(t.prototype,"value",{get:function(){return this.getValue()},enumerable:!0,configurable:!0}),t.prototype._subscribe=function(t){var n=e.prototype._subscribe.call(this,t);return n&&!n.closed&&t.next(this._value),n},t.prototype.getValue=function(){if(this.hasError)throw this.thrownError;if(this.closed)throw new Se;return this._value},t.prototype.next=function(t){e.prototype.next.call(this,this._value=t)},t}(Ae),Be=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r.scheduler=t,r.work=n,r.pending=!1,r}return te(t,e),t.prototype.schedule=function(e,t){if(void 0===t&&(t=0),this.closed)return this;this.state=e;var n=this.id,r=this.scheduler;return null!=n&&(this.id=this.recycleAsyncId(r,n,t)),this.pending=!0,this.delay=t,this.id=this.id||this.requestAsyncId(r,this.id,t),this},t.prototype.requestAsyncId=function(e,t,n){return void 0===n&&(n=0),setInterval(e.flush.bind(e,this),n)},t.prototype.recycleAsyncId=function(e,t,n){if(void 0===n&&(n=0),null!==n&&this.delay===n&&!1===this.pending)return t;clearInterval(t)},t.prototype.execute=function(e,t){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var n=this._execute(e,t);if(n)return n;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},t.prototype._execute=function(e,t){var n=!1,r=void 0;try{this.work(e)}catch(e){n=!0,r=!!e&&e||new Error(e)}if(n)return this.unsubscribe(),r},t.prototype._unsubscribe=function(){var e=this.id,t=this.scheduler,n=t.actions,r=n.indexOf(this);this.work=null,this.state=null,this.pending=!1,this.scheduler=null,-1!==r&&n.splice(r,1),null!=e&&(this.id=this.recycleAsyncId(t,e,null)),this.delay=null},t}(function(e){function t(t,n){return e.call(this)||this}return te(t,e),t.prototype.schedule=function(e,t){return this},t}(fe)),He=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r.scheduler=t,r.work=n,r}return te(t,e),t.prototype.schedule=function(t,n){return void 0===n&&(n=0),n>0?e.prototype.schedule.call(this,t,n):(this.delay=n,this.state=t,this.scheduler.flush(this),this)},t.prototype.execute=function(t,n){return n>0||this.closed?e.prototype.execute.call(this,t,n):this._execute(t,n)},t.prototype.requestAsyncId=function(t,n,r){return void 0===r&&(r=0),null!==r&&r>0||null===r&&this.delay>0?e.prototype.requestAsyncId.call(this,t,n,r):t.flush(this)},t}(Be),We=function(){function e(t,n){void 0===n&&(n=e.now),this.SchedulerAction=t,this.now=n}return e.prototype.schedule=function(e,t,n){return void 0===t&&(t=0),new this.SchedulerAction(this,e).schedule(n,t)},e.now=function(){return Date.now()},e}(),Ge=function(e){function t(n,r){void 0===r&&(r=We.now);var i=e.call(this,n,(function(){return t.delegate&&t.delegate!==i?t.delegate.now():r()}))||this;return i.actions=[],i.active=!1,i.scheduled=void 0,i}return te(t,e),t.prototype.schedule=function(n,r,i){return void 0===r&&(r=0),t.delegate&&t.delegate!==this?t.delegate.schedule(n,r,i):e.prototype.schedule.call(this,n,r,i)},t.prototype.flush=function(e){var t=this.actions;if(this.active)t.push(e);else{var n;this.active=!0;do{if(n=e.execute(e.state,e.delay))break}while(e=t.shift());if(this.active=!1,n){for(;e=t.shift();)e.unsubscribe();throw n}}},t}(We),ze=new(function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return te(t,e),t}(Ge))(He),Je=ze,Ye=new Ee((function(e){return e.complete()}));function Qe(e){return e?function(e){return new Ee((function(t){return e.schedule((function(){return t.complete()}))}))}(e):Ye}function Ke(e){return e&&"function"==typeof e.schedule}var Xe,$e=function(e){return function(t){for(var n=0,r=e.length;n<r&&!t.closed;n++)t.next(e[n]);t.complete()}};function Ze(e,t){return new Ee((function(n){var r=new fe,i=0;return r.add(t.schedule((function(){i!==e.length?(n.next(e[i++]),n.closed||r.add(this.schedule())):n.complete()}))),r}))}function et(e,t){return t?Ze(e,t):new Ee($e(e))}function tt(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=e[e.length-1];return Ke(n)?(e.pop(),Ze(e,n)):et(e)}function nt(e,t){return new Ee(t?function(n){return t.schedule(rt,0,{error:e,subscriber:n})}:function(t){return t.error(e)})}function rt(e){var t=e.error;e.subscriber.error(t)}Xe||(Xe={});var it=function(){function e(e,t,n){this.kind=e,this.value=t,this.error=n,this.hasValue="N"===e}return e.prototype.observe=function(e){switch(this.kind){case"N":return e.next&&e.next(this.value);case"E":return e.error&&e.error(this.error);case"C":return e.complete&&e.complete()}},e.prototype.do=function(e,t,n){switch(this.kind){case"N":return e&&e(this.value);case"E":return t&&t(this.error);case"C":return n&&n()}},e.prototype.accept=function(e,t,n){return e&&"function"==typeof e.next?this.observe(e):this.do(e,t,n)},e.prototype.toObservable=function(){switch(this.kind){case"N":return tt(this.value);case"E":return nt(this.error);case"C":return Qe()}throw new Error("unexpected notification kind value")},e.createNext=function(t){return void 0!==t?new e("N",t):e.undefinedValueNotification},e.createError=function(t){return new e("E",void 0,t)},e.createComplete=function(){return e.completeNotification},e.completeNotification=new e("C"),e.undefinedValueNotification=new e("N",void 0),e}();var ot=function(){function e(e,t){void 0===t&&(t=0),this.scheduler=e,this.delay=t}return e.prototype.call=function(e,t){return t.subscribe(new st(e,this.scheduler,this.delay))},e}(),st=function(e){function t(t,n,r){void 0===r&&(r=0);var i=e.call(this,t)||this;return i.scheduler=n,i.delay=r,i}return te(t,e),t.dispatch=function(e){var t=e.notification,n=e.destination;t.observe(n),this.unsubscribe()},t.prototype.scheduleMessage=function(e){this.destination.add(this.scheduler.schedule(t.dispatch,this.delay,new at(e,this.destination)))},t.prototype._next=function(e){this.scheduleMessage(it.createNext(e))},t.prototype._error=function(e){this.scheduleMessage(it.createError(e)),this.unsubscribe()},t.prototype._complete=function(){this.scheduleMessage(it.createComplete()),this.unsubscribe()},t}(he),at=function(){return function(e,t){this.notification=e,this.destination=t}}(),ut=function(e){function t(t,n,r){void 0===t&&(t=Number.POSITIVE_INFINITY),void 0===n&&(n=Number.POSITIVE_INFINITY);var i=e.call(this)||this;return i.scheduler=r,i._events=[],i._infiniteTimeWindow=!1,i._bufferSize=t<1?1:t,i._windowTime=n<1?1:n,n===Number.POSITIVE_INFINITY?(i._infiniteTimeWindow=!0,i.next=i.nextInfiniteTimeWindow):i.next=i.nextTimeWindow,i}return te(t,e),t.prototype.nextInfiniteTimeWindow=function(t){if(!this.isStopped){var n=this._events;n.push(t),n.length>this._bufferSize&&n.shift()}e.prototype.next.call(this,t)},t.prototype.nextTimeWindow=function(t){this.isStopped||(this._events.push(new ct(this._getNow(),t)),this._trimBufferThenGetEvents()),e.prototype.next.call(this,t)},t.prototype._subscribe=function(e){var t,n=this._infiniteTimeWindow,r=n?this._events:this._trimBufferThenGetEvents(),i=this.scheduler,o=r.length;if(this.closed)throw new Se;if(this.isStopped||this.hasError?t=fe.EMPTY:(this.observers.push(e),t=new Te(this,e)),i&&e.add(e=new st(e,i)),n)for(var s=0;s<o&&!e.closed;s++)e.next(r[s]);else for(s=0;s<o&&!e.closed;s++)e.next(r[s].value);return this.hasError?e.error(this.thrownError):this.isStopped&&e.complete(),t},t.prototype._getNow=function(){return(this.scheduler||Je).now()},t.prototype._trimBufferThenGetEvents=function(){for(var e=this._getNow(),t=this._bufferSize,n=this._windowTime,r=this._events,i=r.length,o=0;o<i&&!(e-r[o].time<n);)o++;return i>t&&(o=Math.max(o,i-t)),o>0&&r.splice(0,o),r},t}(Ae),ct=function(){return function(e,t){this.time=e,this.value=t}}(),lt=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.value=null,t.hasNext=!1,t.hasCompleted=!1,t}return te(t,e),t.prototype._subscribe=function(t){return this.hasError?(t.error(this.thrownError),fe.EMPTY):this.hasCompleted&&this.hasNext?(t.next(this.value),t.complete(),fe.EMPTY):e.prototype._subscribe.call(this,t)},t.prototype.next=function(e){this.hasCompleted||(this.value=e,this.hasNext=!0)},t.prototype.error=function(t){this.hasCompleted||e.prototype.error.call(this,t)},t.prototype.complete=function(){this.hasCompleted=!0,this.hasNext&&e.prototype.next.call(this,this.value),e.prototype.complete.call(this)},t}(Ae),ft=1,pt=function(){return Promise.resolve()}(),dt={};function ht(e){return e in dt&&(delete dt[e],!0)}var vt={setImmediate:function(e){var t=ft++;return dt[t]=!0,pt.then((function(){return ht(t)&&e()})),t},clearImmediate:function(e){ht(e)}},bt=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r.scheduler=t,r.work=n,r}return te(t,e),t.prototype.requestAsyncId=function(t,n,r){return void 0===r&&(r=0),null!==r&&r>0?e.prototype.requestAsyncId.call(this,t,n,r):(t.actions.push(this),t.scheduled||(t.scheduled=vt.setImmediate(t.flush.bind(t,null))))},t.prototype.recycleAsyncId=function(t,n,r){if(void 0===r&&(r=0),null!==r&&r>0||null===r&&this.delay>0)return e.prototype.recycleAsyncId.call(this,t,n,r);0===t.actions.length&&(vt.clearImmediate(n),t.scheduled=void 0)},t}(Be),mt=new(function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return te(t,e),t.prototype.flush=function(e){this.active=!0,this.scheduled=void 0;var t,n=this.actions,r=-1,i=n.length;e=e||n.shift();do{if(t=e.execute(e.state,e.delay))break}while(++r<i&&(e=n.shift()));if(this.active=!1,t){for(;++r<i&&(e=n.shift());)e.unsubscribe();throw t}},t}(Ge))(bt),gt=mt,yt=new Ge(Be),_t=yt,wt=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r.scheduler=t,r.work=n,r}return te(t,e),t.prototype.requestAsyncId=function(t,n,r){return void 0===r&&(r=0),null!==r&&r>0?e.prototype.requestAsyncId.call(this,t,n,r):(t.actions.push(this),t.scheduled||(t.scheduled=requestAnimationFrame((function(){return t.flush(null)}))))},t.prototype.recycleAsyncId=function(t,n,r){if(void 0===r&&(r=0),null!==r&&r>0||null===r&&this.delay>0)return e.prototype.recycleAsyncId.call(this,t,n,r);0===t.actions.length&&(cancelAnimationFrame(n),t.scheduled=void 0)},t}(Be),Et=new(function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return te(t,e),t.prototype.flush=function(e){this.active=!0,this.scheduled=void 0;var t,n=this.actions,r=-1,i=n.length;e=e||n.shift();do{if(t=e.execute(e.state,e.delay))break}while(++r<i&&(e=n.shift()));if(this.active=!1,t){for(;++r<i&&(e=n.shift());)e.unsubscribe();throw t}},t}(Ge))(wt),Ot=Et,St=function(e){function t(t,n){void 0===t&&(t=Tt),void 0===n&&(n=Number.POSITIVE_INFINITY);var r=e.call(this,t,(function(){return r.frame}))||this;return r.maxFrames=n,r.frame=0,r.index=-1,r}return te(t,e),t.prototype.flush=function(){for(var e,t,n=this.actions,r=this.maxFrames;(t=n[0])&&t.delay<=r&&(n.shift(),this.frame=t.delay,!(e=t.execute(t.state,t.delay))););if(e){for(;t=n.shift();)t.unsubscribe();throw e}},t.frameTimeFactor=10,t}(Ge),Tt=function(e){function t(t,n,r){void 0===r&&(r=t.index+=1);var i=e.call(this,t,n)||this;return i.scheduler=t,i.work=n,i.index=r,i.active=!0,i.index=t.index=r,i}return te(t,e),t.prototype.schedule=function(n,r){if(void 0===r&&(r=0),!this.id)return e.prototype.schedule.call(this,n,r);this.active=!1;var i=new t(this.scheduler,this.work);return this.add(i),i.schedule(n,r)},t.prototype.requestAsyncId=function(e,n,r){void 0===r&&(r=0),this.delay=e.frame+r;var i=e.actions;return i.push(this),i.sort(t.sortActions),!0},t.prototype.recycleAsyncId=function(e,t,n){},t.prototype._execute=function(t,n){if(!0===this.active)return e.prototype._execute.call(this,t,n)},t.sortActions=function(e,t){return e.delay===t.delay?e.index===t.index?0:e.index>t.index?1:-1:e.delay>t.delay?1:-1},t}(Be);function kt(){}var At=function(){function e(){return Error.call(this),this.message="argument out of range",this.name="ArgumentOutOfRangeError",this}return e.prototype=Object.create(Error.prototype),e}(),xt=function(){function e(){return Error.call(this),this.message="no elements in sequence",this.name="EmptyError",this}return e.prototype=Object.create(Error.prototype),e}(),It=function(){function e(){return Error.call(this),this.message="Timeout has occurred",this.name="TimeoutError",this}return e.prototype=Object.create(Error.prototype),e}();function Nt(e,t){return function(n){if("function"!=typeof e)throw new TypeError("argument is not a function. Are you looking for `mapTo()`?");return n.lift(new Mt(e,t))}}var Mt=function(){function e(e,t){this.project=e,this.thisArg=t}return e.prototype.call=function(e,t){return t.subscribe(new Rt(e,this.project,this.thisArg))},e}(),Rt=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.project=n,i.count=0,i.thisArg=r||i,i}return te(t,e),t.prototype._next=function(e){var t;try{t=this.project.call(this.thisArg,e,this.count++)}catch(e){return void this.destination.error(e)}this.destination.next(t)},t}(he);function Ct(e){var t=this,n=e.args,r=e.subscriber,i=e.params,o=i.callbackFunc,s=i.context,a=i.scheduler,u=i.subject;if(!u){u=i.subject=new lt;try{o.apply(s,n.concat([function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var r=e.length<=1?e[0]:e;t.add(a.schedule(Pt,0,{value:r,subject:u}))}]))}catch(e){u.error(e)}}this.add(u.subscribe(r))}function Pt(e){var t=e.value,n=e.subject;n.next(t),n.complete()}function jt(e){var t=this,n=e.params,r=e.subscriber,i=e.context,o=n.callbackFunc,s=n.args,a=n.scheduler,u=n.subject;if(!u){u=n.subject=new lt;try{o.apply(i,s.concat([function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var r=e.shift();if(r)t.add(a.schedule(qt,0,{err:r,subject:u}));else{var i=e.length<=1?e[0]:e;t.add(a.schedule(Lt,0,{value:i,subject:u}))}}]))}catch(e){this.add(a.schedule(qt,0,{err:e,subject:u}))}}this.add(u.subscribe(r))}function Lt(e){var t=e.value,n=e.subject;n.next(t),n.complete()}function qt(e){var t=e.err;e.subject.error(t)}var Ut=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return te(t,e),t.prototype.notifyNext=function(e,t,n,r,i){this.destination.next(t)},t.prototype.notifyError=function(e,t){this.destination.error(e)},t.prototype.notifyComplete=function(e){this.destination.complete()},t}(he),Dt=function(e){function t(t,n,r){var i=e.call(this)||this;return i.parent=t,i.outerValue=n,i.outerIndex=r,i.index=0,i}return te(t,e),t.prototype._next=function(e){this.parent.notifyNext(this.outerValue,e,this.outerIndex,this.index++,this)},t.prototype._error=function(e){this.parent.notifyError(e,this),this.unsubscribe()},t.prototype._complete=function(){this.parent.notifyComplete(this),this.unsubscribe()},t}(he),Vt=function(e){return function(t){return e.then((function(e){t.closed||(t.next(e),t.complete())}),(function(e){return t.error(e)})).then(null,se),t}};function Ft(){return"function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator"}var Bt=Ft(),Ht=function(e){return function(t){for(var n=e[Bt]();;){var r=void 0;try{r=n.next()}catch(e){return t.error(e),t}if(r.done){t.complete();break}if(t.next(r.value),t.closed)break}return"function"==typeof n.return&&t.add((function(){n.return&&n.return()})),t}},Wt=function(e){return function(t){var n=e[ge]();if("function"!=typeof n.subscribe)throw new TypeError("Provided object does not correctly implement Symbol.observable");return n.subscribe(t)}},Gt=function(e){return e&&"number"==typeof e.length&&"function"!=typeof e};function zt(e){return!!e&&"function"!=typeof e.subscribe&&"function"==typeof e.then}var Jt=function(e){if(e&&"function"==typeof e[ge])return Wt(e);if(Gt(e))return $e(e);if(zt(e))return Vt(e);if(e&&"function"==typeof e[Bt])return Ht(e);var t=ce(e)?"an invalid object":"'"+e+"'";throw new TypeError("You provided "+t+" where a stream was expected. You can provide an Observable, Promise, Array, or Iterable.")};function Yt(e,t,n,r,i){if(void 0===i&&(i=new Dt(e,n,r)),!i.closed)return t instanceof Ee?t.subscribe(i):Jt(t)(i)}var Qt={};var Kt=function(){function e(e){this.resultSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new Xt(e,this.resultSelector))},e}(),Xt=function(e){function t(t,n){var r=e.call(this,t)||this;return r.resultSelector=n,r.active=0,r.values=[],r.observables=[],r}return te(t,e),t.prototype._next=function(e){this.values.push(Qt),this.observables.push(e)},t.prototype._complete=function(){var e=this.observables,t=e.length;if(0===t)this.destination.complete();else{this.active=t,this.toRespond=t;for(var n=0;n<t;n++){var r=e[n];this.add(Yt(this,r,void 0,n))}}},t.prototype.notifyComplete=function(e){0==(this.active-=1)&&this.destination.complete()},t.prototype.notifyNext=function(e,t,n){var r=this.values,i=r[n],o=this.toRespond?i===Qt?--this.toRespond:this.toRespond:0;r[n]=t,0===o&&(this.resultSelector?this._tryResultSelector(r):this.destination.next(r.slice()))},t.prototype._tryResultSelector=function(e){var t;try{t=this.resultSelector.apply(this,e)}catch(e){return void this.destination.error(e)}this.destination.next(t)},t}(Ut);function $t(e,t){return new Ee((function(n){var r=new fe;return r.add(t.schedule((function(){return e.then((function(e){r.add(t.schedule((function(){n.next(e),r.add(t.schedule((function(){return n.complete()})))})))}),(function(e){r.add(t.schedule((function(){return n.error(e)})))}))}))),r}))}function Zt(e,t){if(!e)throw new Error("Iterable cannot be null");return new Ee((function(n){var r,i=new fe;return i.add((function(){r&&"function"==typeof r.return&&r.return()})),i.add(t.schedule((function(){r=e[Bt](),i.add(t.schedule((function(){if(!n.closed){var e,t;try{var i=r.next();e=i.value,t=i.done}catch(e){return void n.error(e)}t?n.complete():(n.next(e),this.schedule())}})))}))),i}))}function en(e){return e&&"function"==typeof e[ge]}function tn(e){return e&&"function"==typeof e[Bt]}function nn(e,t){if(null!=e){if(en(e))return function(e,t){return new Ee((function(n){var r=new fe;return r.add(t.schedule((function(){var i=e[ge]();r.add(i.subscribe({next:function(e){r.add(t.schedule((function(){return n.next(e)})))},error:function(e){r.add(t.schedule((function(){return n.error(e)})))},complete:function(){r.add(t.schedule((function(){return n.complete()})))}}))}))),r}))}(e,t);if(zt(e))return $t(e,t);if(Gt(e))return Ze(e,t);if(tn(e)||"string"==typeof e)return Zt(e,t)}throw new TypeError((null!==e&&o(e)||e)+" is not observable")}function rn(e,t){return t?nn(e,t):e instanceof Ee?e:new Ee(Jt(e))}var on=function(e){function t(t){var n=e.call(this)||this;return n.parent=t,n}return te(t,e),t.prototype._next=function(e){this.parent.notifyNext(e)},t.prototype._error=function(e){this.parent.notifyError(e),this.unsubscribe()},t.prototype._complete=function(){this.parent.notifyComplete(),this.unsubscribe()},t}(he),sn=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return te(t,e),t.prototype.notifyNext=function(e){this.destination.next(e)},t.prototype.notifyError=function(e){this.destination.error(e)},t.prototype.notifyComplete=function(){this.destination.complete()},t}(he);function an(e,t){if(!t.closed){if(e instanceof Ee)return e.subscribe(t);var n;try{n=Jt(e)(t)}catch(e){t.error(e)}return n}}function un(e,t,n){return void 0===n&&(n=Number.POSITIVE_INFINITY),"function"==typeof t?function(r){return r.pipe(un((function(n,r){return rn(e(n,r)).pipe(Nt((function(e,i){return t(n,e,r,i)})))}),n))}:("number"==typeof t&&(n=t),function(t){return t.lift(new cn(e,n))})}var cn=function(){function e(e,t){void 0===t&&(t=Number.POSITIVE_INFINITY),this.project=e,this.concurrent=t}return e.prototype.call=function(e,t){return t.subscribe(new ln(e,this.project,this.concurrent))},e}(),ln=function(e){function t(t,n,r){void 0===r&&(r=Number.POSITIVE_INFINITY);var i=e.call(this,t)||this;return i.project=n,i.concurrent=r,i.hasCompleted=!1,i.buffer=[],i.active=0,i.index=0,i}return te(t,e),t.prototype._next=function(e){this.active<this.concurrent?this._tryNext(e):this.buffer.push(e)},t.prototype._tryNext=function(e){var t,n=this.index++;try{t=this.project(e,n)}catch(e){return void this.destination.error(e)}this.active++,this._innerSub(t)},t.prototype._innerSub=function(e){var t=new on(this),n=this.destination;n.add(t);var r=an(e,t);r!==t&&n.add(r)},t.prototype._complete=function(){this.hasCompleted=!0,0===this.active&&0===this.buffer.length&&this.destination.complete(),this.unsubscribe()},t.prototype.notifyNext=function(e){this.destination.next(e)},t.prototype.notifyComplete=function(){var e=this.buffer;this.active--,e.length>0?this._next(e.shift()):0===this.active&&this.hasCompleted&&this.destination.complete()},t}(sn),fn=un;function pn(e){return void 0===e&&(e=Number.POSITIVE_INFINITY),un(ye,e)}function dn(){return pn(1)}function hn(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return dn()(tt.apply(void 0,e))}function vn(e){return new Ee((function(t){var n;try{n=e()}catch(e){return void t.error(e)}return(n?rn(n):Qe()).subscribe(t)}))}function bn(e,t){return new Ee((function(n){var r=e.length;if(0!==r)for(var i=new Array(r),o=0,s=0,a=function(a){var u=rn(e[a]),c=!1;n.add(u.subscribe({next:function(e){c||(c=!0,s++),i[a]=e},error:function(e){return n.error(e)},complete:function(){++o!==r&&c||(s===r&&n.next(t?t.reduce((function(e,t,n){return e[t]=i[n],e}),{}):i),n.complete())}}))},u=0;u<r;u++)a(u);else n.complete()}))}function mn(e,t,n,r,i){var o;if(function(e){return e&&"function"==typeof e.addEventListener&&"function"==typeof e.removeEventListener}(e)){var s=e;e.addEventListener(t,n,i),o=function(){return s.removeEventListener(t,n,i)}}else if(function(e){return e&&"function"==typeof e.on&&"function"==typeof e.off}(e)){var a=e;e.on(t,n),o=function(){return a.off(t,n)}}else if(function(e){return e&&"function"==typeof e.addListener&&"function"==typeof e.removeListener}(e)){var u=e;e.addListener(t,n),o=function(){return u.removeListener(t,n)}}else{if(!e||!e.length)throw new TypeError("Invalid event target");for(var c=0,l=e.length;c<l;c++)mn(e[c],t,n,r,i)}r.add(o)}function gn(e){var t=e.subscriber,n=e.condition;if(!t.closed){if(e.needIterate)try{e.state=e.iterate(e.state)}catch(e){return void t.error(e)}else e.needIterate=!0;if(n){var r=void 0;try{r=n(e.state)}catch(e){return void t.error(e)}if(!r)return void t.complete();if(t.closed)return}var i;try{i=e.resultSelector(e.state)}catch(e){return void t.error(e)}if(!t.closed&&(t.next(i),!t.closed))return this.schedule(e)}}function yn(e){return!ue(e)&&e-parseFloat(e)+1>=0}function _n(e){var t=e.subscriber,n=e.counter,r=e.period;t.next(n),this.schedule({subscriber:t,counter:n+1,period:r},r)}function wn(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=Number.POSITIVE_INFINITY,r=null,i=e[e.length-1];return Ke(i)?(r=e.pop(),e.length>1&&"number"==typeof e[e.length-1]&&(n=e.pop())):"number"==typeof i&&(n=e.pop()),null===r&&1===e.length&&e[0]instanceof Ee?e[0]:pn(n)(et(e,r))}var En=new Ee(kt);function On(e){var t=e.keys,n=e.index,r=e.subscriber,i=e.subscription,o=e.obj;if(!r.closed)if(n<t.length){var s=t[n];r.next([s,o[s]]),i.add(this.schedule({keys:t,index:n+1,subscriber:r,subscription:i,obj:o}))}else r.complete()}function Sn(e,t){function n(){return!n.pred.apply(n.thisArg,arguments)}return n.pred=e,n.thisArg=t,n}function Tn(e,t){return function(n){return n.lift(new kn(e,t))}}var kn=function(){function e(e,t){this.predicate=e,this.thisArg=t}return e.prototype.call=function(e,t){return t.subscribe(new An(e,this.predicate,this.thisArg))},e}(),An=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.predicate=n,i.thisArg=r,i.count=0,i}return te(t,e),t.prototype._next=function(e){var t;try{t=this.predicate.call(this.thisArg,e,this.count++)}catch(e){return void this.destination.error(e)}t&&this.destination.next(e)},t}(he);function xn(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length){if(!ue(e[0]))return e[0];e=e[0]}return et(e,void 0).lift(new In)}var In=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new Nn(e))},e}(),Nn=function(e){function t(t){var n=e.call(this,t)||this;return n.hasFirst=!1,n.observables=[],n.subscriptions=[],n}return te(t,e),t.prototype._next=function(e){this.observables.push(e)},t.prototype._complete=function(){var e=this.observables,t=e.length;if(0===t)this.destination.complete();else{for(var n=0;n<t&&!this.hasFirst;n++){var r=Yt(this,e[n],void 0,n);this.subscriptions&&this.subscriptions.push(r),this.add(r)}this.observables=null}},t.prototype.notifyNext=function(e,t,n){if(!this.hasFirst){this.hasFirst=!0;for(var r=0;r<this.subscriptions.length;r++)if(r!==n){var i=this.subscriptions[r];i.unsubscribe(),this.remove(i)}this.subscriptions=null}this.destination.next(t)},t}(Ut);function Mn(e){var t=e.start,n=e.index,r=e.count,i=e.subscriber;n>=r?i.complete():(i.next(t),i.closed||(e.index=n+1,e.start=t+1,this.schedule(e)))}function Rn(e,t,n){void 0===e&&(e=0);var r=-1;return yn(t)?r=Number(t)<1?1:Number(t):Ke(t)&&(n=t),Ke(n)||(n=_t),new Ee((function(t){var i=yn(e)?e:+e-n.now();return n.schedule(Cn,i,{index:0,period:r,subscriber:t})}))}function Cn(e){var t=e.index,n=e.period,r=e.subscriber;if(r.next(t),!r.closed){if(-1===n)return r.complete();e.index=t+1,this.schedule(e,n)}}function Pn(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=e[e.length-1];return"function"==typeof n&&e.pop(),et(e,void 0).lift(new jn(n))}var jn=function(){function e(e){this.resultSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new Ln(e,this.resultSelector))},e}(),Ln=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.resultSelector=n,i.iterators=[],i.active=0,i.resultSelector="function"==typeof n?n:void 0,i}return te(t,e),t.prototype._next=function(e){var t=this.iterators;ue(e)?t.push(new Un(e)):"function"==typeof e[Bt]?t.push(new qn(e[Bt]())):t.push(new Dn(this.destination,this,e))},t.prototype._complete=function(){var e=this.iterators,t=e.length;if(this.unsubscribe(),0!==t){this.active=t;for(var n=0;n<t;n++){var r=e[n];if(r.stillUnsubscribed)this.destination.add(r.subscribe());else this.active--}}else this.destination.complete()},t.prototype.notifyInactive=function(){this.active--,0===this.active&&this.destination.complete()},t.prototype.checkIterators=function(){for(var e=this.iterators,t=e.length,n=this.destination,r=0;r<t;r++){if("function"==typeof(s=e[r]).hasValue&&!s.hasValue())return}var i=!1,o=[];for(r=0;r<t;r++){var s,a=(s=e[r]).next();if(s.hasCompleted()&&(i=!0),a.done)return void n.complete();o.push(a.value)}this.resultSelector?this._tryresultSelector(o):n.next(o),i&&n.complete()},t.prototype._tryresultSelector=function(e){var t;try{t=this.resultSelector.apply(this,e)}catch(e){return void this.destination.error(e)}this.destination.next(t)},t}(he),qn=function(){function e(e){this.iterator=e,this.nextResult=e.next()}return e.prototype.hasValue=function(){return!0},e.prototype.next=function(){var e=this.nextResult;return this.nextResult=this.iterator.next(),e},e.prototype.hasCompleted=function(){var e=this.nextResult;return Boolean(e&&e.done)},e}(),Un=function(){function e(e){this.array=e,this.index=0,this.length=0,this.length=e.length}return e.prototype[Bt]=function(){return this},e.prototype.next=function(e){var t=this.index++,n=this.array;return t<this.length?{value:n[t],done:!1}:{value:null,done:!0}},e.prototype.hasValue=function(){return this.array.length>this.index},e.prototype.hasCompleted=function(){return this.array.length===this.index},e}(),Dn=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.parent=n,i.observable=r,i.stillUnsubscribed=!0,i.buffer=[],i.isComplete=!1,i}return te(t,e),t.prototype[Bt]=function(){return this},t.prototype.next=function(){var e=this.buffer;return 0===e.length&&this.isComplete?{value:null,done:!0}:{value:e.shift(),done:!1}},t.prototype.hasValue=function(){return this.buffer.length>0},t.prototype.hasCompleted=function(){return 0===this.buffer.length&&this.isComplete},t.prototype.notifyComplete=function(){this.buffer.length>0?(this.isComplete=!0,this.parent.notifyInactive()):this.destination.complete()},t.prototype.notifyNext=function(e){this.buffer.push(e),this.parent.checkIterators()},t.prototype.subscribe=function(){return an(this.observable,new on(this))},t}(sn),Vn=Object.freeze({__proto__:null,Observable:Ee,ConnectableObservable:Re,GroupedObservable:De,observable:ge,Subject:Ae,BehaviorSubject:Fe,ReplaySubject:ut,AsyncSubject:lt,asap:gt,asapScheduler:mt,async:_t,asyncScheduler:yt,queue:Je,queueScheduler:ze,animationFrame:Ot,animationFrameScheduler:Et,VirtualTimeScheduler:St,VirtualAction:Tt,Scheduler:We,Subscription:fe,Subscriber:he,Notification:it,get NotificationKind(){return Xe},pipe:_e,noop:kt,identity:ye,isObservable:function(e){return!!e&&(e instanceof Ee||"function"==typeof e.lift&&"function"==typeof e.subscribe)},ArgumentOutOfRangeError:At,EmptyError:xt,ObjectUnsubscribedError:Se,UnsubscriptionError:le,TimeoutError:It,bindCallback:function e(t,n,r){if(n){if(!Ke(n))return function(){for(var i=[],o=0;o<arguments.length;o++)i[o]=arguments[o];return e(t,r).apply(void 0,i).pipe(Nt((function(e){return ue(e)?n.apply(void 0,e):n(e)})))};r=n}return function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var i,o=this,s={context:o,subject:i,callbackFunc:t,scheduler:r};return new Ee((function(n){if(r){var a={args:e,subscriber:n,params:s};return r.schedule(Ct,0,a)}if(!i){i=new lt;try{t.apply(o,e.concat([function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];i.next(e.length<=1?e[0]:e),i.complete()}]))}catch(e){be(i)?i.error(e):console.warn(e)}}return i.subscribe(n)}))}},bindNodeCallback:function e(t,n,r){if(n){if(!Ke(n))return function(){for(var i=[],o=0;o<arguments.length;o++)i[o]=arguments[o];return e(t,r).apply(void 0,i).pipe(Nt((function(e){return ue(e)?n.apply(void 0,e):n(e)})))};r=n}return function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var i={subject:void 0,args:e,callbackFunc:t,scheduler:r,context:this};return new Ee((function(n){var o=i.context,s=i.subject;if(r)return r.schedule(jt,0,{params:i,subscriber:n,context:o});if(!s){s=i.subject=new lt;try{t.apply(o,e.concat([function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=e.shift();n?s.error(n):(s.next(e.length<=1?e[0]:e),s.complete())}]))}catch(e){be(s)?s.error(e):console.warn(e)}}return s.subscribe(n)}))}},combineLatest:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=void 0,r=void 0;return Ke(e[e.length-1])&&(r=e.pop()),"function"==typeof e[e.length-1]&&(n=e.pop()),1===e.length&&ue(e[0])&&(e=e[0]),et(e,r).lift(new Kt(n))},concat:hn,defer:vn,empty:Qe,forkJoin:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length){var n=e[0];if(ue(n))return bn(n,null);if(ce(n)&&Object.getPrototypeOf(n)===Object.prototype){var r=Object.keys(n);return bn(r.map((function(e){return n[e]})),r)}}if("function"==typeof e[e.length-1]){var i=e.pop();return bn(e=1===e.length&&ue(e[0])?e[0]:e,null).pipe(Nt((function(e){return i.apply(void 0,e)})))}return bn(e,null)},from:rn,fromEvent:function e(t,n,r,i){return re(r)&&(i=r,r=void 0),i?e(t,n,r).pipe(Nt((function(e){return ue(e)?i.apply(void 0,e):i(e)}))):new Ee((function(e){mn(t,n,(function(t){arguments.length>1?e.next(Array.prototype.slice.call(arguments)):e.next(t)}),e,r)}))},fromEventPattern:function e(t,n,r){return r?e(t,n).pipe(Nt((function(e){return ue(e)?r.apply(void 0,e):r(e)}))):new Ee((function(e){var r,i=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return e.next(1===t.length?t[0]:t)};try{r=t(i)}catch(t){return void e.error(t)}if(re(n))return function(){return n(i,r)}}))},generate:function(e,t,n,r,i){var o,s;if(1==arguments.length){var a=e;s=a.initialState,t=a.condition,n=a.iterate,o=a.resultSelector||ye,i=a.scheduler}else void 0===r||Ke(r)?(s=e,o=ye,i=r):(s=e,o=r);return new Ee((function(e){var r=s;if(i)return i.schedule(gn,0,{subscriber:e,iterate:n,condition:t,resultSelector:o,state:r});for(;;){if(t){var a=void 0;try{a=t(r)}catch(t){return void e.error(t)}if(!a){e.complete();break}}var u=void 0;try{u=o(r)}catch(t){return void e.error(t)}if(e.next(u),e.closed)break;try{r=n(r)}catch(t){return void e.error(t)}}}))},iif:function(e,t,n){return void 0===t&&(t=Ye),void 0===n&&(n=Ye),vn((function(){return e()?t:n}))},interval:function(e,t){return void 0===e&&(e=0),void 0===t&&(t=_t),(!yn(e)||e<0)&&(e=0),t&&"function"==typeof t.schedule||(t=_t),new Ee((function(n){return n.add(t.schedule(_n,e,{subscriber:n,counter:0,period:e})),n}))},merge:wn,never:function(){return En},of:tt,onErrorResumeNext:function e(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];if(0===t.length)return Ye;var r=t[0],i=t.slice(1);return 1===t.length&&ue(r)?e.apply(void 0,r):new Ee((function(t){var n=function(){return t.add(e.apply(void 0,i).subscribe(t))};return rn(r).subscribe({next:function(e){t.next(e)},error:n,complete:n})}))},pairs:function(e,t){return new Ee(t?function(n){var r=Object.keys(e),i=new fe;return i.add(t.schedule(On,0,{keys:r,index:0,subscriber:n,subscription:i,obj:e})),i}:function(t){for(var n=Object.keys(e),r=0;r<n.length&&!t.closed;r++){var i=n[r];e.hasOwnProperty(i)&&t.next([i,e[i]])}t.complete()})},partition:function(e,t,n){return[Tn(t,n)(new Ee(Jt(e))),Tn(Sn(t,n))(new Ee(Jt(e)))]},race:xn,range:function(e,t,n){return void 0===e&&(e=0),new Ee((function(r){void 0===t&&(t=e,e=0);var i=0,o=e;if(n)return n.schedule(Mn,0,{index:i,count:t,start:e,subscriber:r});for(;;){if(i++>=t){r.complete();break}if(r.next(o++),r.closed)break}}))},throwError:nt,timer:Rn,using:function(e,t){return new Ee((function(n){var r,i;try{r=e()}catch(e){return void n.error(e)}try{i=t(r)}catch(e){return void n.error(e)}var o=(i?rn(i):Ye).subscribe(n);return function(){o.unsubscribe(),r&&r.unsubscribe()}}))},zip:Pn,scheduled:nn,EMPTY:Ye,NEVER:En,config:oe});var Fn="undefined"!=typeof window&&window,Bn="undefined"!=typeof self&&"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&self,Hn="undefined"!=typeof global&&global,Wn=Fn||Hn||Bn;function Gn(e,t){return void 0===t&&(t=null),new $n({method:"GET",url:e,headers:t})}function zn(e,t,n){return new $n({method:"POST",url:e,body:t,headers:n})}function Jn(e,t){return new $n({method:"DELETE",url:e,headers:t})}function Yn(e,t,n){return new $n({method:"PUT",url:e,body:t,headers:n})}function Qn(e,t,n){return new $n({method:"PATCH",url:e,body:t,headers:n})}var Kn=Nt((function(e,t){return e.response}));function Xn(e,t){return Kn(new $n({method:"GET",url:e,responseType:"json",headers:t}))}var $n=function(e){function t(t){var n=e.call(this)||this,r={async:!0,createXHR:function(){return this.crossDomain?function(){if(Wn.XMLHttpRequest)return new Wn.XMLHttpRequest;if(Wn.XDomainRequest)return new Wn.XDomainRequest;throw new Error("CORS is not supported by your browser")}():function(){if(Wn.XMLHttpRequest)return new Wn.XMLHttpRequest;var e=void 0;try{for(var t=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],n=0;n<3;n++)try{if(e=t[n],new Wn.ActiveXObject(e))break}catch(e){}return new Wn.ActiveXObject(e)}catch(e){throw new Error("XMLHttpRequest is not supported by your browser")}}()},crossDomain:!0,withCredentials:!1,headers:{},method:"GET",responseType:"json",timeout:0};if("string"==typeof t)r.url=t;else for(var i in t)t.hasOwnProperty(i)&&(r[i]=t[i]);return n.request=r,n}return te(t,e),t.prototype._subscribe=function(e){return new Zn(e,this.request)},t.create=function(){var e=function(e){return new t(e)};return e.get=Gn,e.post=zn,e.delete=Jn,e.put=Yn,e.patch=Qn,e.getJSON=Xn,e}(),t}(Ee),Zn=function(e){function t(t,n){var r=e.call(this,t)||this;r.request=n,r.done=!1;var i=n.headers=n.headers||{};return n.crossDomain||r.getHeader(i,"X-Requested-With")||(i["X-Requested-With"]="XMLHttpRequest"),r.getHeader(i,"Content-Type")||Wn.FormData&&n.body instanceof Wn.FormData||void 0===n.body||(i["Content-Type"]="application/x-www-form-urlencoded; charset=UTF-8"),n.body=r.serializeBody(n.body,r.getHeader(n.headers,"Content-Type")),r.send(),r}return te(t,e),t.prototype.next=function(e){this.done=!0;var t,n=this,r=n.xhr,i=n.request,o=n.destination;try{t=new er(e,r,i)}catch(e){return o.error(e)}o.next(t)},t.prototype.send=function(){var e=this.request,t=this.request,n=t.user,r=t.method,i=t.url,o=t.async,s=t.password,a=t.headers,u=t.body;try{var c=this.xhr=e.createXHR();this.setupEvents(c,e),n?c.open(r,i,o,n,s):c.open(r,i,o),o&&(c.timeout=e.timeout,c.responseType=e.responseType),"withCredentials"in c&&(c.withCredentials=!!e.withCredentials),this.setHeaders(c,a),u?c.send(u):c.send()}catch(e){this.error(e)}},t.prototype.serializeBody=function(e,t){if(!e||"string"==typeof e)return e;if(Wn.FormData&&e instanceof Wn.FormData)return e;if(t){var n=t.indexOf(";");-1!==n&&(t=t.substring(0,n))}switch(t){case"application/x-www-form-urlencoded":return Object.keys(e).map((function(t){return encodeURIComponent(t)+"="+encodeURIComponent(e[t])})).join("&");case"application/json":return JSON.stringify(e);default:return e}},t.prototype.setHeaders=function(e,t){for(var n in t)t.hasOwnProperty(n)&&e.setRequestHeader(n,t[n])},t.prototype.getHeader=function(e,t){for(var n in e)if(n.toLowerCase()===t.toLowerCase())return e[n]},t.prototype.setupEvents=function(e,t){var n=t.progressSubscriber;function r(e){var t,n=r,i=n.subscriber,o=n.progressSubscriber,s=n.request;o&&o.error(e);try{t=new rr(this,s)}catch(e){t=e}i.error(t)}if(e.ontimeout=r,r.request=t,r.subscriber=this,r.progressSubscriber=n,e.upload&&"withCredentials"in e){var i,o;if(n)i=function(e){i.progressSubscriber.next(e)},Wn.XDomainRequest?e.onprogress=i:e.upload.onprogress=i,i.progressSubscriber=n;o=function(e){var t,n=o,r=n.progressSubscriber,i=n.subscriber,s=n.request;r&&r.error(e);try{t=new tr("ajax error",this,s)}catch(e){t=e}i.error(t)},e.onerror=o,o.request=t,o.subscriber=this,o.progressSubscriber=n}function s(e){}function a(e){var t=a,n=t.subscriber,r=t.progressSubscriber,i=t.request;if(4===this.readyState){var o=1223===this.status?204:this.status,s="text"===this.responseType?this.response||this.responseText:this.response;if(0===o&&(o=s?200:0),o<400)r&&r.complete(),n.next(e),n.complete();else{r&&r.error(e);var u=void 0;try{u=new tr("ajax error "+o,this,i)}catch(e){u=e}n.error(u)}}}e.onreadystatechange=s,s.subscriber=this,s.progressSubscriber=n,s.request=t,e.onload=a,a.subscriber=this,a.progressSubscriber=n,a.request=t},t.prototype.unsubscribe=function(){var t=this.done,n=this.xhr;!t&&n&&4!==n.readyState&&"function"==typeof n.abort&&n.abort(),e.prototype.unsubscribe.call(this)},t}(he),er=function(){return function(e,t,n){this.originalEvent=e,this.xhr=t,this.request=n,this.status=t.status,this.responseType=t.responseType||n.responseType,this.response=nr(this.responseType,t)}}(),tr=function(){function e(e,t,n){return Error.call(this),this.message=e,this.name="AjaxError",this.xhr=t,this.request=n,this.status=t.status,this.responseType=t.responseType||n.responseType,this.response=nr(this.responseType,t),this}return e.prototype=Object.create(Error.prototype),e}();function nr(e,t){switch(e){case"json":return function(e){return"response"in e?e.responseType?e.response:JSON.parse(e.response||e.responseText||"null"):JSON.parse(e.responseText||"null")}(t);case"xml":return t.responseXML;case"text":default:return"response"in t?t.response:t.responseText}}var rr=function(e,t){return tr.call(this,"ajax timeout",e,t),this.name="AjaxTimeoutError",this},ir=function(){return $n.create}(),or={url:"",deserializer:function(e){return JSON.parse(e.data)},serializer:function(e){return JSON.stringify(e)}},sr=function(e){function t(t,n){var r=e.call(this)||this;if(t instanceof Ee)r.destination=n,r.source=t;else{var i=r._config=ne({},or);if(r._output=new Ae,"string"==typeof t)i.url=t;else for(var o in t)t.hasOwnProperty(o)&&(i[o]=t[o]);if(!i.WebSocketCtor&&WebSocket)i.WebSocketCtor=WebSocket;else if(!i.WebSocketCtor)throw new Error("no WebSocket constructor can be found");r.destination=new ut}return r}return te(t,e),t.prototype.lift=function(e){var n=new t(this._config,this.destination);return n.operator=e,n.source=this,n},t.prototype._resetState=function(){this._socket=null,this.source||(this.destination=new ut),this._output=new Ae},t.prototype.multiplex=function(e,t,n){var r=this;return new Ee((function(i){try{r.next(e())}catch(e){i.error(e)}var o=r.subscribe((function(e){try{n(e)&&i.next(e)}catch(e){i.error(e)}}),(function(e){return i.error(e)}),(function(){return i.complete()}));return function(){try{r.next(t())}catch(e){i.error(e)}o.unsubscribe()}}))},t.prototype._connectSocket=function(){var e=this,t=this._config,n=t.WebSocketCtor,r=t.protocol,i=t.url,o=t.binaryType,s=this._output,a=null;try{a=r?new n(i,r):new n(i),this._socket=a,o&&(this._socket.binaryType=o)}catch(e){return void s.error(e)}var u=new fe((function(){e._socket=null,a&&1===a.readyState&&a.close()}));a.onopen=function(t){if(!e._socket)return a.close(),void e._resetState();var n=e._config.openObserver;n&&n.next(t);var r=e.destination;e.destination=he.create((function(t){if(1===a.readyState)try{var n=e._config.serializer;a.send(n(t))}catch(t){e.destination.error(t)}}),(function(t){var n=e._config.closingObserver;n&&n.next(void 0),t&&t.code?a.close(t.code,t.reason):s.error(new TypeError("WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }")),e._resetState()}),(function(){var t=e._config.closingObserver;t&&t.next(void 0),a.close(),e._resetState()})),r&&r instanceof ut&&u.add(r.subscribe(e.destination))},a.onerror=function(t){e._resetState(),s.error(t)},a.onclose=function(t){e._resetState();var n=e._config.closeObserver;n&&n.next(t),t.wasClean?s.complete():s.error(t)},a.onmessage=function(t){try{var n=e._config.deserializer;s.next(n(t))}catch(e){s.error(e)}}},t.prototype._subscribe=function(e){var t=this,n=this.source;return n?n.subscribe(e):(this._socket||this._connectSocket(),this._output.subscribe(e),e.add((function(){var e=t._socket;0===t._output.observers.length&&(e&&1===e.readyState&&e.close(),t._resetState())})),e)},t.prototype.unsubscribe=function(){var t=this._socket;t&&1===t.readyState&&t.close(),this._resetState(),e.prototype.unsubscribe.call(this)},t}(xe);function ar(e){return new sr(e)}var ur=function(e){function t(t,n,r){void 0===n&&(n=0),void 0===r&&(r=gt);var i=e.call(this)||this;return i.source=t,i.delayTime=n,i.scheduler=r,(!yn(n)||n<0)&&(i.delayTime=0),r&&"function"==typeof r.schedule||(i.scheduler=gt),i}return te(t,e),t.create=function(e,n,r){return void 0===n&&(n=0),void 0===r&&(r=gt),new t(e,n,r)},t.dispatch=function(e){var t=e.source,n=e.subscriber;return this.add(t.subscribe(n))},t.prototype._subscribe=function(e){var n=this.delayTime,r=this.source;return this.scheduler.schedule(t.dispatch,n,{source:r,subscriber:e})},t}(Ee);var cr=function(){return function(e,t){this.value=e,this.timestamp=t}}();function lr(e,t){var n=!1;return arguments.length>=2&&(n=!0),function(r){return r.lift(new fr(e,t,n))}}var fr=function(){function e(e,t,n){void 0===n&&(n=!1),this.accumulator=e,this.seed=t,this.hasSeed=n}return e.prototype.call=function(e,t){return t.subscribe(new pr(e,this.accumulator,this.seed,this.hasSeed))},e}(),pr=function(e){function t(t,n,r,i){var o=e.call(this,t)||this;return o.accumulator=n,o._seed=r,o.hasSeed=i,o.index=0,o}return te(t,e),Object.defineProperty(t.prototype,"seed",{get:function(){return this._seed},set:function(e){this.hasSeed=!0,this._seed=e},enumerable:!0,configurable:!0}),t.prototype._next=function(e){if(this.hasSeed)return this._tryNext(e);this.seed=e,this.destination.next(e)},t.prototype._tryNext=function(e){var t,n=this.index++;try{t=this.accumulator(this.seed,e,n)}catch(e){this.destination.error(e)}this.seed=t,this.destination.next(t)},t}(he);var dr=function(){return function(e,t){this.value=e,this.interval=t}}(),hr={leading:!0,trailing:!1};var vr=function(){function e(e,t,n){this.durationSelector=e,this.leading=t,this.trailing=n}return e.prototype.call=function(e,t){return t.subscribe(new br(e,this.durationSelector,this.leading,this.trailing))},e}(),br=function(e){function t(t,n,r,i){var o=e.call(this,t)||this;return o.destination=t,o.durationSelector=n,o._leading=r,o._trailing=i,o._hasValue=!1,o}return te(t,e),t.prototype._next=function(e){this._hasValue=!0,this._sendValue=e,this._throttled||(this._leading?this.send():this.throttle(e))},t.prototype.send=function(){var e=this._hasValue,t=this._sendValue;e&&(this.destination.next(t),this.throttle(t)),this._hasValue=!1,this._sendValue=void 0},t.prototype.throttle=function(e){var t=this.tryDurationSelector(e);t&&this.add(this._throttled=an(t,new on(this)))},t.prototype.tryDurationSelector=function(e){try{return this.durationSelector(e)}catch(e){return this.destination.error(e),null}},t.prototype.throttlingDone=function(){var e=this._throttled,t=this._trailing;e&&e.unsubscribe(),this._throttled=void 0,t&&this.send()},t.prototype.notifyNext=function(){this.throttlingDone()},t.prototype.notifyComplete=function(){this.throttlingDone()},t}(sn);var mr,gr={e:{}};function yr(e){return e instanceof Date&&!isNaN(+e)}function _r(){gr.e=void 0;try{return mr.apply(this,arguments)}catch(e){return gr.e=e,gr}finally{mr=void 0}}var wr=Object.freeze({__proto__:null,config:oe,InnerSubscriber:Dt,OuterSubscriber:Ut,Scheduler:We,AnonymousSubject:xe,SubjectSubscription:Te,Subscriber:he,fromPromise:function(e,t){return t?$t(e,t):new Ee(Vt(e))},fromIterable:function(e,t){if(!e)throw new Error("Iterable cannot be null");return t?Zt(e,t):new Ee(Ht(e))},ajax:ir,webSocket:ar,ajaxGet:Gn,ajaxPost:zn,ajaxDelete:Jn,ajaxPut:Yn,ajaxPatch:Qn,ajaxGetJSON:Xn,AjaxObservable:$n,AjaxSubscriber:Zn,AjaxResponse:er,AjaxError:tr,AjaxTimeoutError:rr,WebSocketSubject:sr,CombineLatestOperator:Kt,dispatch:Mn,SubscribeOnObservable:ur,Timestamp:cr,TimeInterval:dr,GroupedObservable:De,defaultThrottleConfig:hr,rxSubscriber:de,iterator:Bt,observable:ge,ArgumentOutOfRangeError:At,EmptyError:xt,Immediate:vt,ObjectUnsubscribedError:Se,TimeoutError:It,UnsubscriptionError:le,applyMixins:function(e,t){for(var n=0,r=t.length;n<r;n++)for(var i=t[n],o=Object.getOwnPropertyNames(i.prototype),s=0,a=o.length;s<a;s++){var u=o[s];e.prototype[u]=i.prototype[u]}},errorObject:gr,hostReportError:se,identity:ye,isArray:ue,isArrayLike:Gt,isDate:yr,isFunction:re,isIterable:tn,isNumeric:yn,isObject:ce,isObservable:en,isPromise:zt,isScheduler:Ke,noop:kt,not:Sn,pipe:_e,root:Wn,subscribeTo:Jt,subscribeToArray:$e,subscribeToIterable:Ht,subscribeToObservable:Wt,subscribeToPromise:Vt,subscribeToResult:Yt,toSubscriber:me,tryCatch:function(e){return mr=e,_r}}),Er=A(Vn),Or=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.bindCallback=Er.bindCallback})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.bindNodeCallback=Er.bindNodeCallback})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.combineLatest=Er.combineLatest})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.concat=Er.concat})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.defer=Er.defer})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.empty=Er.empty})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.forkJoin=Er.forkJoin})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.from=Er.from})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.fromEvent=Er.fromEvent})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.fromEventPattern=Er.fromEventPattern})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.fromPromise=Er.from})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.generate=Er.generate})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.if=Er.iif})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.interval=Er.interval})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.merge=Er.merge})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.race=Er.race})),k((function(e,t){function n(){return Er.NEVER}Object.defineProperty(t,"__esModule",{value:!0}),t.staticNever=n,Er.Observable.never=n})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.of=Er.of})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.onErrorResumeNext=Er.onErrorResumeNext})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.pairs=Er.pairs})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.range=Er.range})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.using=Er.using})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.throw=Er.throwError,Er.Observable.throwError=Er.throwError})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.timer=Er.timer})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.zip=Er.zip})),A(Object.freeze({__proto__:null,ajax:ir,AjaxResponse:er,AjaxError:tr,AjaxTimeoutError:rr}))),Sr=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.ajax=Or.ajax})),A(Object.freeze({__proto__:null,webSocket:ar,WebSocketSubject:sr})));k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.webSocket=Sr.webSocket}));function Tr(e){return function(t){return t.lift(new kr(e))}}var kr=function(){function e(e){this.durationSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new Ar(e,this.durationSelector))},e}(),Ar=function(e){function t(t,n){var r=e.call(this,t)||this;return r.durationSelector=n,r.hasValue=!1,r}return te(t,e),t.prototype._next=function(e){if(this.value=e,this.hasValue=!0,!this.throttled){var t=void 0;try{t=(0,this.durationSelector)(e)}catch(e){return this.destination.error(e)}var n=an(t,new on(this));!n||n.closed?this.clearThrottle():this.add(this.throttled=n)}},t.prototype.clearThrottle=function(){var e=this,t=e.value,n=e.hasValue,r=e.throttled;r&&(this.remove(r),this.throttled=void 0,r.unsubscribe()),n&&(this.value=void 0,this.hasValue=!1,this.destination.next(t))},t.prototype.notifyNext=function(){this.clearThrottle()},t.prototype.notifyComplete=function(){this.clearThrottle()},t}(sn);function xr(e,t){return void 0===t&&(t=_t),Tr((function(){return Rn(e,t)}))}var Ir=function(){function e(e){this.closingNotifier=e}return e.prototype.call=function(e,t){return t.subscribe(new Nr(e,this.closingNotifier))},e}(),Nr=function(e){function t(t,n){var r=e.call(this,t)||this;return r.buffer=[],r.add(an(n,new on(r))),r}return te(t,e),t.prototype._next=function(e){this.buffer.push(e)},t.prototype.notifyNext=function(){var e=this.buffer;this.buffer=[],this.destination.next(e)},t}(sn);function Mr(e,t){return void 0===t&&(t=null),function(n){return n.lift(new Rr(e,t))}}var Rr=function(){function e(e,t){this.bufferSize=e,this.startBufferEvery=t,this.subscriberClass=t&&e!==t?Pr:Cr}return e.prototype.call=function(e,t){return t.subscribe(new this.subscriberClass(e,this.bufferSize,this.startBufferEvery))},e}(),Cr=function(e){function t(t,n){var r=e.call(this,t)||this;return r.bufferSize=n,r.buffer=[],r}return te(t,e),t.prototype._next=function(e){var t=this.buffer;t.push(e),t.length==this.bufferSize&&(this.destination.next(t),this.buffer=[])},t.prototype._complete=function(){var t=this.buffer;t.length>0&&this.destination.next(t),e.prototype._complete.call(this)},t}(he),Pr=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.bufferSize=n,i.startBufferEvery=r,i.buffers=[],i.count=0,i}return te(t,e),t.prototype._next=function(e){var t=this,n=t.bufferSize,r=t.startBufferEvery,i=t.buffers,o=t.count;this.count++,o%r==0&&i.push([]);for(var s=i.length;s--;){var a=i[s];a.push(e),a.length===n&&(i.splice(s,1),this.destination.next(a))}},t.prototype._complete=function(){for(var t=this.buffers,n=this.destination;t.length>0;){var r=t.shift();r.length>0&&n.next(r)}e.prototype._complete.call(this)},t}(he);var jr=function(){function e(e,t,n,r){this.bufferTimeSpan=e,this.bufferCreationInterval=t,this.maxBufferSize=n,this.scheduler=r}return e.prototype.call=function(e,t){return t.subscribe(new qr(e,this.bufferTimeSpan,this.bufferCreationInterval,this.maxBufferSize,this.scheduler))},e}(),Lr=function(){return function(){this.buffer=[]}}(),qr=function(e){function t(t,n,r,i,o){var s=e.call(this,t)||this;s.bufferTimeSpan=n,s.bufferCreationInterval=r,s.maxBufferSize=i,s.scheduler=o,s.contexts=[];var a=s.openContext();if(s.timespanOnly=null==r||r<0,s.timespanOnly){var u={subscriber:s,context:a,bufferTimeSpan:n};s.add(a.closeAction=o.schedule(Ur,n,u))}else{var c={subscriber:s,context:a},l={bufferTimeSpan:n,bufferCreationInterval:r,subscriber:s,scheduler:o};s.add(a.closeAction=o.schedule(Vr,n,c)),s.add(o.schedule(Dr,r,l))}return s}return te(t,e),t.prototype._next=function(e){for(var t,n=this.contexts,r=n.length,i=0;i<r;i++){var o=n[i],s=o.buffer;s.push(e),s.length==this.maxBufferSize&&(t=o)}t&&this.onBufferFull(t)},t.prototype._error=function(t){this.contexts.length=0,e.prototype._error.call(this,t)},t.prototype._complete=function(){for(var t=this.contexts,n=this.destination;t.length>0;){var r=t.shift();n.next(r.buffer)}e.prototype._complete.call(this)},t.prototype._unsubscribe=function(){this.contexts=null},t.prototype.onBufferFull=function(e){this.closeContext(e);var t=e.closeAction;if(t.unsubscribe(),this.remove(t),!this.closed&&this.timespanOnly){e=this.openContext();var n=this.bufferTimeSpan,r={subscriber:this,context:e,bufferTimeSpan:n};this.add(e.closeAction=this.scheduler.schedule(Ur,n,r))}},t.prototype.openContext=function(){var e=new Lr;return this.contexts.push(e),e},t.prototype.closeContext=function(e){this.destination.next(e.buffer);var t=this.contexts;(t?t.indexOf(e):-1)>=0&&t.splice(t.indexOf(e),1)},t}(he);function Ur(e){var t=e.subscriber,n=e.context;n&&t.closeContext(n),t.closed||(e.context=t.openContext(),e.context.closeAction=this.schedule(e,e.bufferTimeSpan))}function Dr(e){var t=e.bufferCreationInterval,n=e.bufferTimeSpan,r=e.subscriber,i=e.scheduler,o=r.openContext();r.closed||(r.add(o.closeAction=i.schedule(Vr,n,{subscriber:r,context:o})),this.schedule(e,t))}function Vr(e){var t=e.subscriber,n=e.context;t.closeContext(n)}var Fr=function(){function e(e,t){this.openings=e,this.closingSelector=t}return e.prototype.call=function(e,t){return t.subscribe(new Br(e,this.openings,this.closingSelector))},e}(),Br=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.closingSelector=r,i.contexts=[],i.add(Yt(i,n)),i}return te(t,e),t.prototype._next=function(e){for(var t=this.contexts,n=t.length,r=0;r<n;r++)t[r].buffer.push(e)},t.prototype._error=function(t){for(var n=this.contexts;n.length>0;){var r=n.shift();r.subscription.unsubscribe(),r.buffer=null,r.subscription=null}this.contexts=null,e.prototype._error.call(this,t)},t.prototype._complete=function(){for(var t=this.contexts;t.length>0;){var n=t.shift();this.destination.next(n.buffer),n.subscription.unsubscribe(),n.buffer=null,n.subscription=null}this.contexts=null,e.prototype._complete.call(this)},t.prototype.notifyNext=function(e,t){e?this.closeBuffer(e):this.openBuffer(t)},t.prototype.notifyComplete=function(e){this.closeBuffer(e.context)},t.prototype.openBuffer=function(e){try{var t=this.closingSelector.call(this,e);t&&this.trySubscribe(t)}catch(e){this._error(e)}},t.prototype.closeBuffer=function(e){var t=this.contexts;if(t&&e){var n=e.buffer,r=e.subscription;this.destination.next(n),t.splice(t.indexOf(e),1),this.remove(r),r.unsubscribe()}},t.prototype.trySubscribe=function(e){var t=this.contexts,n=new fe,r={buffer:[],subscription:n};t.push(r);var i=Yt(this,e,r);!i||i.closed?this.closeBuffer(r):(i.context=r,this.add(i),n.add(i))},t}(Ut);var Hr=function(){function e(e){this.closingSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new Wr(e,this.closingSelector))},e}(),Wr=function(e){function t(t,n){var r=e.call(this,t)||this;return r.closingSelector=n,r.subscribing=!1,r.openBuffer(),r}return te(t,e),t.prototype._next=function(e){this.buffer.push(e)},t.prototype._complete=function(){var t=this.buffer;t&&this.destination.next(t),e.prototype._complete.call(this)},t.prototype._unsubscribe=function(){this.buffer=void 0,this.subscribing=!1},t.prototype.notifyNext=function(){this.openBuffer()},t.prototype.notifyComplete=function(){this.subscribing?this.complete():this.openBuffer()},t.prototype.openBuffer=function(){var e=this.closingSubscription;e&&(this.remove(e),e.unsubscribe());var t,n=this.buffer;this.buffer&&this.destination.next(n),this.buffer=[];try{t=(0,this.closingSelector)()}catch(e){return this.error(e)}e=new fe,this.closingSubscription=e,this.add(e),this.subscribing=!0,e.add(an(t,new on(this))),this.subscribing=!1},t}(sn);function Gr(e){return function(t){var n=new zr(e),r=t.lift(n);return n.caught=r}}var zr=function(){function e(e){this.selector=e}return e.prototype.call=function(e,t){return t.subscribe(new Jr(e,this.selector,this.caught))},e}(),Jr=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.selector=n,i.caught=r,i}return te(t,e),t.prototype.error=function(t){if(!this.isStopped){var n=void 0;try{n=this.selector(t,this.caught)}catch(t){return void e.prototype.error.call(this,t)}this._unsubscribeAndRecycle();var r=new on(this);this.add(r);var i=an(n,r);i!==r&&this.add(i)}},t}(sn);function Yr(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=null;return"function"==typeof e[e.length-1]&&(n=e.pop()),1===e.length&&ue(e[0])&&(e=e[0].slice()),function(t){return t.lift.call(rn([t].concat(e)),new Kt(n))}}function Qr(e,t){return un(e,t,1)}var Kr=function(){function e(e,t){this.predicate=e,this.source=t}return e.prototype.call=function(e,t){return t.subscribe(new Xr(e,this.predicate,this.source))},e}(),Xr=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.predicate=n,i.source=r,i.count=0,i.index=0,i}return te(t,e),t.prototype._next=function(e){this.predicate?this._tryPredicate(e):this.count++},t.prototype._tryPredicate=function(e){var t;try{t=this.predicate(e,this.index++,this.source)}catch(e){return void this.destination.error(e)}t&&this.count++},t.prototype._complete=function(){this.destination.next(this.count),this.destination.complete()},t}(he);var $r=function(){function e(e){this.durationSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new Zr(e,this.durationSelector))},e}(),Zr=function(e){function t(t,n){var r=e.call(this,t)||this;return r.durationSelector=n,r.hasValue=!1,r}return te(t,e),t.prototype._next=function(e){try{var t=this.durationSelector.call(this,e);t&&this._tryNext(e,t)}catch(e){this.destination.error(e)}},t.prototype._complete=function(){this.emitValue(),this.destination.complete()},t.prototype._tryNext=function(e,t){var n=this.durationSubscription;this.value=e,this.hasValue=!0,n&&(n.unsubscribe(),this.remove(n)),(n=an(t,new on(this)))&&!n.closed&&this.add(this.durationSubscription=n)},t.prototype.notifyNext=function(){this.emitValue()},t.prototype.notifyComplete=function(){this.emitValue()},t.prototype.emitValue=function(){if(this.hasValue){var t=this.value,n=this.durationSubscription;n&&(this.durationSubscription=void 0,n.unsubscribe(),this.remove(n)),this.value=void 0,this.hasValue=!1,e.prototype._next.call(this,t)}},t}(sn);function ei(e,t){return void 0===t&&(t=_t),function(n){return n.lift(new ti(e,t))}}var ti=function(){function e(e,t){this.dueTime=e,this.scheduler=t}return e.prototype.call=function(e,t){return t.subscribe(new ni(e,this.dueTime,this.scheduler))},e}(),ni=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.dueTime=n,i.scheduler=r,i.debouncedSubscription=null,i.lastValue=null,i.hasValue=!1,i}return te(t,e),t.prototype._next=function(e){this.clearDebounce(),this.lastValue=e,this.hasValue=!0,this.add(this.debouncedSubscription=this.scheduler.schedule(ri,this.dueTime,this))},t.prototype._complete=function(){this.debouncedNext(),this.destination.complete()},t.prototype.debouncedNext=function(){if(this.clearDebounce(),this.hasValue){var e=this.lastValue;this.lastValue=null,this.hasValue=!1,this.destination.next(e)}},t.prototype.clearDebounce=function(){var e=this.debouncedSubscription;null!==e&&(this.remove(e),e.unsubscribe(),this.debouncedSubscription=null)},t}(he);function ri(e){e.debouncedNext()}function ii(e){return void 0===e&&(e=null),function(t){return t.lift(new oi(e))}}var oi=function(){function e(e){this.defaultValue=e}return e.prototype.call=function(e,t){return t.subscribe(new si(e,this.defaultValue))},e}(),si=function(e){function t(t,n){var r=e.call(this,t)||this;return r.defaultValue=n,r.isEmpty=!0,r}return te(t,e),t.prototype._next=function(e){this.isEmpty=!1,this.destination.next(e)},t.prototype._complete=function(){this.isEmpty&&this.destination.next(this.defaultValue),this.destination.complete()},t}(he);var ai=function(){function e(e,t){this.delay=e,this.scheduler=t}return e.prototype.call=function(e,t){return t.subscribe(new ui(e,this.delay,this.scheduler))},e}(),ui=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.delay=n,i.scheduler=r,i.queue=[],i.active=!1,i.errored=!1,i}return te(t,e),t.dispatch=function(e){for(var t=e.source,n=t.queue,r=e.scheduler,i=e.destination;n.length>0&&n[0].time-r.now()<=0;)n.shift().notification.observe(i);if(n.length>0){var o=Math.max(0,n[0].time-r.now());this.schedule(e,o)}else this.unsubscribe(),t.active=!1},t.prototype._schedule=function(e){this.active=!0,this.destination.add(e.schedule(t.dispatch,this.delay,{source:this,destination:this.destination,scheduler:e}))},t.prototype.scheduleNotification=function(e){if(!0!==this.errored){var t=this.scheduler,n=new ci(t.now()+this.delay,e);this.queue.push(n),!1===this.active&&this._schedule(t)}},t.prototype._next=function(e){this.scheduleNotification(it.createNext(e))},t.prototype._error=function(e){this.errored=!0,this.queue=[],this.destination.error(e),this.unsubscribe()},t.prototype._complete=function(){this.scheduleNotification(it.createComplete()),this.unsubscribe()},t}(he),ci=function(){return function(e,t){this.time=e,this.notification=t}}();var li=function(){function e(e){this.delayDurationSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new fi(e,this.delayDurationSelector))},e}(),fi=function(e){function t(t,n){var r=e.call(this,t)||this;return r.delayDurationSelector=n,r.completed=!1,r.delayNotifierSubscriptions=[],r.index=0,r}return te(t,e),t.prototype.notifyNext=function(e,t,n,r,i){this.destination.next(e),this.removeSubscription(i),this.tryComplete()},t.prototype.notifyError=function(e,t){this._error(e)},t.prototype.notifyComplete=function(e){var t=this.removeSubscription(e);t&&this.destination.next(t),this.tryComplete()},t.prototype._next=function(e){var t=this.index++;try{var n=this.delayDurationSelector(e,t);n&&this.tryDelay(n,e)}catch(e){this.destination.error(e)}},t.prototype._complete=function(){this.completed=!0,this.tryComplete(),this.unsubscribe()},t.prototype.removeSubscription=function(e){e.unsubscribe();var t=this.delayNotifierSubscriptions.indexOf(e);return-1!==t&&this.delayNotifierSubscriptions.splice(t,1),e.outerValue},t.prototype.tryDelay=function(e,t){var n=Yt(this,e,t);n&&!n.closed&&(this.destination.add(n),this.delayNotifierSubscriptions.push(n))},t.prototype.tryComplete=function(){this.completed&&0===this.delayNotifierSubscriptions.length&&this.destination.complete()},t}(Ut),pi=function(e){function t(t,n){var r=e.call(this)||this;return r.source=t,r.subscriptionDelay=n,r}return te(t,e),t.prototype._subscribe=function(e){this.subscriptionDelay.subscribe(new di(e,this.source))},t}(Ee),di=function(e){function t(t,n){var r=e.call(this)||this;return r.parent=t,r.source=n,r.sourceSubscribed=!1,r}return te(t,e),t.prototype._next=function(e){this.subscribeToSource()},t.prototype._error=function(e){this.unsubscribe(),this.parent.error(e)},t.prototype._complete=function(){this.unsubscribe(),this.subscribeToSource()},t.prototype.subscribeToSource=function(){this.sourceSubscribed||(this.sourceSubscribed=!0,this.unsubscribe(),this.source.subscribe(this.parent))},t}(he);var hi=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new vi(e))},e}(),vi=function(e){function t(t){return e.call(this,t)||this}return te(t,e),t.prototype._next=function(e){e.observe(this.destination)},t}(he);function bi(e,t){return function(n){return n.lift(new mi(e,t))}}var mi=function(){function e(e,t){this.keySelector=e,this.flushes=t}return e.prototype.call=function(e,t){return t.subscribe(new gi(e,this.keySelector,this.flushes))},e}(),gi=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.keySelector=n,i.values=new Set,r&&i.add(an(r,new on(i))),i}return te(t,e),t.prototype.notifyNext=function(){this.values.clear()},t.prototype.notifyError=function(e){this._error(e)},t.prototype._next=function(e){this.keySelector?this._useKeySelector(e):this._finalizeNext(e,e)},t.prototype._useKeySelector=function(e){var t,n=this.destination;try{t=this.keySelector(e)}catch(e){return void n.error(e)}this._finalizeNext(t,e)},t.prototype._finalizeNext=function(e,t){var n=this.values;n.has(e)||(n.add(e),this.destination.next(t))},t}(sn);function yi(e,t){return function(n){return n.lift(new _i(e,t))}}var _i=function(){function e(e,t){this.compare=e,this.keySelector=t}return e.prototype.call=function(e,t){return t.subscribe(new wi(e,this.compare,this.keySelector))},e}(),wi=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.keySelector=r,i.hasKey=!1,"function"==typeof n&&(i.compare=n),i}return te(t,e),t.prototype.compare=function(e,t){return e===t},t.prototype._next=function(e){var t;try{var n=this.keySelector;t=n?n(e):e}catch(e){return this.destination.error(e)}var r=!1;if(this.hasKey)try{r=(0,this.compare)(this.key,t)}catch(e){return this.destination.error(e)}else this.hasKey=!0;r||(this.key=t,this.destination.next(e))},t}(he);function Ei(e){return void 0===e&&(e=Ti),function(t){return t.lift(new Oi(e))}}var Oi=function(){function e(e){this.errorFactory=e}return e.prototype.call=function(e,t){return t.subscribe(new Si(e,this.errorFactory))},e}(),Si=function(e){function t(t,n){var r=e.call(this,t)||this;return r.errorFactory=n,r.hasValue=!1,r}return te(t,e),t.prototype._next=function(e){this.hasValue=!0,this.destination.next(e)},t.prototype._complete=function(){if(this.hasValue)return this.destination.complete();var e=void 0;try{e=this.errorFactory()}catch(t){e=t}this.destination.error(e)},t}(he);function Ti(){return new xt}function ki(e){return function(t){return 0===e?Qe():t.lift(new Ai(e))}}var Ai=function(){function e(e){if(this.total=e,this.total<0)throw new At}return e.prototype.call=function(e,t){return t.subscribe(new xi(e,this.total))},e}(),xi=function(e){function t(t,n){var r=e.call(this,t)||this;return r.total=n,r.count=0,r}return te(t,e),t.prototype._next=function(e){var t=this.total,n=++this.count;n<=t&&(this.destination.next(e),n===t&&(this.destination.complete(),this.unsubscribe()))},t}(he);var Ii=function(){function e(e,t,n){this.predicate=e,this.thisArg=t,this.source=n}return e.prototype.call=function(e,t){return t.subscribe(new Ni(e,this.predicate,this.thisArg,this.source))},e}(),Ni=function(e){function t(t,n,r,i){var o=e.call(this,t)||this;return o.predicate=n,o.thisArg=r,o.source=i,o.index=0,o.thisArg=r||o,o}return te(t,e),t.prototype.notifyComplete=function(e){this.destination.next(e),this.destination.complete()},t.prototype._next=function(e){var t=!1;try{t=this.predicate.call(this.thisArg,e,this.index++,this.source)}catch(e){return void this.destination.error(e)}t||this.notifyComplete(!1)},t.prototype._complete=function(){this.notifyComplete(!0)},t}(he);var Mi=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new Ri(e))},e}(),Ri=function(e){function t(t){var n=e.call(this,t)||this;return n.hasCompleted=!1,n.hasSubscription=!1,n}return te(t,e),t.prototype._next=function(e){this.hasSubscription||(this.hasSubscription=!0,this.add(an(e,new on(this))))},t.prototype._complete=function(){this.hasCompleted=!0,this.hasSubscription||this.destination.complete()},t.prototype.notifyComplete=function(){this.hasSubscription=!1,this.hasCompleted&&this.destination.complete()},t}(sn);var Ci=function(){function e(e){this.project=e}return e.prototype.call=function(e,t){return t.subscribe(new Pi(e,this.project))},e}(),Pi=function(e){function t(t,n){var r=e.call(this,t)||this;return r.project=n,r.hasSubscription=!1,r.hasCompleted=!1,r.index=0,r}return te(t,e),t.prototype._next=function(e){this.hasSubscription||this.tryNext(e)},t.prototype.tryNext=function(e){var t,n=this.index++;try{t=this.project(e,n)}catch(e){return void this.destination.error(e)}this.hasSubscription=!0,this._innerSub(t)},t.prototype._innerSub=function(e){var t=new on(this),n=this.destination;n.add(t);var r=an(e,t);r!==t&&n.add(r)},t.prototype._complete=function(){this.hasCompleted=!0,this.hasSubscription||this.destination.complete(),this.unsubscribe()},t.prototype.notifyNext=function(e){this.destination.next(e)},t.prototype.notifyError=function(e){this.destination.error(e)},t.prototype.notifyComplete=function(){this.hasSubscription=!1,this.hasCompleted&&this.destination.complete()},t}(sn);var ji=function(){function e(e,t,n){this.project=e,this.concurrent=t,this.scheduler=n}return e.prototype.call=function(e,t){return t.subscribe(new Li(e,this.project,this.concurrent,this.scheduler))},e}(),Li=function(e){function t(t,n,r,i){var o=e.call(this,t)||this;return o.project=n,o.concurrent=r,o.scheduler=i,o.index=0,o.active=0,o.hasCompleted=!1,r<Number.POSITIVE_INFINITY&&(o.buffer=[]),o}return te(t,e),t.dispatch=function(e){var t=e.subscriber,n=e.result,r=e.value,i=e.index;t.subscribeToProjection(n,r,i)},t.prototype._next=function(e){var n=this.destination;if(n.closed)this._complete();else{var r=this.index++;if(this.active<this.concurrent){n.next(e);try{var i=(0,this.project)(e,r);if(this.scheduler){var o={subscriber:this,result:i,value:e,index:r};this.destination.add(this.scheduler.schedule(t.dispatch,0,o))}else this.subscribeToProjection(i,e,r)}catch(e){n.error(e)}}else this.buffer.push(e)}},t.prototype.subscribeToProjection=function(e,t,n){this.active++,this.destination.add(an(e,new on(this)))},t.prototype._complete=function(){this.hasCompleted=!0,this.hasCompleted&&0===this.active&&this.destination.complete(),this.unsubscribe()},t.prototype.notifyNext=function(e){this._next(e)},t.prototype.notifyComplete=function(){var e=this.buffer;this.active--,e&&e.length>0&&this._next(e.shift()),this.hasCompleted&&0===this.active&&this.destination.complete()},t}(sn);function qi(e){return function(t){return t.lift(new Ui(e))}}var Ui=function(){function e(e){this.callback=e}return e.prototype.call=function(e,t){return t.subscribe(new Di(e,this.callback))},e}(),Di=function(e){function t(t,n){var r=e.call(this,t)||this;return r.add(new fe(n)),r}return te(t,e),t}(he);var Vi=function(){function e(e,t,n,r){this.predicate=e,this.source=t,this.yieldIndex=n,this.thisArg=r}return e.prototype.call=function(e,t){return t.subscribe(new Fi(e,this.predicate,this.source,this.yieldIndex,this.thisArg))},e}(),Fi=function(e){function t(t,n,r,i,o){var s=e.call(this,t)||this;return s.predicate=n,s.source=r,s.yieldIndex=i,s.thisArg=o,s.index=0,s}return te(t,e),t.prototype.notifyComplete=function(e){var t=this.destination;t.next(e),t.complete(),this.unsubscribe()},t.prototype._next=function(e){var t=this.predicate,n=this.thisArg,r=this.index++;try{t.call(n||this,e,r,this.source)&&this.notifyComplete(this.yieldIndex?r:e)}catch(e){this.destination.error(e)}},t.prototype._complete=function(){this.notifyComplete(this.yieldIndex?-1:void 0)},t}(he);var Bi=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new Hi(e))},e}(),Hi=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return te(t,e),t.prototype._next=function(e){},t}(he);var Wi=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new Gi(e))},e}(),Gi=function(e){function t(t){return e.call(this,t)||this}return te(t,e),t.prototype.notifyComplete=function(e){var t=this.destination;t.next(e),t.complete()},t.prototype._next=function(e){this.notifyComplete(!1)},t.prototype._complete=function(){this.notifyComplete(!0)},t}(he);function zi(e){return function(t){return 0===e?Qe():t.lift(new Ji(e))}}var Ji=function(){function e(e){if(this.total=e,this.total<0)throw new At}return e.prototype.call=function(e,t){return t.subscribe(new Yi(e,this.total))},e}(),Yi=function(e){function t(t,n){var r=e.call(this,t)||this;return r.total=n,r.ring=new Array,r.count=0,r}return te(t,e),t.prototype._next=function(e){var t=this.ring,n=this.total,r=this.count++;t.length<n?t.push(e):t[r%n]=e},t.prototype._complete=function(){var e=this.destination,t=this.count;if(t>0)for(var n=this.count>=this.total?this.total:this.count,r=this.ring,i=0;i<n;i++){var o=t++%n;e.next(r[o])}e.complete()},t}(he);function Qi(e,t){var n=arguments.length>=2;return function(r){return r.pipe(e?Tn((function(t,n){return e(t,n,r)})):ye,zi(1),n?ii(t):Ei((function(){return new xt})))}}function Ki(e){return function(t){return t.lift(new Xi(e))}}var Xi=function(){function e(e){this.value=e}return e.prototype.call=function(e,t){return t.subscribe(new $i(e,this.value))},e}(),$i=function(e){function t(t,n){var r=e.call(this,t)||this;return r.value=n,r}return te(t,e),t.prototype._next=function(e){this.destination.next(this.value)},t}(he);var Zi=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new eo(e))},e}(),eo=function(e){function t(t){return e.call(this,t)||this}return te(t,e),t.prototype._next=function(e){this.destination.next(it.createNext(e))},t.prototype._error=function(e){var t=this.destination;t.next(it.createError(e)),t.complete()},t.prototype._complete=function(){var e=this.destination;e.next(it.createComplete()),e.complete()},t}(he);function to(e,t){return arguments.length>=2?function(n){return _e(lr(e,t),zi(1),ii(t))(n)}:function(t){return _e(lr((function(t,n,r){return e(t,n,r+1)})),zi(1))(t)}}function no(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(t){return t.lift.call(wn.apply(void 0,[t].concat(e)))}}function ro(e,t,n){return void 0===n&&(n=Number.POSITIVE_INFINITY),"function"==typeof t?un((function(){return e}),t,n):("number"==typeof t&&(n=t),un((function(){return e}),n))}var io=function(){function e(e,t,n){this.accumulator=e,this.seed=t,this.concurrent=n}return e.prototype.call=function(e,t){return t.subscribe(new oo(e,this.accumulator,this.seed,this.concurrent))},e}(),oo=function(e){function t(t,n,r,i){var o=e.call(this,t)||this;return o.accumulator=n,o.acc=r,o.concurrent=i,o.hasValue=!1,o.hasCompleted=!1,o.buffer=[],o.active=0,o.index=0,o}return te(t,e),t.prototype._next=function(e){if(this.active<this.concurrent){var t=this.index++,n=this.destination,r=void 0;try{r=(0,this.accumulator)(this.acc,e,t)}catch(e){return n.error(e)}this.active++,this._innerSub(r)}else this.buffer.push(e)},t.prototype._innerSub=function(e){var t=new on(this),n=this.destination;n.add(t);var r=an(e,t);r!==t&&n.add(r)},t.prototype._complete=function(){this.hasCompleted=!0,0===this.active&&0===this.buffer.length&&(!1===this.hasValue&&this.destination.next(this.acc),this.destination.complete()),this.unsubscribe()},t.prototype.notifyNext=function(e){var t=this.destination;this.acc=e,this.hasValue=!0,t.next(e)},t.prototype.notifyComplete=function(){var e=this.buffer;this.active--,e.length>0?this._next(e.shift()):0===this.active&&this.hasCompleted&&(!1===this.hasValue&&this.destination.next(this.acc),this.destination.complete())},t}(sn);function so(e,t){return function(n){var r;if(r="function"==typeof e?e:function(){return e},"function"==typeof t)return n.lift(new ao(r,t));var i=Object.create(n,Ce);return i.source=n,i.subjectFactory=r,i}}var ao=function(){function e(e,t){this.subjectFactory=e,this.selector=t}return e.prototype.call=function(e,t){var n=this.selector,r=this.subjectFactory(),i=n(r).subscribe(e);return i.add(t.subscribe(r)),i},e}();var uo=function(){function e(e){this.nextSources=e}return e.prototype.call=function(e,t){return t.subscribe(new co(e,this.nextSources))},e}(),co=function(e){function t(t,n){var r=e.call(this,t)||this;return r.destination=t,r.nextSources=n,r}return te(t,e),t.prototype.notifyError=function(){this.subscribeToNextSource()},t.prototype.notifyComplete=function(){this.subscribeToNextSource()},t.prototype._error=function(e){this.subscribeToNextSource(),this.unsubscribe()},t.prototype._complete=function(){this.subscribeToNextSource(),this.unsubscribe()},t.prototype.subscribeToNextSource=function(){var e=this.nextSources.shift();if(e){var t=new on(this),n=this.destination;n.add(t);var r=an(e,t);r!==t&&n.add(r)}else this.destination.complete()},t}(sn);var lo=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new fo(e))},e}(),fo=function(e){function t(t){var n=e.call(this,t)||this;return n.hasPrev=!1,n}return te(t,e),t.prototype._next=function(e){var t;this.hasPrev?t=[this.prev,e]:this.hasPrev=!0,this.prev=e,t&&this.destination.next(t)},t}(he);function po(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=e.length;if(0===n)throw new Error("list of properties cannot be empty.");return function(t){return Nt(ho(e,n))(t)}}function ho(e,t){return function(n){for(var r=n,i=0;i<t;i++){var o=null!=r?r[e[i]]:void 0;if(void 0===o)return;r=o}return r}}function vo(e){return e?so((function(){return new Ae}),e):so(new Ae)}function bo(e,t,n,r){n&&"function"!=typeof n&&(r=n);var i="function"==typeof n?n:void 0,o=new ut(e,t,r);return function(e){return so((function(){return o}),i)(e)}}function mo(e){return void 0===e&&(e=-1),function(t){return 0===e?Qe():e<0?t.lift(new go(-1,t)):t.lift(new go(e-1,t))}}var go=function(){function e(e,t){this.count=e,this.source=t}return e.prototype.call=function(e,t){return t.subscribe(new yo(e,this.count,this.source))},e}(),yo=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.count=n,i.source=r,i}return te(t,e),t.prototype.complete=function(){if(!this.isStopped){var t=this.source,n=this.count;if(0===n)return e.prototype.complete.call(this);n>-1&&(this.count=n-1),t.subscribe(this._unsubscribeAndRecycle())}},t}(he);var _o=function(){function e(e){this.notifier=e}return e.prototype.call=function(e,t){return t.subscribe(new wo(e,this.notifier,t))},e}(),wo=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.notifier=n,i.source=r,i.sourceIsBeingSubscribedTo=!0,i}return te(t,e),t.prototype.notifyNext=function(){this.sourceIsBeingSubscribedTo=!0,this.source.subscribe(this)},t.prototype.notifyComplete=function(){if(!1===this.sourceIsBeingSubscribedTo)return e.prototype.complete.call(this)},t.prototype.complete=function(){if(this.sourceIsBeingSubscribedTo=!1,!this.isStopped){if(this.retries||this.subscribeToRetries(),!this.retriesSubscription||this.retriesSubscription.closed)return e.prototype.complete.call(this);this._unsubscribeAndRecycle(),this.notifications.next(void 0)}},t.prototype._unsubscribe=function(){var e=this.notifications,t=this.retriesSubscription;e&&(e.unsubscribe(),this.notifications=void 0),t&&(t.unsubscribe(),this.retriesSubscription=void 0),this.retries=void 0},t.prototype._unsubscribeAndRecycle=function(){var t=this._unsubscribe;return this._unsubscribe=null,e.prototype._unsubscribeAndRecycle.call(this),this._unsubscribe=t,this},t.prototype.subscribeToRetries=function(){var t;this.notifications=new Ae;try{t=(0,this.notifier)(this.notifications)}catch(t){return e.prototype.complete.call(this)}this.retries=t,this.retriesSubscription=an(t,new on(this))},t}(sn);var Eo=function(){function e(e,t){this.count=e,this.source=t}return e.prototype.call=function(e,t){return t.subscribe(new Oo(e,this.count,this.source))},e}(),Oo=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.count=n,i.source=r,i}return te(t,e),t.prototype.error=function(t){if(!this.isStopped){var n=this.source,r=this.count;if(0===r)return e.prototype.error.call(this,t);r>-1&&(this.count=r-1),n.subscribe(this._unsubscribeAndRecycle())}},t}(he);var So=function(){function e(e,t){this.notifier=e,this.source=t}return e.prototype.call=function(e,t){return t.subscribe(new To(e,this.notifier,this.source))},e}(),To=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.notifier=n,i.source=r,i}return te(t,e),t.prototype.error=function(t){if(!this.isStopped){var n=this.errors,r=this.retries,i=this.retriesSubscription;if(r)this.errors=void 0,this.retriesSubscription=void 0;else{n=new Ae;try{r=(0,this.notifier)(n)}catch(t){return e.prototype.error.call(this,t)}i=an(r,new on(this))}this._unsubscribeAndRecycle(),this.errors=n,this.retries=r,this.retriesSubscription=i,n.next(t)}},t.prototype._unsubscribe=function(){var e=this.errors,t=this.retriesSubscription;e&&(e.unsubscribe(),this.errors=void 0),t&&(t.unsubscribe(),this.retriesSubscription=void 0),this.retries=void 0},t.prototype.notifyNext=function(){var e=this._unsubscribe;this._unsubscribe=null,this._unsubscribeAndRecycle(),this._unsubscribe=e,this.source.subscribe(this)},t}(sn);var ko=function(){function e(e){this.notifier=e}return e.prototype.call=function(e,t){var n=new Ao(e),r=t.subscribe(n);return r.add(an(this.notifier,new on(n))),r},e}(),Ao=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.hasValue=!1,t}return te(t,e),t.prototype._next=function(e){this.value=e,this.hasValue=!0},t.prototype.notifyNext=function(){this.emitValue()},t.prototype.notifyComplete=function(){this.emitValue()},t.prototype.emitValue=function(){this.hasValue&&(this.hasValue=!1,this.destination.next(this.value))},t}(sn);var xo=function(){function e(e,t){this.period=e,this.scheduler=t}return e.prototype.call=function(e,t){return t.subscribe(new Io(e,this.period,this.scheduler))},e}(),Io=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.period=n,i.scheduler=r,i.hasValue=!1,i.add(r.schedule(No,n,{subscriber:i,period:n})),i}return te(t,e),t.prototype._next=function(e){this.lastValue=e,this.hasValue=!0},t.prototype.notifyNext=function(){this.hasValue&&(this.hasValue=!1,this.destination.next(this.lastValue))},t}(he);function No(e){var t=e.subscriber,n=e.period;t.notifyNext(),this.schedule(e,n)}var Mo=function(){function e(e,t){this.compareTo=e,this.comparator=t}return e.prototype.call=function(e,t){return t.subscribe(new Ro(e,this.compareTo,this.comparator))},e}(),Ro=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.compareTo=n,i.comparator=r,i._a=[],i._b=[],i._oneComplete=!1,i.destination.add(n.subscribe(new Co(t,i))),i}return te(t,e),t.prototype._next=function(e){this._oneComplete&&0===this._b.length?this.emit(!1):(this._a.push(e),this.checkValues())},t.prototype._complete=function(){this._oneComplete?this.emit(0===this._a.length&&0===this._b.length):this._oneComplete=!0,this.unsubscribe()},t.prototype.checkValues=function(){for(var e=this,t=e._a,n=e._b,r=e.comparator;t.length>0&&n.length>0;){var i=t.shift(),o=n.shift(),s=!1;try{s=r?r(i,o):i===o}catch(e){this.destination.error(e)}s||this.emit(!1)}},t.prototype.emit=function(e){var t=this.destination;t.next(e),t.complete()},t.prototype.nextB=function(e){this._oneComplete&&0===this._a.length?this.emit(!1):(this._b.push(e),this.checkValues())},t.prototype.completeB=function(){this._oneComplete?this.emit(0===this._a.length&&0===this._b.length):this._oneComplete=!0},t}(he),Co=function(e){function t(t,n){var r=e.call(this,t)||this;return r.parent=n,r}return te(t,e),t.prototype._next=function(e){this.parent.nextB(e)},t.prototype._error=function(e){this.parent.error(e),this.unsubscribe()},t.prototype._complete=function(){this.parent.completeB(),this.unsubscribe()},t}(he);function Po(){return new Ae}function jo(){return function(e){return Ie()(so(Po)(e))}}function Lo(e,t,n){var r;return r=e&&"object"===o(e)?e:{bufferSize:e,windowTime:t,refCount:!1,scheduler:n},function(e){return e.lift(function(e){var t,n,r=e.bufferSize,i=void 0===r?Number.POSITIVE_INFINITY:r,o=e.windowTime,s=void 0===o?Number.POSITIVE_INFINITY:o,a=e.refCount,u=e.scheduler,c=0,l=!1,f=!1;return function(e){var r;c++,!t||l?(l=!1,t=new ut(i,s,u),r=t.subscribe(this),n=e.subscribe({next:function(e){t.next(e)},error:function(e){l=!0,t.error(e)},complete:function(){f=!0,n=void 0,t.complete()}}),f&&(n=void 0)):r=t.subscribe(this),this.add((function(){c--,r.unsubscribe(),r=void 0,n&&!f&&a&&0===c&&(n.unsubscribe(),n=void 0,t=void 0)}))}}(r))}}var qo=function(){function e(e,t){this.predicate=e,this.source=t}return e.prototype.call=function(e,t){return t.subscribe(new Uo(e,this.predicate,this.source))},e}(),Uo=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.predicate=n,i.source=r,i.seenValue=!1,i.index=0,i}return te(t,e),t.prototype.applySingleValue=function(e){this.seenValue?this.destination.error("Sequence contains more than one element"):(this.seenValue=!0,this.singleValue=e)},t.prototype._next=function(e){var t=this.index++;this.predicate?this.tryNext(e,t):this.applySingleValue(e)},t.prototype.tryNext=function(e,t){try{this.predicate(e,t,this.source)&&this.applySingleValue(e)}catch(e){this.destination.error(e)}},t.prototype._complete=function(){var e=this.destination;this.index>0?(e.next(this.seenValue?this.singleValue:void 0),e.complete()):e.error(new xt)},t}(he);function Do(e){return function(t){return t.lift(new Vo(e))}}var Vo=function(){function e(e){this.total=e}return e.prototype.call=function(e,t){return t.subscribe(new Fo(e,this.total))},e}(),Fo=function(e){function t(t,n){var r=e.call(this,t)||this;return r.total=n,r.count=0,r}return te(t,e),t.prototype._next=function(e){++this.count>this.total&&this.destination.next(e)},t}(he);var Bo=function(){function e(e){if(this._skipCount=e,this._skipCount<0)throw new At}return e.prototype.call=function(e,t){return 0===this._skipCount?t.subscribe(new he(e)):t.subscribe(new Ho(e,this._skipCount))},e}(),Ho=function(e){function t(t,n){var r=e.call(this,t)||this;return r._skipCount=n,r._count=0,r._ring=new Array(n),r}return te(t,e),t.prototype._next=function(e){var t=this._skipCount,n=this._count++;if(n<t)this._ring[n]=e;else{var r=n%t,i=this._ring,o=i[r];i[r]=e,this.destination.next(o)}},t}(he);var Wo=function(){function e(e){this.notifier=e}return e.prototype.call=function(e,t){return t.subscribe(new Go(e,this.notifier))},e}(),Go=function(e){function t(t,n){var r=e.call(this,t)||this;r.hasValue=!1;var i=new on(r);r.add(i),r.innerSubscription=i;var o=an(n,i);return o!==i&&(r.add(o),r.innerSubscription=o),r}return te(t,e),t.prototype._next=function(t){this.hasValue&&e.prototype._next.call(this,t)},t.prototype.notifyNext=function(){this.hasValue=!0,this.innerSubscription&&this.innerSubscription.unsubscribe()},t.prototype.notifyComplete=function(){},t}(sn);var zo=function(){function e(e){this.predicate=e}return e.prototype.call=function(e,t){return t.subscribe(new Jo(e,this.predicate))},e}(),Jo=function(e){function t(t,n){var r=e.call(this,t)||this;return r.predicate=n,r.skipping=!0,r.index=0,r}return te(t,e),t.prototype._next=function(e){var t=this.destination;this.skipping&&this.tryCallPredicate(e),this.skipping||t.next(e)},t.prototype.tryCallPredicate=function(e){try{var t=this.predicate(e,this.index++);this.skipping=Boolean(t)}catch(e){this.destination.error(e)}},t}(he);function Yo(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=e[e.length-1];return Ke(n)?(e.pop(),function(t){return hn(e,t,n)}):function(t){return hn(e,t)}}var Qo=function(){function e(e,t){this.scheduler=e,this.delay=t}return e.prototype.call=function(e,t){return new ur(t,this.delay,this.scheduler).subscribe(e)},e}();function Ko(e,t){return"function"==typeof t?function(n){return n.pipe(Ko((function(n,r){return rn(e(n,r)).pipe(Nt((function(e,i){return t(n,e,r,i)})))})))}:function(t){return t.lift(new Xo(e))}}var Xo=function(){function e(e){this.project=e}return e.prototype.call=function(e,t){return t.subscribe(new $o(e,this.project))},e}(),$o=function(e){function t(t,n){var r=e.call(this,t)||this;return r.project=n,r.index=0,r}return te(t,e),t.prototype._next=function(e){var t,n=this.index++;try{t=this.project(e,n)}catch(e){return void this.destination.error(e)}this._innerSub(t)},t.prototype._innerSub=function(e){var t=this.innerSubscription;t&&t.unsubscribe();var n=new on(this),r=this.destination;r.add(n),this.innerSubscription=an(e,n),this.innerSubscription!==n&&r.add(this.innerSubscription)},t.prototype._complete=function(){var t=this.innerSubscription;t&&!t.closed||e.prototype._complete.call(this),this.unsubscribe()},t.prototype._unsubscribe=function(){this.innerSubscription=void 0},t.prototype.notifyComplete=function(){this.innerSubscription=void 0,this.isStopped&&e.prototype._complete.call(this)},t.prototype.notifyNext=function(e){this.destination.next(e)},t}(sn);function Zo(e,t){return t?Ko((function(){return e}),t):Ko((function(){return e}))}function es(e){return function(t){return t.lift(new ts(e))}}var ts=function(){function e(e){this.notifier=e}return e.prototype.call=function(e,t){var n=new ns(e),r=an(this.notifier,new on(n));return r&&!n.seenValue?(n.add(r),t.subscribe(n)):n},e}(),ns=function(e){function t(t){var n=e.call(this,t)||this;return n.seenValue=!1,n}return te(t,e),t.prototype.notifyNext=function(){this.seenValue=!0,this.complete()},t.prototype.notifyComplete=function(){},t}(sn);var rs=function(){function e(e,t){this.predicate=e,this.inclusive=t}return e.prototype.call=function(e,t){return t.subscribe(new is(e,this.predicate,this.inclusive))},e}(),is=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.predicate=n,i.inclusive=r,i.index=0,i}return te(t,e),t.prototype._next=function(e){var t,n=this.destination;try{t=this.predicate(e,this.index++)}catch(e){return void n.error(e)}this.nextOrComplete(e,t)},t.prototype.nextOrComplete=function(e,t){var n=this.destination;Boolean(t)?n.next(e):(this.inclusive&&n.next(e),n.complete())},t}(he);function os(e,t,n){return function(r){return r.lift(new ss(e,t,n))}}var ss=function(){function e(e,t,n){this.nextOrObserver=e,this.error=t,this.complete=n}return e.prototype.call=function(e,t){return t.subscribe(new as(e,this.nextOrObserver,this.error,this.complete))},e}(),as=function(e){function t(t,n,r,i){var o=e.call(this,t)||this;return o._tapNext=kt,o._tapError=kt,o._tapComplete=kt,o._tapError=r||kt,o._tapComplete=i||kt,re(n)?(o._context=o,o._tapNext=n):n&&(o._context=n,o._tapNext=n.next||kt,o._tapError=n.error||kt,o._tapComplete=n.complete||kt),o}return te(t,e),t.prototype._next=function(e){try{this._tapNext.call(this._context,e)}catch(e){return void this.destination.error(e)}this.destination.next(e)},t.prototype._error=function(e){try{this._tapError.call(this._context,e)}catch(e){return void this.destination.error(e)}this.destination.error(e)},t.prototype._complete=function(){try{this._tapComplete.call(this._context)}catch(e){return void this.destination.error(e)}return this.destination.complete()},t}(he);function us(e,t,n){return void 0===t&&(t=_t),void 0===n&&(n=hr),function(r){return r.lift(new cs(e,t,n.leading,n.trailing))}}var cs=function(){function e(e,t,n,r){this.duration=e,this.scheduler=t,this.leading=n,this.trailing=r}return e.prototype.call=function(e,t){return t.subscribe(new ls(e,this.duration,this.scheduler,this.leading,this.trailing))},e}(),ls=function(e){function t(t,n,r,i,o){var s=e.call(this,t)||this;return s.duration=n,s.scheduler=r,s.leading=i,s.trailing=o,s._hasTrailingValue=!1,s._trailingValue=null,s}return te(t,e),t.prototype._next=function(e){this.throttled?this.trailing&&(this._trailingValue=e,this._hasTrailingValue=!0):(this.add(this.throttled=this.scheduler.schedule(fs,this.duration,{subscriber:this})),this.leading?this.destination.next(e):this.trailing&&(this._trailingValue=e,this._hasTrailingValue=!0))},t.prototype._complete=function(){this._hasTrailingValue?(this.destination.next(this._trailingValue),this.destination.complete()):this.destination.complete()},t.prototype.clearThrottle=function(){var e=this.throttled;e&&(this.trailing&&this._hasTrailingValue&&(this.destination.next(this._trailingValue),this._trailingValue=null,this._hasTrailingValue=!1),e.unsubscribe(),this.remove(e),this.throttled=null)},t}(he);function fs(e){e.subscriber.clearThrottle()}function ps(e,t,n){return void 0===n&&(n=_t),function(r){var i=yr(e),o=i?+e-n.now():Math.abs(e);return r.lift(new ds(o,i,t,n))}}var ds=function(){function e(e,t,n,r){this.waitFor=e,this.absoluteTimeout=t,this.withObservable=n,this.scheduler=r}return e.prototype.call=function(e,t){return t.subscribe(new hs(e,this.absoluteTimeout,this.waitFor,this.withObservable,this.scheduler))},e}(),hs=function(e){function t(t,n,r,i,o){var s=e.call(this,t)||this;return s.absoluteTimeout=n,s.waitFor=r,s.withObservable=i,s.scheduler=o,s.scheduleTimeout(),s}return te(t,e),t.dispatchTimeout=function(e){var t=e.withObservable;e._unsubscribeAndRecycle(),e.add(an(t,new on(e)))},t.prototype.scheduleTimeout=function(){var e=this.action;e?this.action=e.schedule(this,this.waitFor):this.add(this.action=this.scheduler.schedule(t.dispatchTimeout,this.waitFor,this))},t.prototype._next=function(t){this.absoluteTimeout||this.scheduleTimeout(),e.prototype._next.call(this,t)},t.prototype._unsubscribe=function(){this.action=void 0,this.scheduler=null,this.withObservable=null},t}(sn);function vs(e,t){return void 0===t&&(t=_t),ps(e,nt(new It),t)}function bs(e,t,n){return 0===n?[t]:(e.push(t),e)}function ms(e){return function(t){return t.lift(new gs(e))}}var gs=function(){function e(e){this.windowBoundaries=e}return e.prototype.call=function(e,t){var n=new ys(e),r=t.subscribe(n);return r.closed||n.add(an(this.windowBoundaries,new on(n))),r},e}(),ys=function(e){function t(t){var n=e.call(this,t)||this;return n.window=new Ae,t.next(n.window),n}return te(t,e),t.prototype.notifyNext=function(){this.openWindow()},t.prototype.notifyError=function(e){this._error(e)},t.prototype.notifyComplete=function(){this._complete()},t.prototype._next=function(e){this.window.next(e)},t.prototype._error=function(e){this.window.error(e),this.destination.error(e)},t.prototype._complete=function(){this.window.complete(),this.destination.complete()},t.prototype._unsubscribe=function(){this.window=null},t.prototype.openWindow=function(){var e=this.window;e&&e.complete();var t=this.destination,n=this.window=new Ae;t.next(n)},t}(sn);var _s=function(){function e(e,t){this.windowSize=e,this.startWindowEvery=t}return e.prototype.call=function(e,t){return t.subscribe(new ws(e,this.windowSize,this.startWindowEvery))},e}(),ws=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.destination=t,i.windowSize=n,i.startWindowEvery=r,i.windows=[new Ae],i.count=0,t.next(i.windows[0]),i}return te(t,e),t.prototype._next=function(e){for(var t=this.startWindowEvery>0?this.startWindowEvery:this.windowSize,n=this.destination,r=this.windowSize,i=this.windows,o=i.length,s=0;s<o&&!this.closed;s++)i[s].next(e);var a=this.count-r+1;if(a>=0&&a%t==0&&!this.closed&&i.shift().complete(),++this.count%t==0&&!this.closed){var u=new Ae;i.push(u),n.next(u)}},t.prototype._error=function(e){var t=this.windows;if(t)for(;t.length>0&&!this.closed;)t.shift().error(e);this.destination.error(e)},t.prototype._complete=function(){var e=this.windows;if(e)for(;e.length>0&&!this.closed;)e.shift().complete();this.destination.complete()},t.prototype._unsubscribe=function(){this.count=0,this.windows=null},t}(he);var Es=function(){function e(e,t,n,r){this.windowTimeSpan=e,this.windowCreationInterval=t,this.maxWindowSize=n,this.scheduler=r}return e.prototype.call=function(e,t){return t.subscribe(new Ss(e,this.windowTimeSpan,this.windowCreationInterval,this.maxWindowSize,this.scheduler))},e}(),Os=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._numberOfNextedValues=0,t}return te(t,e),t.prototype.next=function(t){this._numberOfNextedValues++,e.prototype.next.call(this,t)},Object.defineProperty(t.prototype,"numberOfNextedValues",{get:function(){return this._numberOfNextedValues},enumerable:!0,configurable:!0}),t}(Ae),Ss=function(e){function t(t,n,r,i,o){var s=e.call(this,t)||this;s.destination=t,s.windowTimeSpan=n,s.windowCreationInterval=r,s.maxWindowSize=i,s.scheduler=o,s.windows=[];var a=s.openWindow();if(null!==r&&r>=0){var u={subscriber:s,window:a,context:null},c={windowTimeSpan:n,windowCreationInterval:r,subscriber:s,scheduler:o};s.add(o.schedule(As,n,u)),s.add(o.schedule(ks,r,c))}else{var l={subscriber:s,window:a,windowTimeSpan:n};s.add(o.schedule(Ts,n,l))}return s}return te(t,e),t.prototype._next=function(e){for(var t=this.windows,n=t.length,r=0;r<n;r++){var i=t[r];i.closed||(i.next(e),i.numberOfNextedValues>=this.maxWindowSize&&this.closeWindow(i))}},t.prototype._error=function(e){for(var t=this.windows;t.length>0;)t.shift().error(e);this.destination.error(e)},t.prototype._complete=function(){for(var e=this.windows;e.length>0;){var t=e.shift();t.closed||t.complete()}this.destination.complete()},t.prototype.openWindow=function(){var e=new Os;return this.windows.push(e),this.destination.next(e),e},t.prototype.closeWindow=function(e){e.complete();var t=this.windows;t.splice(t.indexOf(e),1)},t}(he);function Ts(e){var t=e.subscriber,n=e.windowTimeSpan,r=e.window;r&&t.closeWindow(r),e.window=t.openWindow(),this.schedule(e,n)}function ks(e){var t=e.windowTimeSpan,n=e.subscriber,r=e.scheduler,i=e.windowCreationInterval,o=n.openWindow(),s=this,a={action:s,subscription:null},u={subscriber:n,window:o,context:a};a.subscription=r.schedule(As,t,u),s.add(a.subscription),s.schedule(e,i)}function As(e){var t=e.subscriber,n=e.window,r=e.context;r&&r.action&&r.subscription&&r.action.remove(r.subscription),t.closeWindow(n)}var xs=function(){function e(e,t){this.openings=e,this.closingSelector=t}return e.prototype.call=function(e,t){return t.subscribe(new Is(e,this.openings,this.closingSelector))},e}(),Is=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.openings=n,i.closingSelector=r,i.contexts=[],i.add(i.openSubscription=Yt(i,n,n)),i}return te(t,e),t.prototype._next=function(e){var t=this.contexts;if(t)for(var n=t.length,r=0;r<n;r++)t[r].window.next(e)},t.prototype._error=function(t){var n=this.contexts;if(this.contexts=null,n)for(var r=n.length,i=-1;++i<r;){var o=n[i];o.window.error(t),o.subscription.unsubscribe()}e.prototype._error.call(this,t)},t.prototype._complete=function(){var t=this.contexts;if(this.contexts=null,t)for(var n=t.length,r=-1;++r<n;){var i=t[r];i.window.complete(),i.subscription.unsubscribe()}e.prototype._complete.call(this)},t.prototype._unsubscribe=function(){var e=this.contexts;if(this.contexts=null,e)for(var t=e.length,n=-1;++n<t;){var r=e[n];r.window.unsubscribe(),r.subscription.unsubscribe()}},t.prototype.notifyNext=function(e,t,n,r,i){if(e===this.openings){var o=void 0;try{o=(0,this.closingSelector)(t)}catch(e){return this.error(e)}var s=new Ae,a=new fe,u={window:s,subscription:a};this.contexts.push(u);var c=Yt(this,o,u);c.closed?this.closeWindow(this.contexts.length-1):(c.context=u,a.add(c)),this.destination.next(s)}else this.closeWindow(this.contexts.indexOf(e))},t.prototype.notifyError=function(e){this.error(e)},t.prototype.notifyComplete=function(e){e!==this.openSubscription&&this.closeWindow(this.contexts.indexOf(e.context))},t.prototype.closeWindow=function(e){if(-1!==e){var t=this.contexts,n=t[e],r=n.window,i=n.subscription;t.splice(e,1),r.complete(),i.unsubscribe()}},t}(Ut);var Ns=function(){function e(e){this.closingSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new Ms(e,this.closingSelector))},e}(),Ms=function(e){function t(t,n){var r=e.call(this,t)||this;return r.destination=t,r.closingSelector=n,r.openWindow(),r}return te(t,e),t.prototype.notifyNext=function(e,t,n,r,i){this.openWindow(i)},t.prototype.notifyError=function(e){this._error(e)},t.prototype.notifyComplete=function(e){this.openWindow(e)},t.prototype._next=function(e){this.window.next(e)},t.prototype._error=function(e){this.window.error(e),this.destination.error(e),this.unsubscribeClosingNotification()},t.prototype._complete=function(){this.window.complete(),this.destination.complete(),this.unsubscribeClosingNotification()},t.prototype.unsubscribeClosingNotification=function(){this.closingNotification&&this.closingNotification.unsubscribe()},t.prototype.openWindow=function(e){void 0===e&&(e=null),e&&(this.remove(e),e.unsubscribe());var t=this.window;t&&t.complete();var n,r=this.window=new Ae;this.destination.next(r);try{n=(0,this.closingSelector)()}catch(e){return this.destination.error(e),void this.window.error(e)}this.add(this.closingNotification=Yt(this,n))},t}(Ut);function Rs(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(t){var n;"function"==typeof e[e.length-1]&&(n=e.pop());var r=e;return t.lift(new Cs(r,n))}}var Cs=function(){function e(e,t){this.observables=e,this.project=t}return e.prototype.call=function(e,t){return t.subscribe(new Ps(e,this.observables,this.project))},e}(),Ps=function(e){function t(t,n,r){var i=e.call(this,t)||this;i.observables=n,i.project=r,i.toRespond=[];var o=n.length;i.values=new Array(o);for(var s=0;s<o;s++)i.toRespond.push(s);for(s=0;s<o;s++){var a=n[s];i.add(Yt(i,a,void 0,s))}return i}return te(t,e),t.prototype.notifyNext=function(e,t,n){this.values[n]=t;var r=this.toRespond;if(r.length>0){var i=r.indexOf(n);-1!==i&&r.splice(i,1)}},t.prototype.notifyComplete=function(){},t.prototype._next=function(e){if(0===this.toRespond.length){var t=[e].concat(this.values);this.project?this._tryProject(t):this.destination.next(t)}},t.prototype._tryProject=function(e){var t;try{t=this.project.apply(this,e)}catch(e){return void this.destination.error(e)}this.destination.next(t)},t}(Ut);function js(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(t){return t.lift.call(Pn.apply(void 0,[t].concat(e)))}}var Ls=Object.freeze({__proto__:null,audit:Tr,auditTime:xr,buffer:function(e){return function(t){return t.lift(new Ir(e))}},bufferCount:Mr,bufferTime:function(e){var t=arguments.length,n=_t;Ke(arguments[arguments.length-1])&&(n=arguments[arguments.length-1],t--);var r=null;t>=2&&(r=arguments[1]);var i=Number.POSITIVE_INFINITY;return t>=3&&(i=arguments[2]),function(t){return t.lift(new jr(e,r,i,n))}},bufferToggle:function(e,t){return function(n){return n.lift(new Fr(e,t))}},bufferWhen:function(e){return function(t){return t.lift(new Hr(e))}},catchError:Gr,combineAll:function(e){return function(t){return t.lift(new Kt(e))}},combineLatest:Yr,concat:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(t){return t.lift.call(hn.apply(void 0,[t].concat(e)))}},concatAll:dn,concatMap:Qr,concatMapTo:function(e,t){return Qr((function(){return e}),t)},count:function(e){return function(t){return t.lift(new Kr(e,t))}},debounce:function(e){return function(t){return t.lift(new $r(e))}},debounceTime:ei,defaultIfEmpty:ii,delay:function(e,t){void 0===t&&(t=_t);var n=yr(e)?+e-t.now():Math.abs(e);return function(e){return e.lift(new ai(n,t))}},delayWhen:function(e,t){return t?function(n){return new pi(n,t).lift(new li(e))}:function(t){return t.lift(new li(e))}},dematerialize:function(){return function(e){return e.lift(new hi)}},distinct:bi,distinctUntilChanged:yi,distinctUntilKeyChanged:function(e,t){return yi((function(n,r){return t?t(n[e],r[e]):n[e]===r[e]}))},elementAt:function(e,t){if(e<0)throw new At;var n=arguments.length>=2;return function(r){return r.pipe(Tn((function(t,n){return n===e})),ki(1),n?ii(t):Ei((function(){return new At})))}},endWith:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(t){return hn(t,tt.apply(void 0,e))}},every:function(e,t){return function(n){return n.lift(new Ii(e,t,n))}},exhaust:function(){return function(e){return e.lift(new Mi)}},exhaustMap:function e(t,n){return n?function(r){return r.pipe(e((function(e,r){return rn(t(e,r)).pipe(Nt((function(t,i){return n(e,t,r,i)})))})))}:function(e){return e.lift(new Ci(t))}},expand:function(e,t,n){return void 0===t&&(t=Number.POSITIVE_INFINITY),t=(t||0)<1?Number.POSITIVE_INFINITY:t,function(r){return r.lift(new ji(e,t,n))}},filter:Tn,finalize:qi,find:function(e,t){if("function"!=typeof e)throw new TypeError("predicate is not a function");return function(n){return n.lift(new Vi(e,n,!1,t))}},findIndex:function(e,t){return function(n){return n.lift(new Vi(e,n,!0,t))}},first:function(e,t){var n=arguments.length>=2;return function(r){return r.pipe(e?Tn((function(t,n){return e(t,n,r)})):ye,ki(1),n?ii(t):Ei((function(){return new xt})))}},groupBy:je,ignoreElements:function(){return function(e){return e.lift(new Bi)}},isEmpty:function(){return function(e){return e.lift(new Wi)}},last:Qi,map:Nt,mapTo:Ki,materialize:function(){return function(e){return e.lift(new Zi)}},max:function(e){return to("function"==typeof e?function(t,n){return e(t,n)>0?t:n}:function(e,t){return e>t?e:t})},merge:no,mergeAll:pn,mergeMap:un,flatMap:fn,mergeMapTo:ro,mergeScan:function(e,t,n){return void 0===n&&(n=Number.POSITIVE_INFINITY),function(r){return r.lift(new io(e,t,n))}},min:function(e){return to("function"==typeof e?function(t,n){return e(t,n)<0?t:n}:function(e,t){return e<t?e:t})},multicast:so,observeOn:function(e,t){return void 0===t&&(t=0),function(n){return n.lift(new ot(e,t))}},onErrorResumeNext:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 1===e.length&&ue(e[0])&&(e=e[0]),function(t){return t.lift(new uo(e))}},pairwise:function(){return function(e){return e.lift(new lo)}},partition:function(e,t){return function(n){return[Tn(e,t)(n),Tn(Sn(e,t))(n)]}},pluck:po,publish:vo,publishBehavior:function(e){return function(t){return so(new Fe(e))(t)}},publishLast:function(){return function(e){return so(new lt)(e)}},publishReplay:bo,race:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(t){return 1===e.length&&ue(e[0])&&(e=e[0]),t.lift.call(xn.apply(void 0,[t].concat(e)))}},reduce:to,repeat:mo,repeatWhen:function(e){return function(t){return t.lift(new _o(e))}},retry:function(e){return void 0===e&&(e=-1),function(t){return t.lift(new Eo(e,t))}},retryWhen:function(e){return function(t){return t.lift(new So(e,t))}},refCount:Ie,sample:function(e){return function(t){return t.lift(new ko(e))}},sampleTime:function(e,t){return void 0===t&&(t=_t),function(n){return n.lift(new xo(e,t))}},scan:lr,sequenceEqual:function(e,t){return function(n){return n.lift(new Mo(e,t))}},share:jo,shareReplay:Lo,single:function(e){return function(t){return t.lift(new qo(e,t))}},skip:Do,skipLast:function(e){return function(t){return t.lift(new Bo(e))}},skipUntil:function(e){return function(t){return t.lift(new Wo(e))}},skipWhile:function(e){return function(t){return t.lift(new zo(e))}},startWith:Yo,subscribeOn:function(e,t){return void 0===t&&(t=0),function(n){return n.lift(new Qo(e,t))}},switchAll:function(){return Ko(ye)},switchMap:Ko,switchMapTo:Zo,take:ki,takeLast:zi,takeUntil:es,takeWhile:function(e,t){return void 0===t&&(t=!1),function(n){return n.lift(new rs(e,t))}},tap:os,throttle:function(e,t){return void 0===t&&(t=hr),function(n){return n.lift(new vr(e,!!t.leading,!!t.trailing))}},throttleTime:us,throwIfEmpty:Ei,timeInterval:function(e){return void 0===e&&(e=_t),function(t){return vn((function(){return t.pipe(lr((function(t,n){var r=t.current;return{value:n,current:e.now(),last:r}}),{current:e.now(),value:void 0,last:void 0}),Nt((function(e){var t=e.current,n=e.last,r=e.value;return new dr(r,t-n)})))}))}},timeout:vs,timeoutWith:ps,timestamp:function(e){return void 0===e&&(e=_t),Nt((function(t){return new cr(t,e.now())}))},toArray:function(){return to(bs,[])},window:ms,windowCount:function(e,t){return void 0===t&&(t=0),function(n){return n.lift(new _s(e,t))}},windowTime:function(e){var t=_t,n=null,r=Number.POSITIVE_INFINITY;return Ke(arguments[3])&&(t=arguments[3]),Ke(arguments[2])?t=arguments[2]:yn(arguments[2])&&(r=Number(arguments[2])),Ke(arguments[1])?t=arguments[1]:yn(arguments[1])&&(n=Number(arguments[1])),function(i){return i.lift(new Es(e,n,r,t))}},windowToggle:function(e,t){return function(n){return n.lift(new xs(e,t))}},windowWhen:function(e){return function(t){return t.lift(new Ns(e))}},withLatestFrom:Rs,zip:js,zipAll:function(e){return function(t){return t.lift(new jn(e))}}}),qs=A(Ls),Us=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.buffer=function(e){return qs.buffer(e)(this)}})),Ds=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.buffer=Us.buffer})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.bufferCount=function(e,t){return void 0===t&&(t=null),qs.bufferCount(e,t)(this)}}))),Vs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.bufferCount=Ds.bufferCount})),A(wr)),Fs=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.bufferTime=function(e){var t=arguments.length,n=Er.asyncScheduler;Vs.isScheduler(arguments[arguments.length-1])&&(n=arguments[arguments.length-1],t--);var r=null;t>=2&&(r=arguments[1]);var i=Number.POSITIVE_INFINITY;return t>=3&&(i=arguments[2]),qs.bufferTime(e,r,i,n)(this)}})),Bs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.bufferTime=Fs.bufferTime})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.bufferToggle=function(e,t){return qs.bufferToggle(e,t)(this)}}))),Hs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.bufferToggle=Bs.bufferToggle})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.bufferWhen=function(e){return qs.bufferWhen(e)(this)}}))),Ws=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.bufferWhen=Hs.bufferWhen})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t._catch=function(e){return qs.catchError(e)(this)}}))),Gs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.catch=Ws._catch,Er.Observable.prototype._catch=Ws._catch})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.combineAll=function(e){return qs.combineAll(e)(this)}}))),zs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.combineAll=Gs.combineAll})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.combineLatest=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=null;return"function"==typeof e[e.length-1]&&(n=e.pop()),1===e.length&&Vs.isArray(e[0])&&(e=e[0].slice()),this.lift.call(Er.of.apply(void 0,[this].concat(e)),new Vs.CombineLatestOperator(n))}}))),Js=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.combineLatest=zs.combineLatest})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.concat=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.lift.call(Er.concat.apply(void 0,[this].concat(e)))}}))),Ys=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.concat=Js.concat})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.concatAll=function(){return qs.concatAll()(this)}}))),Qs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.concatAll=Ys.concatAll})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.concatMap=function(e){return qs.concatMap(e)(this)}}))),Ks=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.concatMap=Qs.concatMap})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.concatMapTo=function(e){return qs.concatMapTo(e)(this)}}))),Xs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.concatMapTo=Ks.concatMapTo})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.count=function(e){return qs.count(e)(this)}}))),$s=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.count=Xs.count})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.dematerialize=function(){return qs.dematerialize()(this)}}))),Zs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.dematerialize=$s.dematerialize})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.debounce=function(e){return qs.debounce(e)(this)}}))),ea=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.debounce=Zs.debounce})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.debounceTime=function(e,t){return void 0===t&&(t=Er.asyncScheduler),qs.debounceTime(e,t)(this)}}))),ta=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.debounceTime=ea.debounceTime})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.defaultIfEmpty=function(e){return void 0===e&&(e=null),qs.defaultIfEmpty(e)(this)}}))),na=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.defaultIfEmpty=ta.defaultIfEmpty})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.delay=function(e,t){return void 0===t&&(t=Er.asyncScheduler),qs.delay(e,t)(this)}}))),ra=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.delay=na.delay})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.delayWhen=function(e,t){return qs.delayWhen(e,t)(this)}}))),ia=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.delayWhen=ra.delayWhen})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.distinct=function(e,t){return qs.distinct(e,t)(this)}}))),oa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.distinct=ia.distinct})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.distinctUntilChanged=function(e,t){return qs.distinctUntilChanged(e,t)(this)}}))),sa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.distinctUntilChanged=oa.distinctUntilChanged})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.distinctUntilKeyChanged=function(e,t){return qs.distinctUntilKeyChanged(e,t)(this)}}))),aa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.distinctUntilKeyChanged=sa.distinctUntilKeyChanged})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t._do=function(e,t,n){return qs.tap(e,t,n)(this)}}))),ua=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.do=aa._do,Er.Observable.prototype._do=aa._do})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.exhaust=function(){return qs.exhaust()(this)}}))),ca=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.exhaust=ua.exhaust})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.exhaustMap=function(e){return qs.exhaustMap(e)(this)}}))),la=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.exhaustMap=ca.exhaustMap})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.expand=function(e,t,n){return void 0===t&&(t=Number.POSITIVE_INFINITY),void 0===n&&(n=void 0),t=(t||0)<1?Number.POSITIVE_INFINITY:t,qs.expand(e,t,n)(this)}}))),fa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.expand=la.expand})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.elementAt=function(e,t){return qs.elementAt.apply(void 0,arguments)(this)}}))),pa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.elementAt=fa.elementAt})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.filter=function(e,t){return qs.filter(e,t)(this)}}))),da=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.filter=pa.filter})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t._finally=function(e){return qs.finalize(e)(this)}}))),ha=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.finally=da._finally,Er.Observable.prototype._finally=da._finally})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.find=function(e,t){return qs.find(e,t)(this)}}))),va=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.find=ha.find})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.findIndex=function(e,t){return qs.findIndex(e,t)(this)}}))),ba=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.findIndex=va.findIndex})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.first=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return qs.first.apply(void 0,e)(this)}}))),ma=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.first=ba.first})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.groupBy=function(e,t,n,r){return qs.groupBy(e,t,n,r)(this)}}))),ga=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.groupBy=ma.groupBy})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ignoreElements=function(){return qs.ignoreElements()(this)}}))),ya=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.ignoreElements=ga.ignoreElements})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.isEmpty=function(){return qs.isEmpty()(this)}}))),_a=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.isEmpty=ya.isEmpty})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.audit=function(e){return qs.audit(e)(this)}}))),wa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.audit=_a.audit})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.auditTime=function(e,t){return void 0===t&&(t=Er.asyncScheduler),qs.auditTime(e,t)(this)}}))),Ea=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.auditTime=wa.auditTime})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.last=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return qs.last.apply(void 0,e)(this)}}))),Oa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.last=Ea.last})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.letProto=function(e){return e(this)}}))),Sa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.let=Oa.letProto,Er.Observable.prototype.letBind=Oa.letProto})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.every=function(e,t){return qs.every(e,t)(this)}}))),Ta=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.every=Sa.every})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.map=function(e,t){return qs.map(e,t)(this)}}))),ka=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.map=Ta.map})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.mapTo=function(e){return qs.mapTo(e)(this)}}))),Aa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.mapTo=ka.mapTo})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.materialize=function(){return qs.materialize()(this)}}))),xa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.materialize=Aa.materialize})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.max=function(e){return qs.max(e)(this)}}))),Ia=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.max=xa.max})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.merge=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.lift.call(Er.merge.apply(void 0,[this].concat(e)))}}))),Na=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.merge=Ia.merge})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.mergeAll=function(e){return void 0===e&&(e=Number.POSITIVE_INFINITY),qs.mergeAll(e)(this)}}))),Ma=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.mergeAll=Na.mergeAll})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.mergeMap=function(e,t){return void 0===t&&(t=Number.POSITIVE_INFINITY),qs.mergeMap(e,t)(this)}}))),Ra=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.mergeMap=Ma.mergeMap,Er.Observable.prototype.flatMap=Ma.mergeMap})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.mergeMapTo=function(e,t){return void 0===t&&(t=Number.POSITIVE_INFINITY),qs.mergeMapTo(e,t)(this)}}))),Ca=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.flatMapTo=Ra.mergeMapTo,Er.Observable.prototype.mergeMapTo=Ra.mergeMapTo})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.mergeScan=function(e,t,n){return void 0===n&&(n=Number.POSITIVE_INFINITY),qs.mergeScan(e,t,n)(this)}}))),Pa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.mergeScan=Ca.mergeScan})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.min=function(e){return qs.min(e)(this)}}))),ja=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.min=Pa.min})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.multicast=function(e,t){return qs.multicast(e,t)(this)}}))),La=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.multicast=ja.multicast})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.observeOn=function(e,t){return void 0===t&&(t=0),qs.observeOn(e,t)(this)}}))),qa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.observeOn=La.observeOn})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.onErrorResumeNext=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return qs.onErrorResumeNext.apply(void 0,e)(this)}}))),Ua=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.onErrorResumeNext=qa.onErrorResumeNext})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.pairwise=function(){return qs.pairwise()(this)}}))),Da=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.pairwise=Ua.pairwise})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.partition=function(e,t){return qs.partition(e,t)(this)}}))),Va=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.partition=Da.partition})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.pluck=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return qs.pluck.apply(void 0,e)(this)}}))),Fa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.pluck=Va.pluck})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.publish=function(e){return qs.publish(e)(this)}}))),Ba=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.publish=Fa.publish})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.publishBehavior=function(e){return qs.publishBehavior(e)(this)}}))),Ha=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.publishBehavior=Ba.publishBehavior})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.publishReplay=function(e,t,n,r){return qs.publishReplay(e,t,n,r)(this)}}))),Wa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.publishReplay=Ha.publishReplay})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.publishLast=function(){return qs.publishLast()(this)}}))),Ga=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.publishLast=Wa.publishLast})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.race=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return qs.race.apply(void 0,e)(this)}}))),za=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.race=Ga.race})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.reduce=function(e,t){return arguments.length>=2?qs.reduce(e,t)(this):qs.reduce(e)(this)}}))),Ja=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.reduce=za.reduce})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.repeat=function(e){return void 0===e&&(e=-1),qs.repeat(e)(this)}}))),Ya=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.repeat=Ja.repeat})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.repeatWhen=function(e){return qs.repeatWhen(e)(this)}}))),Qa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.repeatWhen=Ya.repeatWhen})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.retry=function(e){return void 0===e&&(e=-1),qs.retry(e)(this)}}))),Ka=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.retry=Qa.retry})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.retryWhen=function(e){return qs.retryWhen(e)(this)}}))),Xa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.retryWhen=Ka.retryWhen})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.sample=function(e){return qs.sample(e)(this)}}))),$a=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.sample=Xa.sample})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.sampleTime=function(e,t){return void 0===t&&(t=Er.asyncScheduler),qs.sampleTime(e,t)(this)}}))),Za=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.sampleTime=$a.sampleTime})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.scan=function(e,t){return arguments.length>=2?qs.scan(e,t)(this):qs.scan(e)(this)}}))),eu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.scan=Za.scan})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.sequenceEqual=function(e,t){return qs.sequenceEqual(e,t)(this)}}))),tu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.sequenceEqual=eu.sequenceEqual})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.share=function(){return qs.share()(this)}}))),nu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.share=tu.share})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.shareReplay=function(e,t,n){return e&&"object"===o(e)?qs.shareReplay(e)(this):qs.shareReplay(e,t,n)(this)}}))),ru=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.shareReplay=nu.shareReplay})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.single=function(e){return qs.single(e)(this)}}))),iu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.single=ru.single})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.skip=function(e){return qs.skip(e)(this)}}))),ou=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.skip=iu.skip})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.skipLast=function(e){return qs.skipLast(e)(this)}}))),su=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.skipLast=ou.skipLast})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.skipUntil=function(e){return qs.skipUntil(e)(this)}}))),au=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.skipUntil=su.skipUntil})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.skipWhile=function(e){return qs.skipWhile(e)(this)}}))),uu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.skipWhile=au.skipWhile})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.startWith=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return qs.startWith.apply(void 0,e)(this)}}))),cu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.startWith=uu.startWith})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.subscribeOn=function(e,t){return void 0===t&&(t=0),qs.subscribeOn(e,t)(this)}}))),lu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.subscribeOn=cu.subscribeOn})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t._switch=function(){return qs.switchAll()(this)}}))),fu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.switch=lu._switch,Er.Observable.prototype._switch=lu._switch})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.switchMap=function(e){return qs.switchMap(e)(this)}}))),pu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.switchMap=fu.switchMap})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.switchMapTo=function(e){return qs.switchMapTo(e)(this)}}))),du=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.switchMapTo=pu.switchMapTo})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.take=function(e){return qs.take(e)(this)}}))),hu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.take=du.take})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.takeLast=function(e){return qs.takeLast(e)(this)}}))),vu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.takeLast=hu.takeLast})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.takeUntil=function(e){return qs.takeUntil(e)(this)}}))),bu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.takeUntil=vu.takeUntil})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.takeWhile=function(e){return qs.takeWhile(e)(this)}}))),mu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.takeWhile=bu.takeWhile})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.throttle=function(e,t){return void 0===t&&(t=Vs.defaultThrottleConfig),qs.throttle(e,t)(this)}}))),gu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.throttle=mu.throttle})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.throttleTime=function(e,t,n){return void 0===t&&(t=Er.asyncScheduler),void 0===n&&(n=Vs.defaultThrottleConfig),qs.throttleTime(e,t,n)(this)}}))),yu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.throttleTime=gu.throttleTime})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.timeInterval=function(e){return void 0===e&&(e=Er.asyncScheduler),qs.timeInterval(e)(this)}}))),_u=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.timeInterval=yu.timeInterval})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.timeout=function(e,t){return void 0===t&&(t=Er.asyncScheduler),qs.timeout(e,t)(this)}}))),wu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.timeout=_u.timeout})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.timeoutWith=function(e,t,n){return void 0===n&&(n=Er.asyncScheduler),qs.timeoutWith(e,t,n)(this)}}))),Eu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.timeoutWith=wu.timeoutWith})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.timestamp=function(e){return void 0===e&&(e=Er.asyncScheduler),qs.timestamp(e)(this)}}))),Ou=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.timestamp=Eu.timestamp})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.toArray=function(){return qs.toArray()(this)}}))),Su=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.toArray=Ou.toArray})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.window=function(e){return qs.window(e)(this)}}))),Tu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.window=Su.window})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.windowCount=function(e,t){return void 0===t&&(t=0),qs.windowCount(e,t)(this)}}))),ku=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.windowCount=Tu.windowCount})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.windowTime=function(e){var t=Er.asyncScheduler,n=null,r=Number.POSITIVE_INFINITY;return Vs.isScheduler(arguments[3])&&(t=arguments[3]),Vs.isScheduler(arguments[2])?t=arguments[2]:Vs.isNumeric(arguments[2])&&(r=Number(arguments[2])),Vs.isScheduler(arguments[1])?t=arguments[1]:Vs.isNumeric(arguments[1])&&(n=Number(arguments[1])),qs.windowTime(e,n,r,t)(this)}}))),Au=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.windowTime=ku.windowTime})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.windowToggle=function(e,t){return qs.windowToggle(e,t)(this)}}))),xu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.windowToggle=Au.windowToggle})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.windowWhen=function(e){return qs.windowWhen(e)(this)}}))),Iu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.windowWhen=xu.windowWhen})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.withLatestFrom=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return qs.withLatestFrom.apply(void 0,e)(this)}}))),Nu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.withLatestFrom=Iu.withLatestFrom})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.zipProto=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.lift.call(Er.zip.apply(void 0,[this].concat(e)))}}))),Mu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.zip=Nu.zipProto})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.zipAll=function(e){return qs.zipAll(e)(this)}}))),Ru=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),Er.Observable.prototype.zipAll=Mu.zipAll})),function(){return function(e,t){void 0===t&&(t=Number.POSITIVE_INFINITY),this.subscribedFrame=e,this.unsubscribedFrame=t}}()),Cu=function(e){function t(t,n){var r=e.call(this,(function(e){var t=this,n=t.logSubscribedFrame(),r=new fe;return r.add(new fe((function(){t.logUnsubscribedFrame(n)}))),t.scheduleMessages(e),r}))||this;return r.messages=t,r.subscriptions=[],r.scheduler=n,r}return te(t,e),t.prototype.scheduleMessages=function(e){for(var t=this.messages.length,n=0;n<t;n++){var r=this.messages[n];e.add(this.scheduler.schedule((function(e){var t=e.message,n=e.subscriber;t.notification.observe(n)}),r.frame,{message:r,subscriber:e}))}},t}(Ee),Pu=function(e){function t(t,n){var r=e.call(this)||this;return r.messages=t,r.subscriptions=[],r.scheduler=n,r}return te(t,e),t.prototype._subscribe=function(t){var n=this,r=n.logSubscribedFrame(),i=new fe;return i.add(new fe((function(){n.logUnsubscribedFrame(r)}))),i.add(e.prototype._subscribe.call(this,t)),i},t.prototype.setup=function(){for(var e=this,t=e.messages.length,n=0;n<t;n++)!function(){var t=e.messages[n];e.scheduler.schedule((function(){t.notification.observe(e)}),t.frame)}()},t}(Ae),ju=function(e){function t(t){var n=e.call(this,Tt,750)||this;return n.assertDeepEqual=t,n.hotObservables=[],n.coldObservables=[],n.flushTests=[],n.runMode=!1,n}return te(t,e),t.prototype.createTime=function(e){var n=e.indexOf("|");if(-1===n)throw new Error('marble diagram for time should have a completion marker "|"');return n*t.frameTimeFactor},t.prototype.createColdObservable=function(e,n,r){if(-1!==e.indexOf("^"))throw new Error('cold observable cannot have subscription offset "^"');if(-1!==e.indexOf("!"))throw new Error('cold observable cannot have unsubscription marker "!"');var i=t.parseMarbles(e,n,r,void 0,this.runMode),o=new Cu(i,this);return this.coldObservables.push(o),o},t.prototype.createHotObservable=function(e,n,r){if(-1!==e.indexOf("!"))throw new Error('hot observable cannot have unsubscription marker "!"');var i=t.parseMarbles(e,n,r,void 0,this.runMode),o=new Pu(i,this);return this.hotObservables.push(o),o},t.prototype.materializeInnerObservable=function(e,t){var n=this,r=[];return e.subscribe((function(e){r.push({frame:n.frame-t,notification:it.createNext(e)})}),(function(e){r.push({frame:n.frame-t,notification:it.createError(e)})}),(function(){r.push({frame:n.frame-t,notification:it.createComplete()})})),r},t.prototype.expectObservable=function(e,n){var r=this;void 0===n&&(n=null);var i,o=[],s={actual:o,ready:!1},a=t.parseMarblesAsSubscriptions(n,this.runMode),u=a.subscribedFrame===Number.POSITIVE_INFINITY?0:a.subscribedFrame,c=a.unsubscribedFrame;this.schedule((function(){i=e.subscribe((function(e){var t=e;e instanceof Ee&&(t=r.materializeInnerObservable(t,r.frame)),o.push({frame:r.frame,notification:it.createNext(t)})}),(function(e){o.push({frame:r.frame,notification:it.createError(e)})}),(function(){o.push({frame:r.frame,notification:it.createComplete()})}))}),u),c!==Number.POSITIVE_INFINITY&&this.schedule((function(){return i.unsubscribe()}),c),this.flushTests.push(s);var l=this.runMode;return{toBe:function(e,n,r){s.ready=!0,s.expected=t.parseMarbles(e,n,r,!0,l)}}},t.prototype.expectSubscriptions=function(e){var n={actual:e,ready:!1};this.flushTests.push(n);var r=this.runMode;return{toBe:function(e){var i="string"==typeof e?[e]:e;n.ready=!0,n.expected=i.map((function(e){return t.parseMarblesAsSubscriptions(e,r)}))}}},t.prototype.flush=function(){for(var t=this,n=this.hotObservables;n.length>0;)n.shift().setup();e.prototype.flush.call(this),this.flushTests=this.flushTests.filter((function(e){return!e.ready||(t.assertDeepEqual(e.actual,e.expected),!1)}))},t.parseMarblesAsSubscriptions=function(e,t){var n=this;if(void 0===t&&(t=!1),"string"!=typeof e)return new Ru(Number.POSITIVE_INFINITY);for(var r,i=e.length,o=-1,s=Number.POSITIVE_INFINITY,a=Number.POSITIVE_INFINITY,u=0,c=function(i){var c=u,f=function(e){c+=e*n.frameTimeFactor},p=e[i];switch(p){case" ":t||f(1);break;case"-":f(1);break;case"(":o=u,f(1);break;case")":o=-1,f(1);break;case"^":if(s!==Number.POSITIVE_INFINITY)throw new Error("found a second subscription point '^' in a subscription marble diagram. There can only be one.");s=o>-1?o:u,f(1);break;case"!":if(a!==Number.POSITIVE_INFINITY)throw new Error("found a second subscription point '^' in a subscription marble diagram. There can only be one.");a=o>-1?o:u;break;default:if(t&&p.match(/^[0-9]$/)&&(0===i||" "===e[i-1])){var d=e.slice(i).match(/^([0-9]+(?:\.[0-9]+)?)(ms|s|m) /);if(d){i+=d[0].length-1;var h=parseFloat(d[1]),v=void 0;switch(d[2]){case"ms":v=h;break;case"s":v=1e3*h;break;case"m":v=1e3*h*60}f(v/l.frameTimeFactor);break}}throw new Error("there can only be '^' and '!' markers in a subscription marble diagram. Found instead '"+p+"'.")}u=c,r=i},l=this,f=0;f<i;f++)c(f),f=r;return a<0?new Ru(s):new Ru(s,a)},t.parseMarbles=function(e,t,n,r,i){var s=this;if(void 0===r&&(r=!1),void 0===i&&(i=!1),-1!==e.indexOf("!"))throw new Error('conventional marble diagrams cannot have the unsubscription marker "!"');for(var a,u=e.length,c=[],l=i?e.replace(/^[ ]+/,"").indexOf("^"):e.indexOf("^"),f=-1===l?0:l*-this.frameTimeFactor,p="object"!==o(t)?function(e){return e}:function(e){return r&&t[e]instanceof Cu?t[e].messages:t[e]},d=-1,h=function(t){var r=f,o=function(e){r+=e*s.frameTimeFactor},u=void 0,l=e[t];switch(l){case" ":i||o(1);break;case"-":o(1);break;case"(":d=f,o(1);break;case")":d=-1,o(1);break;case"|":u=it.createComplete(),o(1);break;case"^":o(1);break;case"#":u=it.createError(n||"error"),o(1);break;default:if(i&&l.match(/^[0-9]$/)&&(0===t||" "===e[t-1])){var h=e.slice(t).match(/^([0-9]+(?:\.[0-9]+)?)(ms|s|m) /);if(h){t+=h[0].length-1;var b=parseFloat(h[1]),m=void 0;switch(h[2]){case"ms":m=b;break;case"s":m=1e3*b;break;case"m":m=1e3*b*60}o(m/v.frameTimeFactor);break}}u=it.createNext(p(l)),o(1)}u&&c.push({frame:d>-1?d:f,notification:u}),f=r,a=t},v=this,b=0;b<u;b++)h(b),b=a;return c},t.prototype.run=function(e){var n=t.frameTimeFactor,r=this.maxFrames;t.frameTimeFactor=1,this.maxFrames=Number.POSITIVE_INFINITY,this.runMode=!0,Ge.delegate=this;var i={cold:this.createColdObservable.bind(this),hot:this.createHotObservable.bind(this),flush:this.flush.bind(this),expectObservable:this.expectObservable.bind(this),expectSubscriptions:this.expectSubscriptions.bind(this)};try{var o=e(i);return this.flush(),o}finally{t.frameTimeFactor=n,this.maxFrames=r,this.runMode=!1,Ge.delegate=void 0}},t}(St),Lu=A(Object.freeze({__proto__:null,TestScheduler:ju})),qu=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Observable=Er.Observable,t.Subject=Er.Subject,t.AnonymousSubject=Vs.AnonymousSubject;var n=Vs;t.config=n.config;var r=Er;t.Subscription=r.Subscription,t.ReplaySubject=r.ReplaySubject,t.BehaviorSubject=r.BehaviorSubject,t.Notification=r.Notification,t.EmptyError=r.EmptyError,t.ArgumentOutOfRangeError=r.ArgumentOutOfRangeError,t.ObjectUnsubscribedError=r.ObjectUnsubscribedError,t.UnsubscriptionError=r.UnsubscriptionError,t.pipe=r.pipe,t.TestScheduler=Lu.TestScheduler;var i=Er;t.Subscriber=i.Subscriber,t.AsyncSubject=i.AsyncSubject,t.ConnectableObservable=i.ConnectableObservable,t.TimeoutError=i.TimeoutError,t.VirtualTimeScheduler=i.VirtualTimeScheduler,t.AjaxResponse=Or.AjaxResponse,t.AjaxError=Or.AjaxError,t.AjaxTimeoutError=Or.AjaxTimeoutError;var o=Er,s=Vs,a=Vs;t.TimeInterval=a.TimeInterval,t.Timestamp=a.Timestamp,t.operators=qs;var u={asap:o.asapScheduler,queue:o.queueScheduler,animationFrame:o.animationFrameScheduler,async:o.asyncScheduler};t.Scheduler=u;var c={rxSubscriber:s.rxSubscriber,observable:s.observable,iterator:s.iterator};t.Symbol=c})),Uu=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(qu)})),Du=T(Uu),Vu=sm.visitorId,Fu=function(){return Vu},Bu=new Du.Subject(1),Hu=function(){return Bu.asObservable().startWith(Fu()).distinctUntilChanged()},Wu=function(e){Vu=e,Bu.next(e),sm.visitorId=e},Gu=function(){return sm.siteId},zu=new Du.BehaviorSubject(sm.authenticatedExternally||!1),Ju=function(){return zu.value},Yu=function(e){zu.next(Boolean(e))},Qu=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];try{var n=new URL(e),r=Array.from(n.searchParams.keys());return r.forEach((function(e){t.includes(e)||n.searchParams.set(e,"FILTERED")})),n.toString()}catch(t){return e}},Ku=new function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.publishInterval,n=void 0===t?3e3:t,r=e.maximumBatchSize,i=void 0===r?50:r,o=e.maximumBufferSize,s=void 0===o?1e3:o,a=e.maximumConsecutiveRetries,u=void 0===a?10:a,c=e.transports,l=void 0===c?[]:c,f=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.position;void 0===n&&(n=l.length),l.splice(n,0,e)},p={},d={},h=function e(t){var n=t.transports,r=t.payload;return 0===n.length?Promise.reject():n[0].process({payload:r}).catch((function(){return e({payload:r,transports:n.slice(1)})}))},v=function(e){return 0===Object.keys(e).length||Y(e).every((function(e){return 0===e.length}))},b=function(){var e={};return Object.keys(p).forEach((function(t){e[t]=p[t].splice(0,i)})),v(e)?Promise.resolve():h({transports:l,payload:e}).then((function(){return Object.keys(d).forEach((function(e){return d[e]=0})),Promise.resolve()})).catch((function(){return Object.keys(e).forEach((function(t){d[t]++,d[t]<u?p[t]=e[t].concat(p[t]):d[t]=0})),Promise.reject()}))},m=!1,g=null,y=!1,_=function(){if(m)throw new Error("Publisher is already started");m=!0,g=setInterval((function(){y||(y=!0,b().then((function(){return y=!1}),(function(){return y=!1})))}),n),window.addEventListener("unload",b)},w=function(){m=!1,clearInterval(g)},E=function(e,t){p[e]||(d[e]||(d[e]=0),p[e]=[]),p[e].push(t),p[e].splice(s)};return{start:_,stop:w,addToBucket:E,flush:b,buckets:p,addTransport:f,transports:l}}({publishInterval:sm.conf.log_publish_interval_ms||3e3});Ku.start(),Ku.addTransport(new Q.HttpTransport({url:sm.conf.client_logger_url,method:"POST",encode:function(e){var t=e.logs,n=e.stats;return JSON.stringify({logs:t||[],stats:n||[]})}}));sm.logger=new function e(t){var n=arguments,r=t.publisher,i=t.tags,o=void 0===i?{}:i,s=t.currentIsoDate,a=void 0===s?function(){return(new Date).toISOString()}:s,u=t.maxObjectDepth,c=void 0===u?3:u,l=t.maxArrayLength,f=void 0===l?10:l,p=t.windowConsole,d=void 0===p?window.console:p,h=t.localStorage,v=void 0===h?window.localStorage:h,b=t.liveLogsKey,m=void 0===b?"sm.live_logs":b,g=t.liveLogsEnabled,y=void 0!==g&&g,_=t.whitelist,w=void 0===_?{}:_,E=0===Object.keys(w).length,O=new H,S=function(e){return r.addToBucket("logs",e)},T=function(){return d&&(y||"1"===v[m])},k=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if(c===t)return["-pruned-"];for(var r=[],i=0;i<e.length;i++){if(i===f){var o=e[i-1];Array.isArray(o)?r.push(["-pruned-"]):o&&"object"===U(o)?r.push({pruned:!0}):r.push("-pruned-");break}r.push(N(e[i],t+1,n))}return r},A=function(e,t){var n,r=e,i=B(t);try{for(i.s();!(n=i.n()).done;){var o=n.value;if(!r||!r.hasOwnProperty(o))return;r=r[o]}}catch(e){i.e(e)}finally{i.f()}return r},x=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if(t===c)return"-pruned-";var r={};return z(e,(function(i){var o=e[i];E||A(w,[].concat(D(n),[i]))?r[i]=N(o,t+1,[].concat(D(n),[i])):Array.isArray(o)?r[i]=["-redacted-"]:o&&"object"===U(o)?r[i]={redacted:!0}:r[i]="-redacted-"})),r},I=function(e){return{message:e.message,stack:e.stack}},N=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];return-1!==J.indexOf(U(e))?e:"function"==typeof e?"<Function>":null===e?null:e instanceof Error?I(e):Array.isArray(e)?k(e,t,n):x(e,t,n)},M=function(e){return function(){if(T()){var t=d[e]||d.log;t.apply(t,arguments)}var n=Array.prototype.slice.call(arguments).map((function(e){return N(e,0)})).filter((function(e){return void 0!==e})),r=G(o);r=W(r,{level:e,attributes:n,timestamp:a()}),"error"===e?r=W(r,{breadcrumbs:O.list}):O.add(r),S(r)}},R=function(e){return e.filter((function(e){return e instanceof Error}))[0]};this.debug=M("debug"),this.log=M("info"),this.info=M("info"),this.warn=M("warn"),this.error=function(){var e=Array.prototype.slice.call(arguments),t=R(e);if(!t||!t._acked)return"string"!=typeof e[0]||t||(e[0]=new Error(e[0])),M("error").apply(null,e)},this.withTags=function(t){return new e(W(n[0],{tags:W(o,t)}))},this.enableLiveLogs=function(){return v[m]="1"}}({publisher:Ku,tags:{actor:"visitor",site_id:sm.siteId,visitor_id:function(){return Fu()},tab_id:function(){return sm.tabId},user_agent:window.navigator.userAgent,url:function(){return Qu(String(window.location))},client_version:function(e){e||(e="visitor/bootstrapper-b69d123fb-c94131007.js");var t=e.split("-")[1];if(t)return t.slice(0,-3)}()},whitelist:{"@timestamp":!0,accurate_difference:!0,accurate_recording_time:!0,accurate_start_time:!0,action:!0,activeTicket:{id:!0},actor:!0,app:!0,application:!0,applied_background_type:!0,asset_url:!0,assumed_visitor_id:!0,attributes:!0,audio_direction:!0,audio_permissions_required:!0,audio_type:!0,blank_attributes:!0,browser:!0,caller:!0,canReceive:{audio:!0,video:!0},canSend:{audio:!0,video:!0},canShareScreen:!0,candidate:!0,category:!0,cause:!0,channelUrl:!0,channel_url:!0,clear_previous:!0,client_version:!0,code:!0,component_name:!0,conferenceId:!0,conference_id:!0,configured_background_type:!0,constraints:{audio:!0,video:!0},countClientButtons:!0,createdAt:!0,current_result:!0,custom_command_id:!0,difference:!0,duration:!0,early_recording:!0,ended_engagements:{capabilities:!0,end_reason:!0,id:!0,restarted_from_engagement_id:!0,site_id:!0,status:!0,sub_engagement_id:!0,visitor:!0},engagementId:!0,engagement_id:!0,engagement_requests:{id:!0,operator_id:!0,outcome:!0,site_id:!0},engagements:{capabilities:!0,id:!0,restarted_from_engagement_id:!0,site_id:!0,status:!0,sub_engagement_id:!0,visitor:!0},enqueuedInCurrentTab:!0,err:{cause:!0,message:!0,stack:!0,error:!0,type:!0},error:!0,error_count:!0,error_status_code:!0,event:{isTrusted:!0},eventName:!0,feature:!0,fn:!0,found_tab_id:!0,glia_team:!0,ice_connection_state:!0,id:!0,identifier:!0,identity:!0,idle_for:!0,iframe_src:!0,index_name:!0,interval_seconds:!0,isAsyncTransfer:!0,isEngaged:!0,isReestablishing:!0,isTransfer:!0,isVisitorAuthenticatedExternally:!0,is_active_tab:!0,kube_container:!0,kube_host:!0,kube_namespace:!0,kube_pod:!0,label:!0,level:!0,localVideoProvider:!0,localVideoType:!0,locale:!0,major_browser_version:!0,media:!0,media_options:{one_way:!0,oneWay:!0},medra_version:!0,message:!0,"message-1":{capabilities:{text:!0},channel_url:!0,engagement_request_id:!0,entrypoint:!0,id:!0,media:{audio:!0},operator:{id:!0,media_type:!0,teams:!0},platform:!0,restarted_from_engagement_id:!0,site_id:!0,start_time:!0,status:!0,sub_engagement_id:!0,sub_engagement_legacy_id:!0,transferrable_sites:!0,visitor:{authenticated:!0,browser_tab_id:!0}},message_id:!0,modified_url:!0,newScreenSessionId:!0,new_result:!0,new_tab_id:!0,new_transport:!0,observations:{id:!0,operator_id:!0,site_id:!0},oldScreenSessionId:!0,online:!0,operator:{assignment:{type:!0},id:!0,state:{available:!0,media:!0,medias:!0,oneWayMedias:!0}},operatorId:!0,operatorMedia:!0,operator_id:!0,options:{oneWay:!0,operatorId:!0,source:!0},origin:!0,original_url:!0,params:{tabId:!0,visitor_priority:!0,URL:!0,account_actions:!0,arg:!0,"engagement id":!0,engagement_id:!0,engagement_media:!0,operator_id:!0,proactive_reactive:!0,"site id":!0,source:!0,starting_media:!0,type:!0,url:!0,"visitor id":!0,visitor_id:!0,accountAction:!0,dealerId:!0,overseerID:!0,overseerName:!0,sm_url:!0,elementClassName:!0,showVisitorCode:!0,elementId:!0,queueID:!0,elementText:!0,elementTagName:!0,custom:!0,site:!0,visitor:!0},pubsub_data:{allow_rejection:!0,dispatched_at:!0,engagement:{ended_engagements:!0,engagements:!0,observations:!0,requests:!0},event_id:!0,event_type:!0,headers:{accept:!0,"content-type":!0,"x-salemove-tab-id":!0},idle_timeout_seconds:!0,isTrusted:!0,joins:{self:!0},leaves:{self:!0},medias:!0,method:!0,page_description:!0,page_url:!0,payload:{action:!0,media:!0,media_options:!0,pause_async:!0,queue_id:!0,site_id:!0,source:!0,visitor_id:!0,visitor_metadata:!0,queue_ids:!0},queue_id:!0,response:{headers:!0,status:!0},self:{metas:!0},state:!0,status:!0,tab_id:!0,topics:!0,url:!0,visitor_metadata:{browser_name:!0,browser_type:!0,device_type:!0,os_type:!0},authentication_requests:!0,omniq:{queue_tickets:!0},message:{engagement_id:!0,id:!0,sender:!0,status:!0,sub_engagement:!0,sub_engagement_id:!0,target:!0,timestamp:!0,type:!0},typing_indicator:{clock:!0,engagement_id:!0,sender:!0,sub_engagement_id:!0,typing:!0},undelivered_messages:!0},q2_user_id:!0,queueState:{medias:!0,state:!0},queue_ids:!0,queue_state:!0,queue_ticket_id:!0,queue_tickets:{id:!0,site_id:!0,state:!0},queued:!0,reason:!0,recording_time:!0,remoteVideoProvider:!0,remoteVideoType:!0,response_body:!0,route:!0,routing:{queues:!0},rule_id:!0,rule_name:!0,screenId:!0,screenSessionId:!0,sdp:!0,sdpMLineIndex:!0,sdpMid:!0,send_to_server:!0,siteId:!0,site_id:!0,source:!0,source_id:!0,stack:!0,start_time:!0,startingMedia:!0,status:!0,stream:!0,subEngagementId:!0,sub_engagement_uuid:!0,tab_id:!0,team_ids:!0,timestamp:!0,topic:!0,transport:!0,twilio_error_code:!0,twilio_error_description:!0,type:!0,updated_webcomponents:!0,upgrade_request:{id:!0,video:!0,audio:!0},url:!0,user_agent:!0,video_direction:!0,video_permissions_required:!0,video_type:!0,visibility_state:!0,visitorLeftReason:!0,visitor_code:!0,visitor_id:!0,visitor_metadata:{browser_name:!0,browser_type:!0,device_type:!0,os_type:!0},warningName:!0,webrtc_mode:!0,window_name:!0,attempt:!0,authentication_provider_id:!0,constructor:!0,engagement_request_id:!0,offer:{video:!0},payload:{media:!0,queue_id:!0,queue_ids:!0,source:!0},remoteAudioType:!0,request:{audio:!0,video:!0},status_text:!0,webhooks:!0,candidate_info:{candidate:!0,sdpMLineIndex:!0,sdpMid:!0},component:!0,description_info:{sdp:!0,type:!0},foundation:!0,prefix:!0,priority:!0,protocol:!0,readyState:!0,relatedAddress:!0,relatedPort:!0,responseURL:!0,state:!0,statusText:!0,tcpType:!0,timeout:!0,toJSON:!0,cached_queues_length:!0,error_cause:!0,error_message:!0,response:{error:!0,stack:!0},target:!0,generation:!0,iframe_class:!0,"network-cost":!0,source_attributes:{element_class_name:!0,element_id:!0,element_tag_name:!0,element_text:!0},tag_name:!0,ufrag:!0,custom_code_url:!0,dependencies:!0,details:{site_ids:!0},elementSelector:!0,element_selector:!0,new_url:!0,queue_id:!0,queue_states:{id:!0,status:!0},queue_status:!0,selector:!0,source_type:!0,tagFunction:!0,tagId:!0,url_length:!0,debug_message:!0,ref:!0,rx_version:!0,sub_engagement_id:!0,context:!0,rejoin_count:!0,action_attributes:{browser_event_conditions:{queue_ids:!0},frequency:{type:!0,filters:{timeframe:!0}},id:!0,in_browser:!0,rule_name:!0,type:!0,duration:!0,horizontal_offset:!0,no_operators_online_text:!0,text:!0,vertical_offset:!0,clear_previous:!0,operator_team_id:!0,priority:!0,fields:!0,provider:!0,tag_function:!0,tag_id:!0,action:!0,category:!0},__sm__mutation_summary_node_map_id__:!0,browser_event_conditions:{queue_ids:!0},client_webrtc_mode:!0,fields:!0,frequency:{filters:!0,max_occurrences:!0,type:!0},in_browser:!0,lastSelectedTimeframe:!0,provider:!0,server_webrtc_mode:!0,tag_function:!0,tag_id:!0,webrtc_modes_different:!0,session_id:!0,sm_version:!0,error_details:{resource:!0},to_save_key:!0,to_save_value:!0,relayProtocol:!0,transitionReason:!0}});var Xu,$u=sm.logger,Zu=new Z(new function e(t){var n=t.publisher,r=t.globalTags,i=void 0===r?[]:r,o=function(e){return n.addToBucket("stats",e)},s=function(e,t,n,r){return r||(r=[]),{stat:e,params:[t,n,i.concat(r)]}};this.increment=function(e,t,n){isNaN(parseInt(t))&&(n=t,t=1),o(s("increment",e,t,n))},this.decrement=function(e,t,n){isNaN(parseInt(t))&&(n=t,t=1),o(s("decrement",e,t,n))},this.gauge=function(e,t,n){o(s("gauge",e,t,n))},this.histogram=function(e,t,n){o(s("histogram",e,t,n))},this.timing=function(e,t,n){o(s("timing",e,t,n))},this.set=function(e,t,n){o(s("set",e,t,n))},this.withTags=function(t){return new e({publisher:n,globalTags:i.concat(t)})}}({publisher:Ku,globalTags:["application:visitor","visitor_page_adaption:".concat(sm.conf.engagement.visitor_page_adaption)]}),(Xu={},{record:function(e){Xu[e]=Number(new Date)},currentLatencyFrom:function(e){var t=Xu[e];return t?Number(new Date)-t:-1}})),ec="sm.app.visitor_api.dynamic_import",tc="default"===sm.conf.communications.lib,nc=function(e){return-1!==sm.conf.assets.server.indexOf("libs.")?"".concat(sm.conf.assets.server,"/").concat(e):[sm.conf.assets.server,sm.conf.assets.prepend||"/",e].join("")},rc={Medra:{url:tc?"https://libs.salemove.com/medra-5.6.7.min.js":sm.conf.communications.lib,returning:function(){return sm.Medra},integrity:tc?j({name:"medra"}):null,gliaTeam:"media"},Comms:{url:nc("visitor_app/comms/app-b69d123fb-c94131007.js"),integrity:j({name:"comms"}),gliaTeam:"media"},Cobra:{url:"".concat(sm.conf.cobra.lib.visitor,".js"),returning:function(){return sm.Cobra},integrity:j({name:"visitor_cobra"}),gliaTeam:"engage"},webcomponents:{url:nc("visitor/webcomponents-b69d123fb-c94131007.js"),integrity:j({name:"webcomponents"}),gliaTeam:"engage"},webcomponents_es5:{url:nc("visitor/webcomponents_es5-b69d123fb-c94131007.js"),integrity:j({name:"webcomponents_es5"}),gliaTeam:"engage"},legacy_webcomponents:{url:nc("visitor/legacy_webcomponents-b69d123fb-c94131007.js"),integrity:j({name:"legacy_webcomponents"}),gliaTeam:"engage"}},ic={},oc=function(e){var t,n=rc,r=L,i=Zu,o=ic;"string"==typeof e?t=e:(t=e.target,e.loader&&(r=e.loader),e.possibleTargets&&(n=e.possibleTargets),e.stats&&(i=e.stats),e.loaded&&(o=e.loaded));var s=n[t];if(!s)return Du.Observable.throw("Invalid target");if(o[t]){if(s.returning){var a=s.returning();return void 0===a?Du.Observable.throw(new Error("An error occurred while loading ".concat(t,", as it is undefined"))):Du.Observable.of(a)}return Du.Observable.of(null)}return Du.Observable.create((function(e){r({fileUrl:s.url,integrity:s.integrity,onAttempt:function(){i.increment(ec,["action:attempted","module:".concat(t),"glia_team:".concat(s.gliaTeam)])},onLoad:function(){if(o[t]=!0,s.returning){var n=s.returning();void 0===n?(i.increment(ec,["action:failed","module:".concat(t),"glia_team:".concat(s.gliaTeam)]),e.error(new Error("An error occurred while loading ".concat(t,", as it is undefined")))):(i.increment(ec,["action:succeeded","module:".concat(t),"glia_team:".concat(s.gliaTeam)]),e.next(n),e.complete())}else i.increment(ec,["action:succeeded","module:".concat(t),"glia_team:".concat(s.gliaTeam)]),e.next(),e.complete()},onError:function(){i.increment(ec,["action:warning","module:".concat(t),"glia_team:".concat(s.gliaTeam)])},onGiveUp:function(){i.increment(ec,["action:failed","module:".concat(t),"glia_team:".concat(s.gliaTeam)]);var n=new Error("Loading ".concat(t," failed"));$u.warn(n,{target:t}),n._acked=!0,e.error(n)},retryLimit:3,backoffDelay:500})}))},sc={MSG:{PROACTIVE_REQUEST:"proactive_call:request",PROACTIVE_ACCEPT:"proactive_call:accept",PROACTIVE_DECLINE:"proactive_call:decline",REACTIVE_ENGAGEMENT_REQUEST_TIMEOUT:"reactive_engagement_request_timeout",ENGAGEMENT_PREPARE:"engagement:prepare",ENGAGEMENT_CLEANUP:"engagement:cleanup",DISCONNECT:"connection_lost",RECONNECTED:"connection_restored",MEDIA_SELECTED:"media_selected",ENGAGEMENT_TRANSFERRED:"engagement:transferred",ENGAGEMENT_END_POPUP_CLOSED:"engagement:end:popup:closed",PUBLIC:{ENGAGEMENT_START:"sm:engagement:start",ENGAGEMENT_END:"sm:engagement:end",ENGAGEMENT_GET_AUDIO_TYPE:"sm:engagement:get_audio_type",ENGAGEMENT_GET_UPGRADE_MEDIA_TYPE:"sm:engagement:get_upgrade_media_type",ENGAGEMENT_MEDIA_UPGRADE_REQUEST:"sm:engagement:media_upgrade_request",ENGAGEMENT_SELECT_MEDIA_TYPE:"sm:engagement:select_media_type",ENGAGEMENT_ERROR:"sm:engagement:error"},WILL_ASK_MEDIA_PERMISSION:"engagement:media_permission:will_ask",SHOW_PERMISSION_ARROW:"communication:show_permission_arrow",HIDE_PERMISSION_ARROW:"communication:hide_permission_arrow",ALLOW_STREAM:"engagement:media_permission:allow",DENY_STREAM:"engagement:media_permission:_deny",IS_ENGAGED:"engagement:is_engaged",PHONE_STATUSES:{CONNECTED:"connected",CONNECTING:"connecting"},ENGAGEMENT_REMOVE_AUDIO:"engagement:remove_audio"}},ac=new Du.Subject;sc.vent={trigger:function(e,t){ac.next({eventName:e,eventBody:t})},observable:function(e){return ac.filter((function(t){return t.eventName===e})).map((function(e){return e.eventBody}))}};var uc={};sc.request=function(e,t){var n=uc[e];if(n)return n(t)},sc.reqres={setHandler:function(e,t){uc[e]=t},removeHandler:function(e){delete uc[e]}};var cc=[],lc=null,fc=function(){(lc=document.createElement("SPAN")).id="cobrowsing-mouse-container",document.body.appendChild(lc);var e=new MutationObserver((function(){var e,t,n=document.body.childNodes[document.body.childNodes.length-1];n!==lc&&-1===cc.indexOf(n)&&(e=document.body,(t=e.childNodes[e.childNodes.length-1])!==lc&&(cc.push(t),setTimeout((function(){cc=[]}),1e4),e.appendChild(lc)))}));return e.observe(document.body,{childList:!0}),{unsubscribe:function(){e.disconnect()}}},pc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Observable=Er.Observable})),dc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(pc)})),hc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.combineLatest=Er.combineLatest})),vc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(hc)})),bc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.from=Er.from})),mc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(bc)})),gc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Subject=Er.Subject})),yc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(gc)})),_c=function(){function e(t){var n=t.duration;s(this,e),this.duration=n}return u(e,[{key:"perform",value:function(){sc.vent.trigger("trigger_expand_reactive",{duration:this.duration})}}]),e}(),wc=function(){function e(t){var n=t.text,r=t.no_operators_online_text,i=t.duration,o=t.priority;s(this,e),this.text=n,this.noOperatorsOnlineText=r,this.duration=i,this.priority=o}return u(e,[{key:"perform",value:function(){sc.vent.trigger("trigger_reactive_callout",{text:this.text,noOperatorsOnlineText:this.noOperatorsOnlineText,duration:this.duration,priority:this.priority})}}]),e}(),Ec=function(){function e(t){var n=t.text;s(this,e),this.text=n}return u(e,[{key:"perform",value:function(){sc.vent.trigger("trigger_media_selection",{text:this.text,source:"callout"})}}]),e}(),Oc=function(){function e(){s(this,e)}return u(e,[{key:"perform",value:function(){sc.vent.trigger("reactive_bar:enable")}}]),e}(),Sc=function(){function e(){s(this,e)}return u(e,[{key:"perform",value:function(){sc.vent.trigger("reactive_bar:disable")}}]),e}(),Tc=function(){function e(t){var n=t.vertical_offset,r=t.horizontal_offset;s(this,e),this.verticalOffset=n,this.horizontalOffset=r}return u(e,[{key:"perform",value:function(){sc.vent.trigger("reactive_bar:set_position",{verticalOffset:this.verticalOffset,horizontalOffset:this.horizontalOffset})}}]),e}(),kc=function(e){var t=e.category,n=e.action,r=e.label;$u.info("Tracking Google Analytics Event",{category:t,action:n,label:r}),"function"==typeof window.gtag?window.gtag("event",n,{event_category:t,event_label:r}):window._gaq&&window._gaq.push?window._gaq.push(["_trackEvent",t,n,r]):"function"==typeof window.ga&&window.ga("send","event",t,n,r)},Ac=function(){function e(t){s(this,e),this.options=t}return u(e,[{key:"perform",value:function(){switch(this.options.provider){case"google":this.trackGoogle(this.options);break;case"omniture":this.trackOmniture(this.options);break;default:$u.error("Unknown analytics provider",this.options.provider)}}},{key:"trackGoogle",value:function(e){var t=e.category,n=e.action,r=e.fields;kc({category:t,action:n,label:r?JSON.stringify(r):void 0})}},{key:"trackOmniture",value:function(e){!function(e){var t=e.tagFunction,n=e.tagId,r=e.params;try{var i=Object.keys(r||{}).reduce((function(e,t){return t.match(/url/i)&&"string"==typeof r[t]?e[t]=Qu(r[t]):e[t]=r[t],e}),{});$u.info("Tracking Omniture Analytics Event",{tagFunction:t,tagId:n,params:i}),"function"==typeof window[t]&&window[t](n,I.clone(r))}catch(e){$u.warn("Client error occurred during Omniture event tracking",e)}}({tagFunction:e.tag_function,tagId:e.tag_id,params:e.fields})}}]),e}(),xc=function(e,t){var n=t.operator;return n&&-1!==n.teamNames.indexOf(e)},Ic=function(){function e(t){var n=t.operator_team;s(this,e),this.operatorTeam=n}return u(e,[{key:"perform",value:function(e){e.cobraObservable.filter(I.partial(xc,this.operatorTeam)).pluck("cobraSourceInitializer").subscribe((function(e){return e.block()}))}}]),e}(),Nc=function(){function e(t){var n=t.text,r=t.duration;s(this,e),this.text=n,this.duration=r}return u(e,[{key:"perform",value:function(){sc.vent.trigger("show_engagement_invitation",{text:this.text,duration:this.duration})}}]),e}(),Mc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.empty=Er.empty})),Rc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(Mc)})),Cc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.of=Er.of})),Pc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(Cc)})),jc=I.compose(I.isEmpty,I.symmetricDifference);(sm.BusinessRules={}).ACTION_TYPES={SHOW_OPERATORS_IN_SELECTOR_V2:"show_operators_in_selector_v2"};var Lc=function(e){var t=e.event,n=e.site_id,r=e.tab_id;return"business_rules"===t&&n===sm.siteId&&(!r||r===sm.tabId)},qc=function(){function e(){s(this,e)}return u(e,[{key:"perform",value:function(){}}]),e}(),Uc=function(){function e(t){s(this,e),this.expectedAction=t}return u(e,[{key:"perform",value:function(){throw new Error("No handler found for action ".concat(this.expectedAction))}}]),e}(),Dc={expand_operator_selector:_c,reactive_callout:wc,media_selection:Ec,show_reactive_tab_only_when:Oc,hide_reactive_tab:Sc,set_reactive_tab_position:Tc,show_operators_in_selector_v2:qc,send_analytics_event:Ac,hide_page_from_operators:Ic,show_engagement_invitation:Nc},Vc=new yc.Subject,Fc=Vc.pipe(bo());Fc.connect();var Bc=function(){function e(t){var n=t.volatileNotifications,r=t.cobraObservable,i=t.routingObservable;s(this,e),this._performAction=this._performAction.bind(this),this.cobraObservable=r,this.routingObservable=i,this.actionsObservable=Fc.pipe(no(n.pipe(Tn(Lc),Nt(I.prop("payload"))))),this._routingUpdateTimeout=sm.conf.overseer.routing_update_timeout_in_milliseconds}return u(e,[{key:"start",value:function(){return this.actionsObservable.subscribe(this._performAction)}},{key:"_performAction",value:function(e){var t=e.type,n=e.rule_id,r=e.browser_event_conditions,i=this.cobraObservable,o=function(e,t){var n=Dc[e];return n?new n(t):new Uc(e)}(t,e);(function(e){var t=e.expectedQueueIds,n=e.routingObservable,r=e.routingUpdateTimeout,i=e.loggerMetadata,o=void 0===i?{}:i,s=e.logger,a=void 0===s?$u:s;return t?n.pipe(Tn((function(e){var n=e.queue_ids;return!(!n||!t)&&jc(n,t)})),ki(1),vs(r),Gr((function(e){return"TimeoutError"===e.name?a.warn("In-browser business rule action not triggered, expected queue ids not received",I.merge(o,{queue_ids:t})):a.error("In-browser business rule action triggering error",e),Rc.empty()}))):Pc.of(null)})({expectedQueueIds:I.prop("queue_ids",r),routingUpdateTimeout:this._routingUpdateTimeout,routingObservable:this.routingObservable,loggerMetadata:{type:t,rule_id:n}}).subscribe((function(){var t,n;t=e,n={rule_id:I.prop("rule_id",t)},$u.log("In-browser business rule action triggered",n),o.perform(i)}),(function(e){return $u.error("Error from should trigger in-browser action subscription",e)}))}}],[{key:"triggerAction",value:function(e){Vc.next(e)}},{key:"actionTriggers",value:function(e,t){return Fc.pipe(no(e.pipe(Tn(Lc),Nt(I.prop("payload")))),Tn((function(e){return e.type===t})))}}]),e}();sm.BusinessRules.Controller=Bc;var Hc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.merge=Er.merge})),Wc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(Hc)})),Gc=function(e){return{element_text:e.textContent,element_id:e.id,element_tag_name:e.tagName,element_class_name:e.className}},zc=function(e){return!function(e){return 0===e.offsetWidth&&0===e.offsetHeight||e.style&&"none"===e.style.display}(e)},Jc=function(e){for(var t=e.parentElement,n=[];null!==t;)n.push(t),t=t.parentElement;return n},Yc=function(e){return Array.prototype.slice.call(e)},Qc=function(e,t){return(e.matches||e.msMatchesSelector).call(e,t)},Kc=1,Xc=10;function $c(e){if(!e)return null;for(var t=[];e&&e.nodeType===Kc;e=e.parentNode){for(var n=0,r=e.previousSibling;r;r=r.previousSibling)r.nodeType!==Xc&&r.nodeName===e.nodeName&&++n;var i=(e.prefix?e.prefix+":":"")+e.localName,o="["+(n+1)+"]";t.splice(0,0,i+o)}return t.length?"/"+t.join("/"):null}var Zc=new RegExp(/\/([^/[]+)\[(\d+)\]/g),el=new RegExp(/:nth-of-type\(1\)/g);function tl(e,t){if("/"===t)return e;if(t){var n=t.replace(Zc,"$1:nth-of-type($2) > ").slice(0,-2).replace(el,"");return e.querySelector(n)}return null}var nl=function(e,t){return Du.Observable.fromEventPattern((function(n){return e.addEventListener(t,n)}),(function(n){return e.removeEventListener(t,n)}))},rl=function(e,t){return Du.Observable.fromEventPattern((function(n){return e.on(t,n)}),(function(n){return e.off(t,n)}))},il=function(e){return Du.Observable.create((function(t){var n=e.subscribe(t);return function(){return n.unsubscribe()}}))},ol=function(e){return Du.Observable.create((function(t){var n=e.subscribe(t.next.bind(t),t.error.bind(t),t.complete.bind(t));return function(){return n.dispose()}}))},sl=function(e){return e.flatMap((function(e){return Du.Observable.throw(e)}))},al=function(e){return Du.Observable.create((function(t){e.connect(),e.subscribe(t)}))},ul=function(e,t){var n=t.maxRetries,r=t.calculateDelay,i=t.shouldRetry,o=void 0===i?I.always(!0):i,s=t.scheduler,a=void 0===s?Du.Scheduler.asap:s;return e.retryWhen((function(e){return function(e,t){return e.scan((function(e,n){return c({count:e.count+1},t,n)}),{count:0})}(e,"error").flatMap((function(e){var t=e.count,i=e.error;return o(i)&&t<=n?Du.Observable.timer(r(t),a):Du.Observable.throw(i)}))}))},cl=function(e){var t=e.target,n=e.selector;return"function"==typeof t.msMatchesSelector?t.msMatchesSelector(n):"function"==typeof t.matches&&t.matches(n)},ll=function(e){var t=e.pattern;return-1!==e.element.textContent.indexOf(t)},fl=function(e){return e&&e.nodeType===Kc},pl=function(e){var t=e.selector;return t&&-1!==t.indexOf(":contains")},dl=function(e){var t=e.selector,n=t.replace(/'/g,'"').match(/(.*):contains\("([^"]+)"/);if(I.isNil(n))throw new Error("Failed to match :contains selector - ".concat(t));var r=n[1].trim(),i=n[2].trim();if(I.isEmpty(r))throw new Error("The :contains selector has no tag to match");return{cssSelector:r,containsText:i}},hl=function(e){return pl({selector:e})?function(e){var t=e.selector,n=dl({selector:t}),r=n.cssSelector,i=n.containsText,o=Yc(document.querySelectorAll(r));return I.filter((function(e){return ll({pattern:i,element:e})}),o)}({selector:e}):Yc(document.querySelectorAll(e))},vl=function(e,t){return Wc.merge.apply(void 0,w(I.map((function(t){return nl(t,e)}),t)))},bl=function(e){var t=e.elementSelector,n=e.eventName;return vl(n,hl(t))},ml=function(e){var t=e.target,n=e.selector;if(!fl(t))return!1;if(pl({selector:n})){var r=dl({selector:n}),i=r.cssSelector,o=r.containsText;return cl({target:t,selector:i})&&ll({pattern:o,element:t})}return!I.isEmpty(n)&&cl({target:t,selector:n})},gl=function(){function e(t){var n=t.id,r=t.form_selector,i=t.input_selector,o=t.value;s(this,e),this.filteredValueOrFocusout=this.filteredValueOrFocusout.bind(this),this._valueMatching=this._valueMatching.bind(this),this._formatEvent=this._formatEvent.bind(this),this.id=n,this.formSelector=r,this.inputSelector=i,this.value=o}return u(e,[{key:"track",value:function(){return Wc.merge(this._trackTextFields(),this._trackChangeableFields(),this._trackCheckableFields()).pipe(Nt(this._formatEvent))}},{key:"_trackTextFields",value:function(){var e;try{e=vl("keyup",this._getObservableFields("input[type=text], input:not([type]), textarea"))}catch(t){this._recordInvalidSelector(t),e=Rc.empty()}return e.pipe(Tn(this._valueChangingKey),Nt(this._extractValueFromInput),yi(I.equals),Tn(this._valueMatching),Ko(this.filteredValueOrFocusout))}},{key:"_trackChangeableFields",value:function(){var e;try{e=vl("change",this._getObservableFields("select"))}catch(t){this._recordInvalidSelector(t),e=Rc.empty()}return e.pipe(Nt(this._extractValueFromOption),yi(I.equals),Tn(this._valueMatching))}},{key:"_trackCheckableFields",value:function(){var e;try{e=vl("change",this._getObservableFields("input[type=radio], input[type=checkbox]"))}catch(t){this._recordInvalidSelector(t),e=Rc.empty()}return e.pipe(Nt(this._extractValueFromInput),Tn(this._valueMatching))}},{key:"_getObservableFields",value:function(e){if(this.inputSelector)return Yc(document.querySelectorAll(this.inputSelector)).filter((function(t){return ml({target:t,selector:e})}));if(this.formSelector){var t=Yc(document.querySelectorAll("form"+this.formSelector));return I.unnest(I.map((function(t){return Yc(t.querySelectorAll(e))}),t))}return Yc(document.body.querySelectorAll(e))}},{key:"filteredValueOrFocusout",value:function(e){return this.value?Pc.of(e):nl(e.target,"focusout").pipe(Ki(e))}},{key:"_valueChangingKey",value:function(e){return e.keyCode>=45}},{key:"_valueMatching",value:function(e){var t=e.target.value;return!this.value||t.match(new RegExp(this.value))}},{key:"_extractValueFromInput",value:function(e){return{target:e.target,value:e.target.value}}},{key:"_extractValueFromOption",value:function(e){var t=I.find((function(e){return e.selected}),Yc(e.target.querySelectorAll("option")));return{target:e.target,value:t&&t.value}}},{key:"_formatEvent",value:function(e){var t=e.target,n=e.value;return{id:this.id,type:"form_filling",source_attributes:I.merge(Gc(t),{value:n})}}},{key:"_recordInvalidSelector",value:function(e){Zu.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:form_filling","reason:invalid_selector"]),$u.warn("Failed to track form filling. Invalid selector",{error:e,form_selector:this.formSelector,input_selector:this.inputSelector,source_id:this.id})}}]),e}(),yl="clicking",_l=function(){function e(t){var n=t.id,r=t.element_selector,i=t.element_tag,o=t.number,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:$u,u=arguments.length>2&&void 0!==arguments[2]?arguments[2]:500;s(this,e),this._isTargetElementsOrItsChild=this._isTargetElementsOrItsChild.bind(this),this._formatEvent=this._formatEvent.bind(this),this.id=n,this.elementSelector=r,this.elementTag=i,this.number=o,this.logger=a,this.throttleTime=u}return u(e,[{key:"track",value:function(){var e,t,n=this,r=(e=document,t="click",Du.Observable.fromEventPattern((function(n){return e.addEventListener(t,n,!0)}),(function(n){return e.removeEventListener(t,n,!0)}))).pipe(Tn((function(e){return n._isTargetElementsOrItsChild(e.target)}))),i=this.number||1;return function(e,t){var n=e.events,r=e.throttleTime,i=e.numberToTrigger;return n.pipe(us(r,t),Do(i-1))}({events:r,throttleTime:this.throttleTime,numberToTrigger:i}).map(this._formatEvent)}},{key:"_isTargetElementsOrItsChild",value:function(e){var t=this._getElementsSelector();try{var n=hl(t);return I.intersection(n,function(e){for(var t=[];e;)t.push(e),e=e.parentElement;return t}(e)).length>0}catch(e){return Zu.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:".concat(yl),"reason:invalid_selector"]),this.logger.warn(e,"Failed to query DOM element",{elementSelector:t}),!1}}},{key:"_getElementsSelector",value:function(){return this._tagConstraint()+this._selectorConstraint()}},{key:"_tagConstraint",value:function(){return this.elementTag||""}},{key:"_selectorConstraint",value:function(){return this.elementSelector?"".concat(this.elementSelector):""}},{key:"_formatEvent",value:function(e){return{id:this.id,type:yl,source_attributes:Gc(e.target)}}}]),e}(),wl=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.timer=Er.timer})),El=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(wl)}));var Ol=function(){function e(t){var n=t.source_id;s(this,e),this.saveNavigationEvent=this.saveNavigationEvent.bind(this),this.clear=this.clear.bind(this),this._getHistory=this._getHistory.bind(this),this._formatHistory=this._formatHistory.bind(this),this.key="sm_navigations-"+n,this.storage=window.sessionStorage}return u(e,[{key:"saveNavigationEvent",value:function(e){this.storage.setItem(this.key,this._formatHistory(e))}},{key:"anyMatch",value:function(e){return I.any((function(t){return t.match(e)}))(this._getHistory())}},{key:"clear",value:function(){this.storage.removeItem(this.key)}},{key:"_getHistory",value:function(){try{return JSON.parse(this.storage.getItem(this.key))||[]}catch(e){return sm.logger.error("Unexpected format for navigation history in sessionStorage",{error:e}),this.clear(),[]}}},{key:"_formatHistory",value:function(e){var t=I.takeLast(2,I.append(e,this._getHistory()));return JSON.stringify(t)}}]),e}();var Sl=!1;try{var Tl=Object.defineProperty({},"passive",{get:function(){return Sl=!0}});window.addEventListener("sm-passive-test",null,Tl),window.removeEventListener("sm-passive-test",null,Tl)}catch(e){}var kl=function(e,t){return Du.Observable.fromEventPattern((function(n){return e.addEventListener(t,n,!!Sl&&{passive:!0})}),(function(n){return e.removeEventListener(t,n)}))},Al={getStream:function(e){var t,n=I.map((function(e){return kl(document,e)}),e);return Du.Observable.merge((t=Du.Observable).merge.apply(t,w(n)),kl(window,"focus"),kl(window,"pageshow"))}};sm.PeriodicalActivityTracker=Al;var xl=function(){var e=_(void 0!==document.hidden?["hidden","visibilitychange"]:void 0!==document.mozHidden?["mozHidden","mozvisibilitychange"]:void 0!==document.msHidden?["msHidden","msvisibilitychange"]:["webkitHidden","webkitvisibilitychange"],2),t=e[0],n=e[1];if(void 0===document.addEventListener||void 0===t)return Du.Observable.of({focused:void 0});var r=function(){return{visible:!document[t]}};return kl(document,n).map(r).startWith(r())},Il=function(){var e=(window.crypto||window.msCrypto).getRandomValues(new Uint8Array(16));e[6]=15&e[6]|64,e[8]=191&e[8]|128;for(var t="",n=0;n<e.length;n++)e[n]<16&&(t+="0"),t+=e[n].toString(16),[3,5,7,9].indexOf(n)>-1&&(t+="-");return t},Nl=function(e){return"object"===o(e)&&Boolean(e&&e.messageName)},Ml=function(e,t,n){var r={messageName:e,payload:t};return n&&(r.options=n),r};function Rl(e){var t=this,n=new Cl({allowedSource:e});["on","off","start","stop","respondTo"].forEach((function(e){t[e]=n[e].bind(n)})),this.observable=function(e){return rl(n,e)},this.emit=function(t,n,r){e.postMessage(Ml(t,n,r),"*")},this.request=function(e,n,r){var i=e+":response",o=Il();t.on(i,(function e(n,s,a,u){u&&u.requestId===o&&(t.off(i,e),r(n,s,a))})),t.emit(e,n,{requestId:o})}}function Cl(e){var t=this,n=e.allowAnySource,r=e.allowedSource;if(n&&r)throw new Error("Pass allowedSource or allowAnySource, not both");if(!n&&!r)throw new Error("Pass allowedSource or allowAnySource");var i=function(e){if((n||e.source===r)&&Nl(e.data)){var i=e.data,o=i.messageName,s=i.payload,a=i.options;return t.emitEvent(o,[s,e.source,e.origin,a])}};this.start=function(){window.addEventListener("message",i)},this.stop=function(){window.removeEventListener("message",i),t.removeEvent()},this.respondTo=function(e,n){var r=function(t,r,i,o){n(t,(function(t){return r.postMessage(Ml(e+":response",t,o),i)}),r,i)};return t.on(e,r),function(){return t.off(e,r)}}}Cl.prototype=Object.create(x.prototype);var Pl=null,jl=function(){if(!Pl){var e=Al.getStream(["scroll","keyup","mousemove","touchstart","orientationchange"]).share(),t=new Cl({allowAnySource:!0});t.start();var n=rl(t,"activity_from_cobrowsable_iframe"),r=xl().filter(I.propEq("visible",!0));(Pl=Du.Observable.merge(e,n,r).publish()).connect()}return Pl};var Ll=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.interval=Er.interval})),ql=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(Ll)})),Ul=function(e){return e?parseFloat(e.replace(/[^\d\.]+/,"")):null},Dl="number",Vl=function(){function e(t){var n=t.id,r=t.element_selector,i=t.minimum_value;s(this,e),this._elementValues=this._elementValues.bind(this),this._numberMatching=this._numberMatching.bind(this),this._formatEvent=this._formatEvent.bind(this),this.id=n,this.elementSelector=r,this.minimumValue=i}return u(e,[{key:"track",value:function(){return ql.interval(100).pipe(fn(this._elementValues),Tn(this._numberMatching),Nt(this._formatEvent),ki(1))}},{key:"_elementValues",value:function(){var e;try{e=Yc(document.querySelectorAll(this.elementSelector))}catch(t){Zu.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:".concat(Dl),"reason:invalid_selector"]),$u.warn("Failed to track number. Invalid selector",{error:t,element_selector:this.elementSelector,source_id:this.id}),e=[]}return mc.from(I.flatten(e.map(this._elementValue)))}},{key:"_elementValue",value:function(e){return[{element:e,value:Ul(e.innerHTML)},{element:e,value:Ul(e.value)}]}},{key:"_numberMatching",value:function(e){var t=e.value;return"number"==typeof t&&t>=this.minimumValue}},{key:"_formatEvent",value:function(e){var t=e.element,n=e.value;return{id:this.id,type:Dl,source_attributes:I.merge(Gc(t),{value:n})}}}]),e}();var Fl={attributes:!0,characterData:!1,childList:!1,subtree:!1,attributeOldValue:!1,characterDataOldValue:!1};var Bl=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.fromPromise=Er.from})),Hl=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(Bl)}));var Wl={text:"chat",audio:"voice",phone:"phone",video:"video"};var Gl=function(){function e(){s(this,e)}return u(e,[{key:"track",value:function(){return Rc.empty()}}]),e}(),zl={form_filling:gl,clicking:_l,time_on_page:function(e){var t=e.id,n=e.seconds,r=function(){return{id:t,type:"time_on_page",source_attributes:{}}};this.track=function(){return El.timer(1e3*n).pipe(Nt(r))}},mouse_in:function(e){var t=e.id,n=e.element_selector,r=function(e){return{id:t,type:"mouse_in",source_attributes:Gc(e.target)}};this.track=function(){try{return bl({elementSelector:n,eventName:"mouseenter"}).pipe(Nt(r))}catch(e){return Zu.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:mouse_in","reason:invalid_selector"]),$u.warn("Failed to track mouse in. Invalid selector",{error:(null==e?void 0:e.message)||e,element_selector:n,source_id:t}),Rc.empty()}}},mouse_out:function(e){var t=e.id,n=e.element_selector,r=function(e){return{id:t,type:"mouse_out",source_attributes:Gc(e.target)}};this.track=function(){try{return bl({elementSelector:n,eventName:"mouseleave"}).pipe(Nt(r))}catch(e){return Zu.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:mouse_out","reason:invalid_selector"]),$u.warn("Failed to track mouse out. Invalid selector",{error:e,element_selector:n,source_id:t}),Rc.empty()}}},scrolling:function(e){var t=e.id,n=e.percentage,r=function(){return{id:t,type:"scrolling",source_attributes:{}}},i=function(){var e=window.pageYOffset,t=window.innerHeight;return e/(document.documentElement.scrollHeight-t)*100>n};this.track=function(){return nl(window,"scroll").pipe(Tn(i),Nt(r),ki(1))}},navigation:function(e){var t=e.id,n=e.path,r=function(){return{id:t,type:"navigation",source_attributes:{}}};this.track=function(){var e=new RegExp(n,"i");return sm.hrefObservable.pipe(Tn((function(t){return t.match(e)})),Nt(r))}},activity:function(e){var t=e.id,n=function(){return{id:t,type:"activity",source_attributes:{}}};this.track=function(){return El.timer(6e4).pipe(ro(jl()),ki(1),mo(),Nt(n))}},number:Vl,element_created:function(e){var t=e.id,n=e.element_selector,r=e.on_page_load;this.track=function(e){var i=e.options;return n?i.initialLoad&&!r?Rc.empty():Pc.of({id:t,type:"element_created",source_attributes:{}}):Rc.empty()}},element_changed:function(e){var t=e.id,n=e.element_selector,r=function(e){return{id:t,type:"element_changed",source_attributes:Gc(e.target)}};this.track=function(e){var i=e.options,o=i.triggerObservable,s=i.mutationObserver;try{hl(n).forEach((function(e){s.observe(e,Fl)}))}catch(e){Zu.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:element_changed","reason:invalid_selector"]),$u.warn("Failed to observe element changes. Invalid selector",{error:e,element_selector:n,source_id:t})}return o.pipe(Nt(r))}},transfer:function(e){var t=e.id,n=function(e){return{id:t,type:"transfer",source_attributes:{operator_id:e.operatorId,operator_name:e.operatorName,starting_media:e.startingMedia}}};this.track=function(){return sc.vent.observable(sc.MSG.ENGAGEMENT_TRANSFERRED).pipe(Nt(n))}},proactive_accept:function(e){var t=e.id,n=function(e){var n=e.operator;return{id:t,type:"proactive_accept",source_attributes:{operator_id:n.id,operator_name:n.name}}};this.track=function(){return sc.vent.observable(sc.MSG.PROACTIVE_ACCEPT).pipe(bi(I.prop("engagement_request_id")),Nt(n))}},proactive_decline:function(e){var t=e.id,n=function(e){var n=e.operator;return{id:t,type:"proactive_decline",source_attributes:{operator_id:n.id,operator_name:n.name}}};this.track=function(){return sc.vent.observable(sc.MSG.PROACTIVE_DECLINE).pipe(Nt(n))}},engagement_start:function(e){var t=e.id,n=function(e){var n=e.operator,r=e.startingMedia,i=e.engagementId,o=e.type;return{id:t,type:"engagement_start",source_attributes:{operator_id:n.id,operator_name:n.name,proactive_or_reactive:o,engagement_media:Wl[r],engagement_id:i}}};this.track=function(){return Hl.fromPromise(sm.getApi({version:"v1"})).pipe(fn((function(e){return e.observable(e.EVENTS.ENGAGEMENT_START)})),Tn(I.complement(I.prop("isReestablishing"))),Nt(n))}},reactive_engagement_request_timeout:function(e){var t=e.id,n=function(e){var n=e.operator;return{id:t,type:"reactive_engagement_request_timeout",source_attributes:{operator_id:n.id,operator_name:n.name}}};this.track=function(){return sc.vent.observable(sc.MSG.REACTIVE_ENGAGEMENT_REQUEST_TIMEOUT).pipe(Nt(n))}},consecutive_navigation:function(e,t){var n=e.id,r=e.to,i=e.from,o=t||new Ol({source_id:n}),s=function(){return o.anyMatch(new RegExp(i,"i"))},a=function(){return{id:n,type:"consecutive_navigation",source_attributes:{}}};this.track=function(){return sm.hrefObservable.pipe(Tn((function(e){return e.match(new RegExp(i,"i"))}))).subscribe(o.saveNavigationEvent),sm.hrefObservable.pipe(Tn(I.both((function(e){return e.match(new RegExp(r,"i"))}),s)),os(o.clear),Nt(a))}},enqueued:function(e){var t=e.id;this.track=function(e){var n=e.internalVisitorStateObservable,r=["enqueued","request_sent"],i=I.propEq("site_id",sm.siteId),o=I.compose(I.filter(i),I.pathOr([],["omniq","queue_tickets"])),s=I.compose(I.nth(0),I.filter((function(e){var t=I.lensPath(["visitor","browser_tab_id"]);return I.compose(I.equals(sm.tabId),I.view(t))(e)})),I.filter((function(e){return-1!==r.indexOf(e.state)})),o);return n.pipe(Nt(s),Tn(I.identity),yi(null,I.prop("id")),Nt((function(e){return{id:t,type:"enqueued",source_attributes:{ticket_id:e.id}}})))}}},Jl={buildObservable:I.curry((function(e,t,n){var r=function(e){var t=e.sources,n=e.internalVisitorStateObservable,r=e.options;return 0===Object.keys(t).length?Rc.empty():new(zl[t.type]||Gl)(t).track({internalVisitorStateObservable:n,options:r})}({sources:t.sources,internalVisitorStateObservable:e,options:n});return t.url_matcher?r.pipe(Rs(function(e){var t=new RegExp(e,"i");return sm.hrefObservable.pipe(Nt((function(e){return e.match(t)})),yi(I.equals))}(t.url_matcher),(function(e,t){return{value:e,isMatching:t}})),Tn(I.prop("isMatching")),Nt(I.prop("value"))):r}))},Yl=function(){function e(){s(this,e)}return u(e,null,[{key:"observable",value:function(e,t){var n=this._selectorsToObserveOnElementCreated(e.sources);return n.length>0?this._trackCreatedElements(e,n,t):Pc.of({})}},{key:"_trackCreatedElements",value:function(e,t,n){var r=this._initiateSourceAttributes(e.sources);return n.pipe(Nt((function(e){return{target:e,initialLoad:!1}})),Yo({target:document.body,initialLoad:!0}),Tn(this._filterBySourceType({source:e.sources,selectors:t,rawRule:e})),Nt(I.pick(["initialLoad"])),Nt(I.merge(r)))}},{key:"_filterBySourceType",value:function(e){var t=this,n=e.source,r=e.selectors,i=e.rawRule;return function(e){var o=e.target;return!(!e.initialLoad||"element_created"===n.type)||t._targetMatchesAny(o,r,i,n)}}},{key:"_initiateSourceAttributes",value:function(e){switch(e.type){case"element_changed":return this._getElementChangedAttributes(e);default:return{}}}},{key:"_getElementChangedAttributes",value:function(e){var t=new yc.Subject,n=new MutationObserver((function(n){return I.forEach((function(n){if(ml({target:n.target,selector:e.desired_selector}))return t.next(n)}),n)}));return{triggerObservable:t.asObservable(),mutationObserver:n}}},{key:"_selectorsToObserveOnElementCreated",value:function(e){switch(e.type){case"form_filling":return[e.form_selector,e.input_selector];case"mouse_in":case"mouse_out":case"element_changed":case"element_created":return[e.element_selector];default:return[]}}},{key:"_targetMatchesAny",value:function(e,t,n,r){return I.any((function(t){try{return ml({target:e,selector:t})||function(e){var t=e.target,n=e.selector;return!(!fl(t)||!t.hasChildNodes())&&I.any((function e(t){var r=ml({target:t,selector:n});return!r&&t.hasChildNodes()?I.any(e,t.childNodes):r}),t.childNodes)}({target:e,selector:t})}catch(e){return Zu.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:".concat(r.type),"reason:invalid_selector"]),$u.warn("Failed to track element. Invalid selector",{error:e&&e.message,selector:t,source_type:r.type,rule_id:n.id}),!1}}),t)}}]),e}();function Ql(e){return(Ql="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Kl(e){return function(e){if(Array.isArray(e))return Xl(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return Xl(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Xl(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Xl(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var $l,Zl=function(e,t,n){var r={};for(var i in n)r[i]=n[i];return r[e]=t,r},ef=function(e){return function t(n){return 0===arguments.length?t:e.apply(this,arguments)}},tf=ef((function(e){return null===e||"object"!==Ql(e)?e:Array.isArray(e)?e.map((function(e){return tf(e)})):Object.keys(e).reduce((function(t,n){return Zl(function(e){var t=e.split("_");return[t[0]].concat(Kl(t.slice(1).map((function(e){return function(e){return"".concat(e.slice(0,1).toUpperCase()).concat(e.slice(1).toLowerCase())}(e)})))).join("")}(n),tf(e[n]),t)}),{})})),nf=ef((function(e){return null===e||"object"!==Ql(e)?e:Array.isArray(e)?e.map((function(e){return nf(e)})):Object.keys(e).reduce((function(t,n){return Zl(n.replace(/\W+/g," ").split(RegExp(" |\\B(?=[A-Z])")).map((function(e){return e.toLowerCase()})).join("_"),nf(e[n]),t)}),{})})),rf=($l=function(e,t){return Object.keys(t).reduce((function(n,r){var i=e[r];if(Array.isArray(i)){var o=t[r];if(!o||"object"!==Ql(o))throw new Error("Nested value should be an object");return Zl(i[0]||r,rf(i[1],o),n)}return Zl(i||r,t[r],n)}),{})},function e(t,n){return 0===arguments.length?e:1===arguments.length?ef((function(e){return $l(t,e)})):$l(t,n)}),of=u((function e(t){var n=t.status,r=t.medias;s(this,e),this.status=n,this.medias=r}));of.prototype.STATUSES={OPEN:"open",CLOSED:"closed",FULL:"full",UNSTAFFED:"unstaffed"};var sf=function(e){return"opened"===e?of.prototype.STATUSES.OPEN:e},af=u((function e(t){var n=t.id,r=t.name,i=t.status,o=t.medias;s(this,e),this.id=n,this.name=r,this.state=new of({status:i,medias:o})})),uf={SALEMOVE:{ALREADY_QUEUED:"already queued",INVALID_INPUT:"invalid input",OPERATOR_UNAVAILABLE:"operator unavailable",INTERNAL_ERROR:"internal error",RESOURCE_NOT_FOUND:"not found",OPERATOR_DECLINED:"operator declined",DECLINE:"decline",CANCEL:"cancel",TIMEOUT:"timeout",NETWORK_TIMEOUT:"network timeout",CONNECTION_LOST:"connection lost",TOO_MANY_REQUESTS:"too many requests",FORBIDDEN:"forbidden",NOT_SUPPORTED:"not supported",DISABLED:"disabled",ALREADY_ENGAGED:"already engaged",CONFLICT:"conflict",FILE_CONTENT_TYPE_NOT_ALLOWED:"file content type not allowed",FILE_TOO_LARGE:"file too large",DENIED_BY_PERMISSIONS_POLICY:"denied by permissions policy",DEVICE_ACCESS_ERROR:"device access error",DENIED_BY_SYSTEM:"denied by system"}},cf=5e3,lf=["text","phone","audio","video"],ff=[502,503],pf=[400,413,422],df="sm_change_element_attributes",hf="omnicore",vf="omnibrowse",bf={"content-type":"application/json",accept:"application/vnd.salemove.v1+json"},mf=["af","al","dz","as","ad","ao","ai","ag","ar","am","aw","au","at","az","bs","bh","bd","bb","by","be","bz","bj","bm","bt","bo","ba","bw","br","io","vg","bn","bg","bf","bi","kh","cm","ca","cv","bq","ky","cf","td","cl","cn","cx","cc","co","km","cd","cg","ck","cr","ci","hr","cu","cw","cy","cz","dk","dj","dm","do","ec","eg","sv","gq","er","ee","et","fk","fo","fj","fi","fr","gf","pf","ga","gm","ge","de","gh","gi","gr","gl","gd","gp","gu","gt","gg","gn","gw","gy","ht","hn","hk","hu","is","in","id","ir","iq","ie","im","il","it","jm","jp","je","jo","kz","ke","ki","xk","kw","kg","la","lv","lb","ls","lr","ly","li","lt","lu","mo","mk","mg","mw","my","mv","ml","mt","mh","mq","mr","mu","yt","mx","fm","md","mc","mn","me","ms","ma","mz","mm","na","nr","np","nl","nc","nz","ni","ne","ng","nu","nf","kp","mp","no","om","pk","pw","ps","pa","pg","py","pe","ph","pl","pt","pr","qa","re","ro","ru","rw","bl","sh","kn","lc","mf","pm","vc","ws","sm","st","sa","sn","rs","sc","sl","sg","sx","sk","si","sb","so","za","kr","ss","es","lk","sd","sr","sj","sz","se","ch","sy","tw","tj","tz","th","tl","tg","tk","to","tt","tn","tr","tm","tc","tv","vi","ug","ua","ae","gb","us","uy","uz","vu","va","ve","vn","wf","eh","ye","zm","zw","ax"],gf=I.compose(I.chain(I.values),I.values)(uf),yf=u((function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(s(this,e),this.cause=n.cause,n.message&&(this.message=n.message),this.cause&&I.contains(this.cause,gf))||(this.cause=uf.SALEMOVE.INTERNAL_ERROR,(t=sm.logger).error.apply(t,["Incorrect Error usage"].concat(Array.prototype.slice.call(arguments))))})),_f=function(e){var t=String(e);if(0===t.indexOf("[object "))try{t=JSON.stringify(e)}catch(e){t=e instanceof TypeError?"Unable to parse param: ".concat(e.message):"Unexpected parse error ".concat(e)}return t},wf=function(e,t){t||(t={});var n,r=t.logger||$u;return n=e.cause,I.contains(n,I.values(uf.SALEMOVE))?e:function(e,t){if(e||(e={}),t||(t=$u),I.contains(e.status,ff))return new yf({cause:uf.SALEMOVE.INTERNAL_ERROR});if(0===e.status||0===e.readyState)return new yf({cause:uf.SALEMOVE.NETWORK_TIMEOUT});var n="Uncaught error in 'public' observable. Wrapping as an internal error.";return e.details&&(n+=" Details: ".concat(_f(e.details),".")),e.error&&(n+=" Error: ".concat(_f(e.error),".")),e.debug_message&&(n+=" Debug message: ".concat(_f(e.debug_message),".")),e.message&&(n+=" Message: ".concat(_f(e.message))),t.error(n.substr(0,1e3),e),new yf({cause:uf.SALEMOVE.INTERNAL_ERROR})}(e,r)},Ef=function(e){return e||(e={}),Du.Observable.throw(wf(e))},Of=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e instanceof yf)return Du.Observable.throw(e);var n=function(){return I.contains(e.status,pf)?new yf({cause:uf.SALEMOVE.INVALID_INPUT}):409===e.status?new yf({cause:uf.SALEMOVE.CONFLICT}):e.cause===uf.SALEMOVE.NETWORK_TIMEOUT?e:wf(e)},r=n();return t.allowedCauses&&r.cause!==uf.SALEMOVE.INTERNAL_ERROR&&!I.contains(r.cause,t.allowedCauses)?($u.error("Unhandled error treated as internal error",{status:e.status,message:e.message,debug_message:e.debugMessage}),Du.Observable.throw(new yf({cause:uf.SALEMOVE.INTERNAL_ERROR}))):Du.Observable.throw(r)},Sf="queue:multi",Tf={channelObservable:null,topicNotifications:{}},kf=function(e){var t=e.queueId,n=e.name,r=e.state,i=e.medias;return new af({id:t,name:n,status:sf(r),medias:i})},Af=function(e){var t=e.pubsub,n=e.cache;n||(n=Tf);var r=n.channelObservable,i=n.topicNotifications||{};return function(e){var o=I.map(I.concat("queue:"),e);return Du.Observable.create((function(s){if(r){!function(e){var t=e.queueIds,n=e.observer;t.forEach((function(e){var t=i[e];if(t)return n.next(t)}))}({queueIds:e,observer:s}),r.flatMap((function(e){return e.watchNewTopics(o)})).toPromise().catch((function(e){return $u.warn("Unable to update queue pubsub channel topics ",e)}))}else(r=t.joinChannel(Sf,{topics:o}).do((function(){return $u.info("Joined ".concat(Sf," topic"))})).publishReplay(1)).connect(),n.channelObservable=r;return r.flatMap((function(e){return e.observable("change")})).map(rf({queue_id:"queueId"})).filter((function(t){var n=t.queueId;return-1!==e.indexOf(n)})).map(kf).do((function(e){i[e.id]=e})).subscribe(s)}))}},xf=function(e){var t=e.queueIds;return(0,e.observeQueueStateUpdates)(t).pipe(lr((function(e,t){var n=I.findIndex(I.propEq("id",t.id))(e);return-1===n?I.append(t,e):I.equals(I.find(I.propEq("id",t.id))(e),t)?e:I.update(n,t,e)}),[]),yi((function(e,t){return e===t})))};var If=function(e){var t=e.queueIds;return(0,e.observeQueueStateUpdates)(t).pipe(je(I.prop("id")),fn((function(e){return e.distinctUntilChanged()})))},Nf=function(e,t){if(!e)throw new yf({cause:uf.SALEMOVE.INVALID_INPUT,message:"Queue IDs list is undefined"});if(I.isEmpty(e))throw new yf({cause:uf.SALEMOVE.INVALID_INPUT,message:"Queue IDs list is empty"});if(!t)throw new yf({cause:uf.SALEMOVE.INVALID_INPUT,message:"Listener is undefined"})},Mf=function(e){var t=e.enabled,n=e.createQueueStateObservable,r=e.createQueueStateAccumulateObservable,i=e.pubsub;r||(r=xf),n||(n=If);var o=function(e){var n=e.queueIds,o=e.listener;if(t){var s=new Du.Subscription;Nf(n,o);try{var a=r({queueIds:n,observeQueueStateUpdates:Af({pubsub:i})});s.add(a.subscribe(o,$u.error.bind($u,"Failed to receive queue state list updates")))}catch(e){$u.error("Failed subscribe to queue state list updates",e)}return s}};return{subscribe:function(e,r){if(t){var o=new Du.Subscription;Nf(e,r);try{var s=n({queueIds:e,observeQueueStateUpdates:Af({pubsub:i})}).publish();o.add(s.subscribe(r,$u.error.bind($u,"Failed to receive queue state updates"))),o.add(function(e,t){var n=new Du.Subscription;return n.add(t.bufferCount(e.length).take(1).subscribe((function(e){return $u.info("Received initial queue states",{queue_states:I.map((function(e){return{id:e.id,status:e.state.status}}),e)})}))),n.add(t.skip(e.length).subscribe((function(e){return $u.info("Received queue state update",{queue_id:e.id,queue_status:e.state.status})}))),n}(e,s)),o.add(s.connect())}catch(e){$u.error("Failed subscribe to queue state updates",e)}}},subscribeToList:o,subscribeToListAsObservable:function(e){var t=e.queueIds,n=e.subscribeToListFn;return n||(n=o),t?Du.Observable.create((function(e){return n({queueIds:t,listener:e.next.bind(e)})})):Du.Observable.empty()}}},Rf=function(){function e(){s(this,e)}return u(e,[{key:"start",value:function(e,t){var n=t.routingObservable;return this.ruleTracker(t,e).pipe(fn((function(r){var i,o=t.queuesAvailabilityObservable.pipe(ei(100,i));return vc.combineLatest(t.currentStatusObservable,o).pipe(ki(1),Nt((function(t){var i=_(t,2),o=i[0],s=i[1];return{overseerApi:e,bufferedEvents:r,currentStatus:o,queuesState:s,routingObservable:n}})))}))).concatMap(this.actUponRules).subscribe(null,(function(e){$u.error("Error from business rule subscription: ".concat(I.prop("message",e)||e),e)}))}},{key:"ruleTracker",value:function(t,n,r){var i=t.rules,o=t.domInsertObservable,s=t.buildRuleObservable,a=mc.from(i).pipe(fn(Pf),fn(function(e){var t=e.domInsertObservable,n=e.buildRuleObservable;return function(e){return Yl.observable(e,t).pipe(Ko((function(t){return n(e,t)})),Nt((function(t){return I.merge({attrs:t},e)})))}}({domInsertObservable:o,buildRuleObservable:s})),Lo(1)),u=dc.Observable.merge(a.pipe(xr(e.BUFFER_TIME,r)),a.pipe(Qi(null,null)));return a.pipe(ms(u),un((function(e){return e.toArray()})),js(u,(function(e,t){return e})),Tn((function(e){return e.length>0})))}},{key:"actUponRules",value:function(e){var t=e.overseerApi,n=e.currentStatus,r=e.queuesState,i=e.bufferedEvents,o=e.controller,s=void 0===o?Bc:o,a=["visitor_status"];r&&a.push("queues_availability"),i=I.map((function(e){var t=I.map(I.prop("type"),e.conditions);return!I.isEmpty(I.difference(t,a))?I.merge(e,{actions:[],send_to_server:!0}):e}),i);var u=I.filter((function(e){return function(e){var t=e.event,n=e.currentStatus,r=e.queuesState,i=I.all((function(e){return function(e,t,n){return"visitor_status"===e.type?-1!==e.status.indexOf(t):"queues_availability"!==e.type||function(e,t){var n=_(I.partition(I.pathEq(["state","status"],"open"))(t),2),r=n[0],i=n[1],o=function(t){var n=t.id;return I.contains(n,e.queueIds)};if("can_enqueue"===e.compareType)return I.any(o,r);if("cannot_enqueue"===e.compareType)return I.any(o,i)}(rf({queue_ids:"queueIds",compare_type:"compareType"},e),n)}(e,n,r)}),t.conditions);i&&$u.log("Business rule source matched: ",{send_to_server:t.send_to_server,rule_name:t.name,url:Qu(window.location.href),source_id:t.attrs.id,rule_id:t.id});return i}({event:e,currentStatus:n,queuesState:r})}),i),c=I.groupBy((function(e){return e.send_to_server?"serverEvents":"browserEvents"}))(u),l=c.serverEvents||[],f=c.browserEvents||[];u.forEach((function(e){var t=e.actions,n=e.attrs,r=e.id,i=e.name,o=e.browser_event_conditions;if(!I.isEmpty(t))return function(e,t,n,r,i,o){e.forEach((function(e){var s={rule_id:n,rule_name:r,browser_event_conditions:o},a=I.merge(s,function(e,t){t||(t={});if(e.fields){var n=function(e,t){var n={};return t.forEach((function(t){var r=t.key,i=t.value,o=t.custom_value,s="custom"===i?o:e[i];n[r]=s})),n}(I.merge({visitor_id:Fu(),site_id:Gu(),url:window.location.href},t),e.fields);return I.merge(e,{fields:n})}return e}(e,t));i.triggerAction(a)}))}(t,n.source_attributes,r,i,s,o)}));var p=I.filter((function(e){var t=e.actions;return!I.isEmpty(t)}),f),d=I.map((function(e){var t=e.actions;return{ruleId:e.id,actionTypes:I.pluck("type",t)}}),p);return I.isEmpty(d)||function(e){var t=e.overseerApi,n=e.browserEvents;t.sendOverseerMetrics({browserEvents:n})}({overseerApi:t,browserEvents:d}),I.isEmpty(l)?dc.Observable.of(null):function(e,t,n){return e.sourcesTriggered({events:n,resolvedConditions:t,tabId:sm.tabId})}(t,a,I.map((function(e){var t=e.attrs,n=e.id;return I.assoc("rule_id",n,t)}))(l)).pipe(Gr((function(e){return e instanceof window.Error?dc.Observable.throwError(e):dc.Observable.of(null)})))}}],[{key:"init",value:function(t,n){var r=n.currentStatusObservable,i=n.internalVisitorStateObservable,o=n.rules,s=n.queuesAvailabilityObservable,a=n.routingObservable,u=dc.Observable.create((function(e){var t=new MutationObserver((function(t){return I.forEach((function(t){return I.forEach((function(t){if(t instanceof HTMLElement)return e.next(t)}),t.addedNodes)}),t)}));return t.observe(document.body,{attributes:!1,characterData:!1,childList:!0,subtree:!0,attributeOldValue:!1,characterDataOldValue:!1}),function(){return t.disconnect()}})),c=Jl.buildObservable(i);return(new e).start(t,{currentStatusObservable:r,queuesAvailabilityObservable:s,rules:o,domInsertObservable:u,buildRuleObservable:c,routingObservable:a})}}]),e}();function Cf(e){return e.operator?Cf(e.left).concat(Cf(e.right)):[e]}function Pf(e){var t;t=Array.isArray(e.sources)?e.sources:Cf(e.sources);var n=I.map((function(t){return I.assoc("sources",t,e)}),t);return mc.from(n)}Rf.BUFFER_TIME=100,Rf.INIT_TIMESTAMP=(new Date).getTime();var jf=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t._throw=Er.throwError})),Lf=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(jf)})),qf=[sm.conf.api_url,"libs.salemove.com","libs.glia.com","visitor.local.dev"],Uf=function(e){return I.any((function(t){return I.contains(t,e)}),qf)},Df=function(e){if("string"!=typeof e&&(t=e,n=new RegExp("^(https?:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?(\\#[-a-z\\d_]*)?$","i"),!Boolean(n.test(t))))return $u.warn("Invalid URL provided",{rawUrl:e}),!1;var t,n;try{var r=new window.URL(e);return Uf(r.origin)}catch(t){try{var i=e.trim();return Boolean(i)&&i.length>2&&Uf(i)}catch(t){return $u.warn("Error validating URL",{rawUrl:e,error:t}),!1}}},Vf=I.pick(["response","status","statusText","readyState","responseURL"]),Ff=function(e){var t=e.method,n=e.url,r=e.payload,i=e.responseType,o=e.getRequestHeaders,s=e.onUploadProgress,a=e.onSuccess,u=e.onError,c=new XMLHttpRequest;if(c.open(t,n,!0),o){var l=o();r="application/json"===l["Content-Type"]&&"string"!=typeof r?JSON.stringify(r):r,Object.keys(l).forEach((function(e){var t=l[e];c.setRequestHeader(e,t)}))}return c.responseType=i,c.onreadystatechange=function(){if(4===c.readyState)if(c.status>=200&&c.status<300)if("json"===i&&"string"==typeof c.response)try{var e=I.assoc("response",c.response.length>0?JSON.parse(c.response):"",c);a(e)}catch(e){$u.error("Could not parse response json in IE11",{error:e,server_response:c.response}),u(c)}else a(c);else u(c)},s&&c.upload.addEventListener("progress",(function(e){e.lengthComputable&&s({loaded:e.loaded,total:e.total})}),!1),Df(n)?c.send("GET"===t?void 0:r):($u.error("Trying to fetch from invalid URL",{rawUrl:n}),u(c)),function(){return c.abort()}},Bf=function(e){var t=e.method,n=e.url,r=e.payload,i=e.responseType,o=e.getRequestHeaders,s=e.onUploadProgress,a=e.sendRequest,u=e.contentType;return Df(n)?(t=t||"GET",i=i||"json",a=a||Ff,o||(o=function(){return{Accept:"application/vnd.salemove.private+json",Authorization:"Bearer "+sm.accessToken}}),dc.Observable.create((function(e){return a({method:t,url:n,payload:r,responseType:i,getRequestHeaders:u?function(){return I.merge(o(),{"Content-Type":u})}:o,onUploadProgress:s,onSuccess:function(t){e.next(t),e.complete()},onError:function(t){return e.error(Vf(t))}})}))):($u.error("Trying to fetch from invalid URL",{rawUrl:n}),Lf._throw(new yf({cause:uf.SALEMOVE.INTERNAL_ERROR,message:"Request URL is invalid"})))},Hf=function(e){var t=e.url,n=e.method,r=e.payload,i=e.responseType,o=e.contentType,s=e.getRequestHeaders,a=e.calculateAttemptDelay,u=e.retryLimit,c=void 0===u?5:u,l=e.onSuccess,f=e.onError,p=void 0===f?function(){}:f,d=e.onAttempt,h=void 0===d?function(){}:d,v=e.onAttemptError,b=void 0===v?function(){}:v,m=e.shouldRetry,g=void 0===m?function(){return!0}:m;C({calculateAttemptDelay:a,attempt:function(e){var a=e.repeat;h(),Ff({method:n,url:t,payload:r,responseType:i,getRequestHeaders:o?function(){return I.merge(s(),{"Content-Type":o})}:s,onError:function(e){var t=g(e.status);b(t),(t?a:p)(e)},onSuccess:l})},onGiveUp:p,retryLimit:c})},Wf=function(e,t){var n=e.url,r=e.assetKey,i=e.onError,o=e.onSuccess,s=e.identifier,a={method:"GET",responseType:"json",onSuccess:function(e){t.increment("sm.assets.load",["action:succeeded","asset:".concat(r)]),o(e)},onAttempt:function(){t.increment("sm.assets.load",["action:attempted","asset:".concat(r)])},onAttemptError:function(e){$u.warn("Failed fetching ".concat(r).concat(e?", retrying":""),{asset_url:n,identifier:s}),t.increment("sm.assets.load",["action:warning","asset:".concat(r)])},onError:function(){$u.warn("Error fetching ".concat(r),{asset_url:n,identifier:s}),t.increment("sm.assets.load",["action:failed","asset:".concat(r)]),"function"==typeof i&&i()}};Hf(I.merge(a,e))},Gf=function(){return{Accept:"application/vnd.salemove.private+json",Authorization:"Bearer "+sm.accessToken}};function zf(e){var t=e.stats,n=function(e){return t.increment("sm.service.overseer_api.action_shortcircuited",["type:".concat(e)])},r=function(){t.increment("sm.lib.overseer",["action:attempted"])};return{sourcesTriggered:function(e){var n=e.events,i=e.tabId,o=e.resolvedConditions,s=e.xhrWithRetry,a=void 0===s?Hf:s;return dc.Observable.create((function(e){var s=I.merge({visitor_id:Fu(),site_id:Gu(),url:window.location.href},{events:n,tab_id:i,resolved_conditions:o});a({method:"POST",url:"".concat(sm.conf.api_url,"/overseer/sources_triggered"),payload:s,contentType:"application/json",responseType:"json",getRequestHeaders:Gf,onAttempt:r,onSuccess:function(){var n,r,i;r=(n={resource:"overseer",method:"sources_triggered"}).resource,i=n.method,$u.log("Successfully executed '".concat(i,"' on resource ").concat(r)),t.increment("sm.lib.overseer",["action:succeeded"]),e.next(null),e.complete()},onError:function(n){var r,i,o;i=(r={resource:"overseer",method:"sources_triggered"}).resource,o=r.method,$u.warn("Failed to execute '".concat(o,"' on resource ").concat(i)),t.increment("sm.lib.overseer",["action:failed"]),e.error(n)},calculateAttemptDelay:M(100),shouldRetry:function(e){return 422!==e}})}))},sendOverseerMetrics:function(e){var t=e.browserEvents;I.forEach(n,t.flatMap((function(e){return e.actionTypes})))}}}var Jf=function(e){var t=function(e){return I.compose(I.reject(I.isNil),I.chain(I.prop("queue_ids")),I.chain(I.prop("conditions")))(e)}(e)||[],n=function(e){return I.compose(I.reject(I.isNil),I.chain(I.path(["browser_event_conditions","queue_ids"])))(e)}(e)||[],r=t.concat(n);return I.uniq(r)},Yf=function(e){return I.filter(I.compose(I.or(I.isEmpty,I.isNil),I.chain(I.propOr([],"queue_ids")),I.prop("conditions")))(e)},Qf=function(e){return I.filter(I.compose(I.isEmpty,I.pathOr([],["browser_event_conditions","queue_ids"])))(e)};function Kf(e){var t=e.cobraObservable,n=e.internalVisitorStateObservable,r=e.volatileNotifications,i=e.stats,o=e.currentStatusObservable,s=e.queuesStateUpdatesObservable,a=e.routingObservable;new Bc({volatileNotifications:r,cobraObservable:t,routingObservable:a}).start();var u=new zf({stats:i}),c=sm.conf.overseer.rules,l=sm.conf.omniq.omniq_enabled?c:function(e){return I.compose(Yf,Qf)(e)}(c),f=Jf(l),p=function(){if(I.not(I.isEmpty(f))){var e=new Du.ReplaySubject(1);return s.subscribeToList({queueIds:f,listener:e.next.bind(e)}),e}return Du.Observable.of(null)}();Rf.init(u,{currentStatusObservable:o.startWith("available"),internalVisitorStateObservable:n,queuesAvailabilityObservable:p,rules:l,routingObservable:a})}function Xf(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i=!1!==r.rethrow;return function(){try{return n.apply(this,arguments)}catch(n){if(Zu.clientHandlerError(t),$u.warn(e,n),i)throw n;console.error(n)}}}var $f=I.curryN(2,(function(e,t){return I.compose(I.forEach((function(t){var n=_(t,2),r=n[0],i=n[1];return e(r,i)})),I.toPairs)(t)})),Zf=function(){var e={},t=function(e,t){return Xf("Event handler for ".concat(e," threw an error"),e,t,{rethrow:!1})},n=function(n,r){var i=(e[n]||{}).listenerEntries||[],o=I.compose(I.map((function(e){var i=e.listener;return{listener:i,subscription:r.subscribe(t(n,i),$u.error)}})),I.forEach((function(e){return e.subscription.unsubscribe()})))(i);e[n]={observable:r,listenerEntries:o}};return{observable:function(t){return e[t].observable},addEventListener:function(n,r){var i=e[n]||{},o=i.listenerEntries||[],s=i.observable;if(!I.any(I.propEq("listener",r),o)){var a=s?s.subscribe(t(n,r),$u.error):Du.Subscription.EMPTY,u=I.append({listener:r,subscription:a},o);return e[n]={listenerEntries:u,observable:s},null}},removeEventListener:function(t,n){var r=e[t]||{},i=r.listenerEntries||[],o=r.observable,s=I.find(I.propEq("listener",n))(i);if(s){s.subscription.unsubscribe();var a=I.without([s])(i);e[t]={observable:o,listenerEntries:a}}return null},proxy:n,proxyAll:$f(n),eventWithoutListenerObservable:function(t){return(e[t]||{}).observable.pipe(Tn((function(){return!function(t){var n=(e[t]||{}).listenerEntries||[];return I.not(I.isEmpty(n))}(t)})))},stop:function(){I.compose(I.forEach((function(e){return e.unsubscribe()})),I.map(I.prop("subscription")),I.chain(I.prop("listenerEntries")),I.values)(e),e={}}}},ep=function(){var e=new Du.Subscription,t=Zf(),n=function(n,r){var i=r.publishReplay(1);e.add(i.connect()),t.proxy(n,i)};return{addEventListener:t.addEventListener,removeEventListener:t.removeEventListener,eventWithoutListenerObservable:t.eventWithoutListenerObservable,proxy:n,proxyAll:$f(n),stop:function(){e.unsubscribe(),t.stop()},observable:t.observable}};function tp(e){var t=ep();return t.proxy("change",e),{addEventListener:t.addEventListener,removeEventListener:t.removeEventListener}}var np=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:sm.tracker;return tp(e.getUserIsActiveTabObservable())},rp=function(){return tp(Du.Observable.of(!0))};function ip(e){var t=e.channelObservable,n=e.logger.withTags({feature:"cobra"}),r=t.flatMap((function(e){var t=e.channel,n=e.operator;return oc("Cobra").map((function(e){return{Cobra:e,channel:t,operator:n}}))})).distinctUntilChanged(null,(function(e){return e.channel.url})).switchMap((function(e){var t=e.Cobra,r=e.channel,i=e.operator,o=new t.SourceInitializer(r,np(),i.id,n),s=o.initialize(),a=function(){return o.stop()};return r.addDestroyListener((function(){return a()})),Du.Observable.create((function(e){return e.next({cobraSourceInitializer:o,cobraSource:s,operator:i}),function(){return a()}}))})).do((function(e){var t=e.operator;return n.info("Cobra: Started successfully",{operator_id:t.id})}),n.warn.bind(n,"Cobra: Failed to start"),(function(){return n.info("Cobra: Stopped and will not start again")})),i=r.publishReplay(1);return sm.cobraSubscription=i.connect(),{cobraObservable:r=i.filter(I.pathEq(["cobraSource","status"],"started"))}}var op,sp={UNKNOWN:"unknown",NESTED_COBROWSABLE_IFRAME:"nested_cobrowsable_visitor",ENGAGEMENT_IFRAME:"main_visitor"},ap="cobrowsable_iframe_id",up="sm:source:nested_cobrowsable_iframe:channel_url",cp="sm:iframe_context_check",lp=function e(t,n){var r=function(e,t){for(var n=e.querySelectorAll("iframe"),r=0;r<n.length;r++){var i=n[r];if(i.contentWindow===t)return i}}(t,n);if(r)return r;for(var i=t.querySelectorAll("*"),o=0;o<i.length;++o){var s=i[o];if(s.shadowRoot){var a=e(s.shadowRoot,n);if(a)return a}}return null},fp=new Du.ReplaySubject(1);op=new Set,fp.next(op);var pp=function(e){op.has(e)||(op.add(e),fp.next(op))};function dp(e){var t={parent:{},top:{}},n=new Rl(window.parent);this.start=function(){n.start()},this.stop=function(){n.stop()},this.request=function(){n.request(cp,{tab_id:e},(function(e){e.context?(t.parent[e.context]=!0,pp(e.tabId)):($u.warn("Received iframe identity check with unexpected payload"),t.parent[e]=!0)})),n.request(up,{},(function(e){var n=e.url;t.nestedCobrowsableVisitorIframeChannelUrl=n}))},this.getCurrentContext=function(){return t},this.getParentWindowMessenger=function(){return n}}var hp=function(e){var t=new Cl({allowAnySource:!0});return t.start(),t.respondTo(cp,(function(t,n,r){var i=lp(document,r);i&&function(e){var t=e.attributes[ap];t&&t.value||e.setAttribute(ap,Il())}(i),t.tab_id?pp(t.tab_id):$u.warn("Received iframe identity check with unexpected payload",t),n({context:"visitor_page",tabId:e})})),t.stop.bind(t)},vp=function(e){var t=new Cl({allowAnySource:!0});return t.start(),t.respondTo(cp,(function(t,n,r){n({context:"visitor_browser",tabId:e})})),t.stop.bind(t)};function bp(e,t){var n=t.visitor_api.iframe_identity_detection_timeout||5e3,r=t.visitor_api.iframe_identity_validity_check_timeout||3e4,i=function(){var t=e.getCurrentContext();return t.parent.visitor_page?sp.NESTED_COBROWSABLE_IFRAME:t.parent.visitor_browser?sp.ENGAGEMENT_IFRAME:void 0};return{detect:i,identityObservable:function(t){var o=Du.Observable.interval(200,t).take(Math.round(n/200)).do((function(t){if(!t)return e.request()})).map(i).startWith(i()).filter((function(e){return Boolean(e)})).take(1).defaultIfEmpty(sp.UNKNOWN).share(),s=o.filter((function(e){return e===sp.UNKNOWN})).flatMap((function(){return Du.Observable.interval(r/2,t).take(2).do((function(t){t||e.request()})).map(i).filter((function(e){return Boolean(e)})).take(1)}));return o.merge(s)},IDENTITIES:sp}}var mp=function(){var e,t,n=new Du.Subject;e=window.history,(t=e?e.pushState:void 0)&&(e.pushState=function(r){var i=t.apply(e,arguments);return n.next({state:r}),i}),function(){var e=window.history,t=e?e.replaceState:void 0;t&&(e.replaceState=function(r){var i=t.apply(e,arguments);return n.next({state:r}),i})}(),nl(window,"popstate").subscribe(n);var r=n.startWith({}).map((function(){return window.location.href})).distinctUntilChanged();sm.hrefObservable=r},gp=function(e){if("function"==typeof e)return e;return function(){return e}},yp="undefined"!=typeof self?self:null,_p="undefined"!=typeof window?window:null,wp=yp||_p||wp,Ep="2.0.0",Op=0,Sp=1,Tp=2,kp=3,Ap="closed",xp="errored",Ip="joined",Np="joining",Mp="leaving",Rp="phx_close",Cp="phx_error",Pp="phx_join",jp="phx_reply",Lp="phx_leave",qp="longpoll",Up="websocket",Dp=4,Vp=function(){function e(t,n,r,i){s(this,e),this.channel=t,this.event=n,this.payload=r||function(){return{}},this.receivedResp=null,this.timeout=i,this.timeoutTimer=null,this.recHooks=[],this.sent=!1}return u(e,[{key:"resend",value:function(e){this.timeout=e,this.reset(),this.send()}},{key:"send",value:function(){this.hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload(),ref:this.ref,join_ref:this.channel.joinRef()}))}},{key:"receive",value:function(e,t){return this.hasReceived(e)&&t(this.receivedResp.response),this.recHooks.push({status:e,callback:t}),this}},{key:"reset",value:function(){this.cancelRefEvent(),this.ref=null,this.refEvent=null,this.receivedResp=null,this.sent=!1}},{key:"matchReceive",value:function(e){var t=e.status,n=e.response;e._ref;this.recHooks.filter((function(e){return e.status===t})).forEach((function(e){return e.callback(n)}))}},{key:"cancelRefEvent",value:function(){this.refEvent&&this.channel.off(this.refEvent)}},{key:"cancelTimeout",value:function(){clearTimeout(this.timeoutTimer),this.timeoutTimer=null}},{key:"startTimeout",value:function(){var e=this;this.timeoutTimer&&this.cancelTimeout(),this.ref=this.channel.socket.makeRef(),this.refEvent=this.channel.replyEventName(this.ref),this.channel.on(this.refEvent,(function(t){e.cancelRefEvent(),e.cancelTimeout(),e.receivedResp=t,e.matchReceive(t)})),this.timeoutTimer=setTimeout((function(){e.trigger("timeout",{})}),this.timeout)}},{key:"hasReceived",value:function(e){return this.receivedResp&&this.receivedResp.status===e}},{key:"trigger",value:function(e,t){this.channel.trigger(this.refEvent,{status:e,response:t})}}]),e}(),Fp=function(){function e(t,n){s(this,e),this.callback=t,this.timerCalc=n,this.timer=null,this.tries=0}return u(e,[{key:"reset",value:function(){this.tries=0,clearTimeout(this.timer)}},{key:"scheduleTimeout",value:function(){var e=this;clearTimeout(this.timer),this.timer=setTimeout((function(){e.tries=e.tries+1,e.callback()}),this.timerCalc(this.tries+1))}}]),e}(),Bp=function(){function e(t,n,r){var i=this;s(this,e),this.state=Ap,this.topic=t,this.params=gp(n||{}),this.socket=r,this.bindings=[],this.bindingRef=0,this.timeout=this.socket.timeout,this.joinedOnce=!1,this.joinPush=new Vp(this,Pp,this.params,this.timeout),this.pushBuffer=[],this.stateChangeRefs=[],this.rejoinTimer=new Fp((function(){i.socket.isConnected()&&i.rejoin()}),this.socket.rejoinAfterMs),this.stateChangeRefs.push(this.socket.onError((function(){return i.rejoinTimer.reset()}))),this.stateChangeRefs.push(this.socket.onOpen((function(){i.rejoinTimer.reset(),i.isErrored()&&i.rejoin()}))),this.joinPush.receive("ok",(function(){i.state=Ip,i.rejoinTimer.reset(),i.pushBuffer.forEach((function(e){return e.send()})),i.pushBuffer=[]})),this.joinPush.receive("error",(function(){i.state=xp,i.socket.isConnected()&&i.rejoinTimer.scheduleTimeout()})),this.onClose((function(){i.rejoinTimer.reset(),i.socket.hasLogger()&&i.socket.log("channel","close ".concat(i.topic," ").concat(i.joinRef())),i.state=Ap,i.socket.remove(i)})),this.onError((function(e){i.socket.hasLogger()&&i.socket.log("channel","error ".concat(i.topic),e),i.isJoining()&&i.joinPush.reset(),i.state=xp,i.socket.isConnected()&&i.rejoinTimer.scheduleTimeout()})),this.joinPush.receive("timeout",(function(){i.socket.hasLogger()&&i.socket.log("channel","timeout ".concat(i.topic," (").concat(i.joinRef(),")"),i.joinPush.timeout),new Vp(i,Lp,gp({}),i.timeout).send(),i.state=xp,i.joinPush.reset(),i.socket.isConnected()&&i.rejoinTimer.scheduleTimeout()})),this.on(jp,(function(e,t){i.trigger(i.replyEventName(t),e)}))}return u(e,[{key:"join",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeout;if(this.joinedOnce)throw new Error("tried to join multiple times. 'join' can only be called a single time per channel instance");return this.timeout=e,this.joinedOnce=!0,this.rejoin(),this.joinPush}},{key:"onClose",value:function(e){this.on(Rp,e)}},{key:"onError",value:function(e){return this.on(Cp,(function(t){return e(t)}))}},{key:"on",value:function(e,t){var n=this.bindingRef++;return this.bindings.push({event:e,ref:n,callback:t}),n}},{key:"off",value:function(e,t){this.bindings=this.bindings.filter((function(n){return!(n.event===e&&(void 0===t||t===n.ref))}))}},{key:"canPush",value:function(){return this.socket.isConnected()&&this.isJoined()}},{key:"push",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.timeout;if(t=t||{},!this.joinedOnce)throw new Error("tried to push '".concat(e,"' to '").concat(this.topic,"' before joining. Use channel.join() before pushing events"));var r=new Vp(this,e,(function(){return t}),n);return this.canPush()?r.send():(r.startTimeout(),this.pushBuffer.push(r)),r}},{key:"leave",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeout;this.rejoinTimer.reset(),this.joinPush.cancelTimeout(),this.state=Mp;var n=function(){e.socket.hasLogger()&&e.socket.log("channel","leave ".concat(e.topic)),e.trigger(Rp,"leave")},r=new Vp(this,Lp,gp({}),t);return r.receive("ok",(function(){return n()})).receive("timeout",(function(){return n()})),r.send(),this.canPush()||r.trigger("ok",{}),r}},{key:"onMessage",value:function(e,t,n){return t}},{key:"isMember",value:function(e,t,n,r){return this.topic===e&&(!r||r===this.joinRef()||(this.socket.hasLogger()&&this.socket.log("channel","dropping outdated message",{topic:e,event:t,payload:n,joinRef:r}),!1))}},{key:"joinRef",value:function(){return this.joinPush.ref}},{key:"rejoin",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeout;this.isLeaving()||(this.socket.leaveOpenTopic(this.topic),this.state=Np,this.joinPush.resend(e))}},{key:"trigger",value:function(e,t,n,r){var i=this.onMessage(e,t,n,r);if(t&&!i)throw new Error("channel onMessage callbacks must return the payload, modified or unmodified");for(var o=this.bindings.filter((function(t){return t.event===e})),s=0;s<o.length;s++){o[s].callback(i,n,r||this.joinRef())}}},{key:"replyEventName",value:function(e){return"chan_reply_".concat(e)}},{key:"isClosed",value:function(){return this.state===Ap}},{key:"isErrored",value:function(){return this.state===xp}},{key:"isJoined",value:function(){return this.state===Ip}},{key:"isJoining",value:function(){return this.state===Np}},{key:"isLeaving",value:function(){return this.state===Mp}}]),e}(),Hp=function(){function e(){s(this,e)}return u(e,null,[{key:"request",value:function(e,t,n,r,i,o,s){if(wp.XDomainRequest){var a=new wp.XDomainRequest;return this.xdomainRequest(a,e,t,r,i,o,s)}var u=new wp.XMLHttpRequest;return this.xhrRequest(u,e,t,n,r,i,o,s)}},{key:"xdomainRequest",value:function(e,t,n,r,i,o,s){var a=this;return e.timeout=i,e.open(t,n),e.onload=function(){var t=a.parseJSON(e.responseText);s&&s(t)},o&&(e.ontimeout=o),e.onprogress=function(){},e.send(r),e}},{key:"xhrRequest",value:function(e,t,n,r,i,o,s,a){var u=this;return e.open(t,n,!0),e.timeout=o,e.setRequestHeader("Content-Type",r),e.onerror=function(){return a&&a(null)},e.onreadystatechange=function(){if(e.readyState===Dp&&a){var t=u.parseJSON(e.responseText);a(t)}},s&&(e.ontimeout=s),e.send(i),e}},{key:"parseJSON",value:function(e){if(!e||""===e)return null;try{return JSON.parse(e)}catch(t){return console&&console.log("failed to parse JSON response",e),null}}},{key:"serialize",value:function(e,t){var n=[];for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var i=t?"".concat(t,"[").concat(r,"]"):r,s=e[r];"object"===o(s)?n.push(this.serialize(s,i)):n.push(encodeURIComponent(i)+"="+encodeURIComponent(s))}return n.join("&")}},{key:"appendParams",value:function(e,t){if(0===Object.keys(t).length)return e;var n=e.match(/\?/)?"&":"?";return"".concat(e).concat(n).concat(this.serialize(t))}}]),e}(),Wp=function(){function e(t){s(this,e),this.endPoint=null,this.token=null,this.skipHeartbeat=!0,this.reqs=new Set,this.onopen=function(){},this.onerror=function(){},this.onmessage=function(){},this.onclose=function(){},this.pollEndpoint=this.normalizeEndpoint(t),this.readyState=Op,this.poll()}return u(e,[{key:"normalizeEndpoint",value:function(e){return e.replace("ws://","http://").replace("wss://","https://").replace(new RegExp("(.*)/"+Up),"$1/"+qp)}},{key:"endpointURL",value:function(){return Hp.appendParams(this.pollEndpoint,{token:this.token})}},{key:"closeAndRetry",value:function(e,t,n){this.close(e,t,n),this.readyState=Op}},{key:"ontimeout",value:function(){this.onerror("timeout"),this.closeAndRetry(1005,"timeout",!1)}},{key:"isActive",value:function(){return this.readyState===Sp||this.readyState===Op}},{key:"poll",value:function(){var e=this;this.ajax("GET",null,(function(){return e.ontimeout()}),(function(t){if(t){var n=t.status,r=t.token,i=t.messages;e.token=r}else n=0;switch(n){case 200:i.forEach((function(t){setTimeout((function(){return e.onmessage({data:t})}),0)})),e.poll();break;case 204:e.poll();break;case 410:e.readyState=Sp,e.onopen({}),e.poll();break;case 403:e.onerror(403),e.close(1008,"forbidden",!1);break;case 0:case 500:e.onerror(500),e.closeAndRetry(1011,"internal server error",500);break;default:e.onerror(n),e.close()}}))}},{key:"send",value:function(e){var t=this;this.ajax("POST",e,(function(){return t.onerror("timeout")}),(function(e){e&&200===e.status||(t.onerror(e&&e.status),t.closeAndRetry(1011,"internal server error",!1))}))}},{key:"close",value:function(e,t,n){var r,i=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=E(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==n.return||n.return()}finally{if(a)throw o}}}}(this.reqs);try{for(i.s();!(r=i.n()).done;){r.value.abort()}}catch(e){i.e(e)}finally{i.f()}this.readyState=kp;var o=Object.assign({code:1e3,reason:void 0,wasClean:!0},{code:e,reason:t,wasClean:n});"undefined"!=typeof CloseEvent?this.onclose(new CloseEvent("close",o)):this.onclose(o)}},{key:"ajax",value:function(e,t,n,r){var i,o=this;i=Hp.request(e,this.endpointURL(),"application/json",t,this.timeout,(function(){o.reqs.delete(i),n()}),(function(e){o.reqs.delete(i),o.isActive()&&r(e)})),this.reqs.add(i)}}]),e}(),Gp=function(){function e(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};s(this,e);var i=r.events||{state:"presence_state",diff:"presence_diff"};this.state={},this.pendingDiffs=[],this.channel=t,this.joinRef=null,this.caller={onChange:null,onJoin:null,onLeave:null,onSync:function(){}},this.channel.on(i.state,(function(t){var r=n.caller,i=r.onChange,o=r.onJoin,s=r.onLeave,a=r.onSync;n.joinRef=n.channel.joinRef(),o||s?e.syncState(n.state,t,o,s):e.synchronizeState(n.state,t,i),n.pendingDiffs.forEach((function(t){o||s?e.syncDiff(n.state,t,o,s):e.synchronizeDiff(n.state,t,i)})),n.pendingDiffs=[],a()})),this.channel.on(i.diff,(function(t){var r=n.caller,i=r.onChange,o=r.onJoin,s=r.onLeave,a=r.onSync;n.inPendingSyncState()?n.pendingDiffs.push(t):(o||s?e.syncDiff(n.state,t,o,s):e.synchronizeDiff(n.state,t,i),a())}))}return u(e,[{key:"onJoin",value:function(e){console&&console.warn&&console.warn("onJoin is deprecated, use onChange instead"),this.caller.onJoin=e}},{key:"onLeave",value:function(e){console&&console.warn&&console.warn("onLeave is deprecated, use onChange instead"),this.caller.onLeave=e}},{key:"onChange",value:function(e){this.caller.onChange=e}},{key:"onSync",value:function(e){this.caller.onSync=e}},{key:"list",value:function(t){return e.list(this.state,t)}},{key:"inPendingSyncState",value:function(){return!this.joinRef||this.joinRef!==this.channel.joinRef()}}],[{key:"synchronizeState",value:function(e,t,n){var r={},i={};return this.map(e,(function(e,n){t[e]||(i[e]=n)})),this.map(t,(function(t,n){var o=e[t];if(o){var s=n.metas.map((function(e){return e.phx_ref})),a=o.metas.map((function(e){return e.phx_ref})),u=n.metas.filter((function(e){return a.indexOf(e.phx_ref)<0})),c=o.metas.filter((function(e){return s.indexOf(e.phx_ref)<0}));u.length>0&&(r[t]=n,r[t].metas=u),c.length>0&&(u.length>0?i[t]={metas:c}:(i[t]=n,i[t].metas=c))}else r[t]=n})),this.synchronizeDiff(e,{joins:r,leaves:i},n)}},{key:"syncState",value:function(e,t,n,r){var i=this,o=this.clone(e),s={},a={};return this.map(o,(function(e,n){t[e]||(a[e]=n)})),this.map(t,(function(e,t){var n=o[e];if(n){var r=t.metas.map((function(e){return e.phx_ref})),u=n.metas.map((function(e){return e.phx_ref})),c=t.metas.filter((function(e){return u.indexOf(e.phx_ref)<0})),l=n.metas.filter((function(e){return r.indexOf(e.phx_ref)<0}));c.length>0&&(s[e]=t,s[e].metas=c),l.length>0&&(a[e]=i.clone(n),a[e].metas=l)}else s[e]=t})),this.syncDiff(o,{joins:s,leaves:a},n,r)}},{key:"synchronizeDiff",value:function(e,t,n){var r=t.joins,i=t.leaves,o={};return this.map(r,(function(e,t){o[e]={joinedMetas:t.metas,leftMetas:[],update:t}})),this.map(i,(function(e,t){o[e]?o[e].leftMetas=t.metas:o[e]={joinedMetas:[],leftMetas:t.metas,update:t}})),this.map(o,(function(t,r){var i=r.joinedMetas,o=r.leftMetas,s=r.update,a=i.map((function(e){return e.phx_ref})),u=o.map((function(e){return e.phx_ref})),c=e[t],l={metas:c?c.metas:[]};l.metas=l.metas.filter((function(e){return-1===a.indexOf(e.phx_ref)})).concat(i).filter((function(e){return-1===u.indexOf(e.phx_ref)})),Object.keys(s).forEach((function(e){"metas"!==e&&(l[e]=s[e])})),0===l.metas.length?delete e[t]:e[t]=l,n&&n(t,c,l)})),e}},{key:"syncDiff",value:function(e,t,n,r){var i=this,o=this.clone(t),s=o.joins,a=o.leaves;return n||(n=function(){}),r||(r=function(){}),this.map(s,(function(t,r){var o=e[t];if(e[t]=i.clone(r),o){var s,a=e[t].metas.map((function(e){return e.phx_ref})),u=o.metas.filter((function(e){return a.indexOf(e.phx_ref)<0}));(s=e[t].metas).unshift.apply(s,w(u))}n(t,o,r)})),this.map(a,(function(t,n){var i=e[t];if(i){var o=n.metas.map((function(e){return e.phx_ref}));i.metas=i.metas.filter((function(e){return o.indexOf(e.phx_ref)<0})),r(t,i,n),0===i.metas.length&&delete e[t]}})),e}},{key:"list",value:function(e,t){return t||(t=function(e,t){return t}),this.map(e,(function(e,n){return t(e,n)}))}},{key:"map",value:function(e,t){return Object.getOwnPropertyNames(e).map((function(n){return t(n,e[n])}))}},{key:"clone",value:function(e){return JSON.parse(JSON.stringify(e))}}]),e}(),zp={HEADER_LENGTH:1,META_LENGTH:4,KINDS:{push:0,reply:1,broadcast:2},encode:function(e,t){if(e.payload.constructor===ArrayBuffer)return t(this.binaryEncode(e));var n=[e.join_ref,e.ref,e.topic,e.event,e.payload];return t(JSON.stringify(n))},decode:function(e,t){if(e.constructor===ArrayBuffer)return t(this.binaryDecode(e));var n=_(JSON.parse(e),5);return t({join_ref:n[0],ref:n[1],topic:n[2],event:n[3],payload:n[4]})},binaryEncode:function(e){var t=e.join_ref,n=e.ref,r=e.event,i=e.topic,o=e.payload,s=this.META_LENGTH+t.length+n.length+i.length+r.length,a=new ArrayBuffer(this.HEADER_LENGTH+s),u=new DataView(a),c=0;u.setUint8(c++,this.KINDS.push),u.setUint8(c++,t.length),u.setUint8(c++,n.length),u.setUint8(c++,i.length),u.setUint8(c++,r.length),Array.from(t,(function(e){return u.setUint8(c++,e.charCodeAt(0))})),Array.from(n,(function(e){return u.setUint8(c++,e.charCodeAt(0))})),Array.from(i,(function(e){return u.setUint8(c++,e.charCodeAt(0))})),Array.from(r,(function(e){return u.setUint8(c++,e.charCodeAt(0))}));var l=new Uint8Array(a.byteLength+o.byteLength);return l.set(new Uint8Array(a),0),l.set(new Uint8Array(o),a.byteLength),l.buffer},binaryDecode:function(e){var t=new DataView(e),n=t.getUint8(0),r=new TextDecoder;switch(n){case this.KINDS.push:return this.decodePush(e,t,r);case this.KINDS.reply:return this.decodeReply(e,t,r);case this.KINDS.broadcast:return this.decodeBroadcast(e,t,r)}},decodePush:function(e,t,n){var r=t.getUint8(1),i=t.getUint8(2),o=t.getUint8(3),s=this.HEADER_LENGTH+this.META_LENGTH-1,a=n.decode(e.slice(s,s+r));s+=r;var u=n.decode(e.slice(s,s+i));s+=i;var c=n.decode(e.slice(s,s+o));return s+=o,{join_ref:a,ref:null,topic:u,event:c,payload:e.slice(s,e.byteLength)}},decodeReply:function(e,t,n){var r=t.getUint8(1),i=t.getUint8(2),o=t.getUint8(3),s=t.getUint8(4),a=this.HEADER_LENGTH+this.META_LENGTH,u=n.decode(e.slice(a,a+r));a+=r;var c=n.decode(e.slice(a,a+i));a+=i;var l=n.decode(e.slice(a,a+o));a+=o;var f=n.decode(e.slice(a,a+s));a+=s;var p=e.slice(a,e.byteLength);return{join_ref:u,ref:c,topic:l,event:jp,payload:{status:f,response:p}}},decodeBroadcast:function(e,t,n){var r=t.getUint8(1),i=t.getUint8(2),o=this.HEADER_LENGTH+2,s=n.decode(e.slice(o,o+r));o+=r;var a=n.decode(e.slice(o,o+i));return o+=i,{join_ref:null,ref:null,topic:s,event:a,payload:e.slice(o,e.byteLength)}}},Jp=function(){function e(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};s(this,e),this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.channels=[],this.sendBuffer=[],this.ref=0,this.timeout=r.timeout||1e4,this.transport=r.transport||wp.WebSocket||Wp,this.establishedConnections=0,this.defaultEncoder=zp.encode.bind(zp),this.defaultDecoder=zp.decode.bind(zp),this.closeWasClean=!1,this.binaryType=r.binaryType||"arraybuffer",this.connectClock=1,this.transport!==Wp?(this.encode=r.encode||this.defaultEncoder,this.decode=r.decode||this.defaultDecoder):(this.encode=this.defaultEncoder,this.decode=this.defaultDecoder);var i=null;_p&&_p.addEventListener&&(_p.addEventListener("pagehide",(function(e){n.conn&&(n.disconnect(),i=n.connectClock)})),_p.addEventListener("pageshow",(function(e){i===n.connectClock&&(i=null,n.connect())}))),this.heartbeatIntervalMs=r.heartbeatIntervalMs||3e4,this.rejoinAfterMs=function(e){return r.rejoinAfterMs?r.rejoinAfterMs(e):[1e3,2e3,5e3][e-1]||1e4},this.reconnectAfterMs=function(e){return r.reconnectAfterMs?r.reconnectAfterMs(e):[10,50,100,150,200,250,500,1e3,2e3][e-1]||5e3},this.logger=r.logger||null,this.longpollerTimeout=r.longpollerTimeout||2e4,this.params=gp(r.params||{}),this.endPoint="".concat(t,"/").concat(Up),this.vsn=r.vsn||Ep,this.heartbeatTimeoutTimer=null,this.heartbeatTimer=null,this.pendingHeartbeatRef=null,this.reconnectTimer=new Fp((function(){n.teardown((function(){return n.connect()}))}),this.reconnectAfterMs)}return u(e,[{key:"getLongPollTransport",value:function(){return Wp}},{key:"replaceTransport",value:function(e){this.connectClock++,this.closeWasClean=!0,this.reconnectTimer.reset(),this.sendBuffer=[],this.conn&&(this.conn.close(),this.conn=null),this.transport=e}},{key:"protocol",value:function(){return location.protocol.match(/^https/)?"wss":"ws"}},{key:"endPointURL",value:function(){var e=Hp.appendParams(Hp.appendParams(this.endPoint,this.params()),{vsn:this.vsn});return"/"!==e.charAt(0)?e:"/"===e.charAt(1)?"".concat(this.protocol(),":").concat(e):"".concat(this.protocol(),"://").concat(location.host).concat(e)}},{key:"disconnect",value:function(e,t,n){this.connectClock++,this.closeWasClean=!0,this.reconnectTimer.reset(),this.teardown(e,t,n)}},{key:"connect",value:function(e){var t=this;e&&(console&&console.log("passing params to connect is deprecated. Instead pass :params to the Socket constructor"),this.params=gp(e)),this.conn||(this.connectClock++,this.closeWasClean=!1,this.conn=new this.transport(this.endPointURL()),this.conn.binaryType=this.binaryType,this.conn.timeout=this.longpollerTimeout,this.conn.onopen=function(){return t.onConnOpen()},this.conn.onerror=function(e){return t.onConnError(e)},this.conn.onmessage=function(e){return t.onConnMessage(e)},this.conn.onclose=function(e){return t.onConnClose(e)})}},{key:"log",value:function(e,t,n){this.logger(e,t,n)}},{key:"hasLogger",value:function(){return null!==this.logger}},{key:"onOpen",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.open.push([t,e]),t}},{key:"onClose",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.close.push([t,e]),t}},{key:"onError",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.error.push([t,e]),t}},{key:"onMessage",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.message.push([t,e]),t}},{key:"ping",value:function(e){var t=this;if(!this.isConnected())return!1;var n=this.makeRef(),r=Date.now();this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:n});var i=this.onMessage((function(o){o.ref===n&&(t.off([i]),e(Date.now()-r))}));return!0}},{key:"clearHeartbeats",value:function(){clearTimeout(this.heartbeatTimer),clearTimeout(this.heartbeatTimeoutTimer)}},{key:"onConnOpen",value:function(){if(this.hasLogger()){var e=this.endPointURL().replace(/access_token=([^&#/]+)/,"access_token=-pruned-");this.log("transport","connected to ".concat(e))}this.closeWasClean=!1,this.establishedConnections++,this.flushSendBuffer(),this.reconnectTimer.reset(),this.resetHeartbeat(),this.stateChangeCallbacks.open.forEach((function(e){return(0,_(e,2)[1])()}))}},{key:"heartbeatTimeout",value:function(){var e=this;this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null,this.hasLogger()&&this.log("transport","heartbeat timeout. Attempting to re-establish connection"),this.triggerChanError(),this.closeWasClean=!1,this.teardown((function(){return e.reconnectTimer.scheduleTimeout()}),1e3,"heartbeat timeout"))}},{key:"resetHeartbeat",value:function(){var e=this;this.conn&&this.conn.skipHeartbeat||(this.pendingHeartbeatRef=null,this.clearHeartbeats(),this.heartbeatTimer=setTimeout((function(){return e.sendHeartbeat()}),this.heartbeatIntervalMs))}},{key:"teardown",value:function(e,t,n){var r=this;if(!this.conn)return e&&e();this.waitForBufferDone((function(){r.conn&&(t?r.conn.close(t,n||""):r.conn.close()),r.waitForSocketClosed((function(){r.conn&&(r.conn.onopen=function(){},r.conn.onerror=function(){},r.conn.onmessage=function(){},r.conn.onclose=function(){},r.conn=null),e&&e()}))}))}},{key:"waitForBufferDone",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;5!==n&&this.conn&&this.conn.bufferedAmount?setTimeout((function(){t.waitForBufferDone(e,n+1)}),150*n):e()}},{key:"waitForSocketClosed",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;5!==n&&this.conn&&this.conn.readyState!==kp?setTimeout((function(){t.waitForSocketClosed(e,n+1)}),150*n):e()}},{key:"onConnClose",value:function(e){this.hasLogger()&&this.log("transport","close",e),this.triggerChanError(),this.clearHeartbeats(),this.closeWasClean||this.reconnectTimer.scheduleTimeout(),this.stateChangeCallbacks.close.forEach((function(t){return(0,_(t,2)[1])(e)}))}},{key:"onConnError",value:function(e){this.hasLogger()&&this.log("transport",e);var t=this.transport,n=this.establishedConnections;this.stateChangeCallbacks.error.forEach((function(r){(0,_(r,2)[1])(e,t,n)})),(t===this.transport||n>0)&&this.triggerChanError()}},{key:"triggerChanError",value:function(){this.channels.forEach((function(e){e.isErrored()||e.isLeaving()||e.isClosed()||e.trigger(Cp)}))}},{key:"connectionState",value:function(){switch(this.conn&&this.conn.readyState){case Op:return"connecting";case Sp:return"open";case Tp:return"closing";default:return"closed"}}},{key:"isConnected",value:function(){return"open"===this.connectionState()}},{key:"remove",value:function(e){this.off(e.stateChangeRefs),this.channels=this.channels.filter((function(t){return t.joinRef()!==e.joinRef()}))}},{key:"off",value:function(e){for(var t in this.stateChangeCallbacks)this.stateChangeCallbacks[t]=this.stateChangeCallbacks[t].filter((function(t){var n=_(t,1)[0];return-1===e.indexOf(n)}))}},{key:"channel",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=new Bp(e,t,this);return this.channels.push(n),n}},{key:"push",value:function(e){var t=this;if(this.hasLogger()){var n=e.topic,r=e.event,i=e.payload,o=e.ref,s=e.join_ref;this.log("push","".concat(n," ").concat(r," (").concat(s,", ").concat(o,")"),i)}this.isConnected()?this.encode(e,(function(e){return t.conn.send(e)})):this.sendBuffer.push((function(){return t.encode(e,(function(e){return t.conn.send(e)}))}))}},{key:"makeRef",value:function(){var e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}},{key:"sendHeartbeat",value:function(){var e=this;this.pendingHeartbeatRef&&!this.isConnected()||(this.pendingHeartbeatRef=this.makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.heartbeatTimeoutTimer=setTimeout((function(){return e.heartbeatTimeout()}),this.heartbeatIntervalMs))}},{key:"flushSendBuffer",value:function(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach((function(e){return e()})),this.sendBuffer=[])}},{key:"onConnMessage",value:function(e){var t=this;this.decode(e.data,(function(e){var n=e.topic,r=e.event,i=e.payload,o=e.ref,s=e.join_ref;o&&o===t.pendingHeartbeatRef&&(t.clearHeartbeats(),t.pendingHeartbeatRef=null,t.heartbeatTimer=setTimeout((function(){return t.sendHeartbeat()}),t.heartbeatIntervalMs)),t.hasLogger()&&t.log("receive","".concat(i.status||""," ").concat(n," ").concat(r," ").concat(o&&"("+o+")"||""),i);for(var a=0;a<t.channels.length;a++){var u=t.channels[a];u.isMember(n,r,i,s)&&u.trigger(r,i,o,s)}for(var c=0;c<t.stateChangeCallbacks.message.length;c++){(0,_(t.stateChangeCallbacks.message[c],2)[1])(e)}}))}},{key:"leaveOpenTopic",value:function(e){for(var t,n=0;n<this.channels.length;n++){var r=this.channels[n];if(r.topic===e&&(r.isJoined()||r.isJoining())){t=r;break}}t&&(this.hasLogger()&&this.log("transport",'leaving duplicate topic "'.concat(e,'"')),t.leave())}}]),e}(),Yp=function(){return"hidden"===document.visibilityState},Qp=function(){return navigator.onLine},Kp=function(e,t){return t.onlyLongPollEnabled?Wp:window.WebSocket?Qp()?e.transport===window.WebSocket?Wp:window.WebSocket:e.transport:Wp};function Xp(e){var t,n={onlyLongPollEnabled:!1,connectionTriedOnce:!1,avoidLongPollWorkerInterval:6e5},r=function(t,r){n.onlyLongPollEnabled=!0,e.disconnect((function(){e.transport=Wp,r&&r(t),e.connect()}))};return{ensureConnected:function(i){var o=i.onInitialTry,s=i.onInitialError,a=i.avoidLongPollWorkerInterval;if(!n.connectionTriedOnce){o&&o(),"number"==typeof a&&(n.avoidLongPollWorkerInterval=a);try{e.connect(),e.conn.readyState===WebSocket.CLOSED&&r(null,s)}catch(e){r(e,s)}n.connectionTriedOnce=!0,t=function(e,t){if(t.avoidLongPollWorkerInterval>0&&!t.onlyLongPollEnabled){var n=setInterval((function(){if("open"===e.connectionState()&&e.transport===Wp){var n=Kp(e,t);if(e.transport!==n)return e.transport=n,e.disconnect((function(){return e.connect()}))}}),t.avoidLongPollWorkerInterval);return function(){return clearInterval(n)}}}(e,n)}},selectNewTransport:function(){Qp()&&!Yp()&&(e.transport=Kp(e,n))},stop:function(){t&&t()}}}var $p=function(e){return e===window.WebSocket?"WebSocket":e===Wp?"LongPoll":"unknown"},Zp=function(e){return"object"===o(e)?null==e?void 0:e.reason:e},ed={metrics:{}};function td(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{logPrefix:"PubSub"},o=r.logPrefix,s=0,a=!1;n=n||ed;var u=function(e){n.metrics.connectionMetric&&n.increment(n.metrics.connectionMetric,e)},c=function(t){return i(i({},{transport:$p(e.transport),online:Qp(),visibility_state:document.visibilityState,error_count:s}),t)},l=function(t,n){var r=(n||{}).transport;return["transport:".concat(r||$p(e.transport)),"online:".concat(Qp())].concat(t)},f=function(){a=!0,u(l(["action:connected"])),t.info("".concat(o," socket opened"),c({}))},p=function(e){if(e){var n=$p(window.WebSocket),r=c({reason:e.reason,type:e.type,code:e.code&&e.code.toString(),transport:n}),i=l(["action:disconnected","type:".concat(e.type),"code:".concat(e.code)],{transport:n});e.wasClean?(u(i.concat(["reason:closed"])),t.info("".concat(o," connection disconnected cleanly"),r)):Yp()?(u(i.concat(["reason:closed"])),t.info("".concat(o," connection disconnected while tab was hidden"),r)):(u(i.concat(["reason:closed"])),t.info("".concat(o," connection disconnected"),r))}else{var s=$p(Wp),a=c({reason:"unknown",type:"unknown",code:"unknown",transport:s}),f=l(["action:disconnected","type:unknown","reason:unknown","code:unknown"],{transport:s});u(f),t.info("".concat(o," connection disconnected"),a)}},d=function(e){var n=e&&e.type||"unknown";s+=1;var r=e&&e.target?c({type:n}):c({type:n,error:e});Yp()?t.info("".concat(o," connection error while tab was hidden"),r):Qp()?1!==s||a?(u(l(["action:error"])),t.warn("".concat(o," socket connection error"),r)):t.info("".concat(o," socket connection error while attempting to establish the connection first time"),r):t.info("".concat(o," connection error while user was offline"),r)},h=function(n){return t.info("".concat(o," failed to connect with initial transport"),{new_transport:$p(e.transport),error:Zp(n)})},v=function(){return u(l(["action:connect"]))};return{onOpen:f,onClose:p,onError:d,onInitialTry:v,onInitialConnectError:h}}var nd=function(e,t){var n=t.enabled,r=t.logPrefix;return n?function(t,n,o){var s=null!=o&&o.token?i(i({},o),{},{token:"-pruned-"}):o;e.info("".concat(r," ").concat(t,": ").concat(n),{pubsub_data:s})}:function(){}},rd="sm.app.visitor_api.pubsub",id="".concat(rd,".connection"),od="".concat(rd,".push"),sd=2147483647,ad=function(e){var t=e.server,n=e.socket,r=e.stats,i=e.logsEnabled,s=e.getAccessToken,a=e.visitorIdObservable,u=void 0===a?Hu():a,c=e.reconnectConf,l=void 0===c?{}:c,f=e.getVisitorPriority,p=e.renewAccessToken,d=null;l={initialDelay:l.initialDelay||3e3,maxDelay:l.maxDelay||6e4,delayFactor:l.delayFactor||1.5};var h=M(l.initialDelay,l.maxDelay,l.delayFactor),v=0,b=Date.now(),m=l.maxDelay+1e4+1e3;n||(n=new Jp("".concat(t,"/notifications"),{logger:nd($u,{enabled:i,logPrefix:"[PubSub]"}),params:function(){return{access_token:s(),priority:f()}},reconnectAfterMs:function(e){return Date.now()-b>m&&(v=0,b=Date.now()),h(v)},heartbeatIntervalMs:1e4}));var g=new Xp(n),y=new td(n,$u,{increment:r.increment.bind(r),metrics:{connectionMetric:id}},{logPrefix:"PubSub"}),_=new Du.ReplaySubject(1),w=sm.conf.engagement.api_timeout_milliseconds||1e4;n.onOpen((function(){!function(e){var t=!1;e.channels.forEach((function(e){e.isJoined()&&(t||$u.info("Detected joined channels during socket open callback, forcing re-join"),t=!0,e.trigger("phx_error","missed_close"))}))}(n),_.next(!0),y.onOpen()})),n.onClose((function(e){_.next(!1),v+=1,b=Date.now(),y.onClose(e),d&&n.disconnect()})),n.onError((function(e){if(_.next(!1),"number"==typeof e)switch(e){case 403:$u.info("Detected likely pubsub authentication error, reconnecting after max delay"),h.setNextDelayMinimum(l.maxDelay);break;case 410:break;case 500:$u.info("PubSub connection disconnected with error 500");break;case 503:var t=l.maxDelay/2;$u.info("PubSub unavailable, postponing reconnecting for at least ".concat(t," ms")),h.setNextDelayMinimum(t);break;default:return $u.error("Received unhandled pubsub error status ".concat(e,", stopping reconnecting")),void n.disconnect()}y.onError(e),g.selectNewTransport()}));var E=function(e){return"object"===o(e)?null==e?void 0:e.reason:e},O=function(e,t,i,o){var s=function(e){if("function"==typeof e)return e.modify=function(){throw new Error("Cannot modify channel params because it is a closure already")},e;var t=I.clone(e||{}),n=function(){return t};return n.modify=function(e,n){t[e]=n(t[e])},n}(t);o||(o={}),i||(i=[]);var a=Du.Observable.create((function(a){var u=!1,c=(t||{}).timeout||sd,l=n.channel(e,s);return l.join(c).receive("ok",(function(){u=!0,a.next(function(e,t){var n=function(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=i.disableStats,s=i.timeout;s||(s=w);var a=function(e,t){o||r.increment(e,t)};return Du.Observable.create((function(r){return e.push(t,n,s).receive("ok",(function(e){r.next(e),r.complete()})).receive("error",(function(e){a(od,["action:error"]),r.error({type:"error",error:e})})).receive("timeout",(function(){a(od,["action:timeout"]),r.error({type:"timeout"})})),function(){}}))};return{observable:function(t,n){return n||(n={}),Du.Observable.create((function(r){var i=e.on(t,(function(e){return r.next(e)}));return function(){e.off(t,i),n.leaveChannelOnDispose&&e.leave()}}))},push:n,phoenixChannel:e,leave:function(){return e.leave()},watchNewTopics:function(e){return t.modify("topics",(function(t){return I.union(t||[],e)})),n("watch",{topics:e},{timeout:sd})}}}(l,s)),a.complete()})).receive("error",(function(t){t&&"join crashed"===t.reason?$u.info("Joining Pubsub channel failed with crash, retrying",{reason:"error",error:E(t),topic:e}):t&&"overload"===t.reason?$u.info("Joining Pubsub channel failed because of overload, retrying",{topic:e}):(t&&-1!==i.indexOf(t.reason)?$u.info("Joining Pubsub channel failed with expected reason",{reason:"error",error:E(t),topic:e}):$u.warn("Joining Pubsub channel failed",{reason:"error",error:E(t),topic:e}),a.error({type:"error",error:t}))})).receive("timeout",(function(){return $u.warn("Joining Pubsub channel failed",{reason:"timeout",topic:e})})),function(){u&&!o.leaveChannelOnDispose||l.leave()}}));return Du.Observable.defer((function(){return g.ensureConnected({onInitialTry:function(){return y.onInitialTry},onInitialError:function(e){return y.onInitialConnectError(e)}}),Du.Observable.of({})})).flatMapTo(_).filter(I.equals(!0)).take(1).flatMapTo(a)},S=function(e){return Du.Observable.create((function(t){return t.next(e),function(){return e.leave()}}))},T=u.switchMap((function(e){return O("visitor_volatile:".concat(e)).flatMap(S)})).publishReplay(1);T.connect(),T.flatMap((function(e){return e.observable("system:avoid_reconnection")})).subscribe((function(e){var t,r,i=e.duration_in_seconds;r=.5,i=(t=i)+Math.floor(Math.random()*r*t),$u.info("Disabling reconnections to pubsub",{duration_in_seconds:i}),d&&clearTimeout(d),d=setTimeout((function(){$u.info("Enabling reconnections to pubsub"),d=null,n.connect()}),1e3*i)}));var k,A,x,N=I.compose(I.not,I.isEmpty,I.symmetricDifference),R=function(e,t){return I.map((function(t){return"site_visitor:".concat(e,":").concat(t)}),t)},C=[];return{joinChannel:O,volatileChannelObservable:T,joinSiteVisitorNotifications:function(e,t){return!I.isEmpty(C)&&k&&A===e||(A=e,C=t,(k=O("site_visitor:".concat(e),{topics:R(e,C)}).publishReplay(1)).connect(),(x=k.flatMap((function(e){return(0,e.observable)("message")})).filter(I.identity).publishReplay(50)).connect()),N(t,C)&&(C=I.union(t,C),k.take(1).flatMap((function(t){return(0,t.watchNewTopics)(R(e,C))})).subscribe((function(){return $u.debug("Subscribed to additional sites",C)}),(function(e){return $u.warn("Error subscribing to additional sites",e,C)}))),x},connectedObservable:_.distinctUntilChanged(),disconnect:n.disconnect.bind(n),connect:n.connect.bind(n),reconnect:function(){return n.disconnect((function(){return n.connect()}))},renewTokenAndReconnectWaitForTeardown:function(e){var t=e.consolidationSecret;return p({consolidationSecret:t}).flatMap((function(){return Du.Observable.create((function(e){n.disconnect((function(){n.connect(),e.next(),e.complete()}))}))}))},allowReconnection:function(){return null===d},__socket__:n}};function ud(e,t){var n=t.visitorId,r=t.visitorIdObservable,o=t.tabId,s=t.idleTimeoutSeconds,a=t.visitorMetadata;n=n||Fu(),r=(r||Hu()).share();var u="JOIN_NOT_REQUESTED",c="JOINING_ALLOW_REJECTION",l="JOINING_ALLOW_REJECTION_BUT_NO_REJECTION_REQUESTED",f="JOINING_NO_REJECTION",p="JOIN_REJECTED",d="JOINED",h="JOIN_ERROR",v="JOIN_REQUESTED_ALLOW_REJECTION",b="JOIN_REJECTED",m="JOIN_ERROR",g="JOIN_SUCCESSFUL",y="JOIN_REQUESTED_NO_REJECTION",w="VISITOR_ID_CHANGED",E="too_many_tracked",O=new Du.ReplaySubject(1),S=function(t,n,i){var u="visitor_presence:".concat(t),c=n?[E]:[],l=!1;e.joinChannel(u,(function(){return{tab_id:o,page_url:location.href,page_description:document.title,idle_timeout_seconds:s,visitor_metadata:I.pick(["location"],a),allow_rejection:n&&!l}}),c).take(1).takeUntil(r).map((function(e){var t=e.phoenixChannel,n=e.leave;return[new Gp(t),n]})).subscribe((function(e){var t=_(e,2),n=t[0],r=t[1];l=!0,i(g,{presence:n,leavePresence:r})}),(function(e){I.pathEq(["error","reason"],E,e)?i(b):i(m)}))},T={joinState:u,visitorId:n},k=function e(t,n){var r=_(function(e,t,n){switch(t){case v:switch(e.joinState){case u:return[i(i({},e),{},{joinState:c}),function(t){return S(e.visitorId,!0,t)}];default:return[e]}case y:switch(e.joinState){case u:case p:return[i(i({},e),{},{joinState:f}),function(t){return S(e.visitorId,!1,t)}];case c:return[i(i({},e),{},{joinState:l})];default:return[e]}case b:switch(e.joinState){case l:return[i(i({},e),{},{joinState:f}),function(t){return S(e.visitorId,!1,t)}];case c:return[i(i({},e),{},{joinState:p})];case f:return $u.error("Request to join visitor presence channel was rejected, although we did not allow rejection"),[i(i({},e),{},{joinState:p})];default:return $u.error("Received join rejection while we were not joining channel",{currentState:e}),[e]}case m:switch(e.joinState){case c:case f:case l:return[i(i({},e),{},{joinState:h})];default:return $u.error("Received join error while we were not joining channel",{currentState:e}),[e]}case g:switch(e.joinState){case c:case f:case l:return[i(i({},e),{},{joinState:d,leavePresence:n.leavePresence}),function(){return O.next(n.presence)}];default:return $u.error("Received join successful while we were not joining channel",{currentState:e}),[e]}case w:var r=n;if(r===e.visitorId)return[e];switch(e.joinState){case c:case f:case l:var o=e.joinState===c;return[i(i({},e),{},{visitorId:r}),function(e){return S(r,o,e)}];case d:return[i(i({},e),{},{visitorId:r,joinState:f}),function(t){e.leavePresence(),S(r,!1,t)}];default:return $u.info("Visitor ID changed, but not joining visitor presence"),[e]}default:return $u.error("Received invalid action",{action:t}),[e]}}(T,t,n),2),o=r[0],s=r[1];T=o,s&&s(e)};r.subscribe((function(e){return k(w,e)}),$u.error.bind($u,"Error from visitor ID subscription in visitor presence channel")),this.requestJoin=function(){k(y)},this.requestJoinAllowRejection=function(){k(v)},this.getPresenceObservable=function(){return O.asObservable()};var A=O.switchMap((function(e){return Du.Observable.create((function(t){e.onSync((function(){var n=e.list();n[0]?I.any(I.equals(void 0),n[0].metas)?$u.warn("Visitor Presence metas included undefined value"):t.next(n[0].metas):t.next([])}))}))})).publishReplay(1);A=al(A),this.getSameVisitorConnections=function(){return A}}var cd="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function ld(e,t){return e(t={exports:{}},t.exports),t.exports}var fd=/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,pd=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],dd=function(e){var t=e,n=e.indexOf("["),r=e.indexOf("]");-1!=n&&-1!=r&&(e=e.substring(0,n)+e.substring(n,r).replace(/:/g,";")+e.substring(r,e.length));for(var i=fd.exec(e||""),o={},s=14;s--;)o[pd[s]]=i[s]||"";return-1!=n&&-1!=r&&(o.source=t,o.host=o.host.substring(1,o.host.length-1).replace(/;/g,":"),o.authority=o.authority.replace("[","").replace("]","").replace(/;/g,":"),o.ipv6uri=!0),o},hd="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)},vd=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},bd=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),md=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},gd=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(r=(s=a.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{!r&&a.return&&a.return()}finally{if(i)throw o}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},yd=1e3,_d=60*yd,wd=60*_d,Ed=24*wd,Od=365.25*Ed,Sd=function(e,t){t=t||{};var n,r=void 0===e?"undefined":hd(e);if("string"===r&&e.length>0)return function(e){if((e=String(e)).length>1e4)return;var t=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(e);if(!t)return;var n=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return n*Od;case"days":case"day":case"d":return n*Ed;case"hours":case"hour":case"hrs":case"hr":case"h":return n*wd;case"minutes":case"minute":case"mins":case"min":case"m":return n*_d;case"seconds":case"second":case"secs":case"sec":case"s":return n*yd;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return}}(e);if("number"===r&&!1===isNaN(e))return t.long?Td(n=e,Ed,"day")||Td(n,wd,"hour")||Td(n,_d,"minute")||Td(n,yd,"second")||n+" ms":function(e){if(e>=Ed)return Math.round(e/Ed)+"d";if(e>=wd)return Math.round(e/wd)+"h";if(e>=_d)return Math.round(e/_d)+"m";if(e>=yd)return Math.round(e/yd)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))};function Td(e,t,n){if(!(e<t))return e<1.5*t?Math.floor(e/t)+" "+n:Math.ceil(e/t)+" "+n+"s"}var kd=ld((function(e,t){(t=e.exports=o.debug=o).coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){t.enable("")},t.enable=function(e){t.save(e);for(var n=(e||"").split(/[\s,]+/),r=n.length,i=0;i<r;i++)n[i]&&("-"===(e=n[i].replace(/[\\^$+?.()|[\]{}]/g,"\\$&").replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){var n,r;for(n=0,r=t.skips.length;n<r;n++)if(t.skips[n].test(e))return!1;for(n=0,r=t.names.length;n<r;n++)if(t.names[n].test(e))return!0;return!1},t.humanize=Sd,t.names=[],t.skips=[],t.formatters={};var n,r=0;function i(){return t.colors[r++%t.colors.length]}function o(e){function r(){}function o(){var e=o,r=+new Date,s=r-(n||r);e.diff=s,e.prev=n,e.curr=r,n=r,null==e.useColors&&(e.useColors=t.useColors()),null==e.color&&e.useColors&&(e.color=i());for(var a=new Array(arguments.length),u=0;u<a.length;u++)a[u]=arguments[u];a[0]=t.coerce(a[0]),"string"!=typeof a[0]&&(a=["%o"].concat(a));var c=0;a[0]=a[0].replace(/%([a-z%])/g,(function(n,r){if("%%"===n)return n;c++;var i=t.formatters[r];if("function"==typeof i){var o=a[c];n=i.call(e,o),a.splice(c,1),c--}return n})),a=t.formatArgs.apply(e,a);var l=o.log||t.log||console.log.bind(console);l.apply(e,a)}r.enabled=!1,o.enabled=!0;var s=t.enabled(e)?o:r;return s.namespace=e,s}})),Ad=ld((function(e,t){function n(){try{return t.storage.debug}catch(e){}if("undefined"!=typeof process&&"env"in process)return process.env.DEBUG}(t=e.exports=kd).log=function(){return"object"===("undefined"==typeof console?"undefined":hd(console))&&console.log&&Function.prototype.apply.call(console.log,console,arguments)},t.formatArgs=function(){var e=arguments,n=this.useColors;if(e[0]=(n?"%c":"")+this.namespace+(n?" %c":" ")+e[0]+(n?"%c ":" ")+"+"+t.humanize(this.diff),!n)return e;var r="color: "+this.color;e=[e[0],r,"color: inherit"].concat(Array.prototype.slice.call(e,1));var i=0,o=0;return e[0].replace(/%[a-z%]/g,(function(e){"%%"!==e&&(i++,"%c"===e&&(o=i))})),e.splice(o,0,r),e},t.save=function(e){try{null==e?t.storage.removeItem("debug"):t.storage.debug=e}catch(e){}},t.load=n,t.useColors=function(){return"undefined"!=typeof document&&"WebkitAppearance"in document.documentElement.style||window.console&&(console.firebug||console.exception&&console.table)||navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31},t.storage="undefined"!=typeof chrome&&void 0!==chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(e){}}(),t.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"],t.formatters.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}},t.enable(n())})),xd=dd,Id=Ad("socket.io-client:url"),Nd=function(e,t){var n=e;t=t||cd.location,null==e&&(e=t.protocol+"//"+t.host);"string"==typeof e&&("/"===e.charAt(0)&&(e="/"===e.charAt(1)?t.protocol+e:t.host+e),/^(https?|wss?):\/\//.test(e)||(Id("protocol-less url %s",e),e=void 0!==t?t.protocol+"//"+e:"https://"+e),Id("parse %s",e),n=xd(e));n.port||(/^(http|ws)$/.test(n.protocol)?n.port="80":/^(http|ws)s$/.test(n.protocol)&&(n.port="443"));n.path=n.path||"/";var r=-1!==n.host.indexOf(":")?"["+n.host+"]":n.host;return n.id=n.protocol+"://"+r+":"+n.port,n.href=n.protocol+"://"+r+(t&&t.port===n.port?"":":"+n.port),n};var Md=1e3,Rd=6e4,Cd=60*Rd,Pd=24*Cd,jd=365.25*Pd,Ld=function(e,t){return t=t||{},"string"==typeof e?function(e){if((e=""+e).length>1e4)return;var t=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(e);if(!t)return;var n=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return n*jd;case"days":case"day":case"d":return n*Pd;case"hours":case"hour":case"hrs":case"hr":case"h":return n*Cd;case"minutes":case"minute":case"mins":case"min":case"m":return n*Rd;case"seconds":case"second":case"secs":case"sec":case"s":return n*Md;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n}}(e):t.long?qd(n=e,Pd,"day")||qd(n,Cd,"hour")||qd(n,Rd,"minute")||qd(n,Md,"second")||n+" ms":function(e){return e>=Pd?Math.round(e/Pd)+"d":e>=Cd?Math.round(e/Cd)+"h":e>=Rd?Math.round(e/Rd)+"m":e>=Md?Math.round(e/Md)+"s":e+"ms"}(e);var n};function qd(e,t,n){if(!(e<t))return e<1.5*t?Math.floor(e/t)+" "+n:Math.ceil(e/t)+" "+n+"s"}var Ud=ld((function(e,t){(t=e.exports=function(e){function r(){}function o(){var e=o,r=+new Date,s=r-(n||r);e.diff=s,e.prev=n,e.curr=r,n=r,null==e.useColors&&(e.useColors=t.useColors()),null==e.color&&e.useColors&&(e.color=i());var a=Array.prototype.slice.call(arguments);a[0]=t.coerce(a[0]),"string"!=typeof a[0]&&(a=["%o"].concat(a));var u=0;a[0]=a[0].replace(/%([a-z%])/g,(function(n,r){if("%%"===n)return n;u++;var i=t.formatters[r];if("function"==typeof i){var o=a[u];n=i.call(e,o),a.splice(u,1),u--}return n})),"function"==typeof t.formatArgs&&(a=t.formatArgs.apply(e,a));var c=o.log||t.log||console.log.bind(console);c.apply(e,a)}r.enabled=!1,o.enabled=!0;var s=t.enabled(e)?o:r;return s.namespace=e,s}).coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){t.enable("")},t.enable=function(e){t.save(e);for(var n=(e||"").split(/[\s,]+/),r=n.length,i=0;i<r;i++)n[i]&&("-"===(e=n[i].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){var n,r;for(n=0,r=t.skips.length;n<r;n++)if(t.skips[n].test(e))return!1;for(n=0,r=t.names.length;n<r;n++)if(t.names[n].test(e))return!0;return!1},t.humanize=Ld,t.names=[],t.skips=[],t.formatters={};var n,r=0;function i(){return t.colors[r++%t.colors.length]}})),Dd=ld((function(e,t){function n(){var e;try{e=t.storage.debug}catch(e){}return e}(t=e.exports=Ud).log=function(){return"object"===("undefined"==typeof console?"undefined":hd(console))&&console.log&&Function.prototype.apply.call(console.log,console,arguments)},t.formatArgs=function(){var e=arguments,n=this.useColors;if(e[0]=(n?"%c":"")+this.namespace+(n?" %c":" ")+e[0]+(n?"%c ":" ")+"+"+t.humanize(this.diff),!n)return e;var r="color: "+this.color;e=[e[0],r,"color: inherit"].concat(Array.prototype.slice.call(e,1));var i=0,o=0;return e[0].replace(/%[a-z%]/g,(function(e){"%%"!==e&&(i++,"%c"===e&&(o=i))})),e.splice(o,0,r),e},t.save=function(e){try{null==e?t.storage.removeItem("debug"):t.storage.debug=e}catch(e){}},t.load=n,t.useColors=function(){return"WebkitAppearance"in document.documentElement.style||window.console&&(console.firebug||console.exception&&console.table)||navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31},t.storage="undefined"!=typeof chrome&&void 0!==chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(e){}}(),t.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"],t.formatters.j=function(e){return JSON.stringify(e)},t.enable(n())})),Vd=ld((function(e,t){
/*! JSON v3.3.2 | http://bestiejs.github.io/json3 | Copyright 2012-2014, Kit Cambridge | http://kit.mit-license.org */
(function(){var n={function:!0,object:!0},r=n.object&&t&&!t.nodeType&&t,i=n["undefined"==typeof window?"undefined":hd(window)]&&window||this,o=r&&n.object&&e&&!e.nodeType&&"object"==hd(cd)&&cd;function s(e,t){e||(e=i.Object()),t||(t=i.Object());var r=e.Number||i.Number,o=e.String||i.String,a=e.Object||i.Object,u=e.Date||i.Date,c=e.SyntaxError||i.SyntaxError,l=e.TypeError||i.TypeError,f=e.Math||i.Math,p=e.JSON||i.JSON;"object"==(void 0===p?"undefined":hd(p))&&p&&(t.stringify=p.stringify,t.parse=p.parse);var d,h,v,b=a.prototype,m=b.toString,g=new u(-0xc782b5b800cec);try{g=-109252==g.getUTCFullYear()&&0===g.getUTCMonth()&&1===g.getUTCDate()&&10==g.getUTCHours()&&37==g.getUTCMinutes()&&6==g.getUTCSeconds()&&708==g.getUTCMilliseconds()}catch(e){}function y(e){if(y[e]!==v)return y[e];var n;if("bug-string-char-index"==e)n="a"!="a"[0];else if("json"==e)n=y("json-stringify")&&y("json-parse");else{var i,s='{"a":[1,true,false,null,"\\u0000\\b\\n\\f\\r\\t"]}';if("json-stringify"==e){var a=t.stringify,c="function"==typeof a&&g;if(c){(i=function(){return 1}).toJSON=i;try{c="0"===a(0)&&"0"===a(new r)&&'""'==a(new o)&&a(m)===v&&a(v)===v&&a()===v&&"1"===a(i)&&"[1]"==a([i])&&"[null]"==a([v])&&"null"==a(null)&&"[null,null,null]"==a([v,m,null])&&a({a:[i,!0,!1,null,"\0\b\n\f\r\t"]})==s&&"1"===a(null,i)&&"[\n 1,\n 2\n]"==a([1,2],null,1)&&'"-271821-04-20T00:00:00.000Z"'==a(new u(-864e13))&&'"+275760-09-13T00:00:00.000Z"'==a(new u(864e13))&&'"-000001-01-01T00:00:00.000Z"'==a(new u(-621987552e5))&&'"1969-12-31T23:59:59.999Z"'==a(new u(-1))}catch(e){c=!1}}n=c}if("json-parse"==e){var l=t.parse;if("function"==typeof l)try{if(0===l("0")&&!l(!1)){var f=5==(i=l(s)).a.length&&1===i.a[0];if(f){try{f=!l('"\t"')}catch(e){}if(f)try{f=1!==l("01")}catch(e){}if(f)try{f=1!==l("1.")}catch(e){}}}}catch(e){f=!1}n=f}}return y[e]=!!n}if(!y("json")){var _="[object Function]",w="[object Number]",E="[object String]",O="[object Array]",S=y("bug-string-char-index");if(!g)var T=f.floor,k=[0,31,59,90,120,151,181,212,243,273,304,334],A=function(e,t){return k[t]+365*(e-1970)+T((e-1969+(t=+(t>1)))/4)-T((e-1901+t)/100)+T((e-1601+t)/400)};if((d=b.hasOwnProperty)||(d=function(e){var t,n={};return(n.__proto__=null,n.__proto__={toString:1},n).toString!=m?d=function(e){var t=this.__proto__,n=e in(this.__proto__=null,this);return this.__proto__=t,n}:(t=n.constructor,d=function(e){var n=(this.constructor||t).prototype;return e in this&&!(e in n&&this[e]===n[e])}),n=null,d.call(this,e)}),h=function(e,t){var r,i,o,s=0;for(o in(r=function(){this.valueOf=0}).prototype.valueOf=0,i=new r)d.call(i,o)&&s++;return r=i=null,s?h=2==s?function(e,t){var n,r={},i=m.call(e)==_;for(n in e)i&&"prototype"==n||d.call(r,n)||!(r[n]=1)||!d.call(e,n)||t(n)}:function(e,t){var n,r,i=m.call(e)==_;for(n in e)i&&"prototype"==n||!d.call(e,n)||(r="constructor"===n)||t(n);(r||d.call(e,n="constructor"))&&t(n)}:(i=["valueOf","toString","toLocaleString","propertyIsEnumerable","isPrototypeOf","hasOwnProperty","constructor"],h=function(e,t){var r,o,s=m.call(e)==_,a=!s&&"function"!=typeof e.constructor&&n[hd(e.hasOwnProperty)]&&e.hasOwnProperty||d;for(r in e)s&&"prototype"==r||!a.call(e,r)||t(r);for(o=i.length;r=i[--o];a.call(e,r)&&t(r));}),h(e,t)},!y("json-stringify")){var x={92:"\\\\",34:'\\"',8:"\\b",12:"\\f",10:"\\n",13:"\\r",9:"\\t"},I=function(e,t){return("000000"+(t||0)).slice(-e)},N=function(e){for(var t='"',n=0,r=e.length,i=!S||r>10,o=i&&(S?e.split(""):e);n<r;n++){var s=e.charCodeAt(n);switch(s){case 8:case 9:case 10:case 12:case 13:case 34:case 92:t+=x[s];break;default:if(s<32){t+="\\u00"+I(2,s.toString(16));break}t+=i?o[n]:e.charAt(n)}}return t+'"'},M=function e(t,n,r,i,o,s,a){var u,c,f,p,b,g,y,_,S,k,x,M,R,C,P,j;try{u=n[t]}catch(e){}if("object"==(void 0===u?"undefined":hd(u))&&u)if("[object Date]"!=(c=m.call(u))||d.call(u,"toJSON"))"function"==typeof u.toJSON&&(c!=w&&c!=E&&c!=O||d.call(u,"toJSON"))&&(u=u.toJSON(t));else if(u>-1/0&&u<1/0){if(A){for(b=T(u/864e5),f=T(b/365.2425)+1970-1;A(f+1,0)<=b;f++);for(p=T((b-A(f,0))/30.42);A(f,p+1)<=b;p++);b=1+b-A(f,p),y=T((g=(u%864e5+864e5)%864e5)/36e5)%24,_=T(g/6e4)%60,S=T(g/1e3)%60,k=g%1e3}else f=u.getUTCFullYear(),p=u.getUTCMonth(),b=u.getUTCDate(),y=u.getUTCHours(),_=u.getUTCMinutes(),S=u.getUTCSeconds(),k=u.getUTCMilliseconds();u=(f<=0||f>=1e4?(f<0?"-":"+")+I(6,f<0?-f:f):I(4,f))+"-"+I(2,p+1)+"-"+I(2,b)+"T"+I(2,y)+":"+I(2,_)+":"+I(2,S)+"."+I(3,k)+"Z"}else u=null;if(r&&(u=r.call(n,t,u)),null===u)return"null";if("[object Boolean]"==(c=m.call(u)))return""+u;if(c==w)return u>-1/0&&u<1/0?""+u:"null";if(c==E)return N(""+u);if("object"==(void 0===u?"undefined":hd(u))){for(C=a.length;C--;)if(a[C]===u)throw l();if(a.push(u),x=[],P=s,s+=o,c==O){for(R=0,C=u.length;R<C;R++)M=e(R,u,r,i,o,s,a),x.push(M===v?"null":M);j=x.length?o?"[\n"+s+x.join(",\n"+s)+"\n"+P+"]":"["+x.join(",")+"]":"[]"}else h(i||u,(function(t){var n=e(t,u,r,i,o,s,a);n!==v&&x.push(N(t)+":"+(o?" ":"")+n)})),j=x.length?o?"{\n"+s+x.join(",\n"+s)+"\n"+P+"}":"{"+x.join(",")+"}":"{}";return a.pop(),j}};t.stringify=function(e,t,r){var i,o,s,a;if(n[void 0===t?"undefined":hd(t)]&&t)if((a=m.call(t))==_)o=t;else if(a==O){s={};for(var u,c=0,l=t.length;c<l;u=t[c++],((a=m.call(u))==E||a==w)&&(s[u]=1));}if(r)if((a=m.call(r))==w){if((r-=r%1)>0)for(i="",r>10&&(r=10);i.length<r;i+=" ");}else a==E&&(i=r.length<=10?r:r.slice(0,10));return M("",((u={})[""]=e,u),o,s,i,"",[])}}if(!y("json-parse")){var R,C,P=o.fromCharCode,j={92:"\\",34:'"',47:"/",98:"\b",116:"\t",110:"\n",102:"\f",114:"\r"},L=function(){throw R=C=null,c()},q=function(){for(var e,t,n,r,i,o=C,s=o.length;R<s;)switch(i=o.charCodeAt(R)){case 9:case 10:case 13:case 32:R++;break;case 123:case 125:case 91:case 93:case 58:case 44:return e=S?o.charAt(R):o[R],R++,e;case 34:for(e="@",R++;R<s;)if((i=o.charCodeAt(R))<32)L();else if(92==i)switch(i=o.charCodeAt(++R)){case 92:case 34:case 47:case 98:case 116:case 110:case 102:case 114:e+=j[i],R++;break;case 117:for(t=++R,n=R+4;R<n;R++)(i=o.charCodeAt(R))>=48&&i<=57||i>=97&&i<=102||i>=65&&i<=70||L();e+=P("0x"+o.slice(t,R));break;default:L()}else{if(34==i)break;for(i=o.charCodeAt(R),t=R;i>=32&&92!=i&&34!=i;)i=o.charCodeAt(++R);e+=o.slice(t,R)}if(34==o.charCodeAt(R))return R++,e;L();default:if(t=R,45==i&&(r=!0,i=o.charCodeAt(++R)),i>=48&&i<=57){for(48==i&&((i=o.charCodeAt(R+1))>=48&&i<=57)&&L(),r=!1;R<s&&((i=o.charCodeAt(R))>=48&&i<=57);R++);if(46==o.charCodeAt(R)){for(n=++R;n<s&&((i=o.charCodeAt(n))>=48&&i<=57);n++);n==R&&L(),R=n}if(101==(i=o.charCodeAt(R))||69==i){for(43!=(i=o.charCodeAt(++R))&&45!=i||R++,n=R;n<s&&((i=o.charCodeAt(n))>=48&&i<=57);n++);n==R&&L(),R=n}return+o.slice(t,R)}if(r&&L(),"true"==o.slice(R,R+4))return R+=4,!0;if("false"==o.slice(R,R+5))return R+=5,!1;if("null"==o.slice(R,R+4))return R+=4,null;L()}return"$"},U=function e(t){var n,r;if("$"==t&&L(),"string"==typeof t){if("@"==(S?t.charAt(0):t[0]))return t.slice(1);if("["==t){for(n=[];"]"!=(t=q());r||(r=!0))r&&(","==t?"]"==(t=q())&&L():L()),","==t&&L(),n.push(e(t));return n}if("{"==t){for(n={};"}"!=(t=q());r||(r=!0))r&&(","==t?"}"==(t=q())&&L():L()),","!=t&&"string"==typeof t&&"@"==(S?t.charAt(0):t[0])&&":"==q()||L(),n[t.slice(1)]=e(q());return n}L()}return t},D=function(e,t,n){var r=V(e,t,n);r===v?delete e[t]:e[t]=r},V=function(e,t,n){var r,i=e[t];if("object"==(void 0===i?"undefined":hd(i))&&i)if(m.call(i)==O)for(r=i.length;r--;)D(i,r,n);else h(i,(function(e){D(i,e,n)}));return n.call(e,t,i)};t.parse=function(e,t){var n,r;return R=0,C=""+e,n=U(q()),"$"!=q()&&L(),R=C=null,t&&m.call(t)==_?V(((r={})[""]=n,r),"",t):n}}}return t.runInContext=s,t}if(!o||o.global!==o&&o.window!==o&&o.self!==o||(i=o),r)s(i,r);else{var a=i.JSON,u=i.JSON3,c=!1,l=s(i,i.JSON3={noConflict:function(){return c||(c=!0,i.JSON=a,i.JSON3=u,a=u=null),l}});i.JSON={parse:l.parse,stringify:l.stringify}}}).call(cd)})),Fd=Bd;function Bd(e){if(e)return function(e){for(var t in Bd.prototype)e[t]=Bd.prototype[t];return e}(e)}Bd.prototype.on=Bd.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks[e]=this._callbacks[e]||[]).push(t),this},Bd.prototype.once=function(e,t){var n=this;function r(){n.off(e,r),t.apply(this,arguments)}return this._callbacks=this._callbacks||{},r.fn=t,this.on(e,r),this},Bd.prototype.off=Bd.prototype.removeListener=Bd.prototype.removeAllListeners=Bd.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n,r=this._callbacks[e];if(!r)return this;if(1==arguments.length)return delete this._callbacks[e],this;for(var i=0;i<r.length;i++)if((n=r[i])===t||n.fn===t){r.splice(i,1);break}return this},Bd.prototype.emit=function(e){this._callbacks=this._callbacks||{};var t=[].slice.call(arguments,1),n=this._callbacks[e];if(n)for(var r=0,i=(n=n.slice(0)).length;r<i;++r)n[r].apply(this,t);return this},Bd.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks[e]||[]},Bd.prototype.hasListeners=function(e){return!!this.listeners(e).length};var Hd=Array.isArray||function(e){return"[object Array]"==Object.prototype.toString.call(e)},Wd=function(e){return cd.Buffer&&cd.Buffer.isBuffer(e)||cd.ArrayBuffer&&e instanceof ArrayBuffer};var Gd=Hd,zd=Wd,Jd={deconstructPacket:function(e){var t=[],n=e.data;var r=e;return r.data=function e(n){if(!n)return n;if(zd(n)){var r={_placeholder:!0,num:t.length};return t.push(n),r}if(Gd(n)){for(var i=new Array(n.length),o=0;o<n.length;o++)i[o]=e(n[o]);return i}if("object"==(void 0===n?"undefined":hd(n))&&!(n instanceof Date)){i={};for(var s in n)i[s]=e(n[s]);return i}return n}(n),r.attachments=t.length,{packet:r,buffers:t}},reconstructPacket:function(e,t){return e.data=function e(n){if(n&&n._placeholder)return t[n.num];if(Gd(n)){for(var r=0;r<n.length;r++)n[r]=e(n[r]);return n}if(n&&"object"==(void 0===n?"undefined":hd(n))){for(var i in n)n[i]=e(n[i]);return n}return n}(e.data),e.attachments=void 0,e},removeBlobs:function(e,t){var n=0,r=e;!function e(i,o,s){if(!i)return i;if(cd.Blob&&i instanceof Blob||cd.File&&i instanceof File){n++;var a=new FileReader;a.onload=function(){s?s[o]=this.result:r=this.result,--n||t(r)},a.readAsArrayBuffer(i)}else if(Gd(i))for(var u=0;u<i.length;u++)e(i[u],u,i);else if(i&&"object"==(void 0===i?"undefined":hd(i))&&!zd(i))for(var c in i)e(i[c],c,i)}(r),n||t(r)}},Yd=ld((function(e,t){var n=Dd("socket.io-parser"),r=Vd,i=Fd,o=Jd,s=Wd;function a(){}function u(e){var i="",o=!1;return i+=e.type,t.BINARY_EVENT!=e.type&&t.BINARY_ACK!=e.type||(i+=e.attachments,i+="-"),e.nsp&&"/"!=e.nsp&&(o=!0,i+=e.nsp),null!=e.id&&(o&&(i+=",",o=!1),i+=e.id),null!=e.data&&(o&&(i+=","),i+=r.stringify(e.data)),n("encoded %j as %s",e,i),i}function c(){this.reconstructor=null}function l(e){this.reconPack=e,this.buffers=[]}function f(e){return{type:t.ERROR,data:"parser error"}}t.protocol=4,t.types=["CONNECT","DISCONNECT","EVENT","ACK","ERROR","BINARY_EVENT","BINARY_ACK"],t.CONNECT=0,t.DISCONNECT=1,t.EVENT=2,t.ACK=3,t.ERROR=4,t.BINARY_EVENT=5,t.BINARY_ACK=6,t.Encoder=a,t.Decoder=c,a.prototype.encode=function(e,r){(n("encoding packet %j",e),t.BINARY_EVENT==e.type||t.BINARY_ACK==e.type)?function(e,t){function n(e){var n=o.deconstructPacket(e),r=u(n.packet),i=n.buffers;i.unshift(r),t(i)}o.removeBlobs(e,n)}(e,r):r([u(e)])},i(c.prototype),c.prototype.add=function(e){var i;if("string"==typeof e)i=function(e){var i={},o=0;if(i.type=Number(e.charAt(0)),null==t.types[i.type])return f();if(t.BINARY_EVENT==i.type||t.BINARY_ACK==i.type){for(var s="";"-"!=e.charAt(++o)&&(s+=e.charAt(o),o!=e.length););if(s!=Number(s)||"-"!=e.charAt(o))throw new Error("Illegal attachments");i.attachments=Number(s)}if("/"==e.charAt(o+1))for(i.nsp="";++o;){if(","==(u=e.charAt(o)))break;if(i.nsp+=u,o==e.length)break}else i.nsp="/";var a=e.charAt(o+1);if(""!==a&&Number(a)==a){for(i.id="";++o;){var u;if(null==(u=e.charAt(o))||Number(u)!=u){--o;break}if(i.id+=e.charAt(o),o==e.length)break}i.id=Number(i.id)}e.charAt(++o)&&(i=function(e,t){try{e.data=r.parse(t)}catch(e){return f()}return e}(i,e.substr(o)));return n("decoded %s as %j",e,i),i}(e),t.BINARY_EVENT==i.type||t.BINARY_ACK==i.type?(this.reconstructor=new l(i),0===this.reconstructor.reconPack.attachments&&this.emit("decoded",i)):this.emit("decoded",i);else{if(!s(e)&&!e.base64)throw new Error("Unknown type: "+e);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");(i=this.reconstructor.takeBinaryData(e))&&(this.reconstructor=null,this.emit("decoded",i))}},c.prototype.destroy=function(){this.reconstructor&&this.reconstructor.finishedReconstruction()},l.prototype.takeBinaryData=function(e){if(this.buffers.push(e),this.buffers.length==this.reconPack.attachments){var t=o.reconstructPacket(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null},l.prototype.finishedReconstruction=function(){this.reconPack=null,this.buffers=[]}})),Qd=ld((function(e){try{e.exports="undefined"!=typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest}catch(t){e.exports=!1}})),Kd=function(e){var t=e.xdomain,n=e.xscheme,r=e.enablesXDR;try{if("undefined"!=typeof XMLHttpRequest&&(!t||Qd))return new XMLHttpRequest}catch(e){}try{if("undefined"!=typeof XDomainRequest&&!n&&r)return new XDomainRequest}catch(e){}if(!t)try{return new(cd[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(e){}},Xd=Object.keys||function(e){var t=[],n=Object.prototype.hasOwnProperty;for(var r in e)n.call(e,r)&&t.push(r);return t},$d=Array.isArray||function(e){return"[object Array]"==Object.prototype.toString.call(e)},Zd=function(e){return function e(t){if(!t)return!1;if(cd.Buffer&&cd.Buffer.isBuffer&&cd.Buffer.isBuffer(t)||cd.ArrayBuffer&&t instanceof ArrayBuffer||cd.Blob&&t instanceof Blob||cd.File&&t instanceof File)return!0;if($d(t)){for(var n=0;n<t.length;n++)if(e(t[n]))return!0}else if(t&&"object"==(void 0===t?"undefined":hd(t)))for(var r in t.toJSON&&"function"==typeof t.toJSON&&(t=t.toJSON()),t)if(Object.prototype.hasOwnProperty.call(t,r)&&e(t[r]))return!0;return!1}(e)};var eh=function(e,t,n){var r=e.byteLength;if(t=t||0,n=n||r,e.slice)return e.slice(t,n);if(t<0&&(t+=r),n<0&&(n+=r),n>r&&(n=r),t>=r||t>=n||0===r)return new ArrayBuffer(0);for(var i=new Uint8Array(e),o=new Uint8Array(n-t),s=t,a=0;s<n;s++,a++)o[a]=i[s];return o.buffer},th=function(e,t,n){var r=!1;return n=n||nh,i.count=e,0===e?t():i;function i(e,o){if(i.count<=0)throw new Error("after called too many times");--i.count,e?(r=!0,t(e),t=n):0!==i.count||r||t(null,o)}};function nh(){}var rh=ld((function(e,t){
/*! https://mths.be/wtf8 v1.0.0 by @mathias */
!function(n){var r=t,i=e&&e.exports==r&&e,o="object"==hd(cd)&&cd;o.global!==o&&o.window!==o||(n=o);var s,a,u,c=String.fromCharCode;function l(e){for(var t,n,r=[],i=0,o=e.length;i<o;)(t=e.charCodeAt(i++))>=55296&&t<=56319&&i<o?56320==(64512&(n=e.charCodeAt(i++)))?r.push(((1023&t)<<10)+(1023&n)+65536):(r.push(t),i--):r.push(t);return r}function f(e,t){return c(e>>t&63|128)}function p(e){if(0==(4294967168&e))return c(e);var t="";return 0==(4294965248&e)?t=c(e>>6&31|192):0==(4294901760&e)?(t=c(e>>12&15|224),t+=f(e,6)):0==(4292870144&e)&&(t=c(e>>18&7|240),t+=f(e,12),t+=f(e,6)),t+=c(63&e|128)}function d(){if(u>=a)throw Error("Invalid byte index");var e=255&s[u];if(u++,128==(192&e))return 63&e;throw Error("Invalid continuation byte")}function h(){var e,t;if(u>a)throw Error("Invalid byte index");if(u==a)return!1;if(e=255&s[u],u++,0==(128&e))return e;if(192==(224&e)){if((t=(31&e)<<6|d())>=128)return t;throw Error("Invalid continuation byte")}if(224==(240&e)){if((t=(15&e)<<12|d()<<6|d())>=2048)return t;throw Error("Invalid continuation byte")}if(240==(248&e)&&(t=(15&e)<<18|d()<<12|d()<<6|d())>=65536&&t<=1114111)return t;throw Error("Invalid WTF-8 detected")}var v={version:"1.0.0",encode:function(e){for(var t=l(e),n=t.length,r=-1,i="";++r<n;)i+=p(t[r]);return i},decode:function(e){s=l(e),a=s.length,u=0;for(var t,n=[];!1!==(t=h());)n.push(t);return function(e){for(var t,n=e.length,r=-1,i="";++r<n;)(t=e[r])>65535&&(i+=c((t-=65536)>>>10&1023|55296),t=56320|1023&t),i+=c(t);return i}(n)}};if(r&&!r.nodeType)if(i)i.exports=v;else{var b={}.hasOwnProperty;for(var m in v)b.call(v,m)&&(r[m]=v[m])}else n.wtf8=v}(cd)})),ih=ld((function(e,t){!function(){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n=new Uint8Array(256),r=0;r<e.length;r++)n[e.charCodeAt(r)]=r;t.encode=function(t){var n,r=new Uint8Array(t),i=r.length,o="";for(n=0;n<i;n+=3)o+=e[r[n]>>2],o+=e[(3&r[n])<<4|r[n+1]>>4],o+=e[(15&r[n+1])<<2|r[n+2]>>6],o+=e[63&r[n+2]];return i%3==2?o=o.substring(0,o.length-1)+"=":i%3==1&&(o=o.substring(0,o.length-2)+"=="),o},t.decode=function(e){var t,r,i,o,s,a=.75*e.length,u=e.length,c=0;"="===e[e.length-1]&&(a--,"="===e[e.length-2]&&a--);var l=new ArrayBuffer(a),f=new Uint8Array(l);for(t=0;t<u;t+=4)r=n[e.charCodeAt(t)],i=n[e.charCodeAt(t+1)],o=n[e.charCodeAt(t+2)],s=n[e.charCodeAt(t+3)],f[c++]=r<<2|i>>4,f[c++]=(15&i)<<4|o>>2,f[c++]=(3&o)<<6|63&s;return l}}()})),oh=cd.BlobBuilder||cd.WebKitBlobBuilder||cd.MSBlobBuilder||cd.MozBlobBuilder,sh=function(){try{return 2===new Blob(["hi"]).size}catch(e){return!1}}(),ah=sh&&function(){try{return 2===new Blob([new Uint8Array([1,2])]).size}catch(e){return!1}}(),uh=oh&&oh.prototype.append&&oh.prototype.getBlob;function ch(e){for(var t=0;t<e.length;t++){var n=e[t];if(n.buffer instanceof ArrayBuffer){var r=n.buffer;if(n.byteLength!==r.byteLength){var i=new Uint8Array(n.byteLength);i.set(new Uint8Array(r,n.byteOffset,n.byteLength)),r=i.buffer}e[t]=r}}}function lh(e,t){t=t||{};var n=new oh;ch(e);for(var r=0;r<e.length;r++)n.append(e[r]);return t.type?n.getBlob(t.type):n.getBlob()}function fh(e,t){return ch(e),new Blob(e,t||{})}var ph=sh?ah?cd.Blob:fh:uh?lh:void 0,dh=ld((function(e,t){var n,r=Xd,i=Zd,o=eh,s=th,a=rh;cd&&cd.ArrayBuffer&&(n=ih);var u="undefined"!=typeof navigator&&/Android/i.test(navigator.userAgent),c="undefined"!=typeof navigator&&/PhantomJS/i.test(navigator.userAgent),l=u||c;t.protocol=3;var f=t.packets={open:0,close:1,ping:2,pong:3,message:4,upgrade:5,noop:6},p=r(f),d={type:"error",data:"parser error"},h=ph;function v(e,t,n){for(var r=new Array(e.length),i=s(e.length,n),o=function(e,n,i){t(n,(function(t,n){r[e]=n,i(t,r)}))},a=0;a<e.length;a++)o(a,e[a],i)}t.encodePacket=function(e,n,r,i){"function"==typeof n&&(i=n,n=!1),"function"==typeof r&&(i=r,r=null);var o=void 0===e.data?void 0:e.data.buffer||e.data;if(cd.ArrayBuffer&&o instanceof ArrayBuffer)return function(e,n,r){if(!n)return t.encodeBase64Packet(e,r);var i=e.data,o=new Uint8Array(i),s=new Uint8Array(1+i.byteLength);s[0]=f[e.type];for(var a=0;a<o.length;a++)s[a+1]=o[a];return r(s.buffer)}(e,n,i);if(h&&o instanceof cd.Blob)return function(e,n,r){if(!n)return t.encodeBase64Packet(e,r);if(l)return function(e,n,r){if(!n)return t.encodeBase64Packet(e,r);var i=new FileReader;return i.onload=function(){e.data=i.result,t.encodePacket(e,n,!0,r)},i.readAsArrayBuffer(e.data)}(e,n,r);var i=new Uint8Array(1);i[0]=f[e.type];var o=new h([i.buffer,e.data]);return r(o)}(e,n,i);if(o&&o.base64)return function(e,n){var r="b"+t.packets[e.type]+e.data.data;return n(r)}(e,i);var s=f[e.type];return void 0!==e.data&&(s+=r?a.encode(String(e.data)):String(e.data)),i(""+s)},t.encodeBase64Packet=function(e,n){var r,i="b"+t.packets[e.type];if(h&&e.data instanceof cd.Blob){var o=new FileReader;return o.onload=function(){var e=o.result.split(",")[1];n(i+e)},o.readAsDataURL(e.data)}try{r=String.fromCharCode.apply(null,new Uint8Array(e.data))}catch(t){for(var s=new Uint8Array(e.data),a=new Array(s.length),u=0;u<s.length;u++)a[u]=s[u];r=String.fromCharCode.apply(null,a)}return i+=cd.btoa(r),n(i)},t.decodePacket=function(e,n,r){if(void 0===e)return d;if("string"==typeof e){if("b"==e.charAt(0))return t.decodeBase64Packet(e.substr(1),n);if(r&&!1===(e=function(e){try{e=a.decode(e)}catch(e){return!1}return e}(e)))return d;var i=e.charAt(0);return Number(i)==i&&p[i]?e.length>1?{type:p[i],data:e.substring(1)}:{type:p[i]}:d}i=new Uint8Array(e)[0];var s=o(e,1);return h&&"blob"===n&&(s=new h([s])),{type:p[i],data:s}},t.decodeBase64Packet=function(e,t){var r=p[e.charAt(0)];if(!n)return{type:r,data:{base64:!0,data:e.substr(1)}};var i=n.decode(e.substr(1));return"blob"===t&&h&&(i=new h([i])),{type:r,data:i}},t.encodePayload=function(e,n,r){"function"==typeof n&&(r=n,n=null);var o=i(e);if(n&&o)return h&&!l?t.encodePayloadAsBlob(e,r):t.encodePayloadAsArrayBuffer(e,r);if(!e.length)return r("0:");v(e,(function(e,r){t.encodePacket(e,!!o&&n,!0,(function(e){r(null,function(e){return e.length+":"+e}(e))}))}),(function(e,t){return r(t.join(""))}))},t.decodePayload=function(e,n,r){if("string"!=typeof e)return t.decodePayloadAsBinary(e,n,r);var i;if("function"==typeof n&&(r=n,n=null),""==e)return r(d,0,1);for(var o,s,a="",u=0,c=e.length;u<c;u++){var l=e.charAt(u);if(":"!=l)a+=l;else{if(""==a||a!=(o=Number(a)))return r(d,0,1);if(a!=(s=e.substr(u+1,o)).length)return r(d,0,1);if(s.length){if(i=t.decodePacket(s,n,!0),d.type==i.type&&d.data==i.data)return r(d,0,1);if(!1===r(i,u+o,c))return}u+=o,a=""}}return""!=a?r(d,0,1):void 0},t.encodePayloadAsArrayBuffer=function(e,n){if(!e.length)return n(new ArrayBuffer(0));v(e,(function(e,n){t.encodePacket(e,!0,!0,(function(e){return n(null,e)}))}),(function(e,t){var r=t.reduce((function(e,t){var n;return e+(n="string"==typeof t?t.length:t.byteLength).toString().length+n+2}),0),i=new Uint8Array(r),o=0;return t.forEach((function(e){var t="string"==typeof e,n=e;if(t){for(var r=new Uint8Array(e.length),s=0;s<e.length;s++)r[s]=e.charCodeAt(s);n=r.buffer}i[o++]=t?0:1;var a=n.byteLength.toString();for(s=0;s<a.length;s++)i[o++]=parseInt(a[s]);i[o++]=255;for(r=new Uint8Array(n),s=0;s<r.length;s++)i[o++]=r[s]})),n(i.buffer)}))},t.encodePayloadAsBlob=function(e,n){v(e,(function(e,n){t.encodePacket(e,!0,!0,(function(e){var t=new Uint8Array(1);if(t[0]=1,"string"==typeof e){for(var r=new Uint8Array(e.length),i=0;i<e.length;i++)r[i]=e.charCodeAt(i);e=r.buffer,t[0]=0}var o=(e instanceof ArrayBuffer?e.byteLength:e.size).toString(),s=new Uint8Array(o.length+1);for(i=0;i<o.length;i++)s[i]=parseInt(o[i]);if(s[o.length]=255,h){var a=new h([t.buffer,s.buffer,e]);n(null,a)}}))}),(function(e,t){return n(new h(t))}))},t.decodePayloadAsBinary=function(e,n,r){"function"==typeof n&&(r=n,n=null);for(var i=e,s=[],a=!1;i.byteLength>0;){for(var u=new Uint8Array(i),c=0===u[0],l="",f=1;255!=u[f];f++){if(l.length>310){a=!0;break}l+=u[f]}if(a)return r(d,0,1);i=o(i,2+l.length),l=parseInt(l);var p=o(i,0,l);if(c)try{p=String.fromCharCode.apply(null,new Uint8Array(p))}catch(e){var h=new Uint8Array(p);p="";for(f=0;f<h.length;f++)p+=String.fromCharCode(h[f])}s.push(p),i=o(i,l)}var v=s.length;s.forEach((function(e,i){r(t.decodePacket(e,n,!0),i,v)}))}})),hh=ld((function(e){function t(e){if(e)return function(e){for(var n in t.prototype)e[n]=t.prototype[n];return e}(e)}e.exports=t,t.prototype.on=t.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks["$"+e]=this._callbacks["$"+e]||[]).push(t),this},t.prototype.once=function(e,t){function n(){this.off(e,n),t.apply(this,arguments)}return n.fn=t,this.on(e,n),this},t.prototype.off=t.prototype.removeListener=t.prototype.removeAllListeners=t.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n,r=this._callbacks["$"+e];if(!r)return this;if(1==arguments.length)return delete this._callbacks["$"+e],this;for(var i=0;i<r.length;i++)if((n=r[i])===t||n.fn===t){r.splice(i,1);break}return this},t.prototype.emit=function(e){this._callbacks=this._callbacks||{};var t=[].slice.call(arguments,1),n=this._callbacks["$"+e];if(n)for(var r=0,i=(n=n.slice(0)).length;r<i;++r)n[r].apply(this,t);return this},t.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks["$"+e]||[]},t.prototype.hasListeners=function(e){return!!this.listeners(e).length}})),vh=dh,bh=mh;function mh(e){this.path=e.path,this.hostname=e.hostname,this.port=e.port,this.secure=e.secure,this.query=e.query,this.timestampParam=e.timestampParam,this.timestampRequests=e.timestampRequests,this.readyState="",this.agent=e.agent||!1,this.socket=e.socket,this.enablesXDR=e.enablesXDR,this.pfx=e.pfx,this.key=e.key,this.passphrase=e.passphrase,this.cert=e.cert,this.ca=e.ca,this.ciphers=e.ciphers,this.rejectUnauthorized=e.rejectUnauthorized,this.forceNode=e.forceNode,this.extraHeaders=e.extraHeaders,this.localAddress=e.localAddress}hh(mh.prototype),mh.prototype.onError=function(e,t){var n=new Error(e);return n.type="TransportError",n.description=t,this.emit("error",n),this},mh.prototype.open=function(){return"closed"!==this.readyState&&""!==this.readyState||(this.readyState="opening",this.doOpen()),this},mh.prototype.close=function(){return"opening"!==this.readyState&&"open"!==this.readyState||(this.doClose(),this.onClose()),this},mh.prototype.send=function(e){if("open"!==this.readyState)throw new Error("Transport not open");this.write(e)},mh.prototype.onOpen=function(){this.readyState="open",this.writable=!0,this.emit("open")},mh.prototype.onData=function(e){var t=vh.decodePacket(e,this.socket.binaryType);this.onPacket(t)},mh.prototype.onPacket=function(e){this.emit("packet",e)},mh.prototype.onClose=function(){this.readyState="closed",this.emit("close")};var gh,yh={encode:function(e){var t="";for(var n in e)e.hasOwnProperty(n)&&(t.length&&(t+="&"),t+=encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t},decode:function(e){for(var t={},n=e.split("&"),r=0,i=n.length;r<i;r++){var o=n[r].split("=");t[decodeURIComponent(o[0])]=decodeURIComponent(o[1])}return t}},_h=function(e,t){var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e},wh="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),Eh={},Oh=0,Sh=0;function Th(e){var t="";do{t=wh[e%64]+t,e=Math.floor(e/64)}while(e>0);return t}function kh(){var e=Th(+new Date);return e!==gh?(Oh=0,gh=e):e+"."+Th(Oh++)}for(;Sh<64;Sh++)Eh[wh[Sh]]=Sh;kh.encode=Th,kh.decode=function(e){var t=0;for(Sh=0;Sh<e.length;Sh++)t=64*t+Eh[e.charAt(Sh)];return t};var Ah=kh,xh=bh,Ih=yh,Nh=dh,Mh=_h,Rh=Ah,Ch=Ad("engine.io-client:polling"),Ph=Lh,jh=null!=new Kd({xdomain:!1}).responseType;function Lh(e){var t=e&&e.forceBase64;jh&&!t||(this.supportsBinary=!1),xh.call(this,e)}Mh(Lh,xh),Lh.prototype.name="polling",Lh.prototype.doOpen=function(){this.poll()},Lh.prototype.pause=function(e){var t=this;function n(){Ch("paused"),t.readyState="paused",e()}if(this.readyState="pausing",this.polling||!this.writable){var r=0;this.polling&&(Ch("we are currently polling - waiting to pause"),r++,this.once("pollComplete",(function(){Ch("pre-pause polling complete"),--r||n()}))),this.writable||(Ch("we are currently writing - waiting to pause"),r++,this.once("drain",(function(){Ch("pre-pause writing complete"),--r||n()})))}else n()},Lh.prototype.poll=function(){Ch("polling"),this.polling=!0,this.doPoll(),this.emit("poll")},Lh.prototype.onData=function(e){var t=this;Ch("polling got data %s",e);Nh.decodePayload(e,this.socket.binaryType,(function(e,n,r){if("opening"===t.readyState&&t.onOpen(),"close"===e.type)return t.onClose(),!1;t.onPacket(e)})),"closed"!==this.readyState&&(this.polling=!1,this.emit("pollComplete"),"open"===this.readyState?this.poll():Ch('ignoring poll - transport state "%s"',this.readyState))},Lh.prototype.doClose=function(){var e=this;function t(){Ch("writing close packet"),e.write([{type:"close"}])}"open"===this.readyState?(Ch("transport open - closing"),t()):(Ch("transport not open - deferring close"),this.once("open",t))},Lh.prototype.write=function(e){var t=this;this.writable=!1;var n=function(){t.writable=!0,t.emit("drain")};Nh.encodePayload(e,this.supportsBinary,(function(e){t.doWrite(e,n)}))},Lh.prototype.uri=function(){var e=this.query||{},t=this.secure?"https":"http",n="";return!1!==this.timestampRequests&&(e[this.timestampParam]=Rh()),this.supportsBinary||e.sid||(e.b64=1),e=Ih.encode(e),this.port&&("https"===t&&443!==Number(this.port)||"http"===t&&80!==Number(this.port))&&(n=":"+this.port),e.length&&(e="?"+e),t+"://"+(-1!==this.hostname.indexOf(":")?"["+this.hostname+"]":this.hostname)+n+this.path+e};var qh=Kd,Uh=Ph,Dh=hh,Vh=_h,Fh=Ad("engine.io-client:polling-xhr"),Bh=Gh,Hh=zh;function Wh(){}function Gh(e){if(Uh.call(this,e),this.requestTimeout=e.requestTimeout,cd.location){var t="https:"===location.protocol,n=location.port;n||(n=t?443:80),this.xd=e.hostname!==cd.location.hostname||n!==e.port,this.xs=e.secure!==t}else this.extraHeaders=e.extraHeaders}function zh(e){this.method=e.method||"GET",this.uri=e.uri,this.xd=!!e.xd,this.xs=!!e.xs,this.async=!1!==e.async,this.data=void 0!==e.data?e.data:null,this.agent=e.agent,this.isBinary=e.isBinary,this.supportsBinary=e.supportsBinary,this.enablesXDR=e.enablesXDR,this.requestTimeout=e.requestTimeout,this.pfx=e.pfx,this.key=e.key,this.passphrase=e.passphrase,this.cert=e.cert,this.ca=e.ca,this.ciphers=e.ciphers,this.rejectUnauthorized=e.rejectUnauthorized,this.extraHeaders=e.extraHeaders,this.create()}function Jh(){for(var e in zh.requests)zh.requests.hasOwnProperty(e)&&zh.requests[e].abort()}Vh(Gh,Uh),Gh.prototype.supportsBinary=!0,Gh.prototype.request=function(e){return(e=e||{}).uri=this.uri(),e.xd=this.xd,e.xs=this.xs,e.agent=this.agent||!1,e.supportsBinary=this.supportsBinary,e.enablesXDR=this.enablesXDR,e.pfx=this.pfx,e.key=this.key,e.passphrase=this.passphrase,e.cert=this.cert,e.ca=this.ca,e.ciphers=this.ciphers,e.rejectUnauthorized=this.rejectUnauthorized,e.requestTimeout=this.requestTimeout,e.extraHeaders=this.extraHeaders,new zh(e)},Gh.prototype.doWrite=function(e,t){var n="string"!=typeof e&&void 0!==e,r=this.request({method:"POST",data:e,isBinary:n}),i=this;r.on("success",t),r.on("error",(function(e){i.onError("xhr post error",e)})),this.sendXhr=r},Gh.prototype.doPoll=function(){Fh("xhr poll");var e=this.request(),t=this;e.on("data",(function(e){t.onData(e)})),e.on("error",(function(e){t.onError("xhr poll error",e)})),this.pollXhr=e},Dh(zh.prototype),zh.prototype.create=function(){var e={agent:this.agent,xdomain:this.xd,xscheme:this.xs,enablesXDR:this.enablesXDR};e.pfx=this.pfx,e.key=this.key,e.passphrase=this.passphrase,e.cert=this.cert,e.ca=this.ca,e.ciphers=this.ciphers,e.rejectUnauthorized=this.rejectUnauthorized;var t=this.xhr=new qh(e),n=this;try{Fh("xhr open %s: %s",this.method,this.uri),t.open(this.method,this.uri,this.async);try{if(this.extraHeaders)for(var r in t.setDisableHeaderCheck(!0),this.extraHeaders)this.extraHeaders.hasOwnProperty(r)&&t.setRequestHeader(r,this.extraHeaders[r])}catch(e){}if(this.supportsBinary&&(t.responseType="arraybuffer"),"POST"===this.method)try{this.isBinary?t.setRequestHeader("Content-type","application/octet-stream"):t.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(e){}try{t.setRequestHeader("Accept","*/*")}catch(e){}"withCredentials"in t&&(t.withCredentials=!0),this.requestTimeout&&(t.timeout=this.requestTimeout),this.hasXDR()?(t.onload=function(){n.onLoad()},t.onerror=function(){n.onError(t.responseText)}):t.onreadystatechange=function(){4===t.readyState&&(200===t.status||1223===t.status?n.onLoad():setTimeout((function(){n.onError(t.status)}),0))},Fh("xhr data %s",this.data),t.send(this.data)}catch(e){return void setTimeout((function(){n.onError(e)}),0)}cd.document&&(this.index=zh.requestsCount++,zh.requests[this.index]=this)},zh.prototype.onSuccess=function(){this.emit("success"),this.cleanup()},zh.prototype.onData=function(e){this.emit("data",e),this.onSuccess()},zh.prototype.onError=function(e){this.emit("error",e),this.cleanup(!0)},zh.prototype.cleanup=function(e){if(void 0!==this.xhr&&null!==this.xhr){if(this.hasXDR()?this.xhr.onload=this.xhr.onerror=Wh:this.xhr.onreadystatechange=Wh,e)try{this.xhr.abort()}catch(e){}cd.document&&delete zh.requests[this.index],this.xhr=null}},zh.prototype.onLoad=function(){var e;try{var t;try{t=this.xhr.getResponseHeader("Content-Type").split(";")[0]}catch(e){}if("application/octet-stream"===t)e=this.xhr.response||this.xhr.responseText;else if(this.supportsBinary)try{e=String.fromCharCode.apply(null,new Uint8Array(this.xhr.response))}catch(t){for(var n=new Uint8Array(this.xhr.response),r=[],i=0,o=n.length;i<o;i++)r.push(n[i]);e=String.fromCharCode.apply(null,r)}else e=this.xhr.responseText}catch(e){this.onError(e)}null!=e&&this.onData(e)},zh.prototype.hasXDR=function(){return void 0!==cd.XDomainRequest&&!this.xs&&this.enablesXDR},zh.prototype.abort=function(){this.cleanup()},zh.requestsCount=0,zh.requests={},cd.document&&(cd.attachEvent?cd.attachEvent("onunload",Jh):cd.addEventListener&&cd.addEventListener("beforeunload",Jh,!1)),Bh.Request=Hh;var Yh,Qh=Ph,Kh=ev,Xh=/\n/g,$h=/\\n/g;function Zh(){}function ev(e){Qh.call(this,e),this.query=this.query||{},Yh||(cd.___eio||(cd.___eio=[]),Yh=cd.___eio),this.index=Yh.length;var t=this;Yh.push((function(e){t.onData(e)})),this.query.j=this.index,cd.document&&cd.addEventListener&&cd.addEventListener("beforeunload",(function(){t.script&&(t.script.onerror=Zh)}),!1)}_h(ev,Qh),ev.prototype.supportsBinary=!1,ev.prototype.doClose=function(){this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),this.form&&(this.form.parentNode.removeChild(this.form),this.form=null,this.iframe=null),Qh.prototype.doClose.call(this)},ev.prototype.doPoll=function(){var e=this,t=document.createElement("script");this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),t.async=!0,t.src=this.uri(),t.onerror=function(t){e.onError("jsonp poll error",t)};var n=document.getElementsByTagName("script")[0];n?n.parentNode.insertBefore(t,n):(document.head||document.body).appendChild(t),this.script=t,"undefined"!=typeof navigator&&/gecko/i.test(navigator.userAgent)&&setTimeout((function(){var e=document.createElement("iframe");document.body.appendChild(e),document.body.removeChild(e)}),100)},ev.prototype.doWrite=function(e,t){var n=this;if(!this.form){var r,i=document.createElement("form"),o=document.createElement("textarea"),s=this.iframeId="eio_iframe_"+this.index;i.className="socketio",i.style.position="absolute",i.style.top="-1000px",i.style.left="-1000px",i.target=s,i.method="POST",i.setAttribute("accept-charset","utf-8"),o.name="d",i.appendChild(o),document.body.appendChild(i),this.form=i,this.area=o}function a(){u(),t()}function u(){if(n.iframe)try{n.form.removeChild(n.iframe)}catch(e){n.onError("jsonp polling iframe removal error",e)}try{var e='<iframe src="javascript:0" name="'+n.iframeId+'">';r=document.createElement(e)}catch(e){(r=document.createElement("iframe")).name=n.iframeId,r.src="javascript:0"}r.id=n.iframeId,n.form.appendChild(r),n.iframe=r}this.form.action=this.uri(),u(),e=e.replace($h,"\\\n"),this.area.value=e.replace(Xh,"\\n");try{this.form.submit()}catch(e){}this.iframe.attachEvent?this.iframe.onreadystatechange=function(){"complete"===n.iframe.readyState&&a()}:this.iframe.onload=a};var tv,nv={},rv=Object.freeze({default:nv}),iv=rv&&nv||rv,ov=bh,sv=dh,av=yh,uv=_h,cv=Ah,lv=Ad("engine.io-client:websocket"),fv=cd.WebSocket||cd.MozWebSocket;if("undefined"==typeof window)try{tv=iv}catch(e){}var pv=fv;pv||"undefined"!=typeof window||(pv=tv);var dv=hv;function hv(e){e&&e.forceBase64&&(this.supportsBinary=!1),this.perMessageDeflate=e.perMessageDeflate,this.usingBrowserWebSocket=fv&&!e.forceNode,this.usingBrowserWebSocket||(pv=tv),ov.call(this,e)}uv(hv,ov),hv.prototype.name="websocket",hv.prototype.supportsBinary=!0,hv.prototype.doOpen=function(){if(this.check()){var e=this.uri(),t={agent:this.agent,perMessageDeflate:this.perMessageDeflate};t.pfx=this.pfx,t.key=this.key,t.passphrase=this.passphrase,t.cert=this.cert,t.ca=this.ca,t.ciphers=this.ciphers,t.rejectUnauthorized=this.rejectUnauthorized,this.extraHeaders&&(t.headers=this.extraHeaders),this.localAddress&&(t.localAddress=this.localAddress);try{this.ws=this.usingBrowserWebSocket?new pv(e):new pv(e,void 0,t)}catch(e){return this.emit("error",e)}void 0===this.ws.binaryType&&(this.supportsBinary=!1),this.ws.supports&&this.ws.supports.binary?(this.supportsBinary=!0,this.ws.binaryType="nodebuffer"):this.ws.binaryType="arraybuffer",this.addEventListeners()}},hv.prototype.addEventListeners=function(){var e=this;this.ws.onopen=function(){e.onOpen()},this.ws.onclose=function(){e.onClose()},this.ws.onmessage=function(t){e.onData(t.data)},this.ws.onerror=function(t){e.onError("websocket error",t)}},hv.prototype.write=function(e){var t=this;this.writable=!1;for(var n=e.length,r=0,i=n;r<i;r++)!function(e){sv.encodePacket(e,t.supportsBinary,(function(r){if(!t.usingBrowserWebSocket){var i={};if(e.options&&(i.compress=e.options.compress),t.perMessageDeflate)("string"==typeof r?cd.Buffer.byteLength(r):r.length)<t.perMessageDeflate.threshold&&(i.compress=!1)}try{t.usingBrowserWebSocket?t.ws.send(r):t.ws.send(r,i)}catch(e){lv("websocket closed before onclose event")}--n||o()}))}(e[r]);function o(){t.emit("flush"),setTimeout((function(){t.writable=!0,t.emit("drain")}),0)}},hv.prototype.onClose=function(){ov.prototype.onClose.call(this)},hv.prototype.doClose=function(){void 0!==this.ws&&this.ws.close()},hv.prototype.uri=function(){var e=this.query||{},t=this.secure?"wss":"ws",n="";return this.port&&("wss"===t&&443!==Number(this.port)||"ws"===t&&80!==Number(this.port))&&(n=":"+this.port),this.timestampRequests&&(e[this.timestampParam]=cv()),this.supportsBinary||(e.b64=1),(e=av.encode(e)).length&&(e="?"+e),t+"://"+(-1!==this.hostname.indexOf(":")?"["+this.hostname+"]":this.hostname)+n+this.path+e},hv.prototype.check=function(){return!(!pv||"__initialize"in pv&&this.name===hv.prototype.name)};var vv=Kd,bv=Bh,mv=Kh;var gv={polling:function(e){var t=!1,n=!1,r=!1!==e.jsonp;if(cd.location){var i="https:"===location.protocol,o=location.port;o||(o=i?443:80),t=e.hostname!==location.hostname||o!==e.port,n=e.secure!==i}if(e.xdomain=t,e.xscheme=n,"open"in new vv(e)&&!e.forceJSONP)return new bv(e);if(!r)throw new Error("JSONP disabled");return new mv(e)},websocket:dv},yv=[].indexOf,_v=function(e,t){if(yv)return e.indexOf(t);for(var n=0;n<e.length;++n)if(e[n]===t)return n;return-1},wv=/^[\],:{}\s]*$/,Ev=/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,Ov=/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,Sv=/(?:^|:|,)(?:\s*\[)+/g,Tv=/^\s+/,kv=/\s+$/,Av=gv,xv=hh,Iv=Ad("engine.io-client:socket"),Nv=_v,Mv=dh,Rv=dd,Cv=function(e){return"string"==typeof e&&e?(e=e.replace(Tv,"").replace(kv,""),cd.JSON&&JSON.parse?JSON.parse(e):wv.test(e.replace(Ev,"@").replace(Ov,"]").replace(Sv,""))?new Function("return "+e)():void 0):null},Pv=yh,jv=Lv;function Lv(e,t){if(!(this instanceof Lv))return new Lv(e,t);t=t||{},e&&"object"===(void 0===e?"undefined":hd(e))&&(t=e,e=null),e?(e=Rv(e),t.hostname=e.host,t.secure="https"===e.protocol||"wss"===e.protocol,t.port=e.port,e.query&&(t.query=e.query)):t.host&&(t.hostname=Rv(t.host).host),this.secure=null!=t.secure?t.secure:cd.location&&"https:"===location.protocol,t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.agent=t.agent||!1,this.hostname=t.hostname||(cd.location?location.hostname:"localhost"),this.port=t.port||(cd.location&&location.port?location.port:this.secure?443:80),this.query=t.query||{},"string"==typeof this.query&&(this.query=Pv.decode(this.query)),this.upgrade=!1!==t.upgrade,this.path=(t.path||"/engine.io").replace(/\/$/,"")+"/",this.forceJSONP=!!t.forceJSONP,this.jsonp=!1!==t.jsonp,this.forceBase64=!!t.forceBase64,this.enablesXDR=!!t.enablesXDR,this.timestampParam=t.timestampParam||"t",this.timestampRequests=t.timestampRequests,this.transports=t.transports||["polling","websocket"],this.readyState="",this.writeBuffer=[],this.prevBufferLen=0,this.policyPort=t.policyPort||843,this.rememberUpgrade=t.rememberUpgrade||!1,this.binaryType=null,this.onlyBinaryUpgrades=t.onlyBinaryUpgrades,this.perMessageDeflate=!1!==t.perMessageDeflate&&(t.perMessageDeflate||{}),!0===this.perMessageDeflate&&(this.perMessageDeflate={}),this.perMessageDeflate&&null==this.perMessageDeflate.threshold&&(this.perMessageDeflate.threshold=1024),this.pfx=t.pfx||null,this.key=t.key||null,this.passphrase=t.passphrase||null,this.cert=t.cert||null,this.ca=t.ca||null,this.ciphers=t.ciphers||null,this.rejectUnauthorized=void 0===t.rejectUnauthorized?null:t.rejectUnauthorized,this.forceNode=!!t.forceNode;var n="object"===hd(cd)&&cd;n.global===n&&(t.extraHeaders&&Object.keys(t.extraHeaders).length>0&&(this.extraHeaders=t.extraHeaders),t.localAddress&&(this.localAddress=t.localAddress)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingIntervalTimer=null,this.pingTimeoutTimer=null,this.open()}Lv.priorWebsocketSuccess=!1,xv(Lv.prototype),Lv.protocol=Mv.protocol,Lv.Socket=Lv,Lv.Transport=bh,Lv.transports=gv,Lv.parser=dh,Lv.prototype.createTransport=function(e){Iv('creating transport "%s"',e);var t=function(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}(this.query);return t.EIO=Mv.protocol,t.transport=e,this.id&&(t.sid=this.id),new Av[e]({agent:this.agent,hostname:this.hostname,port:this.port,secure:this.secure,path:this.path,query:t,forceJSONP:this.forceJSONP,jsonp:this.jsonp,forceBase64:this.forceBase64,enablesXDR:this.enablesXDR,timestampRequests:this.timestampRequests,timestampParam:this.timestampParam,policyPort:this.policyPort,socket:this,pfx:this.pfx,key:this.key,passphrase:this.passphrase,cert:this.cert,ca:this.ca,ciphers:this.ciphers,rejectUnauthorized:this.rejectUnauthorized,perMessageDeflate:this.perMessageDeflate,extraHeaders:this.extraHeaders,forceNode:this.forceNode,localAddress:this.localAddress})},Lv.prototype.open=function(){var e;if(this.rememberUpgrade&&Lv.priorWebsocketSuccess&&-1!==this.transports.indexOf("websocket"))e="websocket";else{if(0===this.transports.length){var t=this;return void setTimeout((function(){t.emit("error","No transports available")}),0)}e=this.transports[0]}this.readyState="opening";try{e=this.createTransport(e)}catch(e){return this.transports.shift(),void this.open()}e.open(),this.setTransport(e)},Lv.prototype.setTransport=function(e){Iv("setting transport %s",e.name);var t=this;this.transport&&(Iv("clearing existing transport %s",this.transport.name),this.transport.removeAllListeners()),this.transport=e,e.on("drain",(function(){t.onDrain()})).on("packet",(function(e){t.onPacket(e)})).on("error",(function(e){t.onError(e)})).on("close",(function(){t.onClose("transport close")}))},Lv.prototype.probe=function(e){Iv('probing transport "%s"',e);var t=this.createTransport(e,{probe:1}),n=!1,r=this;function i(){if(r.onlyBinaryUpgrades){var i=!this.supportsBinary&&r.transport.supportsBinary;n=n||i}n||(Iv('probe transport "%s" opened',e),t.send([{type:"ping",data:"probe"}]),t.once("packet",(function(i){if(!n)if("pong"===i.type&&"probe"===i.data){if(Iv('probe transport "%s" pong',e),r.upgrading=!0,r.emit("upgrading",t),!t)return;Lv.priorWebsocketSuccess="websocket"===t.name,Iv('pausing current transport "%s"',r.transport.name),r.transport.pause((function(){n||"closed"!==r.readyState&&(Iv("changing transport and sending upgrade packet"),l(),r.setTransport(t),t.send([{type:"upgrade"}]),r.emit("upgrade",t),t=null,r.upgrading=!1,r.flush())}))}else{Iv('probe transport "%s" failed',e);var o=new Error("probe error");o.transport=t.name,r.emit("upgradeError",o)}})))}function o(){n||(n=!0,l(),t.close(),t=null)}function s(n){var i=new Error("probe error: "+n);i.transport=t.name,o(),Iv('probe transport "%s" failed because of error: %s',e,n),r.emit("upgradeError",i)}function a(){s("transport closed")}function u(){s("socket closed")}function c(e){t&&e.name!==t.name&&(Iv('"%s" works - aborting "%s"',e.name,t.name),o())}function l(){t.removeListener("open",i),t.removeListener("error",s),t.removeListener("close",a),r.removeListener("close",u),r.removeListener("upgrading",c)}Lv.priorWebsocketSuccess=!1,t.once("open",i),t.once("error",s),t.once("close",a),this.once("close",u),this.once("upgrading",c),t.open()},Lv.prototype.onOpen=function(){if(Iv("socket open"),this.readyState="open",Lv.priorWebsocketSuccess="websocket"===this.transport.name,this.emit("open"),this.flush(),"open"===this.readyState&&this.upgrade&&this.transport.pause){Iv("starting upgrade probes");for(var e=0,t=this.upgrades.length;e<t;e++)this.probe(this.upgrades[e])}},Lv.prototype.onPacket=function(e){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(Iv('socket receive: type "%s", data "%s"',e.type,e.data),this.emit("packet",e),this.emit("heartbeat"),e.type){case"open":this.onHandshake(Cv(e.data));break;case"pong":this.setPing(),this.emit("pong");break;case"error":var t=new Error("server error");t.code=e.data,this.onError(t);break;case"message":this.emit("data",e.data),this.emit("message",e.data)}else Iv('packet received with socket readyState "%s"',this.readyState)},Lv.prototype.onHandshake=function(e){this.emit("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this.upgrades=this.filterUpgrades(e.upgrades),this.pingInterval=e.pingInterval,this.pingTimeout=e.pingTimeout,this.onOpen(),"closed"!==this.readyState&&(this.setPing(),this.removeListener("heartbeat",this.onHeartbeat),this.on("heartbeat",this.onHeartbeat))},Lv.prototype.onHeartbeat=function(e){clearTimeout(this.pingTimeoutTimer);var t=this;t.pingTimeoutTimer=setTimeout((function(){"closed"!==t.readyState&&t.onClose("ping timeout")}),e||t.pingInterval+t.pingTimeout)},Lv.prototype.setPing=function(){var e=this;clearTimeout(e.pingIntervalTimer),e.pingIntervalTimer=setTimeout((function(){Iv("writing ping packet - expecting pong within %sms",e.pingTimeout),e.ping(),e.onHeartbeat(e.pingTimeout)}),e.pingInterval)},Lv.prototype.ping=function(){var e=this;this.sendPacket("ping",(function(){e.emit("ping")}))},Lv.prototype.onDrain=function(){this.writeBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,0===this.writeBuffer.length?this.emit("drain"):this.flush()},Lv.prototype.flush=function(){"closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length&&(Iv("flushing %d packets in socket",this.writeBuffer.length),this.transport.send(this.writeBuffer),this.prevBufferLen=this.writeBuffer.length,this.emit("flush"))},Lv.prototype.write=Lv.prototype.send=function(e,t,n){return this.sendPacket("message",e,t,n),this},Lv.prototype.sendPacket=function(e,t,n,r){if("function"==typeof t&&(r=t,t=void 0),"function"==typeof n&&(r=n,n=null),"closing"!==this.readyState&&"closed"!==this.readyState){(n=n||{}).compress=!1!==n.compress;var i={type:e,data:t,options:n};this.emit("packetCreate",i),this.writeBuffer.push(i),r&&this.once("flush",r),this.flush()}},Lv.prototype.close=function(){if("opening"===this.readyState||"open"===this.readyState){this.readyState="closing";var e=this;this.writeBuffer.length?this.once("drain",(function(){this.upgrading?r():t()})):this.upgrading?r():t()}function t(){e.onClose("forced close"),Iv("socket closing - telling transport to close"),e.transport.close()}function n(){e.removeListener("upgrade",n),e.removeListener("upgradeError",n),t()}function r(){e.once("upgrade",n),e.once("upgradeError",n)}return this},Lv.prototype.onError=function(e){Iv("socket error %j",e),Lv.priorWebsocketSuccess=!1,this.emit("error",e),this.onClose("transport error",e)},Lv.prototype.onClose=function(e,t){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState){Iv('socket close with reason: "%s"',e);clearTimeout(this.pingIntervalTimer),clearTimeout(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),this.readyState="closed",this.id=null,this.emit("close",e,t),this.writeBuffer=[],this.prevBufferLen=0}},Lv.prototype.filterUpgrades=function(e){for(var t=[],n=0,r=e.length;n<r;n++)~Nv(this.transports,e[n])&&t.push(e[n]);return t};var qv=jv,Uv=dh;qv.parser=Uv;var Dv=qv,Vv=function(e,t){for(var n=[],r=(t=t||0)||0;r<e.length;r++)n[r-t]=e[r];return n};var Fv=function(e,t,n){return e.on(t,n),{destroy:function(){e.removeListener(t,n)}}};var Bv=[].slice,Hv=function(e,t){if("string"==typeof t&&(t=e[t]),"function"!=typeof t)throw new Error("bind() requires a function");var n=Bv.call(arguments,2);return function(){return t.apply(e,n.concat(Bv.call(arguments)))}},Wv=ld((function(e,t){var n=Yd,r=hh,i=Vv,o=Fv,s=Hv,a=Ad("socket.io-client:socket"),u=Zd;e.exports=f;var c={connect:1,connect_error:1,connect_timeout:1,connecting:1,disconnect:1,error:1,reconnect:1,reconnect_attempt:1,reconnect_failed:1,reconnect_error:1,reconnecting:1,ping:1,pong:1},l=r.prototype.emit;function f(e,t,n){this.io=e,this.nsp=t,this.json=this,this.ids=0,this.acks={},this.receiveBuffer=[],this.sendBuffer=[],this.connected=!1,this.disconnected=!0,n&&n.query&&(this.query=n.query),this.io.autoConnect&&this.open()}r(f.prototype),f.prototype.subEvents=function(){if(!this.subs){var e=this.io;this.subs=[o(e,"open",s(this,"onopen")),o(e,"packet",s(this,"onpacket")),o(e,"close",s(this,"onclose"))]}},f.prototype.open=f.prototype.connect=function(){return this.connected||(this.subEvents(),this.io.open(),"open"===this.io.readyState&&this.onopen(),this.emit("connecting")),this},f.prototype.send=function(){var e=i(arguments);return e.unshift("message"),this.emit.apply(this,e),this},f.prototype.emit=function(e){if(c.hasOwnProperty(e))return l.apply(this,arguments),this;var t=i(arguments),r=n.EVENT;u(t)&&(r=n.BINARY_EVENT);var o={type:r,data:t,options:{}};return o.options.compress=!this.flags||!1!==this.flags.compress,"function"==typeof t[t.length-1]&&(a("emitting packet with ack id %d",this.ids),this.acks[this.ids]=t.pop(),o.id=this.ids++),this.connected?this.packet(o):this.sendBuffer.push(o),delete this.flags,this},f.prototype.packet=function(e){e.nsp=this.nsp,this.io.packet(e)},f.prototype.onopen=function(){a("transport is open - connecting"),"/"!==this.nsp&&(this.query?this.packet({type:n.CONNECT,query:this.query}):this.packet({type:n.CONNECT}))},f.prototype.onclose=function(e){a("close (%s)",e),this.connected=!1,this.disconnected=!0,delete this.id,this.emit("disconnect",e)},f.prototype.onpacket=function(e){if(e.nsp===this.nsp)switch(e.type){case n.CONNECT:this.onconnect();break;case n.EVENT:case n.BINARY_EVENT:this.onevent(e);break;case n.ACK:case n.BINARY_ACK:this.onack(e);break;case n.DISCONNECT:this.ondisconnect();break;case n.ERROR:this.emit("error",e.data)}},f.prototype.onevent=function(e){var t=e.data||[];a("emitting event %j",t),null!=e.id&&(a("attaching ack callback to event"),t.push(this.ack(e.id))),this.connected?l.apply(this,t):this.receiveBuffer.push(t)},f.prototype.ack=function(e){var t=this,r=!1;return function(){if(!r){r=!0;var o=i(arguments);a("sending ack %j",o);var s=u(o)?n.BINARY_ACK:n.ACK;t.packet({type:s,id:e,data:o})}}},f.prototype.onack=function(e){var t=this.acks[e.id];"function"==typeof t?(a("calling ack %s with %j",e.id,e.data),t.apply(this,e.data),delete this.acks[e.id]):a("bad ack %s",e.id)},f.prototype.onconnect=function(){this.connected=!0,this.disconnected=!1,this.emit("connect"),this.emitBuffered()},f.prototype.emitBuffered=function(){var e;for(e=0;e<this.receiveBuffer.length;e++)l.apply(this,this.receiveBuffer[e]);for(this.receiveBuffer=[],e=0;e<this.sendBuffer.length;e++)this.packet(this.sendBuffer[e]);this.sendBuffer=[]},f.prototype.ondisconnect=function(){a("server disconnect (%s)",this.nsp),this.destroy(),this.onclose("io server disconnect")},f.prototype.destroy=function(){if(this.subs){for(var e=0;e<this.subs.length;e++)this.subs[e].destroy();this.subs=null}this.io.destroy(this)},f.prototype.close=f.prototype.disconnect=function(){return this.connected&&(a("performing disconnect (%s)",this.nsp),this.packet({type:n.DISCONNECT})),this.destroy(),this.connected&&this.onclose("io client disconnect"),this},f.prototype.compress=function(e){return this.flags=this.flags||{},this.flags.compress=e,this}})),Gv=zv;function zv(e){e=e||{},this.ms=e.min||100,this.max=e.max||1e4,this.factor=e.factor||2,this.jitter=e.jitter>0&&e.jitter<=1?e.jitter:0,this.attempts=0}zv.prototype.duration=function(){var e=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var t=Math.random(),n=Math.floor(t*this.jitter*e);e=0==(1&Math.floor(10*t))?e-n:e+n}return 0|Math.min(e,this.max)},zv.prototype.reset=function(){this.attempts=0},zv.prototype.setMin=function(e){this.ms=e},zv.prototype.setMax=function(e){this.max=e},zv.prototype.setJitter=function(e){this.jitter=e};var Jv=Dv,Yv=Wv,Qv=hh,Kv=Yd,Xv=Fv,$v=Hv,Zv=Ad("socket.io-client:manager"),eb=_v,tb=Gv,nb=Object.prototype.hasOwnProperty,rb=ib;function ib(e,t){if(!(this instanceof ib))return new ib(e,t);e&&"object"===(void 0===e?"undefined":hd(e))&&(t=e,e=void 0),(t=t||{}).path=t.path||"/socket.io",this.nsps={},this.subs=[],this.opts=t,this.reconnection(!1!==t.reconnection),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor(t.randomizationFactor||.5),this.backoff=new tb({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==t.timeout?2e4:t.timeout),this.readyState="closed",this.uri=e,this.connecting=[],this.lastPing=null,this.encoding=!1,this.packetBuffer=[],this.encoder=new Kv.Encoder,this.decoder=new Kv.Decoder,this.autoConnect=!1!==t.autoConnect,this.autoConnect&&this.open()}ib.prototype.emitAll=function(){for(var e in this.emit.apply(this,arguments),this.nsps)nb.call(this.nsps,e)&&this.nsps[e].emit.apply(this.nsps[e],arguments)},ib.prototype.updateSocketIds=function(){for(var e in this.nsps)nb.call(this.nsps,e)&&(this.nsps[e].id=this.engine.id)},Qv(ib.prototype),ib.prototype.reconnection=function(e){return arguments.length?(this._reconnection=!!e,this):this._reconnection},ib.prototype.reconnectionAttempts=function(e){return arguments.length?(this._reconnectionAttempts=e,this):this._reconnectionAttempts},ib.prototype.reconnectionDelay=function(e){return arguments.length?(this._reconnectionDelay=e,this.backoff&&this.backoff.setMin(e),this):this._reconnectionDelay},ib.prototype.randomizationFactor=function(e){return arguments.length?(this._randomizationFactor=e,this.backoff&&this.backoff.setJitter(e),this):this._randomizationFactor},ib.prototype.reconnectionDelayMax=function(e){return arguments.length?(this._reconnectionDelayMax=e,this.backoff&&this.backoff.setMax(e),this):this._reconnectionDelayMax},ib.prototype.timeout=function(e){return arguments.length?(this._timeout=e,this):this._timeout},ib.prototype.maybeReconnectOnOpen=function(){!this.reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()},ib.prototype.open=ib.prototype.connect=function(e,t){if(Zv("readyState %s",this.readyState),~this.readyState.indexOf("open"))return this;Zv("opening %s",this.uri),this.engine=Jv(this.uri,this.opts);var n=this.engine,r=this;this.readyState="opening",this.skipReconnect=!1;var i=Xv(n,"open",(function(){r.onopen(),e&&e()})),o=Xv(n,"error",(function(t){if(Zv("connect_error"),r.cleanup(),r.readyState="closed",r.emitAll("connect_error",t),e){var n=new Error("Connection error");n.data=t,e(n)}else r.maybeReconnectOnOpen()}));if(!1!==this._timeout){var s=this._timeout;Zv("connect attempt will timeout after %d",s);var a=setTimeout((function(){Zv("connect attempt timed out after %d",s),i.destroy(),n.close(),n.emit("error","timeout"),r.emitAll("connect_timeout",s)}),s);this.subs.push({destroy:function(){clearTimeout(a)}})}return this.subs.push(i),this.subs.push(o),this},ib.prototype.onopen=function(){Zv("open"),this.cleanup(),this.readyState="open",this.emit("open");var e=this.engine;this.subs.push(Xv(e,"data",$v(this,"ondata"))),this.subs.push(Xv(e,"ping",$v(this,"onping"))),this.subs.push(Xv(e,"pong",$v(this,"onpong"))),this.subs.push(Xv(e,"error",$v(this,"onerror"))),this.subs.push(Xv(e,"close",$v(this,"onclose"))),this.subs.push(Xv(this.decoder,"decoded",$v(this,"ondecoded")))},ib.prototype.onping=function(){this.lastPing=new Date,this.emitAll("ping")},ib.prototype.onpong=function(){this.emitAll("pong",new Date-this.lastPing)},ib.prototype.ondata=function(e){this.decoder.add(e)},ib.prototype.ondecoded=function(e){this.emit("packet",e)},ib.prototype.onerror=function(e){Zv("error",e),this.emitAll("error",e)},ib.prototype.socket=function(e,t){var n=this.nsps[e];if(!n){n=new Yv(this,e,t),this.nsps[e]=n;var r=this;n.on("connecting",i),n.on("connect",(function(){n.id=r.engine.id})),this.autoConnect&&i()}function i(){~eb(r.connecting,n)||r.connecting.push(n)}return n},ib.prototype.destroy=function(e){var t=eb(this.connecting,e);~t&&this.connecting.splice(t,1),this.connecting.length||this.close()},ib.prototype.packet=function(e){Zv("writing packet %j",e);var t=this;e.query&&0===e.type&&(e.nsp+="?"+e.query),t.encoding?t.packetBuffer.push(e):(t.encoding=!0,this.encoder.encode(e,(function(n){for(var r=0;r<n.length;r++)t.engine.write(n[r],e.options);t.encoding=!1,t.processPacketQueue()})))},ib.prototype.processPacketQueue=function(){if(this.packetBuffer.length>0&&!this.encoding){var e=this.packetBuffer.shift();this.packet(e)}},ib.prototype.cleanup=function(){Zv("cleanup");for(var e=this.subs.length,t=0;t<e;t++){this.subs.shift().destroy()}this.packetBuffer=[],this.encoding=!1,this.lastPing=null,this.decoder.destroy()},ib.prototype.close=ib.prototype.disconnect=function(){Zv("disconnect"),this.skipReconnect=!0,this.reconnecting=!1,"opening"===this.readyState&&this.cleanup(),this.backoff.reset(),this.readyState="closed",this.engine&&this.engine.close()},ib.prototype.onclose=function(e){Zv("onclose"),this.cleanup(),this.backoff.reset(),this.readyState="closed",this.emit("close",e),this._reconnection&&!this.skipReconnect&&this.reconnect()},ib.prototype.reconnect=function(){if(this.reconnecting||this.skipReconnect)return this;var e=this;if(this.backoff.attempts>=this._reconnectionAttempts)Zv("reconnect failed"),this.backoff.reset(),this.emitAll("reconnect_failed"),this.reconnecting=!1;else{var t=this.backoff.duration();Zv("will wait %dms before reconnect attempt",t),this.reconnecting=!0;var n=setTimeout((function(){e.skipReconnect||(Zv("attempting reconnect"),e.emitAll("reconnect_attempt",e.backoff.attempts),e.emitAll("reconnecting",e.backoff.attempts),e.skipReconnect||e.open((function(t){t?(Zv("reconnect attempt error"),e.reconnecting=!1,e.reconnect(),e.emitAll("reconnect_error",t.data)):(Zv("reconnect success"),e.onreconnect())})))}),t);this.subs.push({destroy:function(){clearTimeout(n)}})}},ib.prototype.onreconnect=function(){var e=this.backoff.attempts;this.reconnecting=!1,this.backoff.reset(),this.updateSocketIds(),this.emitAll("reconnect",e)};var ob=ld((function(e,t){var n=Nd,r=Yd,i=rb,o=Ad("socket.io-client");e.exports=t=a;var s=t.managers={};function a(e,t){"object"===(void 0===e?"undefined":hd(e))&&(t=e,e=void 0),t=t||{};var r,a=n(e),u=a.source,c=a.id,l=a.path,f=s[c]&&l in s[c].nsps;return t.forceNew||t["force new connection"]||!1===t.multiplex||f?(o("ignoring socket cache for %s",u),r=i(u,t)):(s[c]||(o("new io instance for %s",u),s[c]=i(u,t)),r=s[c]),a.query&&!t.query?t.query=a.query:t&&"object"===hd(t.query)&&(t.query=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")}(t.query)),r.socket(a.path,t)}t.protocol=r.protocol,t.connect=a,t.Manager=rb,t.Socket=Wv})),sb=function(e,t){return void 0===t?e:t},ab=function(){function e(){vd(this,e)}return bd(e,null,[{key:"establish",value:function(e){var t=e.url,n=e.id,r=e.isActiveTab,i=e.options;e.logger.info("Establishing Kluster connection via Channel lib;");var o=function(e,t){return e+(e.split("?")[1]?"&":"?")+t}(t,"id="+n+"&tags="+function(e){var t=e?[{name:"cobrowse",unique:!0}]:[];return encodeURIComponent(JSON.stringify(t))}(r));return ob.connect(o,{"force new connection":!0,timeout:sb(15e3,i.timeout),reconnectionDelay:sb(1e3,i.reconnectionDelay),reconnectionDelayMax:sb(1e3,i.reconnectionDelayMax),randomizationFactor:sb(0,i.randomizationFactor),reconnectionAttempts:sb(Infinity,i.reconnectionAttempts),upgrade:sb(undefined,i.upgrade)})}}]),e}(),ub=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];vd(this,e),this.emit=this.emit.bind(this),this.socket=t,this.stopped=null===this.socket,this.tags=n,this.childEmitters=[]}return bd(e,[{key:"stop",value:function(){return this.stopped=!0,this.socket=null,this.childEmitters.map((function(e){return e.stop()}))}},{key:"in",value:function(e){var t=new this.constructor(this.socket,[e],this);return this.childEmitters.push(t),t}},{key:"emit",value:function(e,t){if(!this.stopped){var n={"channel:event_name":e,"channel:event_data":t,"channel:tags":this.tags};return this.socket.emit("announce",n)}}},{key:"authorize",value:function(e){if(!this.stopped)return this.socket.emit("authorize",{token:e})}}]),e}(),cb=function(){function e(t){var n=t.id,r=t.socketId,i=t.tags;vd(this,e),this.id=n,this.socketId=r,this.tags=i}return bd(e,null,[{key:"build",value:function(t){var n=t.tags.map((function(e){return e._name}));return new e({id:t.id,socketId:t.socketId,tags:n})}}]),e}(),lb=function(e){if("function"==typeof e)return e;return function(){return e}},fb="undefined"!=typeof self?self:null,pb="undefined"!=typeof window?window:null,db=fb||pb||db,hb="2.0.0",vb=0,bb=1,mb=2,gb=3,yb="closed",_b="errored",wb="joined",Eb="joining",Ob="leaving",Sb="phx_close",Tb="phx_error",kb="phx_join",Ab="phx_reply",xb="phx_leave",Ib="longpoll",Nb="websocket",Mb=4,Rb=function(){function e(t,n,r,i){vd(this,e),this.channel=t,this.event=n,this.payload=r||function(){return{}},this.receivedResp=null,this.timeout=i,this.timeoutTimer=null,this.recHooks=[],this.sent=!1}return bd(e,[{key:"resend",value:function(e){this.timeout=e,this.reset(),this.send()}},{key:"send",value:function(){this.hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload(),ref:this.ref,join_ref:this.channel.joinRef()}))}},{key:"receive",value:function(e,t){return this.hasReceived(e)&&t(this.receivedResp.response),this.recHooks.push({status:e,callback:t}),this}},{key:"reset",value:function(){this.cancelRefEvent(),this.ref=null,this.refEvent=null,this.receivedResp=null,this.sent=!1}},{key:"matchReceive",value:function(e){var t=e.status,n=e.response;e._ref;this.recHooks.filter((function(e){return e.status===t})).forEach((function(e){return e.callback(n)}))}},{key:"cancelRefEvent",value:function(){this.refEvent&&this.channel.off(this.refEvent)}},{key:"cancelTimeout",value:function(){clearTimeout(this.timeoutTimer),this.timeoutTimer=null}},{key:"startTimeout",value:function(){var e=this;this.timeoutTimer&&this.cancelTimeout(),this.ref=this.channel.socket.makeRef(),this.refEvent=this.channel.replyEventName(this.ref),this.channel.on(this.refEvent,(function(t){e.cancelRefEvent(),e.cancelTimeout(),e.receivedResp=t,e.matchReceive(t)})),this.timeoutTimer=setTimeout((function(){e.trigger("timeout",{})}),this.timeout)}},{key:"hasReceived",value:function(e){return this.receivedResp&&this.receivedResp.status===e}},{key:"trigger",value:function(e,t){this.channel.trigger(this.refEvent,{status:e,response:t})}}]),e}(),Cb=function(){function e(t,n){vd(this,e),this.callback=t,this.timerCalc=n,this.timer=null,this.tries=0}return bd(e,[{key:"reset",value:function(){this.tries=0,clearTimeout(this.timer)}},{key:"scheduleTimeout",value:function(){var e=this;clearTimeout(this.timer),this.timer=setTimeout((function(){e.tries=e.tries+1,e.callback()}),this.timerCalc(this.tries+1))}}]),e}(),Pb=function(){function e(t,n,r){var i=this;vd(this,e),this.state=yb,this.topic=t,this.params=lb(n||{}),this.socket=r,this.bindings=[],this.bindingRef=0,this.timeout=this.socket.timeout,this.joinedOnce=!1,this.joinPush=new Rb(this,kb,this.params,this.timeout),this.pushBuffer=[],this.stateChangeRefs=[],this.rejoinTimer=new Cb((function(){i.socket.isConnected()&&i.rejoin()}),this.socket.rejoinAfterMs),this.stateChangeRefs.push(this.socket.onError((function(){return i.rejoinTimer.reset()}))),this.stateChangeRefs.push(this.socket.onOpen((function(){i.rejoinTimer.reset(),i.isErrored()&&i.rejoin()}))),this.joinPush.receive("ok",(function(){i.state=wb,i.rejoinTimer.reset(),i.pushBuffer.forEach((function(e){return e.send()})),i.pushBuffer=[]})),this.joinPush.receive("error",(function(){i.state=_b,i.socket.isConnected()&&i.rejoinTimer.scheduleTimeout()})),this.onClose((function(){i.rejoinTimer.reset(),i.socket.hasLogger()&&i.socket.log("channel","close "+i.topic+" "+i.joinRef()),i.state=yb,i.socket.remove(i)})),this.onError((function(e){i.socket.hasLogger()&&i.socket.log("channel","error "+i.topic,e),i.isJoining()&&i.joinPush.reset(),i.state=_b,i.socket.isConnected()&&i.rejoinTimer.scheduleTimeout()})),this.joinPush.receive("timeout",(function(){i.socket.hasLogger()&&i.socket.log("channel","timeout "+i.topic+" ("+i.joinRef()+")",i.joinPush.timeout),new Rb(i,xb,lb({}),i.timeout).send(),i.state=_b,i.joinPush.reset(),i.socket.isConnected()&&i.rejoinTimer.scheduleTimeout()})),this.on(Ab,(function(e,t){i.trigger(i.replyEventName(t),e)}))}return bd(e,[{key:"join",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeout;if(this.joinedOnce)throw new Error("tried to join multiple times. 'join' can only be called a single time per channel instance");return this.timeout=e,this.joinedOnce=!0,this.rejoin(),this.joinPush}},{key:"onClose",value:function(e){this.on(Sb,e)}},{key:"onError",value:function(e){return this.on(Tb,(function(t){return e(t)}))}},{key:"on",value:function(e,t){var n=this.bindingRef++;return this.bindings.push({event:e,ref:n,callback:t}),n}},{key:"off",value:function(e,t){this.bindings=this.bindings.filter((function(n){return!(n.event===e&&(void 0===t||t===n.ref))}))}},{key:"canPush",value:function(){return this.socket.isConnected()&&this.isJoined()}},{key:"push",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.timeout;if(t=t||{},!this.joinedOnce)throw new Error("tried to push '"+e+"' to '"+this.topic+"' before joining. Use channel.join() before pushing events");var r=new Rb(this,e,(function(){return t}),n);return this.canPush()?r.send():(r.startTimeout(),this.pushBuffer.push(r)),r}},{key:"leave",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeout;this.rejoinTimer.reset(),this.joinPush.cancelTimeout(),this.state=Ob;var n=function(){e.socket.hasLogger()&&e.socket.log("channel","leave "+e.topic),e.trigger(Sb,"leave")},r=new Rb(this,xb,lb({}),t);return r.receive("ok",(function(){return n()})).receive("timeout",(function(){return n()})),r.send(),this.canPush()||r.trigger("ok",{}),r}},{key:"onMessage",value:function(e,t,n){return t}},{key:"isMember",value:function(e,t,n,r){return this.topic===e&&(!r||r===this.joinRef()||(this.socket.hasLogger()&&this.socket.log("channel","dropping outdated message",{topic:e,event:t,payload:n,joinRef:r}),!1))}},{key:"joinRef",value:function(){return this.joinPush.ref}},{key:"rejoin",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeout;this.isLeaving()||(this.socket.leaveOpenTopic(this.topic),this.state=Eb,this.joinPush.resend(e))}},{key:"trigger",value:function(e,t,n,r){var i=this.onMessage(e,t,n,r);if(t&&!i)throw new Error("channel onMessage callbacks must return the payload, modified or unmodified");for(var o=this.bindings.filter((function(t){return t.event===e})),s=0;s<o.length;s++){o[s].callback(i,n,r||this.joinRef())}}},{key:"replyEventName",value:function(e){return"chan_reply_"+e}},{key:"isClosed",value:function(){return this.state===yb}},{key:"isErrored",value:function(){return this.state===_b}},{key:"isJoined",value:function(){return this.state===wb}},{key:"isJoining",value:function(){return this.state===Eb}},{key:"isLeaving",value:function(){return this.state===Ob}}]),e}(),jb=function(){function e(){vd(this,e)}return bd(e,null,[{key:"request",value:function(e,t,n,r,i,o,s){if(db.XDomainRequest){var a=new db.XDomainRequest;return this.xdomainRequest(a,e,t,r,i,o,s)}var u=new db.XMLHttpRequest;return this.xhrRequest(u,e,t,n,r,i,o,s)}},{key:"xdomainRequest",value:function(e,t,n,r,i,o,s){var a=this;return e.timeout=i,e.open(t,n),e.onload=function(){var t=a.parseJSON(e.responseText);s&&s(t)},o&&(e.ontimeout=o),e.onprogress=function(){},e.send(r),e}},{key:"xhrRequest",value:function(e,t,n,r,i,o,s,a){var u=this;return e.open(t,n,!0),e.timeout=o,e.setRequestHeader("Content-Type",r),e.onerror=function(){return a&&a(null)},e.onreadystatechange=function(){if(e.readyState===Mb&&a){var t=u.parseJSON(e.responseText);a(t)}},s&&(e.ontimeout=s),e.send(i),e}},{key:"parseJSON",value:function(e){if(!e||""===e)return null;try{return JSON.parse(e)}catch(t){return console&&console.log("failed to parse JSON response",e),null}}},{key:"serialize",value:function(e,t){var n=[];for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var i=t?t+"["+r+"]":r,o=e[r];"object"===(void 0===o?"undefined":hd(o))?n.push(this.serialize(o,i)):n.push(encodeURIComponent(i)+"="+encodeURIComponent(o))}return n.join("&")}},{key:"appendParams",value:function(e,t){if(0===Object.keys(t).length)return e;var n=e.match(/\?/)?"&":"?";return""+e+n+this.serialize(t)}}]),e}(),Lb=function(){function e(t){vd(this,e),this.endPoint=null,this.token=null,this.skipHeartbeat=!0,this.reqs=new Set,this.onopen=function(){},this.onerror=function(){},this.onmessage=function(){},this.onclose=function(){},this.pollEndpoint=this.normalizeEndpoint(t),this.readyState=vb,this.poll()}return bd(e,[{key:"normalizeEndpoint",value:function(e){return e.replace("ws://","http://").replace("wss://","https://").replace(new RegExp("(.*)/"+Nb),"$1/"+Ib)}},{key:"endpointURL",value:function(){return jb.appendParams(this.pollEndpoint,{token:this.token})}},{key:"closeAndRetry",value:function(e,t,n){this.close(e,t,n),this.readyState=vb}},{key:"ontimeout",value:function(){this.onerror("timeout"),this.closeAndRetry(1005,"timeout",!1)}},{key:"isActive",value:function(){return this.readyState===bb||this.readyState===vb}},{key:"poll",value:function(){var e=this;this.ajax("GET",null,(function(){return e.ontimeout()}),(function(t){if(t){var n=t.status,r=t.token,i=t.messages;e.token=r}else n=0;switch(n){case 200:i.forEach((function(t){setTimeout((function(){return e.onmessage({data:t})}),0)})),e.poll();break;case 204:e.poll();break;case 410:e.readyState=bb,e.onopen({}),e.poll();break;case 403:e.onerror(403),e.close(1008,"forbidden",!1);break;case 0:case 500:e.onerror(500),e.closeAndRetry(1011,"internal server error",500);break;default:e.onerror(n),e.close()}}))}},{key:"send",value:function(e){var t=this;this.ajax("POST",e,(function(){return t.onerror("timeout")}),(function(e){e&&200===e.status||(t.onerror(e&&e.status),t.closeAndRetry(1011,"internal server error",!1))}))}},{key:"close",value:function(e,t,n){var r=!0,i=!1,o=void 0;try{for(var s,a=this.reqs[Symbol.iterator]();!(r=(s=a.next()).done);r=!0){s.value.abort()}}catch(e){i=!0,o=e}finally{try{!r&&a.return&&a.return()}finally{if(i)throw o}}this.readyState=gb;var u=Object.assign({code:1e3,reason:void 0,wasClean:!0},{code:e,reason:t,wasClean:n});"undefined"!=typeof CloseEvent?this.onclose(new CloseEvent("close",u)):this.onclose(u)}},{key:"ajax",value:function(e,t,n,r){var i=this,o=void 0;o=jb.request(e,this.endpointURL(),"application/json",t,this.timeout,(function(){i.reqs.delete(o),n()}),(function(e){i.reqs.delete(o),i.isActive()&&r(e)})),this.reqs.add(o)}}]),e}(),qb=function(){function e(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};vd(this,e);var i=r.events||{state:"presence_state",diff:"presence_diff"};this.state={},this.pendingDiffs=[],this.channel=t,this.joinRef=null,this.caller={onChange:null,onJoin:null,onLeave:null,onSync:function(){}},this.channel.on(i.state,(function(t){var r=n.caller,i=r.onChange,o=r.onJoin,s=r.onLeave,a=r.onSync;n.joinRef=n.channel.joinRef(),o||s?e.syncState(n.state,t,o,s):e.synchronizeState(n.state,t,i),n.pendingDiffs.forEach((function(t){o||s?e.syncDiff(n.state,t,o,s):e.synchronizeDiff(n.state,t,i)})),n.pendingDiffs=[],a()})),this.channel.on(i.diff,(function(t){var r=n.caller,i=r.onChange,o=r.onJoin,s=r.onLeave,a=r.onSync;n.inPendingSyncState()?n.pendingDiffs.push(t):(o||s?e.syncDiff(n.state,t,o,s):e.synchronizeDiff(n.state,t,i),a())}))}return bd(e,[{key:"onJoin",value:function(e){console&&console.warn&&console.warn("onJoin is deprecated, use onChange instead"),this.caller.onJoin=e}},{key:"onLeave",value:function(e){console&&console.warn&&console.warn("onLeave is deprecated, use onChange instead"),this.caller.onLeave=e}},{key:"onChange",value:function(e){this.caller.onChange=e}},{key:"onSync",value:function(e){this.caller.onSync=e}},{key:"list",value:function(t){return e.list(this.state,t)}},{key:"inPendingSyncState",value:function(){return!this.joinRef||this.joinRef!==this.channel.joinRef()}}],[{key:"synchronizeState",value:function(e,t,n){var r={},i={};return this.map(e,(function(e,n){t[e]||(i[e]=n)})),this.map(t,(function(t,n){var o=e[t];if(o){var s=n.metas.map((function(e){return e.phx_ref})),a=o.metas.map((function(e){return e.phx_ref})),u=n.metas.filter((function(e){return a.indexOf(e.phx_ref)<0})),c=o.metas.filter((function(e){return s.indexOf(e.phx_ref)<0}));u.length>0&&(r[t]=n,r[t].metas=u),c.length>0&&(u.length>0?i[t]={metas:c}:(i[t]=n,i[t].metas=c))}else r[t]=n})),this.synchronizeDiff(e,{joins:r,leaves:i},n)}},{key:"syncState",value:function(e,t,n,r){var i=this,o=this.clone(e),s={},a={};return this.map(o,(function(e,n){t[e]||(a[e]=n)})),this.map(t,(function(e,t){var n=o[e];if(n){var r=t.metas.map((function(e){return e.phx_ref})),u=n.metas.map((function(e){return e.phx_ref})),c=t.metas.filter((function(e){return u.indexOf(e.phx_ref)<0})),l=n.metas.filter((function(e){return r.indexOf(e.phx_ref)<0}));c.length>0&&(s[e]=t,s[e].metas=c),l.length>0&&(a[e]=i.clone(n),a[e].metas=l)}else s[e]=t})),this.syncDiff(o,{joins:s,leaves:a},n,r)}},{key:"synchronizeDiff",value:function(e,t,n){var r=t.joins,i=t.leaves,o={};return this.map(r,(function(e,t){o[e]={joinedMetas:t.metas,leftMetas:[],update:t}})),this.map(i,(function(e,t){o[e]?o[e].leftMetas=t.metas:o[e]={joinedMetas:[],leftMetas:t.metas,update:t}})),this.map(o,(function(t,r){var i=r.joinedMetas,o=r.leftMetas,s=r.update,a=i.map((function(e){return e.phx_ref})),u=o.map((function(e){return e.phx_ref})),c=e[t],l={metas:c?c.metas:[]};l.metas=l.metas.filter((function(e){return-1===a.indexOf(e.phx_ref)})).concat(i).filter((function(e){return-1===u.indexOf(e.phx_ref)})),Object.keys(s).forEach((function(e){"metas"!==e&&(l[e]=s[e])})),0===l.metas.length?delete e[t]:e[t]=l,n&&n(t,c,l)})),e}},{key:"syncDiff",value:function(e,t,n,r){var i=this,o=this.clone(t),s=o.joins,a=o.leaves;return n||(n=function(){}),r||(r=function(){}),this.map(s,(function(t,r){var o=e[t];if(e[t]=i.clone(r),o){var s,a=e[t].metas.map((function(e){return e.phx_ref})),u=o.metas.filter((function(e){return a.indexOf(e.phx_ref)<0}));(s=e[t].metas).unshift.apply(s,function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}(u))}n(t,o,r)})),this.map(a,(function(t,n){var i=e[t];if(i){var o=n.metas.map((function(e){return e.phx_ref}));i.metas=i.metas.filter((function(e){return o.indexOf(e.phx_ref)<0})),r(t,i,n),0===i.metas.length&&delete e[t]}})),e}},{key:"list",value:function(e,t){return t||(t=function(e,t){return t}),this.map(e,(function(e,n){return t(e,n)}))}},{key:"map",value:function(e,t){return Object.getOwnPropertyNames(e).map((function(n){return t(n,e[n])}))}},{key:"clone",value:function(e){return JSON.parse(JSON.stringify(e))}}]),e}(),Ub={HEADER_LENGTH:1,META_LENGTH:4,KINDS:{push:0,reply:1,broadcast:2},encode:function(e,t){if(e.payload.constructor===ArrayBuffer)return t(this.binaryEncode(e));var n=[e.join_ref,e.ref,e.topic,e.event,e.payload];return t(JSON.stringify(n))},decode:function(e,t){if(e.constructor===ArrayBuffer)return t(this.binaryDecode(e));var n=JSON.parse(e),r=gd(n,5);return t({join_ref:r[0],ref:r[1],topic:r[2],event:r[3],payload:r[4]})},binaryEncode:function(e){var t=e.join_ref,n=e.ref,r=e.event,i=e.topic,o=e.payload,s=this.META_LENGTH+t.length+n.length+i.length+r.length,a=new ArrayBuffer(this.HEADER_LENGTH+s),u=new DataView(a),c=0;u.setUint8(c++,this.KINDS.push),u.setUint8(c++,t.length),u.setUint8(c++,n.length),u.setUint8(c++,i.length),u.setUint8(c++,r.length),Array.from(t,(function(e){return u.setUint8(c++,e.charCodeAt(0))})),Array.from(n,(function(e){return u.setUint8(c++,e.charCodeAt(0))})),Array.from(i,(function(e){return u.setUint8(c++,e.charCodeAt(0))})),Array.from(r,(function(e){return u.setUint8(c++,e.charCodeAt(0))}));var l=new Uint8Array(a.byteLength+o.byteLength);return l.set(new Uint8Array(a),0),l.set(new Uint8Array(o),a.byteLength),l.buffer},binaryDecode:function(e){var t=new DataView(e),n=t.getUint8(0),r=new TextDecoder;switch(n){case this.KINDS.push:return this.decodePush(e,t,r);case this.KINDS.reply:return this.decodeReply(e,t,r);case this.KINDS.broadcast:return this.decodeBroadcast(e,t,r)}},decodePush:function(e,t,n){var r=t.getUint8(1),i=t.getUint8(2),o=t.getUint8(3),s=this.HEADER_LENGTH+this.META_LENGTH-1,a=n.decode(e.slice(s,s+r));s+=r;var u=n.decode(e.slice(s,s+i));s+=i;var c=n.decode(e.slice(s,s+o));return s+=o,{join_ref:a,ref:null,topic:u,event:c,payload:e.slice(s,e.byteLength)}},decodeReply:function(e,t,n){var r=t.getUint8(1),i=t.getUint8(2),o=t.getUint8(3),s=t.getUint8(4),a=this.HEADER_LENGTH+this.META_LENGTH,u=n.decode(e.slice(a,a+r));a+=r;var c=n.decode(e.slice(a,a+i));a+=i;var l=n.decode(e.slice(a,a+o));a+=o;var f=n.decode(e.slice(a,a+s));a+=s;var p=e.slice(a,e.byteLength);return{join_ref:u,ref:c,topic:l,event:Ab,payload:{status:f,response:p}}},decodeBroadcast:function(e,t,n){var r=t.getUint8(1),i=t.getUint8(2),o=this.HEADER_LENGTH+2,s=n.decode(e.slice(o,o+r));o+=r;var a=n.decode(e.slice(o,o+i));return o+=i,{join_ref:null,ref:null,topic:s,event:a,payload:e.slice(o,e.byteLength)}}},Db=function(){function e(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};vd(this,e),this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.channels=[],this.sendBuffer=[],this.ref=0,this.timeout=r.timeout||1e4,this.transport=r.transport||db.WebSocket||Lb,this.establishedConnections=0,this.defaultEncoder=Ub.encode.bind(Ub),this.defaultDecoder=Ub.decode.bind(Ub),this.closeWasClean=!1,this.binaryType=r.binaryType||"arraybuffer",this.connectClock=1,this.transport!==Lb?(this.encode=r.encode||this.defaultEncoder,this.decode=r.decode||this.defaultDecoder):(this.encode=this.defaultEncoder,this.decode=this.defaultDecoder);var i=null;pb&&pb.addEventListener&&(pb.addEventListener("pagehide",(function(e){n.conn&&(n.disconnect(),i=n.connectClock)})),pb.addEventListener("pageshow",(function(e){i===n.connectClock&&(i=null,n.connect())}))),this.heartbeatIntervalMs=r.heartbeatIntervalMs||3e4,this.rejoinAfterMs=function(e){return r.rejoinAfterMs?r.rejoinAfterMs(e):[1e3,2e3,5e3][e-1]||1e4},this.reconnectAfterMs=function(e){return r.reconnectAfterMs?r.reconnectAfterMs(e):[10,50,100,150,200,250,500,1e3,2e3][e-1]||5e3},this.logger=r.logger||null,this.longpollerTimeout=r.longpollerTimeout||2e4,this.params=lb(r.params||{}),this.endPoint=t+"/"+Nb,this.vsn=r.vsn||hb,this.heartbeatTimeoutTimer=null,this.heartbeatTimer=null,this.pendingHeartbeatRef=null,this.reconnectTimer=new Cb((function(){n.teardown((function(){return n.connect()}))}),this.reconnectAfterMs)}return bd(e,[{key:"getLongPollTransport",value:function(){return Lb}},{key:"replaceTransport",value:function(e){this.connectClock++,this.closeWasClean=!0,this.reconnectTimer.reset(),this.sendBuffer=[],this.conn&&(this.conn.close(),this.conn=null),this.transport=e}},{key:"protocol",value:function(){return location.protocol.match(/^https/)?"wss":"ws"}},{key:"endPointURL",value:function(){var e=jb.appendParams(jb.appendParams(this.endPoint,this.params()),{vsn:this.vsn});return"/"!==e.charAt(0)?e:"/"===e.charAt(1)?this.protocol()+":"+e:this.protocol()+"://"+location.host+e}},{key:"disconnect",value:function(e,t,n){this.connectClock++,this.closeWasClean=!0,this.reconnectTimer.reset(),this.teardown(e,t,n)}},{key:"connect",value:function(e){var t=this;e&&(console&&console.log("passing params to connect is deprecated. Instead pass :params to the Socket constructor"),this.params=lb(e)),this.conn||(this.connectClock++,this.closeWasClean=!1,this.conn=new this.transport(this.endPointURL()),this.conn.binaryType=this.binaryType,this.conn.timeout=this.longpollerTimeout,this.conn.onopen=function(){return t.onConnOpen()},this.conn.onerror=function(e){return t.onConnError(e)},this.conn.onmessage=function(e){return t.onConnMessage(e)},this.conn.onclose=function(e){return t.onConnClose(e)})}},{key:"log",value:function(e,t,n){this.logger(e,t,n)}},{key:"hasLogger",value:function(){return null!==this.logger}},{key:"onOpen",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.open.push([t,e]),t}},{key:"onClose",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.close.push([t,e]),t}},{key:"onError",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.error.push([t,e]),t}},{key:"onMessage",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.message.push([t,e]),t}},{key:"ping",value:function(e){var t=this;if(!this.isConnected())return!1;var n=this.makeRef(),r=Date.now();this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:n});var i=this.onMessage((function(o){o.ref===n&&(t.off([i]),e(Date.now()-r))}));return!0}},{key:"clearHeartbeats",value:function(){clearTimeout(this.heartbeatTimer),clearTimeout(this.heartbeatTimeoutTimer)}},{key:"onConnOpen",value:function(){if(this.hasLogger()){var e=this.endPointURL().replace(/access_token=([^&#/]+)/,"access_token=-pruned-");this.log("transport","connected to "+e)}this.closeWasClean=!1,this.establishedConnections++,this.flushSendBuffer(),this.reconnectTimer.reset(),this.resetHeartbeat(),this.stateChangeCallbacks.open.forEach((function(e){return(0,gd(e,2)[1])()}))}},{key:"heartbeatTimeout",value:function(){var e=this;this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null,this.hasLogger()&&this.log("transport","heartbeat timeout. Attempting to re-establish connection"),this.triggerChanError(),this.closeWasClean=!1,this.teardown((function(){return e.reconnectTimer.scheduleTimeout()}),1e3,"heartbeat timeout"))}},{key:"resetHeartbeat",value:function(){var e=this;this.conn&&this.conn.skipHeartbeat||(this.pendingHeartbeatRef=null,this.clearHeartbeats(),this.heartbeatTimer=setTimeout((function(){return e.sendHeartbeat()}),this.heartbeatIntervalMs))}},{key:"teardown",value:function(e,t,n){var r=this;if(!this.conn)return e&&e();this.waitForBufferDone((function(){r.conn&&(t?r.conn.close(t,n||""):r.conn.close()),r.waitForSocketClosed((function(){r.conn&&(r.conn.onopen=function(){},r.conn.onerror=function(){},r.conn.onmessage=function(){},r.conn.onclose=function(){},r.conn=null),e&&e()}))}))}},{key:"waitForBufferDone",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;5!==n&&this.conn&&this.conn.bufferedAmount?setTimeout((function(){t.waitForBufferDone(e,n+1)}),150*n):e()}},{key:"waitForSocketClosed",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;5!==n&&this.conn&&this.conn.readyState!==gb?setTimeout((function(){t.waitForSocketClosed(e,n+1)}),150*n):e()}},{key:"onConnClose",value:function(e){this.hasLogger()&&this.log("transport","close",e),this.triggerChanError(),this.clearHeartbeats(),this.closeWasClean||this.reconnectTimer.scheduleTimeout(),this.stateChangeCallbacks.close.forEach((function(t){return(0,gd(t,2)[1])(e)}))}},{key:"onConnError",value:function(e){this.hasLogger()&&this.log("transport",e);var t=this.transport,n=this.establishedConnections;this.stateChangeCallbacks.error.forEach((function(r){(0,gd(r,2)[1])(e,t,n)})),(t===this.transport||n>0)&&this.triggerChanError()}},{key:"triggerChanError",value:function(){this.channels.forEach((function(e){e.isErrored()||e.isLeaving()||e.isClosed()||e.trigger(Tb)}))}},{key:"connectionState",value:function(){switch(this.conn&&this.conn.readyState){case vb:return"connecting";case bb:return"open";case mb:return"closing";default:return"closed"}}},{key:"isConnected",value:function(){return"open"===this.connectionState()}},{key:"remove",value:function(e){this.off(e.stateChangeRefs),this.channels=this.channels.filter((function(t){return t.joinRef()!==e.joinRef()}))}},{key:"off",value:function(e){for(var t in this.stateChangeCallbacks)this.stateChangeCallbacks[t]=this.stateChangeCallbacks[t].filter((function(t){var n=gd(t,1)[0];return-1===e.indexOf(n)}))}},{key:"channel",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=new Pb(e,t,this);return this.channels.push(n),n}},{key:"push",value:function(e){var t=this;if(this.hasLogger()){var n=e.topic,r=e.event,i=e.payload,o=e.ref,s=e.join_ref;this.log("push",n+" "+r+" ("+s+", "+o+")",i)}this.isConnected()?this.encode(e,(function(e){return t.conn.send(e)})):this.sendBuffer.push((function(){return t.encode(e,(function(e){return t.conn.send(e)}))}))}},{key:"makeRef",value:function(){var e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}},{key:"sendHeartbeat",value:function(){var e=this;this.pendingHeartbeatRef&&!this.isConnected()||(this.pendingHeartbeatRef=this.makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.heartbeatTimeoutTimer=setTimeout((function(){return e.heartbeatTimeout()}),this.heartbeatIntervalMs))}},{key:"flushSendBuffer",value:function(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach((function(e){return e()})),this.sendBuffer=[])}},{key:"onConnMessage",value:function(e){var t=this;this.decode(e.data,(function(e){var n=e.topic,r=e.event,i=e.payload,o=e.ref,s=e.join_ref;o&&o===t.pendingHeartbeatRef&&(t.clearHeartbeats(),t.pendingHeartbeatRef=null,t.heartbeatTimer=setTimeout((function(){return t.sendHeartbeat()}),t.heartbeatIntervalMs)),t.hasLogger()&&t.log("receive",(i.status||"")+" "+n+" "+r+" "+(o&&"("+o+")"||""),i);for(var a=0;a<t.channels.length;a++){var u=t.channels[a];u.isMember(n,r,i,s)&&u.trigger(r,i,o,s)}for(var c=0;c<t.stateChangeCallbacks.message.length;c++){(0,gd(t.stateChangeCallbacks.message[c],2)[1])(e)}}))}},{key:"leaveOpenTopic",value:function(e){for(var t=void 0,n=0;n<this.channels.length;n++){var r=this.channels[n];if(r.topic===e&&(r.isJoined()||r.isJoining())){t=r;break}}t&&(this.hasLogger()&&this.log("transport",'leaving duplicate topic "'+e+'"'),t.leave())}}]),e}(),Vb=function(e,t){return t.onlyLongPollEnabled?Lb:window.WebSocket?window.navigator.onLine?e.transport===window.WebSocket?Lb:window.WebSocket:e.transport:Lb},Fb=function(e){return!function(e){return e&&"error"===e.type}(e)};function Bb(e){var t={onlyLongPollEnabled:!1,connectionTriedOnce:!1,avoidLongPollWorkerInterval:6e5},n=void 0,r=function(n,r){t.onlyLongPollEnabled=!0,e.disconnect((function(){e.transport=Lb,r&&r(n),e.connect()}))},i=void 0;return{ensureConnected:function(i){var o=i.onInitialTry,s=i.onInitialError,a=i.avoidLongPollWorkerInterval;if(!t.connectionTriedOnce){o&&o(),"number"==typeof a&&(t.avoidLongPollWorkerInterval=a);try{e.connect(),e.conn.readyState===window.WebSocket.CLOSED&&r(null,s)}catch(e){r(e,s)}t.connectionTriedOnce=!0,n=function(e,t){if(t.avoidLongPollWorkerInterval>0&&!t.onlyLongPollEnabled){var n=setInterval((function(){if("open"===e.connectionState()&&e.transport===Lb){var n=Vb(e,t);if(e.transport!==n)return e.transport=n,e.disconnect((function(){return e.connect()}))}}),t.avoidLongPollWorkerInterval);return function(){return clearInterval(n)}}}(e,t)}},selectNewTransport:function(n){Fb(n)&&Fb(i)||(e.transport=Vb(e,t),i=n)},stop:function(){n&&n()}}}var Hb=function(){return"hidden"===document.visibilityState},Wb=function(){return window.navigator.onLine},Gb=function(e){return"object"===(void 0===e?"undefined":hd(e))?e&&e.reason:e},zb=function(e){for(var t=[],n=0;n<e.length;n++)for(var r=0;r<e[n].length;r++)t.push(e[n][r]);return t},Jb=function(e){return e===window.WebSocket?"WebSocket":e===Lb?"LongPoll":"unknown"},Yb=function(e){return"object"===(void 0===e?"undefined":hd(e))?e&&e.reason:e},Qb={metrics:{}};function Kb(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{logPrefix:"PubSub"},i=r.logPrefix,o=0,s=!1;n=n||Qb;var a=function(e){n.metrics.connectionMetric&&n.increment(n.metrics.connectionMetric,e)},u=function(t){var n={transport:Jb(e.transport),online:Wb(),visibility_state:document.visibilityState,error_count:o};return md({},n,t)},c=function(t,n){return["transport:"+((n||{}).transport||Jb(e.transport)),"online:"+Wb()].concat(t)},l=function(){s=!0,a(c(["action:connected"])),t.info(i+" socket opened",u({}))},f=function(e){if(e){var n=Jb(window.WebSocket),r=u({reason:e.reason,type:e.type,code:e.code&&e.code.toString(),transport:n}),o=c(["action:disconnected","type:"+e.type,"code:"+e.code],{transport:n});e.wasClean?(a(o.concat(["reason:closed"])),t.info(i+" connection disconnected cleanly",r)):Hb()?(a(o.concat(["reason:closed"])),t.info(i+" connection disconnected while tab was hidden",r)):(a(o.concat(["reason:closed"])),t.info(i+" connection disconnected",r))}else{var s=Jb(Lb),l=u({reason:"unknown",type:"unknown",code:"unknown",transport:s}),f=c(["action:disconnected","type:unknown","reason:unknown","code:unknown"],{transport:s});a(f),t.info(i+" connection disconnected",l)}},p=function(e){var n=e&&e.type||"unknown";o+=1;var r=e&&e.target?u({type:n}):u({type:n,error:e});Hb()?t.info(i+" connection error while tab was hidden",r):Wb()?1!==o||s?(a(c(["action:error"])),t.warn(i+" socket connection error",r)):t.info(i+" socket connection error while attempting to establish the connection first time",r):t.info(i+" connection error while user was offline",r)},d=function(n){return t.info(i+" failed to connect with initial transport",{new_transport:Jb(e.transport),error:Yb(n)})},h=function(){return a(c(["action:connect"]))};return{onOpen:l,onClose:f,onError:p,onInitialTry:h,onInitialConnectError:d}}var Xb=function(e,t){var n=t.enabled,r=t.logPrefix;return n?function(t,n,i){return e.info(r+" "+t+": "+n,{pubsub_data:i})}:function(){}},$b=function(e,t){window.addEventListener("offline",t),window.addEventListener("online",e)},Zb="[Channel Phoenix]",em={initialDelay:500,maxDelay:1e4,factor:1.2};function tm(e){var t=e.logger,n=e.serverURL,r=e.phoenixLogsEnabled,i=e.getAccessToken,o=e.transport,s=e.socketOverride,a=function(e){var t=e.initialDelay,n=e.maxDelay,r=e.factor,i=e.jitter,o=e.random;n||(n=6e4),void 0===r&&(r=2),void 0===i&&(i=.5),o||(o=Math.random);var s=null,a=function(e){var a=t*Math.pow(r,e);s&&(a=Math.max(a,s),s=null);var u=o(),c=Math.floor(u*i*a),l=Math.floor(10*u)%2==0?a-c:a+c;return Math.min(l,n)};return a.setNextDelayMinimum=function(e){s=e},a.maximizeNextDelay=function(){return a.setNextDelayMinimum(n)},a}(em),u=n.split("?")[0],c={logger:Xb(t,{enabled:r,logPrefix:Zb}),params:function(){return{access_token:i()}},reconnectAfterMs:a,timeout:864e5,transport:o};o&&o.customSerializer&&(c.decode=o.decode,c.encode=o.encode);var l=s||new Db("wss://"+u,c),f=new Bb(l),p=new Kb(l,t,null,{logPrefix:Zb});l.onOpen((function(){p.onOpen()})),l.onClose((function(e){p.onClose(e)})),l.onError((function(e){if("number"==typeof e)switch(e){case 403:t.info(Zb+" Detected likely pubsub authentication error, reconnecting after max delay"),a.setNextDelayMinimum(em.maxDelay);break;case 410:break;case 500:t.info(Zb+" PubSub connection disconnected with error 500");break;case 503:var n=em.maxDelay/2;t.info(Zb+" PubSub unavailable, postponing reconnecting for at least "+n+" ms"),a.setNextDelayMinimum(n);break;default:return t.error(Zb+" Received unhandled pubsub error status "+e+", stopping reconnecting"),void l.disconnect()}p.onError(e),f.selectNewTransport(e)}));var d=void 0,h=function(e){var n=e.checkInterval,r=e.cutoff,i=Date.now();clearInterval(d),d=setInterval((function(){if(l.channels.length>0)i=Date.now();else{var e=Date.now()-i;e>=r&&(t.info(Zb+" Disconnecting from PubSub due to idle",{idle_for:e}),l.disconnect(),clearInterval(d))}}),n||6e4)},v=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};f.ensureConnected({onInitialTry:function(){return p.onInitialTry},onInitialError:function(e){return p.onInitialConnectError(e)}}),l.connect(),e.idleDisconnectCutoff>0&&h({checkInterval:e.idleCheckInterval,cutoff:e.idleDisconnectCutoff})},b=l.disconnect.bind(l),m=l.channel.bind(l),g=function(e,t){var n=e.disconnect,r=e.connect,i=e.triggerChanError,o=!1;return function(e){if(!e&&!o){t.info("Forcefully reconnecting to the socket"),o=!0;try{i()}catch(e){t.warn("Unable to triggerChanError",e)}n((function(){r(),o=!1}))}}}({disconnect:b,connect:v,triggerChanError:l.triggerChanError.bind(l)},t);return{connect:v,disconnect:b,channel:m,forceReconnect:g,socket:l}}var nm="phoenix_signaler.proxy_channel",rm=function(e){return md({},e,{event:"phx_reply",payload:{response:{},status:"ok"}})};function im(e,t){var n=this;this.skipHeartbeat=!0,this.readyState=1,setTimeout((function(){return n.onopen()})),e.onmessage=function(e){n.onmessage(e)},this.send=function(t){e.postMessage(t)},this.close=function(){}}var om=function(e){var t=im.bind(null,e);return t.customSerializer=!0,t.decode=function(e,t){return t(e)},t.encode=function(e,t){return t(e)},t};function am(){var e=void 0;return{listenForProxyTransport:function(t){var n=t.logger,r=t.allowedOrigin,i=t.checkOrigin;i=i||function(e){return e===r};var o=function(t){if(t.source===window.parent&&t.data===nm)if(i(t.origin)){var r=t.ports[0];e=om(r)}else n.warn("Received CrossFrameMultiplexer message from unexpected origin, discarding",{origin:t.origin})};window.addEventListener("message",o);return function(){return window.removeEventListener("message",o)}},getProxyTransport:function(){return e},createProxyTransport:om}}var um=function(){function e(){vd(this,e),this.joinRefs={},this.outboundMessageRefs={}}return bd(e,[{key:"registerInnerJoin",value:function(e,t,n){this.joinRefs[e]={innerJoinRef:t,channel:n}}},{key:"registerInnerLeave",value:function(e){var t=this.joinRefs[e].channel;return delete this.joinRefs[e],t}},{key:"isFresh",value:function(e,t){return this.joinRefs[e]&&this.joinRefs[e].innerJoinRef===t}},{key:"registerOutboundMessage",value:function(e,t,n){return this.outboundMessageRefs[t]=n,this.joinRefs[e].channel}},{key:"processMessageFromBackend",value:function(e){var t=e.topic,n=e.event,r=e.payload,i=e.ref,o=this.joinRefs[t];if(o&&(!i||this.outboundMessageRefs[i])){var s=i&&this.outboundMessageRefs[i];return delete this.outboundMessageRefs[i],{topic:t,event:n,payload:r,ref:s,join_ref:o.innerJoinRef}}}}]),e}();function cm(){return{proxyTo:function(e){var t=e.allowedDomain,n=e.phoenixSocket,r=e.iFrame,i=e.logger,o=new MessageChannel,s=new um,a=[];o.port1.onmessage=function(e){var t=e.data,r=t.topic,u=t.event,c=t.join_ref,l=t.ref;if("phx_join"===u){var f=function(e,t){return e.channels.find((function(e){return e.topic===t&&(e.isJoined()||e.isJoining())}))}(n,r);if(f)return s.registerInnerJoin(r,c,f),void o.port1.postMessage(rm(e.data));var p=n.channel(r);return p.join().receive("ok",(function(){o.port1.postMessage(rm(e.data))})).receive("error",(function(e){i.warn("Failed to join extra channel in proxy transport",{topic:r,error:e})})),a.push(p),void s.registerInnerJoin(r,c,p)}if("phx_leave"!==u)if(s.isFresh(r,c)){var d=n.makeRef(),h=s.registerOutboundMessage(r,d,l);e.data.ref=d,e.data.join_ref=h.joinRef(),n.push(e.data)}else i.info("Discarding stale proxy push",{topic:r,event:u});else{if(s.isFresh(r,c)){var v=s.registerInnerLeave(r);v&&-1!==a.indexOf(v)&&(a.splice(a.indexOf(v),1),v.leave())}else i.info("Discarding stale proxy phx_leave instruction",{topic:r});o.port1.postMessage(rm(e.data))}},r.contentWindow.postMessage(nm,t,[o.port2]);var u=n.onMessage((function(e){var t=s.processMessageFromBackend(e);t&&o.port1.postMessage(t)}));return function(){a.forEach((function(e){return e.leave()})),n.off([u]),o.port1.close()}}}}var lm=void 0,fm=new function(){return{asInner:new am,asOuter:new cm}},pm=function(e){if(e)return[{name:"cobrowse",unique:!0}]},dm=function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=function(e,i){var o={0:e,1:i};r.length>0&&(o[2]=r),t.push("send",o).receive("error",(function(r){t.isClosed()||n.warn("Failed to push channel message",{eventName:e,error:r})})).receive("timeout",(function(){t.isClosed()||n.warn("Failed to push channel message due to timeout",{eventName:e})}))},o=function(i){return e(t,n,r.concat([i]))};return{emit:i,toTag:o}},hm=function(e,t,n){var r={},i=!1;return{on:function(o,s){if(i)t.warn("Tried to add eventHandler to stopped channel",{topic:n,eventName:o});else{var a=e.on(o,function(e){return function(t){t&&t.__value?e(t.__value):e(t)}}(s));!function(e,t,n){r[e]=r[e]||[],r[e].push({handler:t,ref:n})}(o,s,a)}},off:function(t,n){var i=function(e,t){var n=(r[e]||[]).filter((function(e){return e.handler===t}));return 1===n.length?(r[e]=r[e].filter((function(e){return e.handler!==t})),n[0].ref):null}(t,n);i&&e.off(t,i)},stop:function(){i=!0,r={}}}};function vm(e){var t=e.url,n=e.getAccessToken,r=e.isActiveTab,i=e.logger,o=e.callback,s=e.clientOverride,a=e.idleDisconnectCutoff,u=lm,c=fm.asInner.getProxyTransport();u||(u=s||new tm({logger:i,serverURL:t,phoenixLogsEnabled:!1,getAccessToken:n,transport:c}),lm=u);var l=[],f=!1,p=function(e){try{return e.split("?")[1].match(/topic=([^&]+)/)[1]}catch(e){throw new Error("Cannot find topic in channel URL params")}}(t),d=u.channel(p,(function(){return{tags:pm(r)}})),h=dm(d,i),v=hm(d,i,p),b=function(e){var t=[],n=new qb(e),r=function(e,t){return t.metas.map((function(t){return new cb({id:e.match(/visitor/)?"visitor":e,socketId:t.connection_id,tags:t.tags.map((function(e){return e.name}))})}))},i=zb(n.list(r));return n.onSync((function(){i=zb(n.list(r)),t.forEach((function(e){return e(i)}))})),{onParticipantState:function(e){return t.push(e),e(i),function(){t=t.filter((function(t){return t!==e}))}}}}(d).onParticipantState,m=function(){d.leave(),l.forEach((function(e){return e.call()})),l=[],v.stop(),f=!0},g=function(e){var t=e.name,n=e.unique?[{name:t,unique:!0}]:[{name:t}];d.push("register_tags",n).receive("error",(function(e){i.warn("Failed to register tag",{error:e,tag_name:t})})).receive("timeout",(function(){i.warn("Failed to register tag due to timeout",{tag_name:t})}))},y={url:t,on:v.on,off:v.off,onParticipantState:b,emit:h.emit,emitAll:h.emit,toTag:h.toTag,registerTag:g,registerUniqueTag:function(e){var t=e.name;g({name:t,unique:!0})},authorize:function(){},proxyToIframe:function(e,t){return fm.asOuter.proxyTo({allowedDomain:t,phoenixSocket:d.socket,logger:i,iFrame:e})},close:m,destroy:m,addDestroyListener:function(e){l.push(e)},isStopped:function(){return f}};return function(e){var t=!1;(arguments.length>1&&void 0!==arguments[1]?arguments[1]:$b)((function(){if(t)return t=!1,e()}),(function(){t=!0}))}((function(){return function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3e3,r=!1,i=void 0,o=function(t){r||(r=!0,e(t))};t.ping((function(e){clearTimeout(i),o(!0)}))?i=setTimeout((function(){return o(!1)}),n):o(!1)}(u.forceReconnect,u.socket)})),{start:function(){u.connect({idleDisconnectCutoff:a||3e5});var e=void 0,t=!1;d.join().receive("ok",(function(){t||o(null,y),t=!0,i.info("Joining engagement channel succeeded",{topic:p})})).receive("error",(function(t){t&&"join crashed"===t.reason?i.info("Joining engagement channel failed with crash, retrying",{topic:p}):"unauthorized"===t&&(!e||e<Date.now()-1e4)?(i.info("Joining engagement channel failed due to unauthorized, reconnecting to refresh server side user state",{topic:p}),e=Date.now(),u.disconnect((function(){return u.connect()}))):(i.warn("Joining engagement channel failed",{topic:p,error:Gb(t)}),d.leave(),o({reason:t},null))})).receive("timeout",(function(){i.warn("Joining engagement channel failed",{topic:p,reason:"timeout"}),o({reason:"timeout"},null)}))}}}var bm="channel:meta",mm="current-participants",gm="authorization-response",ym=function(e){return function(t){if(t.type===mm){var n=t.participants.map(cb.build);e(n)}}},_m=function(){function e(t){var n=this,r=t.socket,i=t.url,o=t.id,s=t.logger;vd(this,e),this.url=i,this.id=o,this.socket=r,this.logger=s,this._stopped=!1,this._destroyListeners=[],this.emitter=new ub(this.socket),this.emitAll=this.emitter.emit,this.emit=this.emitter.emit,["on","once"].forEach((function(e){n[e]=function(t,r){if(n._stopped)n.logger.warn("Tried to add eventHandler to stopped channel",{eventType:t});else{if(t===bm)throw new Error("Don't set meta message listeners directly, use specialized functions");n.socket[e](t,r)}}}))}return bd(e,null,[{key:"join",value:function(t){var n=t.url,r=t.id,i=t.isInitiallyActive,o=t.options,s=t.callback,a=t.getAccessToken,u=t.logger,c=t.idleDisconnectCutoff;if(u=u||sm.logger,n.match(/engagement_signaler/)){new vm({url:n,getAccessToken:a,isActiveTab:i,logger:u,callback:s,idleDisconnectCutoff:c}).start()}else{var l=ab.establish({url:n,id:r,isActiveTab:i,options:o,logger:u}),f=new e({socket:l,url:n,id:r,logger:u});f.start(),function(e,t,n){var r=void 0,i=void 0,o=function(){e.off("connect",r),e.off("connect_error",i)};r=function(){o(),t()},i=function(e){o(),n(e)},e.on("connect",r),e.on("connect_error",i)}(l,(function(){s(null,f)}),(function(e){f.close();var t=new Error("Engagement.Kluster: Could not establish channel");t.channelUrl=n,t.reason=e,s(t,null)}))}}}]),bd(e,[{key:"off",value:function(e,t){this.socket.off(e,t)}},{key:"removeAllListeners",value:function(e){this.socket.removeAllListeners(e)}},{key:"onParticipantState",value:function(e){var t=this;if(!this._stopped){this._lastKnownParticipantState&&e(this._lastKnownParticipantState);var n=ym(e);return this.socket.on(bm,n),function(){return t.socket.off(bm,n)}}this.logger.warn("Tried to add eventHandler to stopped channel",{eventType:bm})}},{key:"authorize",value:function(e,t){var n=this,r=function e(r){r.type===gm&&(n.socket.off(bm,e),r.success?(n.logger.info("Engagement.Kluster: Channel authorization succeeded",{url:n.url}),t&&t(!0)):(n.logger.warn("Engagement.Kluster: Channel authorization failed",{url:n.url}),t&&t(!1)))},i=function(){n.socket.on(bm,r),n.emitter.authorize(e())};return this.socket.on("reconnect",i),i(),function(){n.socket.off(bm,r),n.socket.off("reconnect",i)}}},{key:"toTag",value:function(e){return this.emitter.in(e)}},{key:"start",value:function(){var e=this;this.socket.on(bm,ym((function(t){e._lastKnownParticipantState=t}))),this.socket.on("disconnect",(function(t){e.logger.info("Engagement.Kluster: Channel disconnected",{url:e.url,reason:t})})),this.socket.on("connect_error",(function(t){e.logger.warn("Engagement.Kluster: Channel connection error",{url:e.url,error:t})}))}},{key:"destroy",value:function(){null===this.socket||this._stopped||this.socket.emit("close_channel"),this.close()}},{key:"close",value:function(){var e=this;return wm(this.emitter,(function(e){return e.stop()})),null===this.socket||this._stopped||(this._stopped=!0,setTimeout((function(){return e.socket.disconnect()}),50)),this.cleanUp(),wm(this.socket,(function(e){return e.removeAllListeners()}))}},{key:"addDestroyListener",value:function(e){return this._destroyListeners.push(e)}},{key:"registerTag",value:function(e){var t=e.name;this.socket.emit("register_tags",[{name:t}])}},{key:"registerUniqueTag",value:function(e){var t=e.name;this.socket.emit("register_tags",[{name:t,unique:!0}])}},{key:"cleanUp",value:function(){this._destroyListeners.forEach((function(e){e.call()})),this._destroyListeners=[]}},{key:"isStopped",value:function(){return this._stopped}}]),e}();function wm(e,t){return null!=e?t(e):void 0}_m.listenForProxyTransport=function(e){return fm.asInner.listenForProxyTransport(e)};var Em=function(){},Om={},Sm=function(e){return Om[e]?Om[e].promise:void 0},Tm=function(e,t){Sm(t)===e&&function(e){delete Om[e]}(t)},km=function(e,t,n){n.then((function(e){e.addDestroyListener((function(){return Tm(n,e.otherId)}))}),Em),Om[e]={promise:n,url:t}},Am=Sm,xm="Engagement.Kluster",Im=function(e){var t=e.isActiveTab,n=e.participantId,r=e.operatorId,i=e.channelUrl,o=e.getAccessToken,s=e.stats,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:_m,u=s.withTags(["protocol:websocket"]).instrument({namespace:"join-channel"}).attempted(),c={operator_id:r,channel_url:i,is_active_tab:t};$u.log("".concat(xm,": Channel join started"),c);var l=new Promise((function(e,r){var s={timeout:3e4,reconnectionDelay:2e3,reconnectionDelayMax:3e3,randomizationFactor:.5,reconnectionAttempts:15,upgrade:!0};a.join({url:i,id:n,isInitiallyActive:t,options:s,getAccessToken:o,logger:$u,callback:function(t,n){t?($u.warn("".concat(xm,": Channel join failed"),I.merge(c,{error:t})),u.failed(),r(t)):(n.authorize(o),$u.info("".concat(xm,": Channel join succeeded"),c),u.succeeded(),n.observable=function(e){return rl(n,e)},e(n))}})}));return km(r,i,l),Du.Observable.fromPromise(l)},Nm=["scroll","keyup","mousemove"];function Mm(e){var t=e.getAccessToken,n=e.stats,r=e.start,i=e.stop,o=e.hideMouse,s=e.createChannelObservable,a=e.dynamicImport;s||(s=Im),a||(a=oc);var u=r.pipe(yi(),Ko((function(e){return s({channelUrl:e,participantId:"source",isActiveTab:!0,getAccessToken:t,stats:n})})),bo(1),Ie());this.sourceObservable=u.pipe(fn((function(e){return a("Cobra").map((function(t){return{Cobra:t,channel:e}}))})),Nt((function(e){var t=e.Cobra,n=e.channel;return new t.SourceInitializer(n,rp()).initialize()})),bo(),Ie()),this.stopSourceObservable=this.sourceObservable.pipe(Ko((function(e){return i.pipe(ki(1),Nt((function(){return e})))})),Gr((function(){return Du.Observable.empty()}))),this.hideMouseObservable=u.pipe(Ko((function(e){return o.pipe(es(i),Nt((function(){return e})))})),Gr((function(){return Du.Observable.empty()})))}var Rm,Cm,Pm=function(){function e(t,n,r,i){s(this,e),this._sendActivityFromCobrowsableIframe=this._sendActivityFromCobrowsableIframe.bind(this),this.windowMessenger=t,this.channelUrl=n,this.getAccessToken=r,this.stats=i}return u(e,[{key:"boot",value:function(){this._activityObservable().subscribe(this._sendActivityFromCobrowsableIframe);var e=new Mm({getAccessToken:this.getAccessToken,stats:this.stats,start:this._startObservable(),stop:this._stopObservable(),hideMouse:this._hideMouseObservable()});e.sourceObservable.subscribe((function(){return $u.log("Source started for cobrowsable iframe")}),(function(e){return $u.error("Couldn't start visitor cobrowsable iframe ".concat(e))})),e.stopSourceObservable.subscribe((function(e){return e.stop()}),$u.error.bind($u,"cobra stop subscription error")),e.hideMouseObservable.subscribe((function(e){return e.toTag("cobrowse").emit("cobra:hide_mouse")}),$u.error.bind($u,"cobra hide mouse subscription error")),$u.info("Started for visitor Nested CoBrowsable iFrame")}},{key:"_startObservable",value:function(){var e=this.channelUrl?Du.Observable.of(this.channelUrl):Du.Observable.empty();return this._cobrowsableFrameInviteObservable(this.windowMessenger).share().merge(e)}},{key:"_stopObservable",value:function(){return this.windowMessenger.observable("cobra:cobrowsable_iframe:stop")}},{key:"_hideMouseObservable",value:function(){return this.windowMessenger.observable("cobra:hide_mouse")}},{key:"_activityObservable",value:function(){return sm.PeriodicalActivityTracker.getStream(Nm)}},{key:"_cobrowsableFrameInviteObservable",value:function(e){return Du.Observable.create((function(t){return e.respondTo("cobra:cobrowsable_iframe:join_channel_and_cobrowse",(function(e,n){var r=e.url;return n(),t.next(r)}))}))}},{key:"_sendActivityFromCobrowsableIframe",value:function(){return this.windowMessenger.emit("activity_from_cobrowsable_iframe")}}]),e}(),jm=new Error("Tried to connect internal visitor state subscription after already connected"),Lm=null,qm=I.compose(I.map(I.pick(["id","site_id","operator_id"])),I.pathOr([],["engagement","observations"])),Um=I.compose(I.map(I.pick(["id","site_id","operator_id","outcome"])),I.pathOr([],["engagement","requests"])),Dm=["id","site_id","status","sub_engagement_id","visitor","restarted_from_engagement_id","capabilities"],Vm=function(e){return I.map(I.pick(e))},Fm=I.map((function(e){return I.merge(e,{visitor:I.pick(["authenticated","browser_tab_id"],e.visitor)})})),Bm=I.compose(Fm,Vm(Dm),I.pathOr([],["engagement","engagements"])),Hm=I.compose(I.map(I.pick(["id","site_id","state"])),I.pathOr([],["omniq","queue_tickets"])),Wm=function(e,t){return I.pathOr({},["routing","".concat(sm.siteId),"".concat(t)],e)},Gm=I.compose(Fm,Vm(I.append("end_reason",Dm)),I.pathOr([],["engagement","ended_engagements"])),zm=function(e){var t=e.pubsub,n=e.tabId,r=e.allowConnectingMultipleTimes,o=e.visitorIdObservable,s=void 0===o?Hu():o;return Lm&&!r?$u.error(jm):((Lm=s.switchMap((function(e){return t.joinChannel("visitor_state:".concat(e)).flatMap((function(e){return(0,e.observable)("change",{leaveChannelOnDispose:!0})})).map((function(t){return i(i({},t||{}),{},{visitor_id:e})}))})).do((function(e){return function(e,t){return $u.info("Received internal visitor state",{routing:Wm(e,t),observations:qm(e),engagement_requests:Um(e),engagements:Bm(e),ended_engagements:Gm(e),queue_tickets:Hm(e)})}(e,n)})).publishReplay(1)).connect(),Lm)},Jm=sm.logger,Ym=function(e){var t=e.status,n=e.body,r=e.error;if(t>=200&&t<300)return Du.Observable.of(n);var i=I.find(I.compose(I.not,I.isNil),[r,n,"unknown"]);return I.is(String,i)?Du.Observable.throw({status:t,reason:i}):Du.Observable.throw(I.merge({status:t},i))},Qm=function(e){return I.is(Object,e)&&"timeout"===e.type?Du.Observable.throw(new yf({cause:uf.SALEMOVE.NETWORK_TIMEOUT})):Du.Observable.throw(e)},Km=I.propEq("persisted",!0);I.has("onpagehide",window)?(Rm=Du.Observable.fromEvent(window,"pageshow").share(),Cm=Du.Observable.fromEvent(window,"pagehide").share()):(Rm=Du.Observable.fromEvent(window,"load").share(),Cm=Du.Observable.fromEvent(window,"unload").share());var Xm={unloadMaybeToPageCache:Cm,loadFromPageCache:Rm.filter(Km)},$m=new RegExp("sm."),Zm=function(e){return"sm.".concat(e)},eg={set:function(e,t){sessionStorage.setItem(Zm(e),function(e){return JSON.stringify(e)}(t))},get:function(e){return function(e){try{return JSON.parse(e)}catch(e){return null}}(sessionStorage.getItem(Zm(e)))},remove:function(e){sessionStorage.removeItem(Zm(e))},removeAll:function(){for(var e=0;e<sessionStorage.length;e++){var t=sessionStorage.key(e);$m.test(t)&&sessionStorage.removeItem(t)}}};var tg=function(){function e(t){var n=t.urlParams,r=t.storage,i=t.unloadMaybeToPageCache,o=t.loadFromPageCache,a=t.windowNameStorage,u=t.sessionContext,c=t.tabIdFromConfiguration;s(this,e),this.markAsAlive=this.markAsAlive.bind(this),this.markAsUnloaded=this.markAsUnloaded.bind(this),this.urlParams=n,this.storage=r,this.unloadMaybeToPageCache=i,this.loadFromPageCache=o,this.windowNameStorage=a,this.sessionContext=u,this.tabIdFromConfiguration=c}return u(e,[{key:"init",value:function(){this.localTabId=this._createOrReuseId(),this.markAsAlive(),this.unloadMaybeToPageCache.subscribe(this.markAsUnloaded,sm.logger.error),this.loadFromPageCache.subscribe(this.markAsAlive,sm.logger.error)}},{key:"markAsAlive",value:function(){this._changeTabStatus("alive")}},{key:"markAsUnloaded",value:function(){this._changeTabStatus("unloaded")}},{key:"getId",value:function(){return this.localTabId}},{key:"getSessionTabIds",value:function(){return Object.keys(this.storage.get("tab_ids")||{})}},{key:"_createOrReuseId",value:function(){var e;if(e=this.tabIdFromConfiguration||this._findIdFromSessionContext()||this._findIdFromWindowName()||this._findIdFromUrlParams()||this._findIdFromStorage())return e;var t,n=(t=new Uint32Array(2),(window.crypto||window.msCrypto).getRandomValues(t),(t[0]*t[1]).toString(36).replace(".","").substring(0,11));return sm.logger.info("No existing tab ID found, generated new tab ID",{new_tab_id:n}),n}},{key:"_changeTabStatus",value:function(e){var t=this.storage.get("tab_ids")||{};return t[this.localTabId]=e,this.storage.set("tab_ids",t),this.windowNameStorage.setItem("tab_ids",t)}},{key:"_findIdFromStorage",value:function(){var e;return(e=this._findIdFromTabIds(this.storage.get("tab_ids")||{}))?(sm.logger.info("Found tab ID from session storage",{found_tab_id:e}),e):null}},{key:"_findIdFromSessionContext",value:function(){return this.sessionContext?this.sessionContext.tab_id:null}},{key:"_findIdFromWindowName",value:function(){var e,t=this.windowNameStorage.getItem("tab_ids")||{};return(e=this._anyFromTabIds(t))?(sm.logger.info('Found tab ID from "window.name"',{window_name:window.name,found_tab_id:e}),e):null}},{key:"_findIdFromTabIds",value:function(e){for(var t=Object.keys(e),n=0;n<t.length;n++){var r=t[n];if("unloaded"===e[r])return r}}},{key:"_anyFromTabIds",value:function(e){return Object.keys(e)[0]}},{key:"_findIdFromUrlParams",value:function(){var e;return(e=this.urlParams.tabId)?(sm.logger.info("Found tab ID from url params",{found_tab_id:e}),e):null}}],[{key:"setup",value:function(t,n){var r=n.sessionContext,i=n.tabIdFromConfiguration,o=new e({urlParams:sm.urlParams,storage:eg,windowNameStorage:t,unloadMaybeToPageCache:Xm.unloadMaybeToPageCache,loadFromPageCache:Xm.loadFromPageCache,sessionContext:r,tabIdFromConfiguration:i});return o.init(),o}}]),e}(),ng=function(e){return function(e){var t=I.propEq("site_id",sm.siteId),n=I.compose(I.any(I.propEq("id",sm.siteId)),I.propOr([],"transferrable_sites")),r=I.pathOr([],["engagement","engagements"],e);try{return I.compose(I.complement(I.isEmpty),I.filter(I.either(t,n)))(r)}catch(t){return void $u.error("Engagements were undefined in state",{state:e,engagements:r})}}(e)?"engaged":function(e){return I.compose(I.complement(I.isEmpty),I.filter(I.propEq("site_id",sm.siteId)),I.pathOr([],["engagement","observations"]))(e)}(e)?"observed":"available"},rg=function(e){return e.map(ng).distinctUntilChanged()},ig="high",og="low",sg="visitor_priority",ag=I.pathOr([],["omniq","queue_tickets"]),ug=I.pathOr([],["engagement","requests"]),cg=I.pathOr([],["engagement","engagements"]),lg=function(e){return function(e){return ag(e).length>0||ug(e).length>0||cg(e).length>0}(e)?ig:og},fg=function(e,t){var n=e.indexOf(t);return n>-1?[e.substring(0,n),e.substring(n+1)]:[e]},pg=function(e,t,n){n||(n="");var r=_(fg(e,"#"),2),i=r[0],o=r[1],s=_(fg(i,"?"),2),a=s[0],u=s[1],c=I.compose(I.join("&"),I.map(I.concat(n)),I.map(I.join("=")),I.map(I.map(encodeURIComponent)),I.toPairs)(t),l=u?"".concat(a,"?").concat(u,"&").concat(c):"".concat(a,"?").concat(c);return o?"".concat(l,"#").concat(o):l},dg=function(){if("function"!=typeof window.getGliaContext)return Promise.resolve({sessionId:null,idToken:null,accessToken:null});try{var e=window.getGliaContext();"function"!=typeof e.then&&(e=Promise.resolve(e));return e.then((function(e){return Promise.resolve(i(i({},{sessionId:null,idToken:null,accessToken:null}),e))}),(function(e){return $u.warn("getGliaContext() promise rejected",{error:e}),Promise.resolve({sessionId:null,idToken:null,accessToken:null})})).catch((function(e){return $u.warn("Unexpected error in getGliaContext() promise",{error:e}),Promise.resolve({sessionId:null,idToken:null,accessToken:null})}))}catch(e){return $u.warn("Unexpected error in getGliaContext()",{error:e}),Promise.resolve({sessionId:null,idToken:null,accessToken:null})}},hg=function(){return Du.Observable.create((function(e){dg().then((function(t){e.next(t),e.complete()}))}))},vg=function(e){var t=e.split(".")[1],n=decodeURIComponent(atob(t).split("").map((function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join(""));return JSON.parse(n)},bg=function(e){return 1e3*vg(e).exp},mg=function(e){try{var t=vg(e);return(t.exp-t.iat)/2*1e3}catch(e){return $u.warn("Fetching interval from access token failed",e),864e5}},gg=function(e){return e&&"string"==typeof e},yg=function(e){var t=e.priority,n=e.accessToken,r=e.consolidationSecret,i=e.url,o=e.tabId,s=e.detectVisitorByExternalSessionTokenEnabled,a=e.includeIdToken,u=void 0===a||a,c=e.sessionTabIds;return i||(i=sm.visitorConfigUrl),i=pg(i,{priority:t,tab_id:o}),Du.Observable.create((function(e){var t=new XMLHttpRequest;return t.onreadystatechange=function(){if(4===this.readyState)if(200===this.status){var n=JSON.parse(t.responseText);e.next({accessToken:n.access_token,visitorId:n.visitor_id,authenticatedExternally:Boolean(n.authenticated_externally)}),e.complete()}else e.error({responseText:t.responseText,status:t.status})},function(e){var t=e.detectVisitorByExternalSessionTokenEnabled;return dg().then((function(e){var n=e.sessionId,r=e.idToken,i=e.accessToken;return[t&&gg(n)?"external_session_id=".concat(n):"",gg(r)?"id_token=".concat(r):"",gg(i)?"external_access_token=".concat(i):""]}))}({detectVisitorByExternalSessionTokenEnabled:s}).then((function(e){var o,s=_(e,3),a=s[0],l=s[1],f=s[2],p=""!==l?"tab_id=".concat(sm.tabId):"",d=(o=c)?o.map((function(e){return"session_tab_ids[]="+e})).join("&"):null,h=[r?"consolidation_token=".concat(encodeURIComponent(r)):null,n?"access_token=".concat(encodeURIComponent(n)):null,a,u?l:"",f,d,p].filter(I.identity).join("&");t.open("POST",i,!0),t.withCredentials=!0,t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.send(h)})),function(){return t.abort()}}))},_g=function(){function e(t){s(this,e),this.attributes=I.clone(t),this.id=this.attributes.id}return u(e,[{key:"get",value:function(e){return this.attributes[e]}},{key:"set",value:function(e){var t=this;Object.keys(e).forEach((function(n){var r=e[n];t.attributes[n]=r}))}},{key:"getId",value:function(){return this.get("id")}},{key:"getName",value:function(){return this.get("name")}},{key:"getFormattedName",value:function(){return this.get("formattedName")}},{key:"getMediaType",value:function(){return this.get("media_type")}},{key:"isOnline",value:function(){return!this.isUnavailable()}},{key:"currentlyAvailable",value:function(){return!this.currentlyUnavailable()}},{key:"currentlyUnavailable",value:function(){return this.isEngaged()||this.isUnavailable()}},{key:"isEngaged",value:function(){return"engaged"===this.get("status")}},{key:"mediaRank",value:function(){switch(this.getMediaType()){case"text":return.8;case"audio":return.9;case"video":return 1;default:return 0}}},{key:"getPictureUrl",value:function(){var e=this.get("picture")&&this.get("picture").url,t=sm.conf.visitor_app.always_use_default_operator_picture,n=sm.conf.visitor_app.default_operator_picture.url;if(!n||!t&&e){var r=-1!==sm.conf.assets.server.indexOf("libs.")?"/":sm.conf.assets.prepend;return e||[sm.conf.assets.server,r||"/","default_operator_picture-b69d123fb-c94131007.png"].join("")}return n}},{key:"isUnavailable",value:function(){return!1===this.get("available")}}]),e}(),wg=function(e){return I.filter(I.contains(I.__,["video"]),e)};function Eg(e){return/iPad|iPhone|iPod/.test(e)&&!window.MSStream}function Og(e){return/^((?!CriOS|Chrome|Android).)+Safari/.test(e)}function Sg(e){return 0===e.length}function Tg(e,t){return-1!==t.indexOf(e)}function kg(e){var t=e.match(/OS ((\d+_?){2,3})\s/);if(!t)return!1;var n=t[1].split("_"),r=n[0]+"."+n[1];return parseFloat(r)>=11.3}function Ag(e){if(Eg(e))return kg(e);var t=function(e){var t=e.match(/Version\/([0-9]+\.[0-9]*)/);return t&&parseFloat(t[1],10)}(e);return!!t&&t>=11}function xg(){return[{name:"RTCPeerConnection",pass:Boolean(window.RTCPeerConnection)},{name:"RTCIceCandidate",pass:Boolean(window.RTCIceCandidate)},{name:"AudioContext",pass:Boolean(window.AudioContext)||Boolean(window.webkitAudioContext)},{name:"MediaStream",pass:Boolean(window.MediaStream)}]}function Ig(){return[].concat(w(xg()),[{name:"getUserMedia",pass:Boolean(window.navigator.mediaDevices)&&Boolean(window.navigator.mediaDevices.getUserMedia)}])}var Ng={video:"camera",audio:"microphone"};function Mg(e,t,n){if(null==n)return!0;var r=Ng[t];return!!Tg(r,n)&&(!Og(e)||!Tg("".concat(r," *"),n))}function Rg(){var e=window.navigator.userAgent;return!(Og(e)&&Eg(e)&&!kg(e))&&Sg(xg().filter((function(e){return!e.pass})))}function Cg(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.media,n=e.iframeAllow,r=window.navigator.userAgent;if(!Mg(r,t,n))return!1;if(Og(r)&&!Ag(r))return!1;var i=Ig().filter((function(e){return!e.pass}));return Sg(i)}var Pg=Object.freeze({__proto__:null,canReceiveMedia:Rg,canSendMedia:Cg}),jg="none",Lg="receiver",qg="duplex",Ug=function(){return Rg()?Cg()?qg:Lg:jg},Dg=["video","audio"],Vg={video:["video","audio","phone","text"],audio:["audio","phone","text"],phone:["phone","text"],text:["text"]},Fg=I.lensPath(["state","medias"]),Bg=I.lensPath(["state","oneWayMedias"]),Hg=function(e,t){var n=I.difference(e.state[t],Dg);return I.assocPath(["state",t],n,e)},Wg=I.curry((function(e,t){return e===qg||e===Lg?t:Hg(t,"oneWayMedias")})),Gg=I.curry((function(e,t){return e===qg?t:Hg(t,"medias")})),zg=function(e){return I.assocPath(["state","media"],e.state.medias,e)},Jg=I.curry((function(e,t){var n,r=e.enabledMediaType,i=e.webRtcMode;return I.compose(zg,Wg(i),Gg(i),(n=r,I.over(Bg,I.intersection(wg(Vg[n])))),function(e){return I.over(Fg,I.intersection(Vg[e]))}(r))(t)})),Yg=u((function e(t){var n=t.id,r=t.name,i=t.formattedName,o=t.picture,a=t.state;s(this,e),this.id=n,this.name=r,this.formattedName=i||(null==r?void 0:r.split(" ")[0]),this.picture=o,this.state=a,this.assignment={type:"direct"}})),Qg=function(e){l(n,e);var t=m(n);function n(){return s(this,n),t.apply(this,arguments)}return u(n,[{key:"serialize",value:function(){return new Yg({id:this.getId(),name:this.getName(),formattedName:this.getFormattedName(),picture:this._getPicture(),state:this._getState()})}},{key:"_getPicture",value:function(){return{url:this.getPictureUrl()}}},{key:"_getState",value:function(){var e=Vg[this.getMediaType()];return{available:this.currentlyAvailable(),medias:e,oneWayMedias:wg(e)}}}]),n}(_g),Kg=I.curry((function(e,t){var n=e.enabledMediaType,r=e.webRtcMode,i=new Qg(t.attributes).serialize();return Jg({enabledMediaType:n,webRtcMode:r},i)})),Xg=function(e){var t=e.id,n=e.name,r=e.formattedName,i=e.picture,o=e.mediaType,s=e.webRtcMode,a=e.enabledMediaType,u=new Qg({id:t,name:n,formattedName:r,picture:i,media_type:o});return Kg({enabledMediaType:a,webRtcMode:s},u)},$g=function(e){var t=e.enabledMediaLevel,n=e.webRtcMode,r=function(e,t){return{operator:e,isVisible:void 0!==e.state.available&&e.reactiveEnabled&&(I.isEmpty(t)||!I.isEmpty(I.intersection(e.teamIds,t)))}};return{fromPresence:function(e,i,o){var s=i.state,a=I.pathOr("operator",["operator_information","name"],s),u=I.pathOr(null,["operator_information","picture","url"],s),c=I.pathOr([],["operator_information","teams"],s),l=I.map(I.prop("id"),c),f=I.pathOr(!0,["operator_information","reactive_enabled"],s),p=I.pathOr([],["engagement","media"],s),d=I.has("engagement",s);-1!==p.indexOf("audio")&&p.push("phone");var h={id:e,name:a,picture:{url:u},state:{available:d?!I.isEmpty(p):void 0,media:p,medias:p,oneWayMedias:p},teamIds:l,reactiveEnabled:f};return h=Jg({enabledMediaType:t,webRtcMode:n},h),r(h,o)},updateVisibility:r}},Zg=function e(t,n){t||(t={}),n||(n={});return{omit:function(r){return e(I.dissoc(r,t),I.dissoc(r,n))},set:function(r){var i=r.operator,o=r.isVisible?I.assoc(i.id,i,n):I.dissoc(i.id,n);return e(I.assoc(i.id,i,t),o)},forEach:function(e){return I.values(t).forEach(e)},immutableFacade:function(){return{get:function(e){var t=n[e];return t?new Yg(t):t},values:function(){return I.map(I.construct(Yg),I.values(n))}}}}},ey=function(e){var t=e.presence,n=e.presenceMapper,r=e.visibleTeamsObservable,i=e.onChange,o=Zg(),s=[],a=r.subscribe((function(e){s=e,o.forEach((function(e){var t=n.updateVisibility(e,s),r=t.operator,i=t.isVisible;o=o.set({operator:r,isVisible:i})})),i(o.immutableFacade())}));t.list((function(e,t){return n.fromPresence(e,t,s)})).forEach((function(e){var t=e.operator,n=e.isVisible;o=o.set({operator:t,isVisible:n})})),i(o.immutableFacade()),t.onChange((function(e,t,r){if(r.metas.length>0){var a=n.fromPresence(e,r,s),u=a.operator,c=a.isVisible;o=o.set({operator:u,isVisible:c})}else o=o.omit(e);i(o.immutableFacade())}));return{stop:function(){return a.unsubscribe()}}},ty="salemove",ny=function(e){try{return JSON.parse(e.name)||{}}catch(e){return{}}},ry=function(e){return""===e.name},iy=function(e){return ry(e)||function(e){return ny(e).hasOwnProperty(ty)}(e)},oy=function(e){return I.lensPath([ty,e])},sy=[void 0,null,"javascript:;",""],ay=!1,uy=function(e,t){if(t||(t=sm.conf.navigatable_hostnames),I.contains(e,sy))return!0;var n=ay?t.engaged:t.available;return I.any((function(t){return e.indexOf(t)>-1}))(n)},cy={isInEngagement:ay,setEngagedStatus:function(e){ay=e},extractLinkFromEvent:function(e){try{var t=e.target;return t&&(t=function(e,t){t=t.toUpperCase();do{if(e.nodeName===t)return e}while(e=e.parentNode);return null}(t,"a")),t}catch(e){return null}},isAllowedToNavigate:uy},ly=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.isAllowed,n=void 0===t?uy:t;Yc(document.querySelectorAll('a[target="_blank"]')).filter((function(e){return"javascript:void(0)"!==e.href})).filter((function(e){return n(e.hostname)})).forEach((function(e){return e.setAttribute("target","_self")}))},fy=["target","defaultPrevented","ctrlKey","shiftKey","metaKey","button"],py=function(e){var t=e.getCurrentUrl,n=e.linkHandler,r=e.clicks,o=e.navigate,s={},a=function(e){var t=e.event,n=e.link;try{var r,a=n.href,u=null!==(r=s)&&void 0!==r&&r.accessToken?i(i({},s),{},{accessToken:"-pruned-"}):s;sm.logger.info("XDomainUrlStorage: adding params to URL",{params:u});var c=pg(a,s,"__sm.");sm.logger.info("XDomainUrlStorage: navigating to modified URL",{original_url:Qu(a),modified_url:Qu(c)}),t.preventDefault(),o(c)}catch(e){sm.logger.error("XDomainUrlStorage: error trying to store values in URL",e)}},u=function(e){return"_blank"!==e.link.target},c=function(e){var t=e.link;return!I.isEmpty(t.href)&&!I.isNil(t.href)&&I.contains(t.protocol,["http:","https:"])},l=function(e){var n=e.link;return!I.contains(n.hostname,t())},f=function(e){var t=e.link;return n.isAllowedToNavigate(t.hostname)},p=function(e){var t=e.event;return!(t.ctrlKey||t.shiftKey||t.metaKey)},d=function(e){return 0===e.event.button},h=function(e){try{return fy.forEach((function(t){return e[t]})),!0}catch(e){return!1}},v=function(e){return!e.defaultPrevented},b=function(e){for(var t=e.target;t&&t.nodeName&&"a"!==t.nodeName.toLowerCase();)t=t.parentElement;return t};return{start:function(){return r.pipe(Tn((function(){return!I.isEmpty(s)})),Tn(h),Tn(v),Nt((function(e){return{event:e,link:b(e)}})),Tn(I.where({link:I.complement(I.isNil)})),Tn(c),Tn(u),Tn(l),Tn(p),Tn(d),Tn(f)).subscribe(a,(function(e){return sm.logger.error("XDomainUrlStorage: error while filtering user click event",e)}),(function(){return sm.logger.error("XDomainUrlStorage: clicks observable was completed")}))},setItem:function(e,t){s=I.assoc(e,t,s)},getItem:function(e){return sm.urlParams?sm.urlParams[e]:void 0}}},dy="sm.",hy=function(){return{getItem:function(e){return window.localStorage.getItem(dy+e)},setItem:function(e,t){return window.localStorage.setItem(dy+e,t)},removeItem:function(e){return window.localStorage.removeItem(dy+e)}}},vy=function(){var e,t,n=(e=window,{getItem:function(t){if(!ry(e))return I.view(oy(t),ny(e))},setItem:function(t,n){if(iy(e)){var r=ny(e),i=I.set(oy(t),n,r);e.name=JSON.stringify(i)}}}),r=(t=Du.Observable.merge(nl(document,"click"),nl(document,"mousedown")),new py({getCurrentUrl:function(){return window.location.href},linkHandler:cy,clicks:t,navigate:function(e){window.location.href=e}}));sm.conf.visitor_api&&sm.conf.visitor_api.persist_visitor_session_in_url&&r.start();var i,o=new hy;return{bestEffortXDomainStorage:(i={prioritizedStorages:[n,r,o]}.prioritizedStorages,{getItem:function(e){return function(e,t){for(var n=0;n<e.length;n++){var r=e[n].getItem(t);if(null!=r)return r}}(i,e)},setItem:function(e,t){return i.forEach((function(n){return n.setItem(e,t)}))}}),windowNameStorage:n,xDomainUrlStorage:r,localStorage:o}},by=function(e){var t=e.internalVisitorStateObservable,n=e.defaultQueues;return t.pipe(Nt((function(e){return function(e,t){var n=I.pathOr({},["routing",sm.siteId,sm.tabId],e);return I.has("queues",n)?{queue_ids:n.queues}:t.length>0?{queue_ids:t.map((function(e){return e.id}))}:{}}(e,n)})),yi(I.equals))},my="sm.app.visitor_api.custom_code",gy=function(e){var t=e.stats,n=e.loadCustomCodeScript,r=sm.conf.customCodeFile?sm.conf.customCodeFile.url:void 0;return r?(n||(n=L),new Promise((function(e,i){var o={integrity:P()?sm.conf.customCodeFile.sri:null,fileUrl:r,beforeLoad:function(){return e({ignored:!1})},onAttempt:function(){return t.increment(my,["action:attempted"])},onLoad:function(){return t.increment(my,["action:succeeded"])},onError:function(){return t.increment(my,["action:warning"])},onGiveUp:function(){return t.increment(my,["action:failed"]),sm.logger.warn(new Error("Failed to load custom code"),{custom_code_url:r})}};return n(o)}))):Promise.resolve({ignored:!0})},yy=function(e,t){return e.increment("sm.gva.assets.load",t)},_y=function(e){var t=e.stats,n=((sm.conf||{}).gva||{}).assets||{},r=sm.conf.visitor_api.load_gva_custom_renderer;return new Promise((function(e){return r&&n.js&&n.css?(n.js.forEach((function(e){return function(e,t){return L({fileUrl:t,integrity:j({versionedName:t.split("/").pop()}),onLoad:function(){return yy(e,["action:succeeded","asset:js"])},onError:function(){return yy(e,["action:warning","asset:js"])},onAttempt:function(){return yy(e,["action:attempted","asset:js"])},onGiveUp:function(){return yy(e,["action:failed","asset:js"]),sm.logger.warn(new Error("Failed to load script file from sm.conf.gva.assets"),{asset_url:t})}})}(t,e)})),n.css.forEach((function(e){return function(e,t){return q({fileUrl:t,integrity:j({versionedName:t.split("/").pop()}),onError:function(){return yy(e,["action:warning","asset:css"])},onAttempt:function(){return yy(e,["action:attempted","asset:css"])},onGiveUp:function(){return yy(e,["action:failed","asset:css"]),sm.logger.warn(new Error("Failed to load css file from sm.conf.gva.assets"),{asset_url:t})}})}(t,e)})),e({gvaAssetsRequested:!0})):e({gvaAssetsRequested:!1})}))};function wy(e,t){var n=t.targetWindow,r=t.logger,o="__sm.",s=n.location.search,a=n.location.href;try{var u=s.replace("?","").split("&").filter((function(e){return e.indexOf(o)>-1})),c=function(t){return Object.keys(e).filter((function(e){return Boolean(t[e])})).map((function(n){return{key:n,value:t[n],regex:e[n]}})).reduce((function(e,t){var n=t.key,i=t.value,o=t.regex;return i.match(o)?e[n]=i:r.error("URL query param does no satisfy provided regex",{param_key:n,param_value:i,regex:o}),e}),{})}(u.map((function(e){return e.split("=")})).map((function(e){var t=_(e,2),n=t[0],r=t[1];return{key:n.replace(o,""),value:r}})).map((function(e){var t=e.key,n=e.value;return{key:decodeURIComponent(t),value:decodeURIComponent(n)}})).reduce((function(e,t){var n=t.key,r=t.value;return e[n]=r,e}),{})),l=u.reduce((function(e,t){return e.replace("?".concat(t),"").replace("&".concat(t),"")}),a);if(l!==a){var f=null!=c&&c.accessToken?i(i({},c),{},{accessToken:"-pruned-"}):c;r.info("Found sm params in URL",{params:f,url_length:a.length}),(n.history?n.history.replaceState:void 0)&&(r.info("Replacing page URL",{original_url:Qu(a),new_url:Qu(l)}),n.history.replaceState(n.history.state,n.document.title,l))}return c}catch(e){return r.error("Error reading sm params from URL",e),{}}}function Ey(e,t){var n,r=t.salemovePresentInParent,i=function(){var t={url:e.location.href,page_title:e.title};if(r)return window.parent.postMessage(JSON.stringify({"sm-xdr-url":t.url}),"*")};this.start=function(){return n=sm.hrefObservable.subscribe(i,$u.error)},this.stop=function(){n&&n.unsubscribe()}}var Oy=function(e){return I.reduce(I.maxBy(I.prop("activity_at")),e[0],e)},Sy=function(e,t){return t?!e||e.activity_at<t.activity_at?t:e:($u.warn("New active tab is not defined",{new_active_tab:t}),e)};function Ty(e,t,n){var r=this,i=t.salemovePresentInParent,o=t.renewFrequency,s=t.visitorPresenceChannel,a=t.tabId,u=void 0===a?sm.tabId:a;this.onStart=n;var c,l=1e3*o,f=Du.Observable.timer(1e4).mapTo({tab_id:u,page_url:location.href}).do((function(){return $u.warn("Defaulting active tab to true, multi-tab cobrowsing can misbehave")})),p=s.getSameVisitorConnections().filter(I.complement(I.isEmpty)),d=p.map(Oy).scan(Sy).merge(f.takeUntil(p)).publishReplay(1),h=d.combineLatest(fp.asObservable()).map((function(e){var t=_(e,2),n=t[0],r=t[1];return n.tab_id===u||r.has(n.tab_id)})).distinctUntilChanged(I.equals),v=new Ey(e,{salemovePresentInParent:i}),b=jl(),m=h.switchMap((function(e){var t=e?l:1500;return b.throttleTime(t)})).map((function(e){return{value:e,timestamp:Date.now()}})).share(),g=function(){return s.getPresenceObservable().take(1).switchMap((function(e){return d.take(1).map((function(t){return{presence:e,activeTab:t}}))})).subscribe((function(t){var n=t.presence,r=t.activeTab,i={page_description:e.title};return r.tab_id!==u&&(i.set_active_tab=!0,i.page_url=location.href),r.tab_id===u&&r.page_url!==location.href&&(i.page_url=location.href),n.channel.push("activity",i,5e3).receive("error",(function(e){return $u.warn("Unable to send activity update to presence",e)})).receive("timeout",(function(){}))}),(function(e){return $u.warn("Unable to send activity update to presence",{error:e})}))},y=function(){if(!r.started){r.started=!0,$u.info("Starting activity tracker"),v.start(),m.skip(1).subscribe((function(){return g()}),$u.error);var e,t=new Du.Subscription([d.connect(),(e=v,new Du.Subscription((function(){return e.stop()})))]);r.onStart(t)}};this.requestStart=function(){s.requestJoin(),s.getPresenceObservable().take(1).subscribe((function(){return y()}))},this.requestStartWhenSpaceAvailable=function(){s.requestJoinAllowRejection(),s.getPresenceObservable().take(1).subscribe((function(){return y()}))},this.getUserIsActiveTabObservable=function(){return r.requestStart(),h},this.avoidGoingIdle=function(){r.requestStart(),c&&clearInterval(c),c=setInterval((function(){return g()}),5e3)}}Ty.NavigationUpdater=Ey;var ky=function(){},Ay=I.propEq("site_id",sm.siteId),xy=I.compose(I.any(I.propEq("id",sm.siteId)),I.propOr([],"transferrable_sites")),Iy=I.compose(I.nth(0),I.filter(I.either(Ay,xy)),I.pathOr([],["engagement","engagements"])),Ny=I.compose(I.nth(0),I.filter((function(e){return!e.outcome})),I.filter(Ay),I.pathOr([],["engagement","requests"])),My=I.compose(I.nth(0),I.filter(I.propEq("site_id",sm.siteId)),I.pathOr([],["engagement","observations"])),Ry=function(e){var t=e.visitor;if(t)return{name:t.name,email:t.email}},Cy=function(e){var t=e.operator,n=I.map(I.prop("name"),t.teams);return{id:t.id,teamNames:n}},Py=function(e){var t,n,r;return(t=Iy(e))?{interaction:"engagement",channelUrl:t.channel_url,operator:Cy(t),visitor:Ry(t),engagement:t}:(n=Ny(e))?{interaction:"engagement",channelUrl:n.channel_url,operator:Cy(n),visitor:Ry(n)}:(r=My(e))?{interaction:"observation",channelUrl:r.channel_url,operator:Cy(r),visitor:Ry(r)}:{}},jy=function(e){var t=_(e,2),n=t[0],r=t[1],i=n.operator?n.operator.id:void 0,o=n.channelUrl,s=r.channelUrl;if(i&&o&&o!==s){var a=Am(i);if(a)return a.then((function(e){return e.destroy()}),ky)}},Ly=function(e){var t,n,r,i=e.internalVisitorStateObservable,o=e.getAccessToken,s=e.stats,a=e.visitorPresenceChannel,u=e.salemovePresentInParent;if(sm.trackerSubscription=new Du.Subscription,sm.tracker=t=new Ty(document,{renewFrequency:(n=sm.conf.engagement.visitor_time_to_inactive_sec,r=sm.conf.engagement.renew_freq_muliplier||.8,Math.max(10,Math.round(n*r))),salemovePresentInParent:u,stats:s,visitorPresenceChannel:a},(function(e){return sm.trackerSubscription.add(e)})),sm.conf.visitor_api.visitor_presence_join_limited){var c=I.pathOr([],["engagement","observations"]),l=I.pathOr([],["engagement","requests"]),f=I.pathOr([],["engagement","engagements"]),p=I.pathOr([],["omniq","queue_tickets"]),d=function(e){return c(e).length>0||l(e).length>0||f(e).length>0||p(e).length>0};i.filter(d).take(1).subscribe((function(){return t.requestStart()})),i.take(1).filter(I.complement(d)).subscribe((function(){return t.requestStartWhenSpaceAvailable()}))}else t.requestStart();var h,v=(h={internalVisitorStateObservable:i},h.internalVisitorStateObservable.pipe(Nt(Py),yi(I.equals)).pipe(Yo({}),Mr(2,1),os(jy),Nt((function(e){var t=_(e,2);return t[0],t[1]})),Yo({}))).publishReplay(1);v.subscribe((function(e){cy.setEngagedStatus("engagement"===e.interaction)}));var b=function(e,t,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Hu();return e.pipe(yi(null,(function(e){return e.channelUrl})),Ko((function(e){return i.pipe(Nt((function(){return e})))})),os(null,$u.warn.bind($u,"Failed to setup channel observable")),Tn((function(e){return Boolean(e.interaction)})),Ko((function(e){return t.getUserIsActiveTabObservable().pipe(ki(1),Nt((function(t){return{status:e,isActiveTab:t}})))})),Ko((function(e){var t=e.status,i=e.isActiveTab;return Im({channelUrl:t.channelUrl,participantId:"visitor",operatorId:t.operator.id,isActiveTab:i,getAccessToken:n,stats:r}).pipe(Gr((function(){return Du.Observable.empty()})),Nt((function(e){return{channel:e,operator:t.operator}})))})),jo())}(v,t,o,s).publishReplay(1);return sm.channelSubscription=b.connect(),v.connect(),{statusObservable:v,channelObservable:b.filter((function(e){var t=e.channel,n=e.operator;return!t.isStopped()||($u.warn("Filtering out stopped channel in channelObservable",{channelUrl:t.url,operator:n,siteId:sm.siteId}),!1)})),tracker:t}},qy={get:function(e){return e.checked},set:function(e,t){e.checked=t}},Uy={select:{get:function(e){return I.compose(I.fromPairs,I.map((function(e){return[e.index,e.selected]})))(e.options)},set:function(e,t){I.forEach((function(e){e.selected=t[e.index]}))(e.options)}},option:{get:function(e){return e.selected},set:function(e,t){e.selected=t}},radio:qy,checkbox:qy,default:{get:function(e){return e.value},set:function(e,t){if("function"==typeof Object.getOwnPropertyDescriptor&&Object.getOwnPropertyDescriptor(e,"value")&&Object.getOwnPropertyDescriptor(e,"value").set)try{return Object.getOwnPropertyDescriptor(e.constructor.prototype,"value").set.call(e,t)}catch(n){e.value=t}else e.value=t}}},Dy=function(e){var t=Uy[e.type]||Uy[e.nodeName&&e.nodeName.toLowerCase()]||Uy.default,n=t.get,r=t.set;return{get:function(){return n(e)},set:function(t){r(e,t)}}},Vy="sm_engagement_serialized_inputs",Fy=function(e,t){return I.compose(I.forEach((function(t){var n=t.destInput,r=t.value;return t.hook.set(r),function(e,t){var n=e.createEvent("HTMLEvents");return n.initEvent("change",!0,!1),t.dispatchEvent(n)}(e,n)})),I.filter((function(e){var t=e.hook,n=e.value;return!I.equals(t.get(),n)})),I.map((function(e){var t=e.destInput;return{destInput:t,value:e.value,hook:Dy(t)}})),I.filter((function(e){var t=e.destInput;return Boolean(t)})),I.map((function(t){var n=t.value,r=t.xpath;return{value:n,destInput:tl(e,r)}})))(t)},By=function(e){var t=I.compose((function(e){return Array.prototype.slice.call(e)}),(function(t){return e.getElementsByTagName(t)})),n=I.chain(t,["INPUT","TEXTAREA","SELECT","PASSWORD","CHECKBOX","RADIO"]);return I.map((function(e){return{value:Dy(e).get(),xpath:$c(e)}}),n)},Hy=[I.ifElse(I.path(["state","available"]),I.always(1),I.always(0)),I.compose(I.length,I.path(["state","media"]))],Wy=I.reduce(I.maxBy((function(e){return I.ap(Hy,[e])})),null),Gy=function(e){return sm.conf.api_url+e},zy=function(e){return function(e){return e.pipe(Tn(I.propEq("connected",!1)))}(e).pipe(Ko((function(){return e.pipe(Tn(I.propEq("connected",!0)),ki(1))})))},Jy=function(e,t,n){t||(t=Bf);var r=(n&&void 0!==n.authenticatedExternally?n.authenticatedExternally:Ju())?"/messaging/chat_transcript?_=".concat(Date.now()):"/engagements/".concat(e,"/chat_transcript?_=").concat(Date.now());return t({url:Gy(r)}).pipe(Nt(I.prop("response")),Lo(),Gr((function(t){return $u.warn("Failed to fetch chat history",{error:t,engagement_id:e}),Pc.of([])})))},Yy=function(e){var t=e.engagementId,n=e.connectionStatusObservable,r=e.requestAsObservable;return zy(n).pipe(fn((function(){return Jy(t,r)})),jo())},Qy=Du.Observable.throw(new yf({cause:uf.SALEMOVE.INTERNAL_ERROR})).pipe(os(null,(function(){return $u.warn("Operators observable timed out!")}))),Ky=function(e,t){t||(t=[]);return e.increment("engagement.flow",["entrypoint:reactive-request"].concat(t))},Xy=function(e,t,n,r){r||(r=Du.Scheduler.asap);var i=t||{},o=i.operatorId,s=i.phoneNumber,a=i.phoneExtension,u=i.source,c=i.oneWay,l=i.siteId;l||(l=sm.siteId);var f=n.api,p=n.operatorsObservable,d=n.serverResponseTimeout,h=n.engagementCoreObservable,v=n.mediaValidation,b=n.statsClient;$u.info("Engagement: Reactive request initiated",{media:e,options:t});var m=o?I.find(I.propEq("id",o)):Wy,g=p.pipe(ps(d,Qy,r),Nt(m),fn((function(e){return e?Du.Observable.of(e):Du.Observable.throw(new yf({cause:uf.SALEMOVE.OPERATOR_UNAVAILABLE}))})));return Du.Observable.combineLatest(g,h).pipe(fn((function(n){return function(n){var i=n.state.medias,o=n.state.oneWayMedias,s=v({media:e,options:t,availableMediaTypes:i,availableOneWayMediaTypes:o});return(s instanceof Du.Observable?s:Du.Observable.from(s,r)).pipe(Nt(I.always(n)))}(_(n,1)[0])})),fn((function(t){var n={phoneNumber:s,phoneExtension:a,oneWay:c};return Ky(b,["action:reach","stage:create-request"]),f.create({operatorId:t.id,siteId:l,media:e,source:u,mediaOptions:n}).pipe(Nt((function(r){return I.merge(r,{operator:t,media:e,mediaOptions:n})})))})))},$y=function(e,t){t||(t=Du.Scheduler.asap);var n=e.media,r=e.mediaOptions,i=e.mediaValidation,o=e.api,s=e.notifyOfTimeout,a=e.operatorsObservable,u=e.engagementCoreObservable,c=e.cobraObservable,l=e.channelObservable,f=e.serverResponseTimeout,p=e.communicationLib,d=e.engagementApi,h=e.webRtcMode,v=e.enabledMediaLevel,b=e.statsClient,m=Xy(n,r,{api:o,operatorsObservable:a,serverResponseTimeout:f,engagementCoreObservable:u,mediaValidation:i,statsClient:b},t).pipe(bo()),g=m.connect();Ky(b,["action:begin"]);var y=m.pipe(fn((function(e){var n=e.engagementRequestId,r=e.acknowledgeTimeoutSeconds,i=e.operator;return Ky(b,["action:reach","stage:requested"]),Du.Observable.combineLatest(o.acceptedObservable,c,l,(function(e,t){return I.merge(e,{cobra:t})})).pipe(ps(1e3*r+f,function(e,t){return Du.Observable.throw(new yf({cause:uf.SALEMOVE.NETWORK_TIMEOUT})).pipe(os(null,(function(){return $u.warn("Engagement request timed out! Some internal listener must be missing.")})),os(null,(function(){return e.notifyOfReactiveFailure({id:t})})))}(o,n),t),no(sl(function(e){return Du.Observable.merge(o.declinedObservable.pipe(Nt(I.always(new yf({cause:uf.SALEMOVE.OPERATOR_DECLINED})))),o.timedOutObservable.pipe(os((function(){return s({operator:e})})),Nt(I.always(new yf({cause:uf.SALEMOVE.TIMEOUT})))))}(i))),ki(1),qi((function(){return g.unsubscribe()})))})),os(null,I.ifElse(I.propEq("cause",uf.SALEMOVE.INTERNAL_ERROR),$u.warn.bind($u,"Engagement: Reactive request failed"),$u.info.bind($u,"Engagement: Reactive request failed"))),os(null,(function(e){return Ky(b,["action:end"].concat(function(e){return e&&e.cause===uf.SALEMOVE.OPERATOR_UNAVAILABLE?["stage:pre-request","expected:true","reason:target-unavailable"]:e&&e.cause===uf.SALEMOVE.INVALID_INPUT?["stage:pre-request","reason:invalid-input"]:e&&e.cause===uf.SALEMOVE.INTERNAL_ERROR?["stage:create-request","reason:internal-error"]:e&&e.cause===uf.SALEMOVE.TIMEOUT?["stage:requested","expected:true","reason:accept-timeout"]:e&&e.cause===uf.SALEMOVE.OPERATOR_DECLINED?["stage:requested","expected:true","reason:decline"]:e&&e.cause===uf.SALEMOVE.NETWORK_TIMEOUT?["stage:create-request","reason:network-error"]:["stage:pre-request","reason:script-load-error"]}(e)))})),Nt((function(e){var t,r,i,o,s,a,u,c,f,b;i=e.engagementId,b=e.subEngagementId,t=e.cobra,n=e.media,s=e.operatorId,u=e.operatorName,c=e.operatorFormattedName,f=e.operatorPicture,a=e.operatorMediaType,o=e.entrypoint,r=e.createdAt;var m=Xg({id:s,name:u,formattedName:c,picture:f,mediaType:a,webRtcMode:h,enabledMediaType:v});return $u.info("Engagement: Reactive request accepted",{engagementId:i,subEngagementId:b,operator:m}),{engagementId:i,subEngagementId:b,startingMedia:n,type:"reactive",isReestablishing:!1,initialChatHistoryObservable:Jy(i),operator:m,communicationLib:p,cobra:t,channelObservable:l,engagementApi:d,entrypoint:o,createdAt:r}})),ki(1));return{requestObservable:m,resultObservable:y}},Zy=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Subscription=Er.Subscription})),e_=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(Zy)})),t_=u((function e(t){var n=t.id,r=t.content,i=t.status,o=t.attachment,a=t.created_at;if(s(this,e),this.id=n,this.content=r,this.sender="visitor",this.sender_details={type:"visitor"},this.status=null,this.attachment=o,this.created_at=a,i){if(!I.find(I.equals(i),I.values(this.STATUSES)))throw new yf({cause:uf.SALEMOVE.INTERNAL_ERROR,message:"Unknown status ".concat(i)});this.status=i}})),n_=I.propEq("sender","visitor");t_.prototype.STATUSES={SENDING:"sending",DELIVERED:"delivered",FAILED:"failed"},t_.prototype.ATTACHMENT_RESPONSE_TYPES={SINGLE_CHOICE_RESPONSE:"single_choice_response",FILES:"files"};var r_=u((function e(t){var n=t.id,r=t.content,i=t.attachment,o=t.metadata,a=t.created_at,u=t.sender,c=void 0===u?{}:u;s(this,e),this.id=n,this.content=r,this.sender="operator",this.sender_details={type:"operator",name:c.name,picture:c.picture?c.picture.url:"",id:c.id},this.attachment=i,this.metadata=o,this.created_at=a}));r_.prototype.ATTACHMENT_TYPES={SINGLE_CHOICE:"single_choice",FILES:"files"};var i_=u((function e(t){var n=t.id,r=t.content,i=t.attachment,o=t.metadata,a=t.created_at;s(this,e),this.id=n,this.content=r,this.sender="system",this.sender_details={type:"system"},this.attachment=i,this.metadata=o,this.created_at=a}));i_.prototype.ATTACHMENT_TYPES={SINGLE_CHOICE:"single_choice",FILES:"files"};var o_=sm.conf.visitor_app_option,s_=function(e,t){return e===t},a_={VISITOR:"visitor",OPERATOR:"operator",SYSTEM:"system"},u_=function(e,t){var n=I.differenceWith(I.eqProps("id"),e,t);return 0===n.length?t:I.concat(n,t)},c_=function(e,t,n){var r=e.pipe(no(t),lr((function(e,t){var n=I.findIndex(I.propEq("id",t.id),e);return-1!==n?I.update(n,t,e):I.prepend(t,e)}),[]),Yo([]));return vc.combineLatest(r,n,u_).pipe(yi(s_))},l_=function(e){var t=e.sender.type;return t===a_.VISITOR?new t_(e):t===a_.OPERATOR?new r_(e):t===a_.SYSTEM?new i_(e):void 0},f_=function(e){var t=e.sender.type;return l_(i(i({},e),{},t===a_.VISITOR?{content:e.message,status:t_.prototype.STATUSES.DELIVERED}:{content:e.message}))},p_=function(e){return I.map(f_,e).reverse()},d_=function(e){var t=e.chatHistoryObservable,n=e.ownMessages,r=e.otherMessages,i=e.statsClient,o=e.fetchExtraOperatorInfo,s=n.pipe(Nt((function(e){var t=e.id,n=e.content,r=e.attachment;return new t_({id:t,content:n,attachment:r,status:null})}))),a=n.pipe(fn((function(e){var t=e.id,n=e.content,r=e.status,i=e.attachment;return r.pipe(Nt((function(e){return new t_({id:t,content:n,attachment:i,status:e})})))}))),u=r.pipe(bi(I.prop("id")),fn((function(e){var t=I.path(["sender","type"],e);if(t===a_.OPERATOR){var n=e.sender.id;return o(n).pipe(Nt((function(t){return I.evolve({sender:I.merge(t)})(e)})))}return t===a_.SYSTEM?Pc.of(e):($u.warn("Received other chat message of unknown sender origin",{id:e.id,sender_type:t}),Rc.empty())})),Nt(l_)),c=t.pipe(Nt(p_)),l=c_(a,u,c).pipe(os((function(){i.increment("sm.app.visitor_api.chat.messages",["action:emitted","visitor_app:".concat(o_)])})));return{messages:c_(s,u,c),messagesWithStatusUpdates:l}},h_=u((function e(t){var n=t.typing;s(this,e),this.typing=n})),v_="visitor";function b_(e){this.recordChatMessageSent=function(t){1===t?e.increment("sm.".concat(v_,".communication.chat.message.sent")):e.increment("sm.".concat(v_,".communication.chat.message.retry"))},this.recordChatMessageDeliveryFailed=function(){e.increment("sm.".concat(v_,".communication.chat.message.delivery_failed"))},this.recordChatMessageDelivered=function(){e.increment("sm.".concat(v_,".communication.chat.message.delivered"))}}var m_=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ReplaySubject=Er.ReplaySubject})),g_=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(m_)})),y_={SENDING:"sending",DELIVERED:"delivered",FAILED:"failed"},__="Chat",w_=function(){function e(t){var n=t.chatApi,r=t.messagesToSend,i=t.previewToSend,o=t.deliveryTimeout,a=void 0===o?sm.conf.chat_message_send_timeout_ms||15e3:o,u=t.history,c=t.guid,l=void 0===c?Il:c,f=t.stats,p=t.logger;s(this,e),this._chatApi=n,this._previewToSend=i,this._history=u,this._generateGuid=l,this._messagesToSend=r,this._deliveryTimeout=a,this.stats=f,this.logger=p,this._messengerStoppedSubject=new yc.Subject,this._sentMessages=new yc.Subject,this._deliveryEvents=this._chatEvents("deliveredMessages"),this._receivedMessageIds=[],this._subscription=new e_.Subscription}return u(e,[{key:"start",value:function(){var e=this;this._subscription.add(this._messagesToSend.subscribe(this._sendMessage.bind(this),this.logger.error)),this._subscription.add(this._previewToSend.subscribe((function(t){return e._chatApi.sendPreview({content:t})}),this.logger.error)),this._subscription.add(this._messagesReceivedFromHistory().subscribe(this._acceptReceivedMessage("history"),(function(t){return e.logger.warn("".concat(__,": Failed to fetch chat history"),t)})))}},{key:"stop",value:function(){this._chatApi.stop(),this._messengerStoppedSubject.next(),this._subscription.unsubscribe()}},{key:"observables",value:function(){return{ownMessages:this._sentMessages.pipe(no(this._receivedVisitorMessages())),otherMessages:this._receivedOtherMessages(),operatorTypingIndicator:this._chatApi.operatorTypingIndicator}}},{key:"_chatEvents",value:function(e){return this._chatApi[e].pipe(es(this._messengerStoppedSubject))}},{key:"_receivedVisitorMessages",value:function(){return this._chatEvents("receivedVisitorMessages").pipe(Nt(I.merge({status:Pc.of(y_.DELIVERED)})))}},{key:"_sendMessageAndWaitForAcknowledgement",value:function(e){var t=this,n=e.message,r=this._deliveryEvents.pipe(Tn((function(e){return I.equals(n.id,e.id)})),ki(1),jo()),i=r.subscribe(I.always);return this._chatApi.sendMessage(n).pipe(Zo(r.pipe(Ki(y_.DELIVERED),ps(this._deliveryTimeout,Lf._throw("".concat(__,": Message timed out before being delivered to other participant"))))),Gr((function(e){return t.logger.info("".concat(__,": Message delivery failed with error"),{error:e,message_id:n.id}),Pc.of(y_.FAILED)})),ki(1),qi(i.unsubscribe))}},{key:"_sendMessage",value:function(e){var t,n,r,i,o,s,a=this,u=(t=e,n=this._generateGuid,r=t.content,i=t.options,o=i?i.attachment:void 0,s=i?i.metadata:void 0,{id:n(),content:r,attachment:o,metadata:s}),c=new g_.ReplaySubject(1).distinctUntilChanged();return c.next(y_.SENDING),this._sentMessages.next(I.merge(u,{status:c})),this._addToReceived(u),this._subscription.add(this._sendMessageAndWaitForAcknowledgement({message:u}).subscribe((function(e){e===y_.DELIVERED&&(c.complete(),a.stats.recordChatMessageDelivered(),a.logger.info("".concat(__,": Message delivered to other participant"),{message_id:u.id})),e===y_.FAILED&&(c.next(y_.FAILED),a.stats.recordChatMessageDeliveryFailed())}),this.logger.error))}},{key:"_acceptReceivedMessage",value:function(e){var t=this;return function(n){t.logger.info("".concat(__,": Message received"),{message_id:n.id,source:e}),t._addToReceived(n),I.pathEq(["sender","type"],"visitor",n)||n.delivered_at||t._chatApi.markMessageAsDelivered(n.id)}}},{key:"_receivedOtherMessages",value:function(){var e=this;return this._chatEvents("receivedOtherMessages").pipe(Tn((function(t){return e._messageNotReceived(t)})),fn((function(t){return Pc.of(t).pipe(os(e._acceptReceivedMessage("participant")),Gr((function(){return Pc.of(t)})))})),jo())}},{key:"_messagesReceivedFromHistory",value:function(){var e=this;return this._history.pipe(Tn((function(t){return e._messageNotReceived(t)})),fn((function(e){return mc.from(e)})))}},{key:"_messageNotReceived",value:function(e){return!I.contains(e.id,this._receivedMessageIds)}},{key:"_addToReceived",value:function(e){this._receivedMessageIds=I.append(e.id,this._receivedMessageIds)}}]),e}();w_.STATUSES=y_;var E_=n.default.visitor_api.own_typing_duration||5e3;var O_="engagement.chat.message",S_="engagement.chat.system_message",T_="engagement.chat.message_status",k_="engagement.chat.typing_indicator.operator",A_="engagement:chat_message:preview_update",x_="Chat",I_={retryLimit:5,initialDelay:1e3,maxDelay:void 0,factor:1.5},N_=function(e){return 0===e||421===e||429===e||e>=500},M_=function(){},R_=I.propSatisfies((function(e){return e===O_||e===S_}),"event_type"),C_=I.propEq("event_type",T_),P_=function(e){var t=I.pathEq(["message","engagement_id"],e);return I.allPass([R_,t])},j_=function(e){var t,n,r=e.engagementId,i=e.visitorId,o=e.logger,s=e.stats,a=e.channelObservable,u=e.xhrWithRetry,c=void 0===u?Hf:u,l=e.getRequestHeaders,f=e.siteVisitorNotifications,p=new yc.Subject,d=function(e){return e.attachment?{content:e.content,attachment:e.attachment}:{content:e.content}},h=(t=p.map(I.prop("content")),t.pipe(Ko((function(e){return""===e?Uu.Observable.of(!1):Uu.Observable.merge(Uu.Observable.of(!0),Uu.Observable.timer(E_,n).map((function(){return!1})))})),us(50,n,{leading:!0,trailing:!0}),yi())).subscribe((function(e){Ff({method:"PUT",url:"".concat(sm.conf.api_url,"/engagements/").concat(r,"/typing_indicator"),payload:JSON.stringify({typing:e}),responseType:"json",getRequestHeaders:function(){return I.merge(l?l():{},{"Content-Type":"application/json"})},onSuccess:M_,onError:function(){return o.warn("Could not set typing indicator")},onAttempt:M_,shouldRetry:function(){return!1}})})),v=p.startWith({content:""}).combineLatest(a).subscribe((function(e){var t=_(e,2),n=t[0];t[1].emit(A_,{engagement_id:r,content:n.content,visitor_id:i})}),o.error.bind(o,"".concat(x_,": Error sending chat preview"))),b=I.compose(I.merge({type:"user"}),I.pick(["id","engagement_id","content","attachment","metadata","sender"]),I.prop("message")),m=I.compose(I.pick(["id","engagement_id"]),I.prop("message")),g=I.pathEq(["message","engagement_id"],r),y=I.pathEq(["message","sender","type"],"visitor"),w=I.pathEq(["message","status"],"delivered"),E=f.pipe(Tn(P_(r))),O=E.pipe(Tn(I.complement(y)),Nt(b)),S=E.pipe(Tn(y),Nt(b)),T=f.pipe(Tn(I.allPass([C_,g,w])),Nt(m)),k=I.propEq("event_type",k_),A=I.pathEq(["typing_indicator","engagement_id"],r);return{stop:function(){v.unsubscribe(),h.unsubscribe()},sendMessage:function(e){var t=e.id;return dc.Observable.create((function(n){var i=0;c({method:"PUT",url:"".concat(sm.conf.api_url,"/engagements/").concat(r,"/chat_messages/").concat(t),payload:JSON.stringify(d(e)),responseType:"json",contentType:"application/json",getRequestHeaders:l,calculateAttemptDelay:M(I_.initialDelay,I_.maxDelay,I_.factor),retryLimit:I_.retryLimit,onSuccess:function(t){o.info("".concat(x_,": Message sent to system, waiting for it to be delivered to other participant"),{message_id:e.id}),n.next(t),n.complete()},onError:function(e){var r=e.status,i=e.statusText,s="".concat(x_,": Failed to send message to system");o.warn(s,{message_id:t,status:r,status_text:i}),n.error(s)},onAttempt:function(){++i>1&&o.info("Chat: Send message request failed, retrying",{message_id:t,attempt:i}),s.recordChatMessageSent(i)},shouldRetry:N_})})).pipe(ki(1))},sendPreview:function(e){return p.next(e)},markMessageAsDelivered:function(e,t,n){c({method:"PATCH",url:"".concat(sm.conf.api_url,"/engagements/").concat(r,"/chat_messages/").concat(e),payload:JSON.stringify({status:"delivered"}),responseType:"json",contentType:"application/json",getRequestHeaders:l,calculateAttemptDelay:M(I_.initialDelay,I_.maxDelay,I_.factor),retryLimit:I_.retryLimit,onSuccess:function(){o.info("".concat(x_,": Marked message as delivered"),{message_id:e}),"function"==typeof t&&t()},onError:function(t){var r=t.status,i=t.statusText;o.warn("".concat(x_,": Failed to mark message as delivered"),{message_id:e,status:r,status_text:i}),"function"==typeof n&&n()},shouldRetry:N_})},receivedOtherMessages:O,receivedVisitorMessages:S,deliveredMessages:T,operatorTypingIndicator:f.pipe(Tn(I.allPass([k,A])),Nt(I.prop("typing_indicator")),lr((function(e,t){return t.clock>e.clock?t:e})),Nt(I.pick(["typing"])),yi(I.equals))}},L_=function(e,t){for(var n,r=[];n=t.exec(e);)r.push(n[1]);return r},q_=function(e,t,n){return t&&I.forEach((function(t){var r=t.split("").join(".*?");e=e.replace(new RegExp(r),n)}),t),e},U_=function(e){var t=!0;return e.split("").reduceRight((function(e,n){return n=parseInt(n,10),(t=!t)&&(n*=2),n>9&&(n-=9),e+n}),0)%10==0},D_=I.compose((function(e){var t=new RegExp(/(?:^|\D)(\d{3}(-| )\d{2}(-| )\d{4})(?=\D|$)/g),n=L_(e,t);return q_(e,n,"***Social Security Number Not Allowed***")}),(function(e){var t=new RegExp("(\\d{".concat(12,",})"),"g"),n=L_(function(e){var t=new RegExp("([a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12})|([^(a-zA-Z0-9:$€£¢)])","gm");return e.replace(t,"$1")}(e),t),r=I.filter(U_,n);return q_(e,r,"***Credit Card Number Not Allowed***")}),(function(e,t){return t.reduce((function(e,t){try{var n=new RegExp(t,"g");return e.replace(n,(function(e){return"*".repeat(e.length)}))}catch(t){return e}}),e)})),V_=function(e){return e.replace(/[0-9]/g,"*")},F_=function(){function e(t){var n=t.channelObservable,r=t.historyObservable,i=t.getRequestHeaders,o=t.logger,a=t.statsClient,u=t.engagementId,c=t.visitorId,l=t.siteVisitorNotifications,f=t.maskingRegularExpressions;s(this,e);var p=new b_(a);this._messagesToSend=new yc.Subject,this._previewToSend=new yc.Subject,this.chatApi=new j_({engagementId:u,visitorId:c,logger:o,stats:p,channelObservable:n,getRequestHeaders:i,siteVisitorNotifications:l}),this.messenger=new w_({chatApi:this.chatApi,stats:p,logger:o,messagesToSend:this._messagesToSend.pipe(Nt((function(e){return function(e,t){var n=e.content,r=e.options;return{content:D_(n,t),options:r}}(e,f)}))),previewToSend:this._previewToSend.pipe(Nt(V_)),history:r}),this.messenger.start()}return u(e,[{key:"sendMessage",value:function(e,t){this._messagesToSend.next({content:e,options:t})}},{key:"sendMessagePreview",value:function(e){this._previewToSend.next(e)}},{key:"stop",value:function(){this.messenger.stop()}},{key:"observables",value:function(){return this.messenger.observables()}}]),e}(),B_=function(){function e(t){var n=t.chatHistoryObservable,r=t.engagementEndObservable,i=t.observeChatMessages,o=t.statsClient,a=t.chatController,u=t.fetchExtraOperatorInfo;s(this,e);var c=new e_.Subscription,l=Zf(),f=a.observables(),p=f.otherMessages,d=f.ownMessages,h=f.operatorTypingIndicator,v=i({chatHistoryObservable:n,otherMessages:p,ownMessages:d,statsClient:o,fetchExtraOperatorInfo:u}),b=v.messages.pipe(bo(1)),m=v.messagesWithStatusUpdates.pipe(bo(1));c.add(b.connect()),c.add(m.connect());var g=h.pipe(Nt(I.construct(h_)),Yo(new h_({typing:!1})),bo(1));c.add(g.connect());var y=function(){l.stop(),c.unsubscribe()},_=I.fromPairs([[this.EVENTS.MESSAGES,b],[this.EVENTS.MESSAGES_WITH_STATUS_UPDATES,m],[this.EVENTS.OPERATOR_TYPING_STATUS_UPDATE,g]]);l.proxyAll(_),this.addEventListener=l.addEventListener,this.removeEventListener=l.removeEventListener,this.observable=function(e){return _[e]},this.sendMessage=function(e,t){a.sendMessage(e,t),a.sendMessagePreview("")},this.sendMessagePreview=function(e){a.sendMessagePreview(e)},r.subscribe((function(){}),y,y)}return u(e,null,[{key:"create",value:function(t){var n=t.chatHistoryObservable,r=t.engagementEndObservable,i=t.statsClient,o=t.engagementId,s=t.getRequestHeaders,a=t.siteVisitorNotifications,u=t.maskingRegularExpressions,c=sc.vent.observable(sc.MSG.PUBLIC.ENGAGEMENT_START),l=dc.Observable.defer((function(){return sc.request("get:engagement_observables").engagementObservable})),f=function(e){var t=e.getRequestHeaders,n=e.xhrWithRetry,r=void 0===n?Hf:n,i=e.takeUntilNotifier,o={},s={},a=i||new Du.Subject;return function(e){return o[e]?Pc.of(o[e]):dc.Observable.create((function(n){if(s[e])s[e].push(n);else{s[e]=[n];var i=function(e){return function(){s[e]&&(s[e].forEach((function(e){e.next(),e.complete()})),delete s[e])}}(e);r({method:"GET",url:"".concat(sm.conf.api_url,"/operators/").concat(e,"?include_engagements=false"),responseType:"json",contentType:"application/json",getRequestHeaders:t,onSuccess:function(t){o[e]=t.response,s[e]&&(s[e].forEach((function(e){e.next(t.response),e.complete()})),delete s[e]),delete s[e]},onError:i,shouldRetry:function(){return!1}})}})).pipe(es(a))}}({getRequestHeaders:s}),p=function(e){var t=e.chatHistoryObservable,n=e.engagementStartObservable,r=e.engagementObservables,i=e.siteVisitorNotifications,o=e.getRequestHeaders,s=e.statsClient,a=e.engagementId,u=e.maskingRegularExpressions,c=n.pipe(ro(r),po("channel"),bo(1)),l=c.connect(),f=new F_({channelObservable:c,historyObservable:t,getRequestHeaders:o,statsClient:s,logger:sm.logger.withTags({engagement_id:a,site_id:sm.siteId}),engagementId:a,visitorId:Fu(),siteVisitorNotifications:i,maskingRegularExpressions:u});return{chatController:f,stopChat:function(){f.stop(),l.unsubscribe()}}}({chatHistoryObservable:n,engagementStartObservable:c,siteVisitorNotifications:a,engagementObservables:l,statsClient:i,engagementId:o,getRequestHeaders:s,maskingRegularExpressions:u}),d=p.chatController,h=p.stopChat;return{chat:new e({chatHistoryObservable:n,engagementEndObservable:r,observeChatMessages:d_,statsClient:i,chatController:d,fetchExtraOperatorInfo:f}),stopChat:h}}}]),e}();B_.prototype.EVENTS={MESSAGES:"messages",MESSAGES_WITH_STATUS_UPDATES:"messages-with-status-updates",OPERATOR_TYPING_STATUS_UPDATE:"operator-typing-status-update"},B_.prototype.SENDERS=a_;var H_=["engagement","engagements"],W_=["engagement","requests"],G_=["visitor","browser_tab_id"],z_=function(e){return I.any(I.propEq("id",sm.siteId),e.transferrable_sites)},J_=function(e){return e&&"transferring"===e.status&&e.capabilities.text},Y_=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=void 0!==t.includeAsyncTransfer&&t.includeAsyncTransfer,r=I.pathOr([],H_,e);try{var i=I.find(z_,r);return J_(i)?n?i:void 0:i}catch(t){return void $u.error("Engagement was undefined in internalVisitorState",{internalVisitorState:e,engagements:r})}},Q_=function(e){return z_(e)&&I.path(G_,e)===sm.tabId&&!J_(e)},K_=I.compose(I.nth(0),I.filter(Q_),I.pathOr([],H_)),X_=I.compose(I.nth(0),I.filter(I.complement(Q_)),I.pathOr([],H_)),$_=I.compose(I.nth(0),I.filter(I.allPass([z_,I.propEq("outcome",null),I.propEq("type","reactive")])),I.pathOr([],W_)),Z_={OBSERVATION:"OBSERVATION",ENGAGEMENT:"ENGAGEMENT",POINTER:"POINTER"},ew=function(){function e(t,n,r){s(this,e),this.mode=t,this.session=n,this.canVisitorEndCobrowsing=r.canVisitorEndCobrowsing||!1}return u(e,null,[{key:"createObservation",value:function(){return new this(Z_.OBSERVATION,null,{})}},{key:"createActive",value:function(e){return new this(e.mode,e.session,e.metadata)}}]),e}(),tw=function(){function e(t){var n=t.cobra;s(this,e),this.stop=function(){return n.switchToObservation()}}return u(e,[{key:"stop",value:function(){}}]),e}(),nw=function(){function e(t){var n=t.operator,r=t.channel;s(this,e),this.operator=n,this.allow=function(){return r.emitAll("engagement:offer_cobrowsing:allow"),$u.info("Visitor accepted cobrowsing request"),null},this.decline=function(){return r.emitAll("engagement:offer_cobrowsing:deny"),$u.info("Visitor declined cobrowsing request"),null}}return u(e,[{key:"allow",value:function(){}},{key:"decline",value:function(){}}]),e}(),rw=u((function e(t){var n=this,r=t.cobraObservable,i=t.internalVisitorStateObservable,o=t.channelObservable,a=t.fromRxJs4,u=void 0===a?ol:a;s(this,e);var c=o.switchMap((function(e){var t=e.channel;return t.emitAll("engagement:offer_cobrowsing:ready"),t.observable("engagement:offer_cobrowsing:offer_cobrowsing").do((function(){return t.emitAll("engagement:offer_cobrowsing:ack")})).map((function(e){return{operator:void 0!==e&&"operator"in e?e.operator:null,channel:t}}))})).do((function(){return $u.info("Received cobrowsing request")})).share().map((function(e){var t=e.operator,n=e.channel;return new nw({operator:t,channel:n})})),l=o.switchMap((function(e){return e.channel.observable("engagement:offer_cobrowsing:deny").map((function(){return{}}))})),f=i.map((function(e){var t=Y_(e),n=void 0!==t?t.platform:void 0;return void 0===n?{}:{canVisitorEndCobrowsing:n!==hf}})).startWith({}).distinctUntilChanged(I.equals),p=r.switchMap((function(e){return u(e.modeObservable.pluck("name").map((function(t){return[t,e]})))})).withLatestFrom(f).map((function(e){var t=_(e,2),r=_(t[0],2),i=r[0],o=r[1];return function(e,t,r){return e===n.MODES.OBSERVATION?ew.createObservation():ew.createActive({mode:e,metadata:t,session:new tw({cobra:r})})}(i,t[1],o)})),d=I.fromPairs([[this.EVENTS.COBROWSING_REQUEST,c],[this.EVENTS.MODE_CHANGE,p],[this.EVENTS.COBROWSING_REQUEST_REJECTED,l]]),h=ep(),v=Zf();v.proxyAll(d),h.proxyAll(d),this.resendPage=function(){return r.timeout(2e3).take(1).toPromise().then((function(e){e.resendPage()}))},this.addUnbufferedEventListener=v.addEventListener,this.removeUnbufferedEventListener=v.removeEventListener,this.addBufferedEventListener=h.addEventListener,this.removeBufferedEventListener=h.removeEventListener,this.observable=function(e){return v.observable(e)},this.bufferedObservable=function(e){return h.observable(e)}}));rw.prototype.EVENTS={COBROWSING_REQUEST:"cobrowsing_request",MODE_CHANGE:"cobrowser_mode_change",COBROWSING_REQUEST_REJECTED:"cobrowsing_request_rejected"},rw.prototype.MODES=Z_;var iw=function(e){return"browser"===e?"audio":"phone"},ow=function(e){var t=e.upgradeRequest,n=e.currentMediaState,r={audio:I.path(["audio","direction"],n),video:I.path(["video","direction"],n)},i=I.pick(["audio","video"],t),o=I.invert(r).two_way||[],s=I.invert(i).two_way||[];return!I.isEmpty(I.difference(s,o))},sw="two_way",aw="one_way",uw=function(e,t){return I.maxBy((function(e){return e===sw?2:e===aw?1:0}),e,t)},cw=function(e){if(e){if(e.video)return"video";if(e.audio&&"browser"===e.audio.type)return"audio";if(e.audio&&"phone"===e.audio.type)return"phone"}return"text"},lw=function(e){return e.stateObservable.bufferCount(2,1).filter((function(e){var t=_(e,2),n=t[0],r=t[1];return n.sub_engagement_id!==r.sub_engagement_id})).do($u.log.bind($u,"Detect sub_engagement change")).map((function(e){var t=_(e,2);t[0];return t[1]})).map((function(e){var t=new _g({id:e.operator.id,name:e.operator.name||"Operator",formattedName:e.operator.formatted_name,picture:{url:e.operator.picture_url},media_type:e.operator.media_type}),n={id:e.id,subEngagementId:e.sub_engagement_legacy_id,channelUrl:e.channel_url,mediaState:e.media_state,operatorId:t.getId(),operatorName:t.getName(),operatorFormattedName:t.getFormattedName(),operatorPicture:t.getPictureUrl(),operatorMedia:t.getMediaType()};return n=I.assoc("startingMedia",cw(n),n)})).map(I.pick(["operatorId","operatorName","operatorFormattedName","operatorPicture","operatorMedia","startingMedia","subEngagementId","id"])).map(I.merge({isReestablishing:!1,isTransfer:!0})).do($u.log.bind($u,"Engagement transferred"))},fw=function(e){var t,n=e.engagement,r=e.transfers,i=e.channelObservable,o=e.webRtcMode,s=e.statusObservable,a={id:n.engagementId,subEngagementId:n.subEngagementId,startingMedia:n.startingMedia,isReestablishing:n.isReestablishing,operatorId:n.operator.id,operatorName:n.operator.name,operatorFormattedName:n.operator.formattedName,operatorPicture:n.operator.picture?n.operator.picture.url:void 0,operatorMedia:(t=n.operator.state.medias,I.findLast(I.contains(I.__,t),lf)),observable:n.observable.bind(n),EVENTS:n.EVENTS},u=s.filter(I.propEq("interaction","engagement")).map(I.prop("channelUrl")).take(1),c=i.switchMap((function(e){var t=e.channel;return u.map((function(e){return{channel:t,engagementChannelUrl:e}}))})).filter((function(e){var t=e.channel,n=e.engagementChannelUrl;return t.url===n})).take(1);return Du.Observable.of(a).merge(r).switchMap((function(e){return c.map((function(t){var n=t.channel;return I.merge({channel:n},e)}))})).map(I.evolve({startingMedia:I.when(I.isNil,I.always(n.startingMedia))})).map((function(e){return I.merge(e,{webRtcMode:o})}))};function pw(e){return I.reduce((function(e,t){return e.then((function(e){return t.then((function(t){return I.append(t,e)}))}))}),Promise.resolve([]),e)}var dw=I.compose(I.join(", "),I.map((function(e){return"'".concat(e,"'")}))),hw=/^\+?[1-9]\d{1,14}$/,vw=function(e){return new Promise((function(t,n){return function(e){return Boolean(e&&e.phoneNumber)}(e)?(r=e.phoneNumber,hw.test(r)?void t():n(new yf({cause:uf.SALEMOVE.INVALID_INPUT,message:"Invalid phone number: '".concat(e.phoneNumber,"'! Make sure that country code is present in the number and it has plus sign (+) prefix")}))):n(new yf({cause:uf.SALEMOVE.INVALID_INPUT,message:"'phone' was specified as the media but the 'phoneNumber' option is missing!"}));var r}))},bw=function(e){return new Promise((function(t,n){if(function(e){return e&&e.hasOwnProperty("phoneExtension")}(e)&&(null!==(r=e.phoneExtension)&&!r.match(/^(,*\d,*){1,25}$/)))return n(new yf({cause:uf.SALEMOVE.INVALID_INPUT,message:"Invalid phone extension: '".concat(e.phoneExtension,"'! The phone extension can only contain commas and up to 25 digits.")}));var r;t()}))},mw=function(e){var t=e.media,n=e.options,r=e.availableMediaTypes,i=e.availableOneWayMediaTypes,o=e.visitorUpgradesAllowed,s=e.highestAllowedMediaType,a=[],u=!1===o?I.drop(r.indexOf(s),r):r;return a.push(function(e,t,n,r,i){return new Promise((function(o,s){if(i.oneWay){if(!1===r)return s(new yf({cause:uf.SALEMOVE.INVALID_INPUT,message:"This site does not support 'one-way' option!"}));if(!I.contains(e,n))return s(new yf({cause:uf.SALEMOVE.INVALID_INPUT,message:"Media must be one of: ".concat(dw(n),"!")}))}if(!i.oneWay&&!I.contains(e,t))return s(new yf({cause:uf.SALEMOVE.INVALID_INPUT,message:"Media must be one of: ".concat(dw(t),"!")}));o()}))}(t,u,i,o,n||{})),"phone"===t&&(a.push(vw(n)),a.push(bw(n))),pw(a)},gw=function(e){var t=e.options,n=e.availableMediaTypes,r=e.availableOneWayMediaTypes,i=e.visitorUpgradesAllowed,o=e.highestAllowedMediaType,s=[],a=!1===i?I.drop(n.indexOf(o),n):n;return s.push(function(e,t,n,r){return new Promise((function(i,o){if(e.audio){var s=["browser","phone"];if(!I.contains(e.audio,s))return o(new yf({cause:uf.SALEMOVE.INVALID_INPUT,message:"Audio must be one of: ".concat(dw(s),"!")}));if(!I.contains("audio",t)&&!I.contains("phone",t))return o(new yf({cause:uf.SALEMOVE.INVALID_INPUT,message:"Audio is not supported!"}))}if(e.video){var a=["one_way","two_way"];if(!I.contains(e.video,a))return o(new yf({cause:uf.SALEMOVE.INVALID_INPUT,message:"Video must be one of: ".concat(dw(a),"!")}));if("one_way"===e.video&&!1===r)return o(new yf({cause:uf.SALEMOVE.INVALID_INPUT,message:"This site does not support 'one-way' option!"}));if("one_way"===e.video&&!I.contains("video",n))return o(new yf({cause:uf.SALEMOVE.INVALID_INPUT,message:"One-way video is not supported!"}));if("two_way"===e.video&&!I.contains("video",t))return o(new yf({cause:uf.SALEMOVE.INVALID_INPUT,message:"Video is not supported!"}))}i()}))}(t,a,r,i)),"phone"===t.audio&&(s.push(vw(t)),s.push(bw(t))),pw(s)},yw=u((function e(t){var n=this;s(this,e);var r=t.visitor,i=t.operator;this.visitor=I.compose(I.evolve({phoneStatus:function(e){switch(e){case sc.MSG.PHONE_STATUSES.CONNECTED:return n.PHONE_STATUSES.CONNECTED;case sc.MSG.PHONE_STATUSES.CONNECTING:return n.PHONE_STATUSES.CONNECTING;default:return n.PHONE_STATUSES.UNUSED}}}),I.pickAll(["media","audioMuted","videoMuted","phoneStatus"]))(r),this.operator=I.pickAll(["media","audioMuted","videoMuted"],i)}));yw.prototype.PHONE_STATUSES={CONNECTED:"connected",CONNECTING:"connecting",UNUSED:"unused"};var _w=u((function e(t){var n=t.id,r=t.label,i=t.is_default,o=t.position;if(s(this,e),this.id=n,this.label=r,this.is_default=i,this.position=o,!this.id||!this.label)throw $u.error("Survey choice missing parameters",{parameters:{id:n,label:r,is_default:i,position:o}}),new yf({cause:uf.SALEMOVE.INTERNAL_ERROR,message:"Survey choice is missing required parameters"})})),ww=u((function e(t){var n=this,r=t.id,i=t.text,o=t.name,a=t.type,u=t.required,c=t.position,l=t.options;s(this,e),this.id=r,this.text=i,this.name=o,this.type=a,this.required=u,this.position=c,this.options=l;var f=function(){return n.options&&Array.isArray(n.options)&&!I.isEmpty(n.options)};if("single_choice"===this.type&&f()&&(this.options=this.options.map((function(e){return new _w(e)}))),"single_choice"!==this.type||f()||$u.warn("Single choice survey question missing options",{parameters:arguments[0]}),!(this.id&&this.text&&this.name&&this.type))throw $u.error("Survey question missing parameters",{parameters:arguments[0]}),new yf({cause:uf.SALEMOVE.INTERNAL_ERROR,message:"Survey question is missing required parameters"})})),Ew=u((function e(t,n){var r=this,i=t.survey;s(this,e),this.id=i.id,this.description=i.description,this.title=i.title,this.type=i.type,this.name=i.name,this.questions=i.questions.map((function(e){return new ww(e)})).filter((function(e){return!(e.type===r.QUESTION_TYPES.SINGLE_CHOICE&&I.isEmpty(e.options))})),this.answer=function(e){return n({surveyId:i.id,answers:nf(e)})}}));Ew.prototype.QUESTION_TYPES={BOOLEAN:"boolean",SCALE:"scale",TEXT:"text",SINGLE_CHOICE:"single_choice"};var Ow=function(e){var t=e.stats,n=e.protocol,r=e.failureTagProperty,i=e.timeout,o=e.timeoutError,s=e.scheduler;return function(e,a){var u=e.resource,c=e.method,l=t.statApiUsage({protocol:n,resource:u})(c).attempted();return a().do(l.succeeded,I.compose(l.failed,I.prop(r))).timeoutWith(i,o.do(null,(function(){l.timedOut(),$u.warn("'".concat(c,"' on resource ").concat(u," has timed out"))})),s).do((function(e){return $u.log("Successfully executed '".concat(c,"' on resource ").concat(u))}),(function(e){return $u.warn("Failed to execute '".concat(c,"' on resource ").concat(u))})).finally((function(){if(!l.isFinished())return l.failed("aborted")}))}},Sw=new yf({cause:uf.SALEMOVE.NETWORK_TIMEOUT}),Tw=["#inner-page",".socketio","script[src*='".concat(n.default.assets.server,"']"),"#cobrowsing-mouse-container","style[data-page-iframer='keep']"],kw=n.default.visitor_app.is_custom_theme?["body > link","head > link"]:["link[href*='".concat(n.default.assets.server,"']"),"link[href*='".concat(n.default.api_url,"']"),"link[href*='https://uploads.salemove.com']"],Aw=Tw.concat(kw),xw=function(){function e(t,n){s(this,e),this._retainedElementsBySelector=this._retainedElementsBySelector.bind(this),this._document=t,n||(n=[]),this._filters=n}return u(e,[{key:"clean",value:function(){this._removeAccordingToFiltersLeavingTopLevelInPlace(),this._cleanHtmlElementOfUnnecessaryAttributes(),this._overrideBodyInlineStyles(),this._hideParentsOfKeptHiddenElements()}},{key:"_removeAccordingToFiltersLeavingTopLevelInPlace",value:function(){var e=I.chain(this._retainedElementsBySelector,this._filters),t=Yc(this._document.head.querySelectorAll("*")).concat(Yc(this._document.body.querySelectorAll("*")));return I.differenceWith(I.identical,t,e).filter((function(e){return"title"!==e.localName})).map((function(e){return e.parentNode.removeChild(e)}))}},{key:"_retainedElementsBySelector",value:function(e){var t=Yc(this._document.querySelectorAll(e));return I.chain((function(e){return Yc(e.querySelectorAll("*")).concat([e]).concat(Jc(e))}),t)}},{key:"_cleanHtmlElementOfUnnecessaryAttributes",value:function(){var e=this._document.querySelector("html");Yc(e.attributes).filter((function(e){return"lang"!==e.name})).forEach((function(t){return e.removeAttribute(t.name)}))}},{key:"_overrideBodyInlineStyles",value:function(){this._document.body.removeAttribute("style")}},{key:"_hideParentsOfKeptHiddenElements",value:function(){if(this._filters.length>0){var e=Yc(this._document.body.querySelectorAll("*")).filter(zc),t=Yc(this._document.body.querySelectorAll(this._filters.join(","))),n=I.chain((function(e){var t=Yc(e.querySelectorAll("*")).concat([e]);return zc(e)?t.concat(Jc(e)):t}),t);I.differenceWith(I.identical,e,n).forEach((function(e){e.style.display="none"}))}}}]),e}(),Iw=sm.conf.visitor_app.css_prefix||"sm-",Nw={id:"inner-page",getTargetUrl:function(){return window.location.href},document:window.document,nonRemoved:[]},Mw=function(){function e(t){s(this,e);var n=I.merge(Nw,t);this._id=n.id,this._targetUrl=n.getTargetUrl(),this._targetDocument=n.document||window.document,this._iframeElement=this._createIframeElement(this._targetDocument);var r=(n.nonRemoved||[]).concat(["#".concat(this._id)]).concat(Aw);this._cleaner=new xw(this._targetDocument,r),this._iframeTargetPointer=n.targetId,this._wrapIframe=n.wrapIframe}return u(e,[{key:"putIntoIframe",value:function(){var e=this;return new Promise((function(t,n){var r=By(e._targetDocument);return e._iframeElement.style.visibility="hidden",e._callWhenIframeLoaded((function(){return e._iframeElement.style.visibility="",Fy(e._iframeElement.contentDocument,r),e._clearCurrentDom(),t({iframe:e._iframeElement})})),e._insertIframe()}))}},{key:"_clearCurrentDom",value:function(){return this._cleaner.clean()}},{key:"_createIframeElement",value:function(e){var t=e.createElement("iframe");return t.setAttribute("id",this._id),t}},{key:"_insertIframe",value:function(){var e;this._iframeElement.src=this._targetUrl,this._ensureBodyExists();var t=this._iframeSiblingElement();if(this._wrapIframe){var n=this._targetDocument.createElement("div");n.setAttribute("id","".concat(Iw,"inner-page-wrapper")),n.appendChild(this._iframeElement),e=n}else e=this._iframeElement;t?this._targetDocument.body.insertBefore(e,this._iframeSiblingElement()):this._targetDocument.body.appendChild(e),this._iframeElement.contentWindow.location.href=this._targetUrl}},{key:"_iframeSiblingElement",value:function(){if(this._iframeTargetPointer)return this._targetDocument.getElementById(this._iframeTargetPointer)}},{key:"_callWhenIframeLoaded",value:function(e){return this._iframeElement.addEventListener("load",(function t(n){return n.target.removeEventListener("load",t),e()}))}},{key:"_ensureBodyExists",value:function(){if(!this._targetDocument.body){var e=this._targetDocument.createElement("body");return this._targetDocument.appendChild(e)}}}]),e}(),Rw="sm-wrapped-page",Cw=function(){function e(t){var n=t.document,r=t.nonRemoved;s(this,e),this.wrap=this.wrap.bind(this),this.unwrap=this.unwrap.bind(this),this.document=n,this.nonRemoved=(r||[]).concat(["#".concat(this._id)]).concat(Aw)}return u(e,[{key:"wrap",value:function(){var e=this._createWrappingDiv(),t=this.nonRemoved.join(", ");Yc(this.document.body.children).forEach((function(n){Qc(n,t)||Qc(n,"iframe")&&"none"===window.getComputedStyle(n).display||e.appendChild(n)}));var n=this.document.body.children[0];this.document.body.insertBefore(e,n)}},{key:"unwrap",value:function(){var e=this.document.getElementById(Rw);e&&(Yc(e.children).forEach((function(t){e.parentNode.appendChild(t)})),e.parentNode.removeChild(e))}},{key:"_createWrappingDiv",value:function(){var e=this.document.createElement("div");return e.id=Rw,e.className=Rw,e}}]),e}(),Pw=u((function e(t){var n=t.media,r=t.medias;s(this,e),this.media=n,this.medias=r})),jw=function(e,t){"iframe"===e?document.querySelector("#inner-page").contentWindow.location.assign(t):window.location.href=t},Lw=function(e){var t=e.volatileNotifications,n=e.visitorPageAdaption;return t.filter(I.both(I.propEq("site_id",sm.siteId),I.propEq("event","navigation_to_url"))).map(I.prop("payload")).subscribe(jw.bind(this,n),$u.error.bind($u,"Unable to navigate to url"))},qw=u((function e(t){var n=t.medraStream;s(this,e),this.stream=n.getWebMediaStream()})),Uw=function(){function e(t){var n=t.medraStream,r=t.connection;s(this,e),n.getWebMediaStream().getVideoTracks()[0].onended=function(){return r.stop()},this.stopSharing=function(){return r.stop(),null}}return u(e,[{key:"stopSharing",value:function(){}}]),e}(),Dw=u((function e(t){var n=t.status,r=t.screen;s(this,e),this.status=n,this.screen=r}));Dw.prototype.STATUSES={SHARING:"sharing",NOT_SHARING:"not_sharing"};var Vw=u((function e(t){var n=t.status,r=t.screen;s(this,e),this.status=n,this.screen=r}));Vw.prototype.STATUSES={SHARING:"sharing",NOT_SHARING:"not_sharing"};var Fw=u((function e(t){var n=t.onAccept,r=t.onDecline;s(this,e),this.accept=function(){return n().then((function(){return{}}))},this.decline=function(){r()}})),Bw=function(){return{mediaDevices:navigator.mediaDevices}},Hw=function(e){return"NotReadableError"===e.name||"NotFoundError"===e.name||"AbortError"===e.name},Ww=function(e){return"Permission denied by system"===e.message?new yf({cause:uf.SALEMOVE.DENIED_BY_SYSTEM}):new yf({cause:uf.SALEMOVE.CANCEL})},Gw=function(e){var t,n=e.conf,r=e.channelObservable,i=e.namespace,o=e.videoProvider;return oc("Medra").map(I.prop("default")).map((function(e){return new e({webRTC:{iceServers:n.communications.webrtc_server,videoProvider:o}})})).flatMap((function(e){return r.do((function(){t&&(sm.logger.info("Stopping Medra connection due to new channel"),t.stop())})).flatMap((function(t){var n=t.channel;return il(e.connect(n,{namespace:i}))})).do((function(e){t=e}))}))},zw=function(){function e(t){var n=t.adapter,r=t.operatorScreenSharedObservable,i=t.visitorScreenSharedObservable,o=t.screenShareRequestedObservable;s(this,e),this.EVENTS={OPERATOR_STATE_UPDATE:"operator_state_update",VISITOR_STATE_UPDATE:"visitor_state_update",SCREEN_SHARING_REQUEST:"screen_sharing_request"};var a=I.fromPairs([[this.EVENTS.OPERATOR_STATE_UPDATE,r],[this.EVENTS.VISITOR_STATE_UPDATE,i],[this.EVENTS.SCREEN_SHARING_REQUEST,o]]);n.proxyAll(a),this.addBufferedEventListener=n.addEventListener,this.removeBufferedEventListener=n.removeEventListener}return u(e,null,[{key:"start",value:function(t){var n,r,i=t.conf,o=t.channelObservable,s=t.connectMedra,a=t.fromRxJs5,u=t.scheduler,c=t.videoProvider,l=t.isReestablishing,f=t.stats;a||(a=il),s||(s=Gw);var p=new Du.Subscription,d=new Du.Subject,h=new Du.Subject;c||(c=function(e,t){var n=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:Bw()).mediaDevices;return{getStream:function(){return new Promise((function(r,i){t.next(new Fw({onAccept:function(){$u.info("Requesting screen capture");var t=e.statScreenShareUsage({stage:"capture",resource:"visitor_api.screen_sharing"}).attempted();return n.getDisplayMedia({video:!0}).then((function(e){r(e),$u.info("Screen capture successful"),t.succeeded()})).catch((function(e){return i(e),"NotAllowedError"===e.name?($u.info("Screen capture permissions denied",e),t.failed("canceled"),Promise.reject(Ww(e))):Hw(e)?($u.info("Screen capture failed due to no access to screen",e),t.failed("device-error"),Promise.reject(new yf({cause:uf.SALEMOVE.DEVICE_ACCESS_ERROR}))):"SecurityError"===e.name?($u.info("Screen capture failed due to Permissions Policy",e),t.failed("permissions-policy"),Promise.reject(new yf({cause:uf.SALEMOVE.DENIED_BY_PERMISSIONS_POLICY}))):(t.failedUnknown(),Promise.reject(new yf({cause:uf.SALEMOVE.INTERNAL_ERROR})))}))},onDecline:function(){sm.logger.info("Screen sharing request declined"),i({name:"NotAllowedError"})}}))}))}}}(f,h));var v=new Du.Subject,b=v.switchMap((function(){return s({conf:i,channelObservable:o,namespace:"visitor-screensharing",videoProvider:c})})).publishReplay(1);if(p.add(b.connect()),v.next({}),b.switchMap((function(e){return a(e.communicationRequest).map((function(t){return{proposal:t,connection:e}}))})).subscribe((function(e){var t=e.proposal,n=e.connection,r=f.statScreenShareUsage({stage:"sharing",resource:"visitor_api.screen_sharing"}).attempted();return t.accept({video:{type:"browser"}}).then((function(e){var t=e.localVideoStream;r.succeeded(),sm.logger.info("Screen sharing succeeded"),d.next({connection:n,localVideoStream:t})})).catch((function(e){e&&e.cause===n.ERRORS.DENIED_BY_SYSTEM?(r.failed("canceled"),sm.logger.info("Screen sharing canceled")):e&&e.cause===n.ERRORS.DEVICE_ACCESS_ERROR?(r.failed("device_access_error"),sm.logger.warn("Screen sharing failed due to device access error",e)):(r.failedUnknown(),sm.logger.warn("Screen sharing failed",e))}))}),sm.logger.error.bind(sm.logger,"Failed to receive screen sharing request")),l){p.add(b.take(1).subscribe((function(e){return e.reestablish().then((function(t){var n=t.localVideoStream;if(n)return d.next({connection:e,localVideoStream:n})}))}),sm.logger.error.bind(sm.logger,"Failed to reestablish visitor screen")))}var m=new Dw({status:Dw.prototype.STATUSES.NOT_SHARING}),g=(n=s({conf:i,channelObservable:o,namespace:"operator-screensharing"}).switchMap((function(e){var t=a(e.communicationRequest).pipe(fn((function(t){return Du.Observable.from(t.accept({})).catch((function(t){return t&&t.cause===e.ERRORS.REMOTE_PARTICIPANT_ERROR?sm.logger.info("Failed to receive operator screen due to error on operator side",t):sm.logger.warn("Failed to receive operator screen",t),Du.Observable.empty()}))})));return l?Du.Observable.merge(Du.Observable.fromPromise(e.reestablish()),t).filter((function(e){var t=e.remoteVideoStream;return!I.isNil(t)})):t})).do((function(){return sm.logger.info("Remote screen sharing stream received")})).flatMap((function(e){var t=e.remoteVideoStream,n=Du.Observable.defer((function(){var e="playing"===t.getMediaState()?Dw.prototype.STATUSES.SHARING:Dw.prototype.STATUSES.NOT_SHARING;return Du.Observable.of(new Dw({screen:new qw({medraStream:t}),status:e}))})),r=a(t.observe(t.EVENTS.DISCONNECTED)).map((function(){return m}));return Du.Observable.merge(n,r)}))).startWith.apply(n,w([m,u].filter(I.identity))),y=new Vw({status:Vw.prototype.STATUSES.NOT_SHARING}),_=null,E=(r=d.do((function(){return sm.logger.info("Screen sharing request accepted")})).switchMap((function(e){var t=e.localVideoStream,n=e.connection;_=new Uw({medraStream:t,connection:n});var r=Du.Observable.of(new Vw({screen:_,status:Vw.prototype.STATUSES.SHARING})),i=a(t.observe(t.EVENTS.DISCONNECTED)).do((function(){return v.next({})})).map((function(){return y}));return Du.Observable.merge(r,i)}))).startWith.apply(r,w([y,u].filter(I.identity))).share(),O=ep();return{screenSharing:new e({adapter:O,operatorScreenSharedObservable:g,visitorScreenSharedObservable:E,screenShareRequestedObservable:h}),stopScreenSharing:function(){_&&_.stopSharing(),O.stop(),p.unsubscribe()}}}}]),e}(),Jw=u((function e(t){var n=t.id,r=t.properties;s(this,e),this.id=n,this.properties=r})),Yw=function(){return"iframe"===sm.conf.visitor_app.visitor_page_adaption},Qw=function(){return Yw()?document.getElementById("inner-page").contentWindow.document:document},Kw=function(e){try{var t=Qw();return Yw()?t.body.querySelector(e):t.querySelector(e)}catch(e){return $u.info("Target element not found",{error:e}),null}},Xw="virtual_assistant_cobrowsing_cursor",$w="virtual_assistant_cobrowsing_cursor_label",Zw=function(e){var t=e.cursorIdentifier,n=e.onRemove;if(!Yw()){var r=Kw(t||"#"+Xw);if(r&&(r.parentElement.removeChild(r),n))return n()}},eE=function(e,t){var n=Kw("#"+Xw);if(!n){var r=function(){var e=Qw().createElement("div");return e.setAttribute("id",Xw),e.style.display="none",e.style.opacity="0",e.style.position="absolute",e.style.zIndex="10",e.style.top="0",e.style.left="0",e.style.width="20px",e.style.height="20px",e.style.backgroundRepeat="no-repeat",e.style.backgroundImage="url('data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAAwAAAARCAYAAADpPU2iAAAAAXNSR0IArs4c6QAAAiNJREFUKBV1kl9oUlEcx39eR21JEAwEHQQ9OKcr2mDoemgsfV5vSdFLqzEu9NSo6MHF8iUIevRBtJfyrdjbarVQF8un7ELWnKUiNzFw88+qqyL3evoe22LG/MGHe87vfL+/37nnHGprWpLtRSKROE9EAugdrVZL8ly+yhYX7zNN01rRaHQa6t6mRqPxaWraxSBi0dg6U1W1GQgEzvQ0wbApijc7Bm56tfqaIbfj9XpPYa4D3dFsNtPXb8z/M2CVRSIxpiiK7Ha7BzHvNsGQ/d8ADUsmP7NqtSrBYDjYQtDpdIf8ICOnc5JKpe2xWq0Wg2Fg38TFffuTg996/Tc5HA4qFn9MVCqVVaz183Vu0PPBYbG7WyO73UbfMtmpQqHwFJr+PuFvdOkFvZ4eLPkI90Ky/J0aikJDZvOlcql0gm8H8EMiWli4Tfl8npaXX9Ds7DVaW3uTbbfVejaXPappKplNpkHCRVUsVjsTBH3ngZR3yp0jttlsLBgMbqEO30oQBMBDgRjT37t7h95vbJAoih9WXq7knJPnKJVK0bBl2OrxeH5B+G6PNLXRgpf2+/2bSD43Go3hjwmp08U6YmOyLOeQHwMmMER4cSyXychcDB6DOVT/Mjp6umMKhZ4wn88nIn8ckPA2Erl1dnz8GcbbIAHWw+Hwo1AwRAPHDCRJErlcrivIG4EAyALmwRwYAUfAyXg8Hi0Wiq2vW+mfF2dmeMELwPAHu44LBYcnDWwAAAAASUVORK5CYII=')",e}(),i=function(e,t){var n=Qw().createElement("div");return n.setAttribute("id",$w),n.style.display="inline-block",n.style.color="#ffffff",n.style.fontSize="13px",n.style.padding="2px 12px",n.style.margin="18px 0 0 14px",n.style.boxShadow="1px 1px 4px rgba(50, 50, 50, 0.75)",n.style.border="1px solid #ffffff",n.style.borderRadius="4px",n.style.backgroundColor="#232323",n.style.whiteSpace="nowrap",n.innerText=t,n}(0,t);r.appendChild(i),n=Qw().body.appendChild(r)}return n.style.display="block",Du.Observable.of({cursor:n})},tE=function(e){return function(t){var n=t.interval.value+1;e.style.left=function(e,t){return(t=e.cursorInitialPosLeft-e.cursorDistanceDiffLeft*t/e.totalCircleSteps).toFixed(0)}(t,n)+"px",e.style.top=function(e,t){return(t=e.cursorInitialPosTop-e.cursorDistanceDiffTop*t/e.totalCircleSteps).toFixed(0)}(t,n)+"px"}},nE=function(e,t){var n=10*t;e.style.left=function(e,t){return(e+3*Math.cos(t*Math.PI/180)).toFixed(0)}(e.offsetLeft,n)+"px",e.style.top=function(e,t){return(e-3*Math.sin(t*Math.PI/180)).toFixed(0)}(e.offsetTop,n)+"px"},rE=function(e){return e||(e={moveCursorToPosition:tE,moveFrequency:20}),function(t){var n,r,i,o=t.cursor.offsetLeft,s=t.cursor.offsetTop,a=(n=t.targetElement,r=n.getBoundingClientRect(),i=r.top+Qw().documentElement.scrollTop,{left:r.left+Qw().documentElement.scrollLeft+n.offsetWidth/2,top:i+n.offsetHeight/2}),u=o-a.left,c=s-a.top,l=Math.abs((u+c)/50).toFixed(0),f=l>0?l:1;return Du.Observable.interval(e.moveFrequency).timeInterval().map((function(e){return{cursorInitialPosLeft:o,cursorInitialPosTop:s,cursorDistanceDiffLeft:u,cursorDistanceDiffTop:c,totalCircleSteps:l,interval:e}})).do(e.moveCursorToPosition(t.cursor)).skip(f-1).take(1).mapTo(t)}},iE=function(e){return e||(e={moveCursorCirclePosition:nE,circleFrequency:50}),function(t){return Du.Observable.interval(e.circleFrequency).timeInterval().do((function(n){return e.moveCursorCirclePosition(t.cursor,n.value)})).skip(107).take(1).mapTo(t)}},oE=function(e,t){e.style.opacity=t>=1?1:(parseFloat(t)+.1).toFixed(1)},sE=function(e,t){t<=.1?(e.style.opacity=0,e.style.display="none"):e.style.opacity=(parseFloat(t)-.1).toFixed(1)},aE=function(e,t,n){return Du.Observable.interval(t.stepDuration).do((function(){var r=e.cursor.style.opacity;"in"===n&&t.fadeInStep(e.cursor,r),"out"===n&&t.fadeOutStep(e.cursor,r)})).skip(9).take(1).mapTo(e)},uE=function(e){return e||(e={fadeInStep:oE,stepDuration:20}),function(t){return aE(t,e,"in")}},cE=function(e){return e||(e={fadeOutStep:sE,stepDuration:120}),function(t){return aE(t,e,"out")}},lE=function(e){e.targetElement.click()},fE="custom_commands",pE=function(){var e=localStorage.getItem(fE);return e?JSON.parse(e):[]},dE=function(e){localStorage.setItem(fE,JSON.stringify(e))},hE=function(e){dE([].concat(w(pE()),[e]))},vE=function(e){dE(pE().filter((function(t){return t.id!==e.id})))},bE="virtual_assistant_cobrowsing",mE="point",gE="scroll",yE="click",_E="navigate",wE=[gE,mE,yE],EE=function(e){return e.targetElement.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})},OE=function(e,t){e.operatorName;var n=e.operatorFormattedName;return function(e){var t,r,i=e.properties[bE];if(t=i.target,!((r=i.type)===_E?t&&t.length:I.contains(r,wE)?Boolean(Kw(t)):($u.info("Invalid Virtual Assistant Cobrowsing action type",{type:r}),0)))return vE(e),Du.Observable.of(e);switch(i.type){case mE:return eE(0,n).map(I.assoc("targetElement",Kw(i.target))).do(EE).flatMap(uE()).flatMap(rE()).flatMap(iE()).flatMap(cE()).do((function(){return vE(e)})).mapTo(e);case yE:return eE(0,n).map(I.assoc("targetElement",Kw(i.target))).do(EE).flatMap(uE()).flatMap(rE()).flatMap(iE()).do((function(){return vE(e)})).do(lE).flatMap(cE()).mapTo(e);case gE:return eE(0,n).map(I.assoc("targetElement",Kw(i.target))).do(EE).flatMap(uE()).flatMap(rE()).do((function(){return vE(e)})).mapTo(e);case _E:return function(e){return Yw()?document.getElementById("inner-page").contentWindow.location.assign(e):window.location.href=e,Du.Observable.of({})}(i.target).do((function(){return vE(e)})).mapTo(e);default:throw new Error("Unknown action: ".concat(i.type))}}},SE="custom_command",TE=function(e){return I.has(bE,e.properties)},kE=u((function e(t){var n=this,r=t.media,i=t.medias,o=t.onAccept,a=t.onDecline,u=t.validateMedia;s(this,e),this.media=r,this.medias=i,u=u||mw;this.select=function(e,t){return u({options:t,availableMediaTypes:n.medias,availableOneWayMediaTypes:[],media:e}).then((function(){return function(e,t){return o({media:e,options:t})}(e,t)}))},this.decline=a})),AE=new yf({cause:uf.SALEMOVE.NETWORK_TIMEOUT}),xE=function(e){var t=e.visitorId,r=e.engagementId,i=e.volatileNotifications,o=e.engagementStateObservable,s=e.wsProxy,a=e.apiTimeoutMilliseconds,u=e.stats,c=Ow({stats:u,protocol:"rest",failureTagProperty:"message",timeout:a,timeoutError:Du.Observable.throw(AE)});return{mediaUpgradeRequestObservable:function(e,t){var n=I.propEq("event_type","engagement.media_upgrade_request"),r=I.pathEq(["media_upgrade_request","engagement_id"],e),i=I.pathEq(["media_upgrade_request","target"],"visitor"),o=I.compose(I.pick(["id","audio","video"]),I.prop("media_upgrade_request"));return t.filter(I.allPass([n,r,i])).map(o)}(r,i),mediaStateObservable:function(e){return e.filter(I.identity).map(I.prop("media")).distinctUntilChanged(I.equals)}(o),requestMediaUpgrade:function(e){var t=e.mediaUpgradeRequest;return c({resource:"media-upgrade-request",method:"create"},(function(){return s.request({method:"POST",url:"".concat(n.default.api_url,"/engagements/").concat(r,"/media_upgrade_requests"),payload:t,headers:bf}).catch((function(e){return Of(e,{allowedCauses:[uf.SALEMOVE.INVALID_INPUT,uf.SALEMOVE.NETWORK_TIMEOUT,uf.SALEMOVE.CONFLICT]})}))})).toPromise()},acceptUpgradeRequest:function(e,t){return c({resource:"media-upgrade-request",method:"accept"},(function(){return s.request({method:"PATCH",url:"".concat(n.default.api_url,"/engagements/").concat(r,"/media_upgrade_requests/").concat(e.id),payload:I.merge(t,{action:"accept"}),headers:bf}).catch((function(e){return Of(e,{allowedCauses:[uf.SALEMOVE.INVALID_INPUT,uf.SALEMOVE.NETWORK_TIMEOUT,uf.SALEMOVE.CONFLICT]})}))})).toPromise()},declineUpgradeRequest:function(e){return c({resource:"media-upgrade-request",method:"decline"},(function(){return s.request({method:"PATCH",url:"".concat(n.default.api_url,"/engagements/").concat(r,"/media_upgrade_requests/").concat(e.id),payload:{action:"decline"},headers:bf}).catch((function(e){return Of(e,{allowedCauses:[uf.SALEMOVE.INVALID_INPUT,uf.SALEMOVE.NETWORK_TIMEOUT,uf.SALEMOVE.CONFLICT]})}))})).toPromise()},removeVideo:function(){return c({resource:"engagement-participant",method:"remove video"},(function(){return s.request({method:"PATCH",url:"".concat(n.default.api_url,"/engagements/").concat(r,"/participants/").concat(t),payload:{action:"remove_video"},headers:bf}).catch(Of)})).map((function(){return{}})).toPromise()},removeAudio:function(){return c({resource:"engagement-participant",method:"remove audio"},(function(){return s.request({method:"PATCH",url:"".concat(n.default.api_url,"/engagements/").concat(r,"/participants/").concat(t),payload:{action:"remove_audio"},headers:bf}).catch(Of)})).map((function(){return{}})).toPromise()}}},IE=function(e){return/android/i.test(e.userAgent)},NE=Object.freeze({__proto__:null,screenCapturingSupported:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window.navigator;return Boolean(I.path(["mediaDevices","getDisplayMedia"],e))&&!IE(e)}}),ME=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Pg,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:NE,n=e.canReceiveMedia()?["browser"]:[],r=e.canSendMedia()?["browser"]:[];return{canReceive:{video:n,audio:n.concat(["phone"])},canSend:{video:r,audio:r.concat(["phone"])},canShareScreen:t.screenCapturingSupported()&&e.canSendMedia()}},RE=function(e,t){return t.filter(ow).map((function(t){var n=t.upgradeRequest,r=t.currentMediaState,i=function(e,t){if("two_way"===e.video)return{media:"video",medias:["video"]};if("two_way"===e.audio)return{media:"audio",medias:t.canSend.audio.map(iw)};throw new Error("Tried to create upgrade offer for one way media")}(n,ME());return new kE(I.merge(i,{onAccept:function(t){return e.acceptUpgradeRequest(n,function(e,t){var n=(e.options?e.options.phoneNumber:void 0)||I.path(["audio","phone_number"],t),r=(e.options?e.options.phoneExtension:void 0)||I.path(["audio","phone_extension"],t);return{audio_type:"video"===e.media?I.path(["audio","type"],t)||"browser":"phone"===e.media?"phone":"browser",phone_number:n,phone_extension:r}}(t,r)).then(I.always({}))},onDecline:function(){return e.declineUpgradeRequest(n).then(I.always({}))}}))})).share()},CE=function(e){var t,n=e.commsApi||xE(I.pick(["engagementId","visitorId","volatileNotifications","engagementStateObservable","wsProxy","apiTimeoutMilliseconds","stats"],e)),r=new Du.Subscription,i=n.mediaUpgradeRequestObservable.switchMap((t=e.channelObservable,function(e){return t.take(1).do((function(t){return t.channel.emit("comms:media_upgrade_request:ack",{id:e.id})})).mapTo(e)})).withLatestFrom(n.mediaStateObservable).map(I.zipObj(["upgradeRequest","currentMediaState"])).share();r.add(function(e,t){return t.filter(I.complement(ow)).do((function(e){var t=e.upgradeRequest;return $u.info("Accepting media request automatically",{upgrade_request:t})})).switchMap((function(t){var n=t.upgradeRequest,r=t.currentMediaState;return e.acceptUpgradeRequest(n,{audio_type:I.path(["audio","type"],r),phone_number:I.path(["audio","phone_number"],r),phone_extension:I.path(["audio","phone_extension"],r)})})).catch((function(){return Du.Observable.empty()})).subscribe((function(){}))}(n,i));return r.add(sc.vent.observable(sc.MSG.ENGAGEMENT_REMOVE_AUDIO).subscribe(n.removeAudio,$u.error.bind($u,"Error removing visitor's audio"))),{removeVideo:n.removeVideo.bind(n),mediaUpgradeOffers:RE(n,i),mediaStateObservable:n.mediaStateObservable,requestMediaUpgrade:function(e){return n.mediaStateObservable.take(1).switchMap((function(t){var r=function(e){var t=e.options,n=e.currentMediaState,r=I.path(["audio","direction"],n),i=I.path(["video","direction"],n),o=t.audio?sw:null,s=t.video?t.video:null,a=uw(o,r),u=uw(s,i),c=I.path(["audio","phone_number"],n)||t.phoneNumber||null,l=I.path(["audio","phone_extension"],n)||t.phoneExtension||null;return{audio:a,video:u,audio_type:I.path(["audio","type"],n)||t.audio||null,phone_number:c,phone_extension:l}}({options:e,currentMediaState:t});return n.requestMediaUpgrade({mediaUpgradeRequest:r})})).toPromise().then(I.always({}))},stop:function(){r.unsubscribe()}}},PE=new yf({cause:uf.SALEMOVE.NETWORK_TIMEOUT}),jE=function(e){return e instanceof DOMException?wf(e):e instanceof yf?e:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(0===e)return new yf({cause:uf.SALEMOVE.CONNECTION_LOST});var o=I.equals(e,404)?uf.SALEMOVE.RESOURCE_NOT_FOUND:I.contains(e,pf)?uf.SALEMOVE.INVALID_INPUT:I.equals(e,429)?uf.SALEMOVE.TOO_MANY_REQUESTS:401===e||403===e?uf.SALEMOVE.FORBIDDEN:($u.warn("An INTERNAL_ERROR error from XHR occurred. Can we expose this error as non-internal?",i({status:e,message:n,responseText:t},r)),uf.SALEMOVE.INTERNAL_ERROR),s=function(){try{return JSON.parse(t).message}catch(e){}};return n||(n=t?s():void 0),new yf(n?{cause:o,message:n}:{cause:o})}(e.status,e.response&&e.response.text&&e.response.text(),e.response?e.response.message:void 0,e)},LE=function(){function e(t,n){var r=this,i=t.id,o=t.securityScanningRequired,a=t.url;if(s(this,e),this.id=i,this.securityScanningRequired=o,this.url=a,this.securityScanningRequired){var u=I.pathEq(["security_scan_result","file_id"],this.id);this.scanResultObservable=n.find(u).map(I.path(["security_scan_result","result"])).map((function(e){return{result:e,file:r}}))}}return u(e,[{key:"getScanResult",value:function(){return this.securityScanningRequired?this.scanResultObservable.toPromise():Promise.reject("Security scanning is not required")}}]),e}(),qE=function(e,t,n,r,i){var o=n.onUploadProgress,s=n.getRequestHeaders,a=new FormData;a.append("content",t),a.append("site_id",sm.siteId);var u=Gy(e?"/engagements/".concat(e,"/files"):"/messaging/files");return I.contains(t.type,i)?t.size>25e6?Du.Observable.throw(new yf({cause:uf.SALEMOVE.FILE_TOO_LARGE,message:"File exceeds the maximum file size"})):function(e){var t=e.method,n=e.url,r=e.payload,i=e.onUploadProgress,o=e.getRequestHeaders;return Bf({method:t,url:n,payload:r,responseType:"json",onUploadProgress:i,getRequestHeaders:o})}({url:u,method:"POST",payload:a,getRequestHeaders:s,onUploadProgress:o}).map((function(e){var t=e.response;return new LE({id:t.file_id,securityScanningRequired:t.security_scanning_required,url:u},r)})).catch((function(e){return Du.Observable.throw(jE(e))})):Du.Observable.throw(new yf({cause:uf.SALEMOVE.FILE_CONTENT_TYPE_NOT_ALLOWED,message:"File content type is not allowed"}))},UE=["visitor_authenticated","visitor_unauthenticated"],DE=function(){function e(t){var n=t.iframe;s(this,e),this.iframe=n}return u(e,[{key:"deframe",value:function(){sc.vent.trigger("visit:restore_url")}}]),e}(),VE=u((function e(t){var n=t.unwrap;s(this,e),this.unwrap=n})),FE=u((function e(){s(this,e),this.responsePromise=Du.Observable.merge(sc.vent.observable(sc.MSG.ALLOW_STREAM).map(I.always("allowed")),sc.vent.observable(sc.MSG.DENY_STREAM).map(I.always("denied"))).take(1).toPromise()})),BE=u((function e(t){var n=t.asynchronous;s(this,e),this.asynchronous=n})),HE=u((function e(t){var n=t.status,r=t.authenticated,i=t.isAsyncTransfer;s(this,e),this.status=n,this.authenticated=r,this.transfer="transferring"===n?new BE({asynchronous:i}):{}}));HE.prototype.STATUSES={ENGAGED:"engaged",TRANSFERRING:"transferring"};var WE=u((function e(t){var n=t.text;s(this,e),this.text=n})),GE=function(){function e(t){var n=this;s(this,e),this.startSalemoveViews=this.startSalemoveViews.bind(this);var r=t.engagementId,i=t.subEngagementId,a=t.startingMedia,u=t.type,c=t.isReestablishing,l=t.chat,f=t.stopChat,p=t.webRtcMode,d=t.enabledMediaLevel,h=t.channelObservable,v=t.operator,b=t.operatorFocusObservable,m=t.communicationWidget,g=t.createEngagementObservable,y=t.mediaStateObservable,_=t.backend,w=t.platform,E=t.startScreenSharing,O=t.stateObservable,S=t.statsClient,T=t.entrypoint,k=t.volatileNotifications,A=t.statusObservable,x=t.comms,N=t.events,M=t.surveyApi,R=t.getRequestHeaders,C=t.siteVisitorNotifications,P=t.createdAt,j=t.cobrowser;this.engagementId=r,this.chat=l,this.mediaState=null,this.isReestablishing=c,this.createdAt=P,this.subEngagementId=i,this.startingMedia=a,this.type=u,this.operator=v,this.cobrowser=j,this.allowFileSending=sm.conf.communications.allow_file_sending,this.allowedFileContentTypes=sm.conf.communications.allowed_file_content_types;var L=E({conf:sm.conf,channelObservable:h,isReestablishing:this.isReestablishing,stats:S}),q=L.screenSharing,U=L.stopScreenSharing;this.screenSharing=q;var D=new Du.Subscription,V=t.engagementEndObservable.map((function(e){return"object"!==o(e)&&null!==e?{}:I.pick(n.ENGAGEMENT_END_EVENT_PAYLOAD_KEYS,e)})).take(1);y=y.publishReplay(1).refCount(),b=b.map((function(e){return"chat"===e?n.FOCUS_TARGETS.CHAT:"cobrowse"===e?n.FOCUS_TARGETS.COBROWSER:($u.error("Unexpected focus target!",e),"")}));var F=sc.vent.observable(sc.MSG.PUBLIC.ENGAGEMENT_MEDIA_UPGRADE_REQUEST).map(I.construct(Pw)),B=sc.vent.observable(sc.MSG.WILL_ASK_MEDIA_PERMISSION).map(I.construct(FE));c||localStorage.removeItem(fE);var H=function(e){return e.pipe(Tn(I.propEq("event",SE)),Nt((function(e){var t=e.payload,n=e.custom_command_id;return I.construct(Jw)({properties:t,id:n})})),Tn((function(e){return I.not(TE(e))})),bi(I.prop("id")),os((function(e){return $u.info("Custom Command: received",{custom_command_id:e.id})})))}(k),W=function(e){var t=Du.Observable.from(pE()),n=e.pipe(Tn(I.propEq("event",SE)),Nt((function(e){var t=e.payload,n=e.custom_command_id;return I.construct(Jw)({properties:t,id:n})})),Tn((function(e){return TE(e)})),bi(I.prop("id")),os((function(e){return $u.info("Virtual CoBrowsing Command: received",{custom_command_id:e.id})})),os(hE));return t.pipe(no(n),os((function(e){return $u.info("Virtual CoBrowsing Command: processing",{custom_command_id:e.id})})))}(k).concatMap(OE({operatorName:v.name,operatorFormattedName:v.formattedName})).subscribe((function(){}),$u.error),G=Zf(),z=O.distinctUntilChanged(I.equals,(function(e){return e.capabilities})).map((function(e){return new WE(e.capabilities)})),J=I.fromPairs([[this.EVENTS.END,V],[this.EVENTS.STATE_CHANGE,O.map((function(e){return{status:e.status,authenticated:I.propOr(!1,"authenticated")(e.visitor),isAsyncTransfer:J_(e)}})).map(I.construct(HE))],[this.EVENTS.CAPABILITIES,z],[this.EVENTS.MEDIA_UPGRADE_OFFER,x.mediaUpgradeOffers],[this.EVENTS.FOCUS,b],[this.EVENTS.MEDIA_STATE_CHANGE,y],[this.EVENTS.MEDIA_PERMISSION_REQUEST,B],[this.EVENTS.WIDGET_MEDIA_UPGRADE_REQUEST,F],[this.EVENTS.CUSTOM_COMMAND,H]]);G.proxyAll(J),this.addEventListener=function(e,t){e===this.EVENTS.COBROWSING_REQUEST?this.cobrowser.addUnbufferedEventListener(rw.prototype.EVENTS.COBROWSING_REQUEST,t):G.addEventListener(e,t)},this.removeEventListener=function(e,t){e===this.EVENTS.COBROWSING_REQUEST?this.cobrowser.removeUnbufferedEventListener(rw.prototype.EVENTS.COBROWSING_REQUEST,t):G.removeEventListener(e,t)},this.recordEvent=function(e){return N.recordEvent(e)};var Y=I.propEq("event_type","engagement.files.security_scan_result"),Q=C.filter(Y).publishReplay(this.SCAN_EVENT_REPLAY_COUNT);D.add(Q.connect()),this.uploadFile=function(e,t){t||(t={});var n=t.onUploadProgress;return qE(this.engagementId,e,{onUploadProgress:n,getRequestHeaders:R},Q,this.allowedFileContentTypes).toPromise()},this.getChatTranscript=function(){return _.chatTranscript().then((function(e){return Promise.resolve(I.map((function(e){var t=e.id,n=e.message,r=e.sender,i=e.attachment,o=e.metadata,s=e.created_at,a=r.type;return"operator"===a?new r_({id:t,content:n,attachment:i,metadata:o,created_at:s,sender:r}):"visitor"===a?new t_({id:t,content:n,status:t_.prototype.STATUSES.DELIVERED,attachment:i,created_at:s}):null}),e))}))},this.observable=function(e){return e===this.EVENTS.COBROWSING_REQUEST?this.cobrowser.observable(rw.prototype.EVENTS.COBROWSING_REQUEST):G.observable(e)};var K=function(){return setTimeout((function(){return G.stop()}))};V.subscribe((function(){}),K,K),this.iframePage=function(e){e||(e={});var t=e.keptElementSelectors;$u.info("Engagement: Iframe page started");var n=new Mw({id:"inner-page",getTargetUrl:function(){return window.location.href},document:window.document,nonRemoved:t||[]});return sm.visitorPageNotifierSubscription&&sm.visitorPageNotifierSubscription.unsubscribe(),sm.trackerSubscription.unsubscribe(),sm.cobraSubscription.unsubscribe(),n.putIntoIframe().then((function(e){var t=e.iframe;return $u.info("Engagement: Iframe page finished"),Promise.resolve(new DE({iframe:t}))}))},this.wrapPage=function(e){e||(e={});var t=e.keptElementSelectors;$u.info("Engagement: Wrap page started");var n=new Cw({document:window.document,nonRemoved:t||[]});return n.wrap(),$u.info("Engagement: Wrap page finished"),Promise.resolve(new VE({unwrap:n.unwrap}))};var X=lw({stateObservable:O}).share();D.add(Lw({volatileNotifications:k,visitorPageAdaption:sm.conf.visitor_app.visitor_page_adaption})),this.getSurvey=function(){return M.fetchSurvey()};var $=G.eventWithoutListenerObservable(this.EVENTS.WIDGET_MEDIA_UPGRADE_REQUEST);D.add($.subscribe((function(){console.warn("No listener set for the Engagement WIDGET_MEDIA_UPGRADE_REQUEST event. See 'WidgetMediaUpgradeRequest' documentation for how to add the listener to enable media upgrades from the sm-engaged-visitor widget."),$u.warn("Listener is not set for WIDGET_MEDIA_UPGRADE_REQUEST")}),$u.error));D.add(y.subscribe((function(e){n.mediaState=e}),$u.error));var Z=g({engagement:this,transfers:X,channelObservable:h,webRtcMode:p,statusObservable:A});m.start(Z),this.communicationWidget=m;var ee=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return m.stop({mediaContinues:Boolean(e.isEngagementRestart)}),x.stop(),f(),U(),Zw({}),$u.info("Triggering ENGAGEMENT_END event"),sc.vent.trigger(sc.MSG.PUBLIC.ENGAGEMENT_END,n),D.unsubscribe()};this.start=function(){var e;n.isReestablishing||(e=["action:reach","stage:establish-engagement"],S.increment("engagement.flow",["entrypoint:".concat(T)].concat(e)));var t,r=sc.vent.trigger.bind(sc.vent,sc.MSG.ENGAGEMENT_TRANSFERRED);t={engagementObservable:Z},sc.reqres.setHandler("get:engagement_observables",I.always(t)),D.add(X.subscribe((function(e){return function(e){n.operator=Xg({id:e.operatorId,name:e.operatorName,formattedName:e.operatorFormattedName,picture:{url:e.operatorPicture},mediaType:e.operatorMedia,webRtcMode:p,enabledMediaType:d})}(e),r(e)}),$u.error)),D.add(V.subscribe(ee,$u.error)),sc.vent.trigger(sc.MSG.PUBLIC.ENGAGEMENT_START,n)},this.upgrade=function(e){if(w===vf)return Promise.reject(new yf({cause:uf.SALEMOVE.NOT_SUPPORTED,message:"Unsupported functionality for OmniBrowse engagement"}));var t=n.operator.state.media,r=n.operator.state.oneWayMedias,i=sm.conf.communications.allow_upgrade_requests,o=n.mediaState.operator.media,s="phone"===o?"audio":o;return $u.info("Initiating media upgrade",{audio_type:e.audio,video_type:e.video,caller:(e?e.caller:void 0)||"client_integrator"}),gw({options:e,availableMediaTypes:t,availableOneWayMediaTypes:r,visitorUpgradesAllowed:i,highestAllowedMediaType:s}).then((function(){return x.requestMediaUpgrade(e)}))},this.end=function(){return ee(),_.end().then(I.always({})).catch((function(e){return 422===(e?e.status:void 0)?($u.warn("Engagement already ended",{reason:e.reason,error_status_code:e.status,engagement_id:n.engagementId}),Promise.reject(new yf({cause:uf.SALEMOVE.CONFLICT}))):I.isNil(e.status)?($u.warn("Engagement end failed. No connection",{reason:e.reason,error_status_code:e.status,engagement_id:n.engagementId}),Promise.reject(new yf({cause:uf.SALEMOVE.NETWORK_TIMEOUT}))):e.status>500&&e.status<=504?($u.warn("Engagement end failed. Service unavailable",{reason:e.reason,error_status_code:e.status,engagement_id:n.engagementId}),Promise.reject(new yf({cause:uf.SALEMOVE.NETWORK_TIMEOUT}))):($u.error("Engagement end failed",{reason:e.reason,error_status_code:e.status,engagement_id:n.engagementId}),Promise.reject(new yf({cause:uf.SALEMOVE.INTERNAL_ERROR})))}))};var te=new Du.Subject;this.notifyOfFocusChange=function(e){return te.next(e)};var ne=te.asObservable().distinctUntilChanged().withLatestFrom(h,(function(e,t){return{target:e,channel:t.channel}})).subscribe((function(e){var t=e.target;return e.channel.emitAll("visitor:focus_changed",t)}),$u.error);D.add(ne),D.add(W)}return u(e,[{key:"start",value:function(){}},{key:"upgrade",value:function(e){return null}},{key:"iframePage",value:function(e){return null}},{key:"wrapPage",value:function(e){}},{key:"getSurvey",value:function(){return null}},{key:"end",value:function(){return null}},{key:"notifyOfFocusChange",value:function(){return null}},{key:"startSalemoveViews",value:function(){$u.error("Private/undocumented Engagement#startSalemoveViews was used"),console.error("Usage of Engagement#startSalemoveViews is not supported")}},{key:"addEventListener",value:function(e,t){}},{key:"removeEventListener",value:function(e,t){}},{key:"recordEvent",value:function(e){return null}},{key:"uploadFile",value:function(e,t){return null}},{key:"getChatTranscript",value:function(){return null}}],[{key:"create",value:function(t){var n=t.engagementId,r=t.subEngagementId,i=t.startingMedia,o=t.mediaState,s=t.type,a=t.isReestablishing,u=t.initialChatHistoryObservable,c=t.operator,l=t.statsClient,f=t.cobra,p=t.channelObservable,d=t.platform,h=t.engagementApi,v=t.connectionStatusObservable,b=t.getRequestHeaders,m=t.internalVisitorStateObservable,g=t.entrypoint,y=t.volatileNotifications,_=t.statusObservable,w=t.pubsub,E=t.wsProxy,O=t.createdAt,S=t.cobrowser,T=m.map(I.compose(I.find(I.propEq("id",n)),I.pathOr([],["engagement","engagements"]))),k=T.filter(I.identity).take(1),A=k.flatMap((function(){return T.filter(I.complement(I.identity)).switchMap((function(){return function(e){var t=e.engagementId,n=e.internalVisitorStateObservable,r=e.logger;return n.take(1).map((function(e){var n=I.pathOr([],["engagement","ended_engagements"],e),i=I.find(I.propEq("id",t),n),o=Boolean(i&&I.contains(i.end_reason,UE));return o&&r.info("Received engagement end signal with authentication end_reason. Initiating engagement restart",{engagement_id:t}),{isEngagementRestart:o}}))}({engagementId:n,internalVisitorStateObservable:m,logger:$u})})).take(1)})),x=sc.vent.observable("engagement:prepare_for_restart").map(I.always({isEngagementRestart:!0})),N=Du.Observable.merge(A,x).take(1),M=p.switchMap((function(e){return e.channel.observable("visitor:state_changed")})),R=k.map(I.prop("transferrable_sites")),C=Fu(),P=R.flatMap((function(e){var t=e.map((function(e){return e.id}));return w.joinSiteVisitorNotifications(C,t)})),j=sm.conf.engagement.api_timeout_milliseconds||cf,L=CE({visitorId:Fu(),engagementId:n,volatileNotifications:y,engagementStateObservable:T,apiTimeoutMilliseconds:j,wsProxy:E,stats:l,channelObservable:p});$u.info("Starting medra communication controller");var q=sc.request("comms:create_controller",{getRequestHeaders:b,visitorAppConf:sm.conf.visitor_app,statsClient:l,volatileNotifications:y,comms:L,pubsub:w,localCapabilities:ME(),onMediaUpgrade:function(e){return h.createMediaUpgrade(e).subscribe($u.log.bind($u,"Media upgrade successfully created"),$u.warn.bind($u,"Failed to create media upgrade"))}}),U=function(e){var t=e.mediaState,n=e.mediaStateChanges,r=t?Ee.of(t):Ee.of(new yw({visitor:{media:"text",audioMuted:!1,videoMuted:!1},operator:{media:"text",audioMuted:!1,videoMuted:!1}}));return n.pipe(no(r),Nt(I.construct(yw)))}({mediaState:o,mediaStateChanges:q.mediaStateChanges()}),D=Du.Observable.merge(u,Yy({engagementId:n,connectionStatusObservable:v})),V=sm.conf.masking_regular_expressions;V||($u.error("Failed to fetch masking_regular_expressions for site",{site_id:sm.siteId,visitor_id:Fu()}),V=[]);var F=B_.create({chatHistoryObservable:D,engagementEndObservable:N,engagementId:n,statsClient:l,getRequestHeaders:b,siteVisitorNotifications:P,maskingRegularExpressions:V}),B=F.chat,H=F.stopChat,W={end:function(){return h.endEngagement({engagementId:n}).toPromise()},chatTranscript:function(){return h.getChatTranscript(n).map(I.filter((function(e){var t=e.sender.type;return I.contains(t,["operator","visitor"])}))).toPromise()}},G=Ug(),z=sm.conf.communications.enabled_media_level,J=function(e){var t=e.engagementId,n=e.wsProxy,r=e.apiTimeoutMilliseconds,i=e.stats,o=Ow({stats:i,protocol:"rest",failureTagProperty:"message",timeout:r,timeoutError:Du.Observable.throw(PE)});return{recordEvent:function(e){return o({resource:"record-event",method:"create"},(function(){return n.request({method:"POST",url:"".concat(sm.conf.api_url,"/engagements/").concat(t,"/events"),payload:e,headers:bf}).catch(Of,{allowedCauses:[uf.SALEMOVE.INVALID_INPUT,uf.SALEMOVE.NETWORK_TIMEOUT]})})).toPromise()}}}({engagementId:n,wsProxy:E,apiTimeoutMilliseconds:j,stats:l}),Y=function(e){var t=e.engagementId,n=e.wsProxy,r=e.apiTimeoutMilliseconds,i=e.stats,o=Ow({stats:i,protocol:"rest",failureTagProperty:"message",timeout:r,timeoutError:Du.Observable.throw(Sw)}),s=function(e){switch(e.status){case 409:return $u.warn("Survey was not accepted because at least some answers were not unique for engagement. This could happen when survey was answered twice for the same engagement.",{engagement_id:t}),Du.Observable.throw(new yf({cause:uf.SALEMOVE.CONFLICT}));default:return Of(e)}},a=function(e){var r=e.surveyId,i=e.answers;return o({resource:"survey-answers-post",method:"create"},(function(){return n.request({method:"POST",url:"".concat(sm.conf.api_url,"/surveys/").concat(r,"/answers"),payload:{engagement_id:t,answers:i},headers:bf}).catch(s)})).toPromise()};return{fetchSurvey:function(){return o({resource:"survey-request",method:"get"},(function(){return n.request({method:"GET",url:"".concat(sm.conf.api_url,"/engagements/").concat(t,"/survey"),payload:null,headers:bf}).catch(Of)})).map((function(e){return new Ew(e,a)})).toPromise()},saveSurveyAnswers:a}}({engagementId:n,wsProxy:E,apiTimeoutMilliseconds:j,stats:l});return i&&(c=function(e,t){var n=e.media,r=e.enabledMediaType,i=e.webRtcMode;if(I.indexOf(n,t.state.medias)>-1)return t;var o=Vg[n];return I.compose(Jg({enabledMediaType:r,webRtcMode:i}),I.set(Bg,o),I.set(Fg,o))(t)}({media:i,enabledMediaType:z,webRtcMode:G},c)),new e({engagementId:n,subEngagementId:r,engagementEndObservable:N,startingMedia:i,type:s,isReestablishing:a,chatHistoryObservable:D,chat:B,stopChat:H,webRtcMode:G,enabledMediaLevel:z,channelObservable:p,operator:c,operatorFocusObservable:M,communicationWidget:q,createEngagementObservable:fw,mediaStateObservable:U,cobra:f,backend:W,platform:d,startScreenSharing:zw.start,stateObservable:T.filter(I.identity).distinctUntilChanged(I.equals),statsClient:l,entrypoint:g,volatileNotifications:y,statusObservable:_,comms:L,events:J,surveyApi:Y,getRequestHeaders:b,siteVisitorNotifications:P,createdAt:O,cobrowser:S})}}]),e}();GE.prototype.SCAN_EVENT_REPLAY_COUNT=100,GE.prototype.EVENTS={END:"end",STATE_CHANGE:"state_change",CAPABILITIES:"capabilities",MEDIA_UPGRADE_OFFER:"media_upgrade_offer",FOCUS:"focus",MEDIA_STATE_CHANGE:"media_state_change",COBROWSING_REQUEST:"cobrowsing_request",MEDIA_PERMISSION_REQUEST:"media_permission_request",WIDGET_MEDIA_UPGRADE_REQUEST:"widget_media_upgrade_request",CUSTOM_COMMAND:"custom_command"},GE.prototype.ENGAGEMENT_END_EVENT_PAYLOAD_KEYS=["isEngagementRestart"],GE.prototype.FOCUS_TARGETS={CHAT:"chat",COBROWSER:"cobrowse"},GE.prototype.MEDIA_TYPES={TEXT:"text",AUDIO:"audio",PHONE:"phone",VIDEO:"video"};var zE=function(e){var t,n,r=e.api,i=e.conf,o=e.operatorsObservable,s=e.media,a=e.options,u=e.statsClient,c=e.cobraObservable,l=e.channelObservable,f=e.cobrowser,p=e.engagementApi,d=e.webRtcMode,h=e.enabledMediaLevel,v=e.connectionStatusObservable,b=e.getRequestHeaders,m=e.internalVisitorStateObservable,g=e.volatileNotifications,y=e.statusObservable,_=e.pubsub,w=e.wsProxy,E=e.dynamicImport,O=new Du.AsyncSubject,S=$y({media:s,mediaOptions:a,mediaValidation:mw,api:r,notifyOfTimeout:sc.vent.trigger.bind(sc.vent,sc.MSG.REACTIVE_ENGAGEMENT_REQUEST_TIMEOUT),operatorsObservable:o,engagementCoreObservable:E("Comms"),cobraObservable:c,channelObservable:l,serverResponseTimeout:cf,communicationLib:i.communications.lib,engagementApi:p,webRtcMode:d,enabledMediaLevel:h,statsClient:u}),T=S.requestObservable,k=S.resultObservable,A=sl(O),x=k.merge(A).take(1).map((function(e){return I.merge(e,{statsClient:u,connectionStatusObservable:v,getRequestHeaders:b,internalVisitorStateObservable:m,volatileNotifications:g,statusObservable:y,pubsub:_,cobrowser:f,wsProxy:w})})).map(GE.create).do(I.invoker(0,"start")).catch(Ef);return{operatorObservable:(t=T,n=A,t.pipe(Nt(I.prop("operator")),no(n),ki(1))).catch(Ef),engagementObservable:x,cancelEngagementRequest:function(){return function(e){var t=e.api,n=e.requestObservable,r=e.resultErrorSubject,i=e.statsClient;return n.catch((function(){return Du.Observable.of({requestNotCreated:!0})})).flatMap((function(e){var n=e.engagementRequestId;return e.requestNotCreated?Du.Observable.of({}):t.cancel({id:n}).do((function(){return r.next(new yf({cause:uf.SALEMOVE.CANCEL}))})).do((function(){return i.increment("engagement.flow",["entrypoint:reactive-request","action:end","stage:requested","expected:true","reason:cancel"])}))}))}({statsClient:u,api:r,requestObservable:T,resultErrorSubject:O}).toPromise()},engagementRequestTimeout:1e3*i.engagement.reactive_call_timeout}},JE=u((function e(t){var n=t.timeout,r=t.engagementPromise,i=t.cancel,o=t.operatorPromise;s(this,e),this.timeout=n,this.engagementPromise=r,this.cancel=i,this.operatorPromise=o})),YE=function(e){l(n,e);var t=m(n);function n(){var e;return s(this,n),(e=t.call(this))._currentSubscription=e_.Subscription.EMPTY,e}return u(n,[{key:"add",value:function(e){if(!this.closed)return"function"==typeof e&&(e=new e_.Subscription(e)),this._currentSubscription&&(this.remove(this._currentSubscription),this._currentSubscription.unsubscribe(),this._currentSubscription=null),y(f(n.prototype),"add",this).call(this,this._currentSubscription=e),this}}]),n}(e_.Subscription),QE=u((function e(t,n){s(this,e),this.code=t,this.validDuration=n})),KE=function(){function e(t){s(this,e);var n=t.incomingEngagementRequestObservable,r=t.setOmnibrowseReestablishHandler,i=t.statsClient,o=t.wsProxy,a=new YE,u=n.filter(I.propEq("platform",vf)).map(I.prop("incomingEngagementRequest"));this.setIncomingEngagementRequestHandler=function(e){return a.add(u.subscribe(e,$u.error))},this.setEngagementReestablishHandler=r,this.getVisitorCode=function(){return Ow({stats:i,protocol:"rest",failureTagProperty:"error",timeout:cf,timeoutError:Du.Observable.throw(new yf({cause:uf.SALEMOVE.NETWORK_TIMEOUT}))})({resource:"omnibrowse",method:"get"},(function(){return o.request({method:"GET",url:"".concat(sm.conf.api_url,"/omnibrowse/sites/").concat(Gu(),"/visitor_code/").concat(Fu()),payload:null,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})})).map((function(e){var t=Date.parse(e.expires_at)-new Date;return new QE(e.code,t)})).catch(I.compose(Du.Observable.throw,I.unless(I.is(yf),I.always(new yf({cause:uf.SALEMOVE.INTERNAL_ERROR}))))).do(null,(function(e){return $u.warn("Fetching visitor code failed",{site_id:sm.siteId,err:e})})).toPromise()}}return u(e,[{key:"setIncomingEngagementRequestHandler",value:function(e){}},{key:"setEngagementReestablishHandler",value:function(e){}},{key:"getVisitorCode",value:function(){return null}}]),e}(),XE=u((function e(t){var n=t.text,r=t.noOperatorsOnlineText,i=t.duration,o=t.priority;s(this,e),this.text=n,this.noOperatorsOnlineText=r,this.duration=i,this.priority=o})),$E=u((function e(t){s(this,e),this.duration=t})),ZE=u((function e(t){var n=t.verticalOffset,r=t.horizontalOffset;s(this,e),this.verticalOffset=n,this.horizontalOffset=r})),eO=u((function e(t){s(this,e),this.text=t})),tO=u((function e(t,n){s(this,e),this.text=t,this.duration=n})),nO=u((function e(t){var n=t.operatorListReady,r=t.isOmniqEnabled,i=t.queueStateReady,o=t.routingObservable;s(this,e);var a=function(e){return r?e.flatMap((function(e){return Du.Observable.combineLatest(o,i).take(1).mapTo(e)})):e.flatMap((function(e){return n.mapTo(e)}))},u=sc.vent.observable("reactive_bar:enable").map(I.always({})),c=sc.vent.observable("reactive_bar:disable").map(I.always({})),l=sc.vent.observable("reactive_bar:set_position").map((function(e){return new ZE(e)})),f=sc.vent.observable("trigger_expand_reactive").map((function(e){return new $E(e.duration)})),p=sc.vent.observable("trigger_media_selection").map((function(e){return new eO(e.text)})),d=sc.vent.observable("trigger_reactive_callout").map((function(e){return new XE({text:e.text,noOperatorsOnlineText:e.noOperatorsOnlineText,duration:e.duration,priority:e.priority})})),h=sc.vent.observable("show_engagement_invitation").map((function(e){return new tO(e.text,e.duration)})),v=I.fromPairs([[this.EVENTS.REACTIVE_ENABLE,u],[this.EVENTS.REACTIVE_DISABLE,c],[this.EVENTS.REACTIVE_SET_POSITION,l],[this.EVENTS.REACTIVE_EXPAND,a(f)],[this.EVENTS.MEDIA_SELECTION_START,a(p)],[this.EVENTS.REACTIVE_CALLOUT_START,a(d)],[this.EVENTS.ENGAGEMENT_INVITATION_SHOW,a(h)]]),b=Zf();b.proxyAll(v);var m=ep();m.proxyAll(v),this.addUnbufferedEventListener=b.addEventListener,this.removeUnbufferedEventListener=b.removeEventListener,this.addBufferedEventListener=m.addEventListener,this.removeBufferedEventListener=m.removeEventListener,this.observable=function(e){return b.observable(e)},this.bufferedObservable=function(e){return m.observable(e)}}));nO.prototype.EVENTS={REACTIVE_ENABLE:"overseer:reactive_enable",REACTIVE_DISABLE:"overseer:reactive_disable",REACTIVE_SET_POSITION:"overseer:reactive_set_position",REACTIVE_EXPAND:"overseer:reactive_expand",MEDIA_SELECTION_START:"overseer:media_selection_start",REACTIVE_CALLOUT_START:"overseer:reactive_callout_start",ENGAGEMENT_INVITATION_SHOW:"overseer:engagement_invitation_show"};var rO,iO=function(){function e(){s(this,e),this.EVENTS={ENGAGEMENT_REQUEST:"omnicall:engagement_request",PHONE_NUMBER_AVAILABLE:"omnicall:phone_number_available"};var t=I.fromPairs([[this.EVENTS.ENGAGEMENT_REQUEST,Du.Observable.never()],[this.EVENTS.PHONE_NUMBER_AVAILABLE,Du.Observable.never()]]),n=Zf();n.proxyAll(t),this.addEventListener=n.addEventListener,this.removeEventListener=n.removeEventListener,this.observable=function(e){return t[e]}}return u(e,[{key:"addEventListener",value:function(e,t){}},{key:"removeEventListener",value:function(e,t){}}]),e}(),oO=u((function e(){s(this,e),this.url=sm.conf.visitor_app.site_logo.url})),sO=function(){function e(){s(this,e),this.visibleOperatorCount=sm.conf.visitor_app.reactive_tab.visible_operator_count,this.backColor=sm.conf.visitor_app.reactive_tab.back_color,this.fontSize=sm.conf.visitor_app.reactive_tab.font_size,this.format=sm.conf.visitor_app.reactive_tab.format,this.frontColor=sm.conf.visitor_app.reactive_tab.front_color,this.iconType=this._iconClassToType(sm.conf.visitor_app.reactive_tab.icon_class),this.placement=sm.conf.visitor_app.reactive_tab.placement,this.size=sm.conf.visitor_app.reactive_tab.size,this.text=sm.conf.visitor_app.reactive_tab.text,this.verticalOffset=sm.conf.visitor_app.reactive_tab.vertical_offset}return u(e,[{key:"_iconClassToType",value:function(e){switch(e){case"ico-voice":return"audio";case"ico-video":return"video";case"ico-text":return"text";default:return $u.error("Unknown icon class of the reactive tab",e),"video"}}}]),e}(),aO=u((function e(){s(this,e),this.apiUrl=sm.conf.api_url,this.alwaysUseDefaultOperatorPicture=sm.conf.visitor_app.always_use_default_operator_picture,this.visitorPageAdaption=sm.conf.visitor_app.visitor_page_adaption,this.engagementMode=function(e){switch(e.visitor_app.visitor_page_adaption){case"div":return"iframeless";case"iframe":return"iframed";case"style":return"nowrap";default:return"iframeless"}}(sm.conf),this.offlineMessagesEnabled=sm.conf.visitor_app.reactive_tab.contact_when_unstaffed,this.reactiveTabEnabled=sm.conf.visitor_app.reactive_tab.enabled,this.widgetMode=sm.conf.visitor_app.widget_mode,this.showReactiveTabWhenOperatorsUnavailable=sm.conf.visitor_app.reactive_tab.show_unavailable,this.theme=sm.conf.visitor_app.theme,this.isCustomTheme=sm.conf.visitor_app.is_custom_theme,this.locale=sm.conf.visitor_app.visitor_app_default_locale,this.reactiveTabVisuals=new sO,this.siteLogo=new oO,this.queuingEnabled=sm.conf.omniq.omniq_enabled,this.panelPosition=sm.conf.visitor_app.reactive_tab.position,this.phoneExtensionEnabled=sm.conf.visitor_app.phone_extension_enabled,this.phoneNumberDefaultCountry=sm.conf.visitor_app.phone_number_default_country,this.hideVisitorInfo=sm.conf.visitor_app.hide_visitor_info_in_visitor_app,this.enableVisitorTranscriptDownload=sm.conf.visitor_app.enable_visitor_transcript_download,this.watchForNewContactOperatorIntegrations=!1!==sm.conf.visitor_app.watch_for_new_contact_operator_integrations,this.engagementInvitationAudio=sm.conf.visitor_app.engagement_invitation_audio})),uO=function(e,t,n,r){e||(e={}),n||(n=[]),r||(r=Du.Scheduler.asap);var i=e,o=i.phone,s=i.email;if(!o&&!s)return Du.Observable.throw({cause:uf.SALEMOVE.INVALID_INPUT,message:"Either phone or email must be specified"});var a=t.createApiRequestObservable,u=t.serverResponseTimeout;return a(I.pick(I.concat(["name","phone","email","message"],n),e)).pipe(Nt((function(){return{}})),Gr((function(e){return Du.Observable.throw(jE(e))})),ps(u,Du.Observable.throw(new yf({cause:uf.SALEMOVE.NETWORK_TIMEOUT,message:"Leave message request timed out"})),r),os(null,I.ifElse(I.propEq("cause",uf.SALEMOVE.TOO_MANY_REQUESTS),$u.warn.bind($u,"Leaving a message failed: too many requests"),$u.info.bind($u,"Leaving a message failed"))),ki(1))},cO=function(e,t){return function(e,t){return Bf({method:"GET",url:e,responseType:"blob",getRequestHeaders:t})}(e,t).map((function(e){return e.response})).catch((function(e){return Du.Observable.throw(jE(e))})).do(null,I.ifElse(I.propEq("cause",uf.SALEMOVE.TOO_MANY_REQUESTS),$u.warn.bind($u,"Requesting asset failed: too many requests"),$u.info.bind($u,"Requesting asset failed"))).take(1)},lO=function(){function e(t){var n=t.id,r=t.api,i=t.operator,o=t.restrictedOperator,a=t.cobraObservable,u=t.channelObservable,c=t.message,l=t.logoUrl,f=t.platform,p=t.timeout,d=t.engagementApi,h=t.statsClient,v=t.cobrowser,b=t.communicationLib,m=t.notifyOfAccept,g=t.notifyOfDecline,y=t.createEngagement,_=t.cobraLoadTimeout,w=t.connectionStatusObservable,E=t.getRequestHeaders,O=t.internalVisitorStateObservable,S=t.volatileNotifications,T=t.statusObservable,k=t.pubsub,A=t.wsProxy;s(this,e),this.message=c,this.timeout=p,this.operator=o,this.logo={url:l};var x=new Du.AsyncSubject,N=x.merge(sl(Du.Observable.merge(r.canceledObservable.map(I.always(new yf({cause:uf.SALEMOVE.CANCEL}))),r.timedOutObservable.map(I.always(new yf({cause:uf.SALEMOVE.TIMEOUT})))))).take(1).flatMap((function(e){return a.map((function(t){return I.merge({cobra:t},e)})).take(1).timeoutWith(_,Du.Observable.throw(new yf({cause:uf.SALEMOVE.INTERNAL_ERROR,message:"Cobra load timeout exceeded"})).do(null,(function(e){return $u.warn("Cobra loading timed out",e)}))).do(null,(function(t){return $u.warn("Loading cobra failed, ending engagement",t),d.endEngagement({engagementId:e.engagementId,reason:"error",subReason:"visitor_cobra_load_failure"}).take(1).subscribe($u.log.bind($u,"Successfully ended engagement after cobra load failure"),$u.warn.bind($u,"Failed to end engagement after cobra load failure"))})).map((function(e){var t=e.engagementId,n=e.subEngagementId,r=e.media,o=e.cobra,s=e.createdAt;return y({operator:i,engagementId:t,subEngagementId:n,startingMedia:r,type:"proactive",isReestablishing:!1,initialChatHistoryObservable:Jy(t),communicationLib:b,statsClient:h,cobra:o,channelObservable:u,platform:f,engagementApi:d,connectionStatusObservable:w,getRequestHeaders:E,internalVisitorStateObservable:O,entrypoint:"proactive-request",volatileNotifications:S,statusObservable:T,pubsub:k,wsProxy:A,createdAt:s,cobrowser:v})})).do((function(e){return e.start()})).catch(Ef)}));this.engagementPromise=N.toPromise(),this.accept=function(){return r.acknowledge({id:n}).do((function(){return m({engagement_request_id:n,operator:i})})).do((function(){return $u.info("Engagement: Proactive request accepted",{operator:i})})).mapTo({}).catch(Ef).toPromise()},this.selectMedia=function(e,t){if(f===vf&&"text"!==e)return Promise.reject(new yf({cause:uf.SALEMOVE.NOT_SUPPORTED,message:"OmniBrowse engagements only support text media."}));var s=o.state.medias,a=wg(o.state.oneWayMedias),u=t||{},c=u.phoneNumber,l=u.phoneExtension,p=u.oneWay;return mw({options:t,availableMediaTypes:s,availableOneWayMediaTypes:a,media:e}).then((function(){return m({engagement_request_id:n,operator:i}),r.accept({id:n,selectedMedia:e,mediaOptions:{phoneNumber:c,phoneExtension:l,oneWay:p}}).do((function(){sm.logger.info("Engagement: Proactive request media selected",arguments[0])})).map((function(t){return I.merge(t,{media:e})})).do(x).mapTo({}).catch(Ef).toPromise()}))},this.decline=function(){return r.decline({id:n}).do((function(){return g({operator:i})})).do((function(){return x.error(new yf({cause:uf.SALEMOVE.DECLINE}))})).do((function(){return sm.logger.info("Engagement, Proactive request declined",arguments[0])})).mapTo({}).catch(Ef).toPromise()}}return u(e,null,[{key:"create",value:function(t){var n=t.api,r=t.id,i=t.operator,o=t.restrictedOperator,s=t.message,a=t.logoUrl,u=t.platform,c=t.timeout,l=t.statsClient,f=t.cobraObservable,p=t.channelObservable,d=t.engagementApi,h=t.connectionStatusObservable,v=t.getRequestHeaders,b=t.internalVisitorStateObservable,m=t.volatileNotifications,g=t.statusObservable,y=t.pubsub,_=t.wsProxy,w=t.cobrowser;return new e({api:n,id:r,statsClient:l,communicationLib:sm.conf.communications.lib,createEngagement:GE.create,cobraObservable:f,operator:i,restrictedOperator:o,platform:u,timeout:c,message:s,logoUrl:a,cobraLoadTimeout:1e4,notifyOfAccept:sc.vent.trigger.bind(sc.vent,sc.MSG.PROACTIVE_ACCEPT),notifyOfDecline:sc.vent.trigger.bind(sc.vent,sc.MSG.PROACTIVE_DECLINE),channelObservable:p,engagementApi:d,connectionStatusObservable:h,getRequestHeaders:v,internalVisitorStateObservable:b,volatileNotifications:m,statusObservable:g,pubsub:y,wsProxy:_,cobrowser:w})}}]),e}(),fO=function(e,t){return t.pipe(Tn((function(t){var n=function(e,t){return I.compose(I.find(I.propEq("id",e)),I.pathOr([],W_))(t)}(e.id,t);return Boolean(n.outcome)})),ki(1),Nt((function(t){var n=K_(t);return n&&n.operator.id===e.operator.id?n:null})),Tn(I.identity))},pO=function(e){var t=e.channelObservable,n=e.internalVisitorStateObservable,r=e.statusObservable,i=e.webRtcMode,o=e.enabledMediaLevel,s=e.statsClient,a=e.cobraObservable,u=e.isEngagedObservable,c=e.engagementApi,l=e.connectionStatusObservable,f=e.getRequestHeaders,p=e.volatileNotifications,d=e.pubsub,h=e.wsProxy,v=e.cobrowser,b=e.dynamicImport;return function(e){var t=e.reestablishRequestObservable,n=e.channelObservable,r=e.statusObservable,i=e.cobraObservable,o=e.isEngagedObservable;return t.pipe(Ko((function(e){var t=r.pipe(Tn(I.equals({}))),o=n.pipe(Tn(I.compose(I.propEq("id",e.operatorId),I.prop("operator"))),ki(1),Ki(e),es(t)),s=i.pipe(Tn(I.pathEq(["operator","id"],e.operatorId)),po("cobraSource"),ki(1));return Du.Observable.combineLatest(o,s,(function(e,t){return I.merge(e,{cobra:t})}))})),Rs(o,(function(e,t){return{engagementReestablishMessage:e,isEngaged:t}})),os((function(e){e.isEngaged?$u.info("Found an ongoing engagement during engagement reestablishing, skipping"):$u.info("Reestablishing ongoing engagement")})),Tn((function(e){return!e.isEngaged})),Nt((function(e){return e.engagementReestablishMessage})))}({reestablishRequestObservable:function(e){var t=e.pipe(Mr(2,1),Nt((function(e){var t=_(e,2),n=t[0],r=t[1],i=X_(n),o=K_(r),s=o&&i,a=o&&n.visitor_id!==r.visitor_id,u=o&&!I.path(["engagement","engagements",0],n)&&I.path(["engagement","engagements",0,"restarted_from_engagement_id"],r);return s||a||u?o:null})),Tn(I.identity));return e.pipe(ki(1),fn((function(t){var n=Du.Observable.of(t).map(K_).filter(I.identity),r=$_(t),i=r?fO(r,e):Du.Observable.empty();return Du.Observable.merge(n,i)})),no(t),Nt((function(e){return{id:e.id,platform:e.platform,subEngagementId:e.sub_engagement_legacy_id,channelUrl:e.channel_url,operatorId:e.operator.id,operatorName:e.operator.name,operatorFormattedName:e.operator.formatted_name,operatorMediaType:e.operator.media_type,operatorPicture:{url:e.operator.picture_url},entrypoint:e.entrypoint,createdAt:e.start_time}})))}(n),channelObservable:t,statusObservable:r,cobraObservable:a,isEngagedObservable:u}).flatMap((function(e){return b("Comms").mapTo(e)})).observeOn(Du.Scheduler.asap).map((function(e){var a=Xg({id:e.operatorId,name:e.operatorName,formattedName:e.operatorFormattedName,picture:e.operatorPicture,mediaType:e.operatorMediaType,webRtcMode:i,enabledMediaType:o}),u=GE.create({engagementId:e.id,subEngagementId:e.subEngagementId,initialChatHistoryObservable:Jy(e.id),operator:a,isReestablishing:!0,mediaState:e.mediaState,platform:e.platform,communicationLib:sm.conf.communications.lib,statsClient:s,cobra:e.cobra,channelObservable:t,engagementApi:c,connectionStatusObservable:l,getRequestHeaders:f,internalVisitorStateObservable:n,entrypoint:e.entrypoint,volatileNotifications:p,statusObservable:r,pubsub:d,wsProxy:h,createdAt:e.createdAt,cobrowser:v});return u.start(),{engagement:u,platform:e.platform}}))},dO=function(e){var t=e.replayedReestablishObservable,n=e.defaultHandler,r=e.storeKey,i=e.platform,o=e.sessionStore,s=e.timeout,a=new YE,u=t.filter(I.propEq("platform",i)).map(I.prop("engagement")),c=function(e){return a.add(u.subscribe(e,$u.error))},l=new Du.Subject;return c((function(e){return o.get(r)?Du.Observable.timer(s).takeUntil(l).subscribe((function(){return o.remove(r),$u.error("Waited for custom reestablish handler to be set, but it wasn't set before timeout."),l.subscribe((function(){return $u.error("Custom reestablish handler was set, but after timeout."),console.error("Salemove#setEngagementReestablishHandler() was called too late!"+" Glia waits ".concat(Math.round(15)," seconds after page load")+" for the custom reestablish handler to be set. Executing the handler anyway, although the default handler has already been called.")})),n(e)})):n(e)})),function(e){c(e),l.next(e),o.set(r,!0)}},hO=u((function e(t){var n=t.engaged,r=t.name,i=t.email;s(this,e),this.engaged=n,this.name=r,this.email=i})),vO=u((function e(t){var n=t.connected;s(this,e),this.connected=n})),bO="__sm_mutation_event_trigger_flip__",mO=new yf({cause:uf.SALEMOVE.INTERNAL_ERROR}),gO=function(e,t){var n=e.wsProxy,r=e.stats,i=e.apiTimeoutMilliseconds;t||(t=Du.Scheduler.asap);var o=function(){return Ow({stats:r,protocol:"rest",failureTagProperty:"message",timeout:i,timeoutError:Du.Observable.throw(mO),scheduler:t})};return{createMediaUpgrade:function(e){var t=e.engagementId,r=e.media;return o()({resource:"media-upgrade",method:"create"},(function(){return n.request({method:"POST",url:"".concat(sm.conf.api_url,"/engagements/").concat(t,"/media_upgrades"),payload:{media:r},headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})}))},getChatTranscript:function(e){return o()({resource:"chat-transcript",method:"fetch"},(function(){return n.request({method:"GET",url:"".concat(sm.conf.api_url,"/engagements/").concat(e,"/chat_transcript"),payload:null,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})}))},endEngagement:function(e){var t=e.engagementId,r=I.compose(I.assoc("action","end"),rf({subReason:"sub_reason"}),I.pick(["reason","subReason"]))(e);return o()({resource:"engagement",method:"end"},(function(){return n.request({method:"PATCH",url:"".concat(sm.conf.api_url,"/engagements/").concat(t),payload:r,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})}))}}},yO=new yf({cause:uf.SALEMOVE.NETWORK_TIMEOUT}),_O={"'operator_id' Operator is not available to be engaged":uf.SALEMOVE.OPERATOR_UNAVAILABLE,"Operator cannot be engaged":uf.SALEMOVE.OPERATOR_UNAVAILABLE,"Visitor cannot be engaged":uf.SALEMOVE.ALREADY_ENGAGED,"'engagement_request_id' already failed":uf.SALEMOVE.CONFLICT,"'engagement_request_id' already accepted":uf.SALEMOVE.CONFLICT,"'engagement_request_id' already acknowledged":uf.SALEMOVE.CONFLICT},wO=(c(rO={},403,uf.SALEMOVE.FORBIDDEN),c(rO,409,uf.SALEMOVE.CONFLICT),rO),EO=["'engagement_request_id' already failed","'engagement_request_id' already accepted","'engagement_request_id' already acknowledged"],OO=function(e,t,n){var r=I.merge(n,{error:e});e&&I.contains(e.message,EO)||e instanceof yf?$u.warn("Failed to ".concat(t," engagement request"),r):$u.error("Failed to ".concat(t," engagement request"),r)},SO=function(e){var t=_O[e&&e.message]||wO[e&&e.status]||uf.SALEMOVE.INTERNAL_ERROR;return new yf({cause:t})},TO=function(e,t){var n=e.wsProxy,r=e.stats,i=e.apiTimeoutMilliseconds,o=e.visitorMetadata,s=e.internalVisitorStateObservable;t||(t=Du.Scheduler.asap);var a=Ow({stats:r,protocol:"rest",failureTagProperty:"cause",timeout:i,timeoutError:Du.Observable.throw(yO),scheduler:t}),u=function(e){var t=e.id,r=e.data;return n.request({method:"PATCH",url:"".concat(sm.conf.api_url,"/engagement_requests/").concat(t),payload:r,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json","x-salemove-tab-id":sm.tabId}})},c=function(e){r.increment("engagement.flow",["entrypoint:proactive-request","stage:requested","action:end"].concat(e))},l=s.pipe(Nt(Y_),Mr(2,1),Tn((function(e){var t=_(e,2),n=t[0],r=t[1];return!n&&Boolean(r)})),Nt((function(e){var t=_(e,2);t[0];return t[1]}))),f=l.pipe(Tn(Q_),os((function(e){var t=e.id;return $u.info("Found new accepted engagement",{engagement_id:t})})),Nt((function(e){return{engagementId:e.id,subEngagementId:e.sub_engagement_legacy_id,operatorId:e.operator.id,operatorMediaType:e.operator.media_type,operatorName:e.operator.name,operatorFormattedName:e.operator.formatted_name,operatorPicture:{url:e.operator.picture_url},media:cw(e.media),entrypoint:e.entrypoint,platform:e.platform,createdAt:e.start_time}}))),p=l.pipe(Tn(I.complement(Q_)),Ki({})),d=function(e){var t=I.propEq("site_id",sm.siteId);return I.compose(I.filter(t),I.pathOr([],["engagement","requests"]))(e)},h=I.compose(I.nth(0),I.filter(I.propEq("outcome",null)),d),v=function(e){return I.compose(I.nth(0),I.filter(I.propEq("id",e)),d)},b=s.pipe(Nt(h),Tn(I.identity)),m=I.curry((function(e,t){return s.pipe(Nt(v(t.id)),Tn(I.identity),Tn((function(t){return I.contains(t.outcome,e)})),ki(1),es(function(e,t){return s.pipe(Nt(v(e.id)),Tn(I.identity),Tn((function(e){return!I.contains(e.outcome,t)})))}(t,I.append(null,e))))})),g=b.pipe(fn(m(["operator_cancel","operator_left"])),Ki({})),y=Du.Observable.merge(p,g),w=b.pipe(fn(m(["timed_out"])),Ki({}));return{create:function(e){var t=e.operatorId,r=e.siteId,i=e.media,s=e.source,u=e.mediaOptions,c={operator_id:t,site_id:r,media:i,source:s||"sdk",visitor_metadata:o,media_options:{phone_number:u.phoneNumber,phone_extension:u.phoneExtension,one_way:u.oneWay}};return $u.info("Engagement: Sending reactive request",c),a({resource:"engagement-request",method:"create"},(function(){return(e=c,n.request({method:"POST",url:"".concat(sm.conf.api_url,"/engagement_requests"),payload:e,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json","x-salemove-tab-id":sm.tabId}})).map((function(e){var t=e.timeout;return{engagementRequestId:e.id,acknowledgeTimeoutSeconds:t}})).catch((function(e){var n={error:e,operator_id:t,site_id:r,media:i,source:s,media_options:u};return e instanceof yf?($u.info("Failed to create engagement request",n),Du.Observable.throw(e)):(403===(e&&e.status)?$u.info("Visitor forbidden to create engagement request",n):422===(e&&e.status)?$u.info("Operator is not available to be engaged",n):409===(e&&e.status)?$u.info("Operator cannot be engaged",n):$u.error("Failed to create engagement request",n),Du.Observable.throw(SO(e)))}));var e}))},cancel:function(e){var t=e.id,n="cancel";return a({resource:"engagement-request",method:n},(function(){return u({id:t,data:{action:n}}).catch((function(e){return OO(e,n,{engagement_request_id:t}),Du.Observable.throw(SO(e))}))}))},acknowledge:function(e){var t=e.id,n="acknowledge";return a({resource:"engagement-request",method:n},(function(){return u({id:t,data:{action:n}}).catch((function(e){return OO(e,n,{engagement_request_id:t}),Du.Observable.throw(SO(e))})).do(null,(function(e){e.cause===uf.SALEMOVE.INTERNAL_ERROR?c(["reason:internal-error"]):e.cause!==uf.SALEMOVE.CONFLICT&&c(["reason:unknown"])}))}))},accept:function(e){var t=e.id,n=e.selectedMedia,r=e.mediaOptions,i="accept";return a({resource:"engagement-request",method:i},(function(){return u({id:t,data:{action:i,media:n,media_options:{phone_number:r.phoneNumber,phone_extension:r.phoneExtension,one_way:r.oneWay},visitor_metadata:o}}).catch((function(e){return OO(e,i,{engagement_request_id:t,media:n,media_options:r}),Du.Observable.throw(SO(e))})).do(null,(function(e){e.cause===uf.SALEMOVE.INTERNAL_ERROR?c(["reason:internal-error"]):e.cause!==uf.SALEMOVE.CONFLICT&&c(["reason:unknown"])})).map(rf({engagement_id:"engagementId",sub_engagement_id:"subEngagementId",created_at:"createdAt"}))}))},decline:function(e){var t=e.id,n="decline";return a({resource:"engagement-request",method:n},(function(){return u({id:t,data:{action:n}}).catch((function(e){return OO(e,n,{engagement_request_id:t}),Du.Observable.throw(SO(e))}))}))},notifyOfReactiveFailure:function(e){var t=e.id;return a({resource:"engagement-request",method:"cancel-due-to-error"},(function(){return u({id:t,data:{action:"cancel",reason:"error"}}).catch((function(e){return Du.Observable.throw(SO(e))})).do(null,$u.warn.bind($u,"Failed to cancel reactive engagement request due to error"))}))},acceptedObservable:f,declinedObservable:b.pipe(fn(m(["rejected"])),Ki({})),canceledObservable:y,timedOutObservable:w}},kO=["name","email","phone","note","customAttributes","customAttributesUpdateMethod"],AO={customAttributes:"custom_attributes",customAttributesUpdateMethod:"custom_attributes_update_method"},xO="last_known_ci:".concat(Gu()),IO=function(e){var t=Fu(),n=JSON.stringify(e);return function(e){for(var t=0,n=0,r=e.length;n<r;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return t}(Math.floor(Date.now()/864e5).toString()+t+n).toString()},NO=new hy,MO=0,RO=function(e,t,n){var r;n||(n=Du.Scheduler.asap);var i=t.createApiRequestObservable,s=t.serverResponseTimeout,a=t.tabId,u=t.visitorMetadata,c=t.status;if(e.customAttributes&&"object"!==o(e.customAttributes))return Du.Observable.throw({cause:uf.SALEMOVE.INVALID_INPUT,message:"Custom attributes must be an object"});if(I.has("customAttributesUpdateMethod",e)&&!I.contains(e.customAttributesUpdateMethod,["merge","replace"]))return Du.Observable.throw({cause:uf.SALEMOVE.INVALID_INPUT,message:"Custom attributes update method must be either merge or replace"});var l=I.compose(rf(AO),I.pick(kO)),f=I.has("externalId",e)?I.compose(I.assocPath(["custom_attributes","external_id"],e.externalId),l)(e):l(e);return f.context={tab_id:a,url:window.location.href,metadata:u,status:c},null!==(r=sm.conf.visitor_api)&&void 0!==r&&r.disable_repeat_updates_optimization||0!==MO||!function(e){try{return NO.getItem(xO)===IO(e)}catch(e){return $u.info("Could not read last saved contact information hash",e),!1}}(I.dissoc("context",f))?(MO+=1,i(f).pipe(os((function(){return function(e){try{NO.setItem(xO,IO(e))}catch(e){$u.info("Could not save last saved contact information hash",e)}}(I.dissoc("context",f))})),Nt((function(){return{}})),Gr((function(e){return Du.Observable.throw(jE(e))})),ps(s,Du.Observable.throw(new yf({cause:uf.SALEMOVE.NETWORK_TIMEOUT,message:"Set visitor information request timed out"})),n),os(null,I.ifElse(I.propEq("cause",uf.SALEMOVE.TOO_MANY_REQUESTS),$u.warn.bind($u,"Setting visitor information failed: too many requests"),$u.info.bind($u,"Setting visitor information failed"))),Gr(Ef))):($u.info("Avoiding first visitor information update as it matches a previous update"),Du.Observable.of({}))},CO={setTimeout:setTimeout,clearTimeout:clearTimeout},PO=function(e,t,n){var r,i,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:CO,s=o.setTimeout,a=o.clearTimeout,u=function(e){return r=e,i&&a(i),i=s((function(){r=void 0}),t),e};return function(){return r?(n(r),Promise.resolve(r)):e().then(u)}},jO=u((function e(t){var n=t.state,r=t.medias,i=t.transitionReason,o=t.ticket,a=t.activeTicket;s(this,e),this.state=n,this.medias=r,this.transitionReason=i,this.ticket=o,this.activeTicket=a}));jO.prototype.QUEUE_STATES={CAN_QUEUE:"can_queue",CANNOT_QUEUE:"cannot_queue",QUEUED:"queued"},jO.prototype.TRANSITION_REASONS={ENGAGED:"engaged",CANCELED:"canceled",UNSTAFFED:"unstaffed",CLOSED:"closed",DISCONNECTED:"disconnected",FAILED:"failed",ALREADY_QUEUED:"already_queued",FORBIDDEN:"forbidden"};var LO=u((function e(t){var n=t.averageDurationInSeconds;s(this,e),this.averageDurationInSeconds=n})),qO=new yf({cause:uf.SALEMOVE.INTERNAL_ERROR}),UO=new yf({cause:uf.SALEMOVE.CANCEL}),DO=function(e,t){return e.increment("engagement.flow",["entrypoint:queue-request"].concat(t))},VO=function(e){var t=e.wsProxy,n=e.statsClient,r=e.apiTimeoutMilliseconds,i=e.ticket_id;return function(e,t){return Ow({stats:e,protocol:"rest",failureTagProperty:"error",timeout:t,timeoutError:Du.Observable.throw(qO)})}(n,r)({resource:"queue_tickets",method:"delete"},(function(){return t.request({method:"DELETE",url:"".concat(sm.conf.api_url,"/queue_tickets/").concat(i),payload:{},headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})})).mapTo({}).do((function(){return function(e){return DO(e,["stage:requested","action:end","expected:true","reason:cancel"])}(n)})).catch(Ef)},FO=function(e){var t=e.engagementApi,n=e.engagementRequestApi,r=e.cobraObservable,i=e.fetchEngagementDependencies,o=e.channelObservable,s=e.communicationLib,a=e.statsClient,u=e.webRtcMode,c=e.enabledMediaLevel,l=e.connectionStatusObservable,f=e.getRequestHeaders,p=e.internalVisitorStateObservable,d=e.volatileNotifications,h=e.pubsub,v=e.statusObservable,b=e.wsProxy,m=e.cobrowser,g=Du.Observable.combineLatest(r,i(),(function(e){return{cobra:e}})).publishReplay(1),y=g.connect();return n.acceptedObservable.take(1).flatMap((function(e){var n=e.engagementId,r=e.subEngagementId,i=e.operatorId,y=e.media,_=e.operatorName,w=e.operatorFormattedName,E=e.operatorPicture,O=e.operatorMediaType,S=e.entrypoint,T=e.createdAt;return g.take(1).map((function(e){var g=e.cobra,k=Xg({id:i,name:_,formattedName:w,picture:E,mediaType:O,webRtcMode:u,enabledMediaType:c});return{engagementId:n,subEngagementId:r,startingMedia:y,type:"reactive",isReestablishing:!1,initialChatHistoryObservable:Jy(n),operator:k,cobra:g,channelObservable:o,communicationLib:s,engagementApi:t,getRequestHeaders:f,internalVisitorStateObservable:p,entrypoint:S,volatileNotifications:d,pubsub:h,statusObservable:v,wsProxy:b,createdAt:T,statsClient:a,connectionStatusObservable:l,cobrowser:m}})).map(GE.create).do(null,(function(){return function(e){return DO(e,["stage:requested","action:end","reason:script-load-error"])}(a)})).do(null,(function(){return t.endEngagement({engagementId:n,reason:"error",subReason:"setup_failed"})}))})).finally((function(){return y.unsubscribe()}))},BO=function(){function e(t){s(this,e);var n=t.ticket_id,r=t.apiTimeoutMilliseconds,i=t.statsClient,o=t.wsProxy,a=t.stopObservable,u=new Du.Subject,c=Du.Observable.merge(u,a);$u.info("Queue Ticket created, waiting for engagement",{queue_ticket_id:n});var l=FO(t).takeUntil(c).do((function(e){return e.start()})).catch(Ef).publishReplay(1);l.connect(),this.engagementPromise=l.merge(c.flatMapTo(Du.Observable.throw(UO))).take(1).toPromise(),this.cancel=function(){return u.next(),l.last(null,null,null).flatMap((function(e){return e?Du.Observable.fromPromise(e.end()):VO({wsProxy:o,statsClient:i,apiTimeoutMilliseconds:r,ticket_id:n})})).toPromise()}}return u(e,null,[{key:"create",value:function(t,n){var r=new Du.Subject;return{ticket:I.compose(I.construct(e),I.assoc("stopObservable",r.asObservable()))(I.merge(t,{ticket_id:I.path(["activeTicket","id"],n)})),subscription:new Du.Subscription((function(){return r.next(),r.unsubscribe()}))}}}]),e}(),HO="requesting",WO="created",GO={open:1,opened:1,full:2,unstaffed:3,closed:4},zO=I.compose(I.reduce(I.minBy((function(e){return GO[e]})),"closed"),I.map(I.path(["state","status"]))),JO=I.compose(I.uniq,I.chain(I.path(["state","medias"]))),YO=function(e){var t=I.filter(I.pathEq(["state","status"],"open"),e),n=JO(t);return{state:zO(e)||"closed",medias:n}},QO=function(e){return I.pick(Object.getOwnPropertyNames(e),e)},KO=["enqueued","request_sent"],XO=I.propEq("site_id",sm.siteId),$O=I.compose(I.filter(XO),I.pathOr([],["omniq","queue_tickets"])),ZO=I.compose(I.nth(0),I.filter((function(e){return-1!==KO.indexOf(e.state)})),$O),eS=I.curry((function(e,t){return I.compose(I.nth(0),I.filter(I.propEq("id",e)),$O)(t)})),tS=function(e){var t=e.queueState,n=e.queued,r=e.enqueuedInCurrentTab;return n||!(I.isNil(t)||I.isNil(n)||I.isNil(r))},nS=function(e,t){return I.intersection(function(e){var t=["text","phone"];return e&&(t=t.concat(["messaging"])),Ug()===qg&&(t=t.concat(["audio","video"])),t}(t),e)},rS=function(e){var t=e.queueState,n=e.queued,r=e.visitorLeftReason,i=e.enqueuedInCurrentTab,o=e.isEngaged,s=e.activeTicket,a=e.isVisitorAuthenticatedExternally,u=e.isAsyncTransfer;if(n)return new jO(i?{state:jO.prototype.QUEUE_STATES.QUEUED,activeTicket:s}:{state:jO.prototype.QUEUE_STATES.CANNOT_QUEUE,transitionReason:jO.prototype.TRANSITION_REASONS.ALREADY_QUEUED});var c=function(e,t){if(t)return jO.prototype.TRANSITION_REASONS.ENGAGED;if(e)switch(e){case"finished":return jO.prototype.TRANSITION_REASONS.ENGAGED;case"canceled":return jO.prototype.TRANSITION_REASONS.CANCELED;case"unstaffed":return jO.prototype.TRANSITION_REASONS.UNSTAFFED;case"closed":return jO.prototype.TRANSITION_REASONS.CLOSED;case"disconnected":return jO.prototype.TRANSITION_REASONS.DISCONNECTED;case"failure":return jO.prototype.TRANSITION_REASONS.FAILED;case"forbidden":return jO.prototype.TRANSITION_REASONS.FORBIDDEN;case"visitor_conflict":return jO.prototype.TRANSITION_REASONS.FAILED;default:return void $u.error("Unknown visitor left reason",{reason:e})}}(r,o);if(c===jO.prototype.TRANSITION_REASONS.ENGAGED||"opened"!==t.state&&"open"!==t.state)return new jO({state:jO.prototype.QUEUE_STATES.CANNOT_QUEUE,transitionReason:c});var l=nS(u?t.medias.concat(["messaging"]):t.medias,a);return 0===l.length?new jO({state:jO.prototype.QUEUE_STATES.CANNOT_QUEUE,transitionReason:c}):new jO({state:jO.prototype.QUEUE_STATES.CAN_QUEUE,medias:l,transitionReason:c})},iS=I.both(I.propEq("state",jO.prototype.QUEUE_STATES.CANNOT_QUEUE),I.propEq("transitionReason",jO.prototype.TRANSITION_REASONS.ENGAGED)),oS=function(e){var t=e.routingObservable,n=e.internalVisitorStateObservable,r=e.visitorAuthenticatedExternallyObservable,i=e.queuesStateUpdatesObservable,o=e.createQueueTicketStateObservable,s=e.queueTicketBindings,a=e.scheduler;if(a||(a=Du.Scheduler.asap),I.path(["conf","omniq","omniq_enabled"],sm)){var u=new Du.ReplaySubject(1);o.subscribe((function(e){return u.next(!I.contains(e,[HO,WO]))}));var c=function(e,t){return e.pipe(vo((function(e){return e.pipe(Yr(t,(function(e,t){return t})),Tn((function(e){return e})),vo((function(t){return e.bufferWhen((function(){return t.take(1)}))})))})),fn((function(e){return Du.Observable.from(e)})))}(function(e){var t=e.routingObservable,n=e.queuesStateUpdatesObservable;return t.pipe(Ko((function(e){var t=e.queue_ids;return I.not(t)?Pc.of([]):n.subscribeToListAsObservable({queueIds:t})})),Nt(YO),Nt(I.objOf("queueState")),yi(I.equals))}({routingObservable:t,queuesStateUpdatesObservable:i}),u),l=Du.Observable.combineLatest(n,r).scan((function(e,t){var n,r,i,o=_(t,2),s=o[0],a=o[1],u=e&&e.activeTicket&&e.activeTicket.id,c=ZO(s),l=Y_(s,{includeAsyncTransfer:!0}),f=Boolean(l)&&!J_(l);return c?{queued:!0,enqueuedInCurrentTab:(r=c,i=I.lensPath(["visitor","browser_tab_id"]),I.compose(I.equals(sm.tabId),I.view(i))(r)),activeTicket:{id:c.id},visitorLeftReason:null,isEngaged:f,isAsyncTransfer:J_(l),isVisitorAuthenticatedExternally:a}:u&&(n=eS(u,s))?{queued:!1,enqueuedInCurrentTab:!1,activeTicket:null,visitorLeftReason:n.state,isEngaged:f,isAsyncTransfer:J_(l),isVisitorAuthenticatedExternally:a}:{queued:!1,enqueuedInCurrentTab:!1,activeTicket:null,visitorLeftReason:null,isEngaged:f,isAsyncTransfer:J_(l),isVisitorAuthenticatedExternally:a}}),{}).do((function(e){e.queued||u.next(!0)})).distinctUntilChanged(I.equals);return{aggregateQueueStateObservable:Du.Observable.merge(c,l).scan(I.merge,{}).filter(tS).do((function(e){sm.conf.visitor_api.enable_staffing_logs&&$u.info("[staffing-logs] Recording raw aggregate queue state",e)})).map(rS).distinctUntilChanged(I.equals,QO).scan(function(e){return function(t,n){var r;if(n.state===jO.prototype.QUEUE_STATES.QUEUED){var i;t.subscription.unsubscribe();var o=BO.create(e,n);return i=o.ticket,r=o.subscription,n.ticket=i,{queueState:n,subscription:r}}return iS(n)?($u.info("Discarding queue ticket subscription as Visitor got engaged"),{queueState:n,subscription:Du.Subscription.EMPTY}):(t.subscription!==Du.Subscription.EMPTY&&$u.info("Dispose queue ticket subscription as Visitor is no longer queued"),t.subscription.unsubscribe(),{queueState:n,subscription:Du.Subscription.EMPTY})}}(s),{subscription:Du.Subscription.EMPTY}).map(I.prop("queueState")).publishReplay(1,Number.POSITIVE_INFINITY,a).refCount()}}return{aggregateQueueStateObservable:Du.Observable.empty()}},sS=function(e){return e&&e.cause===uf.SALEMOVE.FORBIDDEN||e&&e.cause===uf.SALEMOVE.INVALID_INPUT?["reason:invalid-input"]:["reason:unknown"]},aS=[],uS=function(e){l(n,e);var t=m(n);function n(e){var r;return s(this,n),e||(e={}),(r=t.apply(this,arguments)).ticket=e.ticket,r}return u(n)}(yf),cS=new yf({cause:uf.SALEMOVE.NETWORK_TIMEOUT}),lS=function(e){return!function(e){return 0===e}(e.status)?!function(e){return 403===e}(e.status)?"Service Unavailable"===e.errorThrown&&(e=new yf({cause:uf.SALEMOVE.INTERNAL_ERROR})):e=new yf({cause:uf.SALEMOVE.FORBIDDEN}):e=new yf({cause:uf.SALEMOVE.NETWORK_TIMEOUT}),Du.Observable.throw(e)},fS=function(e,t){return Ow({stats:e,protocol:"rest",failureTagProperty:"error",timeout:t,timeoutError:Du.Observable.throw(cS)})},pS=function(e,t){return e.omniq.omniq_enabled?t():Promise.reject(new yf({cause:uf.SALEMOVE.DISABLED}))},dS=function(e){var t=e.conf,n=e.statsClient,r=e.apiTimeoutMilliseconds;return function(){return pS(t,(function(){return fS(n,r)({resource:"queue_wait_duration",method:"get"},(function(){return Bf({url:Gy("/engagements/queue/wait_duration"),responseType:"json"})})).map(I.compose(I.construct(LO),rf({average_duration_in_seconds:"averageDurationInSeconds"}),I.map(Math.floor),I.prop("response"))).catch((function(e){return Du.Observable.throw(jE(e))})).catch(Ef).toPromise()}))}},hS=I.compose((function(e){var t=e.id,n=e.name,r=e.status,i=e.availableProperties;return new af({id:t,name:n,status:r,medias:i.media})}),I.evolve({status:sf}),I.pick(["id","name","status","availableProperties"])),vS=function(e){var t=e.conf,n=e.wsProxy,r=e.statsClient,i=e.apiTimeoutMilliseconds,o=e.apiMaxRetries,s=e.apiRetryIntervalMilliseconds;return function(){var e=function(e){return I.not(I.contains(e.status,I.range(400,499)))};return pS(t,(function(){var t=Du.Observable.defer((function(){return fS(r,i)({resource:"queues",method:"get"},(function(){return n.request({method:"GET",url:"".concat(sm.conf.api_url,"/queues?site_ids[]=").concat(sm.siteId),payload:null,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})}))}));return ul(t,{maxRetries:o,calculateDelay:M(s),shouldRetry:e}).map(I.prop("queues")).map(I.map(rf({available_properties:"availableProperties"}))).map(I.map(hS)).catch(lS).catch(Ef).toPromise()}))}},bS=function(e){var t=e.wsProxy,n=e.pubsub,r=e.routingObservable,i=e.engagementApi,o=e.engagementRequestApi,s=e.operatorsObservable,a=e.cobraObservable,u=e.channelObservable,c=e.communicationLib,l=e.statsClient,f=e.fetchEngagementDependencies,p=e.apiTimeoutMilliseconds,d=e.apiRetryIntervalMilliseconds,h=e.apiMaxRetries,v=e.connectionStatusObservable,b=e.webRtcMode,m=e.enabledMediaLevel,g=e.visitorMetadata,y=e.conf,w=e.getRequestHeaders,E=e.internalVisitorStateObservable,O=e.visitorAuthenticatedExternallyObservable,S=e.volatileNotifications,T=e.statusObservable,k=e.queuesStateUpdatesObservable,A=e.cobrowser,x=new Du.Subscription;x.add(r.subscribe((function(e){aS=e.queue_ids})));var N=function(e){return l.increment("engagement.flow",["entrypoint:queue-request"].concat(e))},M=new Du.Subject,R=oS({routingObservable:r,internalVisitorStateObservable:E,visitorAuthenticatedExternallyObservable:O,queuesStateUpdatesObservable:k,createQueueTicketStateObservable:M,queueTicketBindings:{apiTimeoutMilliseconds:p,statsClient:l,wsProxy:t,engagementApi:i,engagementRequestApi:o,cobraObservable:a,fetchEngagementDependencies:f,operatorsObservable:s,channelObservable:u,communicationLib:c,webRtcMode:b,enabledMediaLevel:m,connectionStatusObservable:v,getRequestHeaders:w,internalVisitorStateObservable:E,volatileNotifications:S,pubsub:n,statusObservable:T,cobrowser:A}}).aggregateQueueStateObservable,C=function(e,t){return R.take(1).flatMap((function(n){var r=n.state,i=n.medias;return r===jO.prototype.QUEUE_STATES.CAN_QUEUE?function(e){var t=e.media,n=e.options,r=e.availableMediaTypes;return mw({media:t,options:n,availableMediaTypes:r,availableOneWayMediaTypes:wg(r)})}({media:e,options:t,availableMediaTypes:i}):Du.Observable.throw(new yf({cause:uf.SALEMOVE.FORBIDDEN,message:"Queue state must be: ".concat(jO.prototype.QUEUE_STATES.CAN_QUEUE)}))}))},P=function(){return E.take(1).flatMap((function(e){return Boolean(Y_(e))?Du.Observable.throw(new yf({cause:uf.SALEMOVE.FORBIDDEN,message:"Visitor is already engaged"})):Du.Observable.of({})}))},j=function(e){return-1!==["Queue is closed","Queue is full"].indexOf(e.details)?Du.Observable.throw(new yf({cause:uf.SALEMOVE.INVALID_INPUT,message:e.message})):409===e.status?R.take(1).flatMap((function(e){return function(e){return Du.Observable.throw(new uS({cause:uf.SALEMOVE.ALREADY_QUEUED,message:"Visitor is already queued",ticket:e}))}(e.ticket)})):403===e.status?Du.Observable.throw(new yf({cause:uf.SALEMOVE.FORBIDDEN})):"Validation error"===e.error?Du.Observable.throw(new yf({cause:uf.SALEMOVE.INVALID_INPUT,message:e.error})):Ef(e)};return{subscription:x,queueForEngagement:function(e,n){return n||(n={}),N(["action:begin"]),pS(y,(function(){var r=_(n.queueId?[{media:e,options:n},P]:[{media:e,options:n,queueIds:aS},C],2),i=r[0],o=r[1],s=function(e){var t=e.wsProxy,n=e.statsClient,r=e.apiTimeoutMilliseconds,i=e.errorHandling,o=e.visitorMetadata;return function(e){var s=e.media,a=e.options,u=e.queueIds;return fS(n,r)({resource:"queue_tickets",method:"create"},(function(){var e={};a.phoneNumber&&(e.phone_number=a.phoneNumber),a.phoneExtension&&(e.phone_extension=a.phoneExtension),a.oneWay&&(e.one_way=a.oneWay);var n=a.source||"sdk",r={media:s,visitor_id:Fu(),media_options:e,source:n,visitor_metadata:o,pause_async:!!I.isNil(a.pauseAsync)||a.pauseAsync};a.queueId?r=I.merge(r,{queue_id:a.queueId}):u&&(r=I.merge(r,{queue_ids:u}));var c={method:"POST",url:"".concat(sm.conf.api_url,"/queue_tickets"),payload:I.merge(r,{site_id:sm.siteId}),headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json","x-salemove-tab-id":sm.tabId}};return t.request(c).catch(i||Ef).do(null,(function(e){return $u.warn("Failed to create a queue ticket",{error:e,payload:I.pick(["media","source","queue_id","queue_ids"],r)})}))}))}}({wsProxy:t,statsClient:l,apiTimeoutMilliseconds:p,visitorMetadata:g,errorHandling:j})(i);return o(e,n).do((function(){return M.next(HO)})).do((function(){return N(["action:reach","stage:create-request"])}),(function(e){return N(["action:end","stage:pre-request"].concat(sS(e)))})).flatMapTo(s).mapTo({}).do((function(){return N(["action:reach","stage:requested"])}),(function(e){return N(["action:end","stage:create-request"].concat(sS(e)))})).do((function(){return M.next(WO)}),(function(){return M.next("failed-to-create")})).toPromise()}))},fetchWaitDuration:dS({conf:y,statsClient:l,apiTimeoutMilliseconds:p}),aggregateQueueStateObservable:R,getQueues:PO(vS({conf:y,wsProxy:t,statsClient:l,apiTimeoutMilliseconds:p,apiMaxRetries:h,apiRetryIntervalMilliseconds:d}),6e4,(function(e){return $u.info("Returning cached response for queues",{cached_queues_length:null==e?void 0:e.length})}))}},mS=function(e,t,n){return function(){if("function"==typeof n&&n(arguments),e&&"function"==typeof e[t])return e[t].apply(e,arguments);throw new yf({cause:uf.SALEMOVE.NOT_SUPPORTED})}},gS=function(e){if(!I.contains(e[0],mf))throw new yf({cause:uf.SALEMOVE.INVALID_INPUT,message:"Make sure function argument is one of ISO 3166-1 alpha-2 country codes"})},yS=function(){function e(t){s(this,e),this.triggerQueueMediaSelection=mS(t,"triggerQueueMediaSelection"),this.setChatMessageRenderer=mS(t,"setChatMessageRenderer"),this.setPhoneNumberDefaultCountry=mS(t,"setPhoneNumberDefaultCountry",gS),this.showVisitorCode=mS(t,"showVisitorCode")}return u(e,[{key:"triggerQueueMediaSelection",value:function(e){}},{key:"setChatMessageRenderer",value:function(e){}},{key:"setPhoneNumberDefaultCountry",value:function(e){}},{key:"showVisitorCode",value:function(){}}]),e}(),_S=u((function e(t){var n=t.id,r=t.siteId,i=t.visitorId,o=t.url,a=t.authenticationApi;s(this,e),this.id=n,this.siteId=r,this.visitorId=i,this.url=o,this.decline=function(e){return a.deleteAuthenticationRequest({id:this.id,siteId:this.siteId,visitorId:this.visitorId,reason:e})}})),wS=new yf({cause:uf.SALEMOVE.NETWORK_TIMEOUT}),ES=function(e){var t=e.wsProxy,n=e.apiTimeoutMilliseconds,r=e.stats,i=Ow({stats:r,protocol:"rest",failureTagProperty:"message",timeout:n,timeoutError:Du.Observable.throw(wS)});return{createAuthenticationRequest:function(e){var n=(e=tf(e)).webhooks||[];return i({resource:"authentication-request",method:"create"},(function(){return t.request({method:"POST",url:"".concat(sm.conf.api_url,"/visitor_authentication_requests"),payload:{authentication_provider_id:e.authenticationProviderId,webhooks:n,visitor_id:Fu(),site_id:sm.siteId},headers:bf}).catch((function(t){return function(e,t){var n=404===e.status?new yf({cause:uf.SALEMOVE.INVALID_INPUT,message:"The authentication provider with ID ".concat(t.authenticationProviderId," was not found.")}):wf(e);return Du.Observable.throw(n)}(t,e)}))})).toPromise()},deleteAuthenticationRequest:function(e){var n=e.id,r=e.siteId,o=e.visitorId,s=e.reason;return i({resource:"authentication-request",method:"delete"},(function(){return t.request({method:"DELETE",url:"".concat(sm.conf.api_url,"/visitor_authentication_requests/").concat(n),payload:{site_id:r,visitor_id:o,fail_reason:s},headers:bf}).catch(Of,{allowedCauses:[uf.SALEMOVE.INVALID_INPUT,uf.SALEMOVE.NETWORK_TIMEOUT]})})).toPromise()}}},OS=!1,SS=function(e){var t=e.volatileChannelObservable,n=e.joinChannel,r=e.renewTokenAndReconnectWaitForTeardown;return function(e,t){return t.pipe(Ko((function(t){return t.observable("message").pipe(Tn((function(e){return"engagement.visitor_consolidation.requested"===e.event_type})),Ko((function(n){var r=n.site_id,o=n.visitor_id,s=n.token_event_id;return e("site_visitor:".concat(o),{topics:["site_visitor:".concat(o,":").concat(r)]}).pipe(Gr((function(e){return e&&"unauthorized"===e.error?dc.Observable.empty():dc.Observable.throw(e)})),fn((function(e){return(0,e.observable)("message",{leaveChannelOnDispose:!0})})),Tn((function(e){return"engagement.visitor_consolidation"===e.event_type&&e.event_id===s})),ki(1),Nt((function(e){return i(i({},e),{},{volatileChannel:t})})))})))})))}(n,t).subscribe((function(e){var t=e.secret,n=e.assumed_visitor_id,i=e.volatileChannel;$u.info("Consolidating visitor",{assumed_visitor_id:n}),i.leave(),r({consolidationSecret:t}).delay(0).subscribe((function(){return Wu(n)}),$u.error.bind($u,"Error from renewing token and reconnecting in visitor consolidation"))}),$u.error.bind($u,"Error from visitor consolidation subscription"))},TS=I.prop("id"),kS=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};s(this,e),this._elements=[],this._ids=new Set,this._changeSubject=new Du.Subject,this._insertToBeginning=!0===t.insertToBeginning,this.observable=this._changeSubject.asObservable()}return u(e,[{key:"change",value:function(e,t){return this._elements=this._elements.map((function(n){return n.id===e?t:n})),this._changeSubject.next(this._elements),this}},{key:"add",value:function(e){return this._ids.has(e.id)?this.change(e.id,e):(this._ids.add(e.id),this._insertToBeginning?this._elements=[e].concat(this._elements):this._elements=this._elements.concat([e])),this._changeSubject.next(this._elements),this}},{key:"replace",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=n.retainMissingElements;if(e.forEach((function(e){return t._ids.add(e.id)})),r){var i=I.indexBy(TS,e),o=this._elements.filter((function(e){return!i[e.id]}));this._insertToBeginning?this._elements=o.concat(e):this._elements=e.concat(o)}else this._elements=e;return this._changeSubject.next(this._elements),this}},{key:"values",value:function(){return this._elements}},{key:"valuesUntil",value:function(e){return I.takeWhile((function(t){return!I.propEq("id",e,t)}),this._elements)}}]),e}(),AS=I.pathOr(0,["engagement","unread_message_count"]),xS={MESSAGES:"MESSAGES",UNREAD_MESSAGE_COUNT:"UNREAD_MESSAGE_COUNT"},IS=function(){return M(I_.initialDelay,I_.maxDelay,I_.factor)},NS={latestQueueIds:[],unreadMessageCount:0,markAsReadCount:0,lastSeenMessageDuringMarkRead:{id:void 0}};function MS(e){var t,n=e.pubsub,r=e.routingObservable,o=e.getRequestHeaders,s=e.internalVisitorStateObservable,a=new Du.Subscription,u=Zf(),c=s.map(AS).distinctUntilChanged().publishReplay(1);a.add(c.connect());var l=s.map((function(e){return Y_(e,{includeAsyncTransfer:!0})}));a.add(l.subscribe((function(e){t=e})));var f=NS;a.add(r.subscribe((function(e){var t=e.queue_ids;f=i(i({},f),{},{latestQueueIds:t})}))),a.add(c.subscribe((function(e){f=i(i({},f),{},{unreadMessageCount:e})})));var p,d=new kS({insertToBeginning:!0}),h=I.pipe(I.prop("message"),rf({content:"message",timestamp:"created_at"}),f_),v=I.propEq("event_type","queued_message.created"),b=Fu(),m=I.pathEq(["message","sender","type"],"visitor"),g=Du.Observable.create((function(e){var r=n.joinSiteVisitorNotifications(b,[sm.siteId]).pipe(I.filter((function(e){return v(e)||t&&P_(t.id)(e)})),I.reject(m),I.map(h)),i=d.observable.subscribe(e);return i.add(r.subscribe(d.add.bind(d))),i})).throttleTime(50,yt,{leading:!0,trailing:!0}).distinctUntilChanged(I.equals).share(),y=I.propEq("event_type","engagement.files.security_scan_result");u.proxyAll(I.fromPairs([[xS.MESSAGES,g],[xS.UNREAD_MESSAGE_COUNT,c]]));var _=u.addEventListener,w=u.removeEventListener;return{EVENTS:xS,addEventListener:_,uploadFile:function(e,t){var r=t.onUploadProgress,i=Fu();return qE(null,e,{onUploadProgress:r,getRequestHeaders:o},function(e){var t=e.visitorId;return p||((p=n.joinSiteVisitorNotifications(t,[sm.siteId]).filter(y).publishReplay(100)).connect(),p)}({visitorId:i}),sm.conf.communications.allowed_file_content_types).toPromise()},removeEventListener:w,fetchMessages:function(){return new Promise((function(e,t){!function(e){var t=e.getRequestHeaders,n=e.onSuccess,r=e.onError;Hf({url:"".concat(sm.conf.api_url,"/messaging/chat_transcript"),method:"GET",getRequestHeaders:t,responseType:"json",calculateAttemptDelay:IS(),onSuccess:function(e){return n(e.response)},shouldRetry:function(e){return e>=500},onError:r})}({getRequestHeaders:o,onSuccess:function(t){var n=p_(t).filter(I.identity);d.replace(n,{retainMissingElements:!0}),e(d.values())},onError:function(e){return t(jE(e))}})}))},send:function(e){var n=e.message,r=e.attachment,s=function(e){var t=e.message,n=e.attachment;return new t_({id:Il(),content:t,attachment:n,status:t_.prototype.STATUSES.SENDING})}({message:n,attachment:r});return d.add(s),new Promise((function(e,a){!function(e){var t=e.id,n=e.ongoingEngagement,r=e.message,i=e.attachment,o=e.queueIds,s=e.getRequestHeaders,a=e.onSuccess,u=e.onError,c=n?"/engagements/".concat(n.id,"/chat_messages/").concat(t):"/messaging/chat_messages/".concat(t);Hf({url:sm.conf.api_url+c,method:"PUT",getRequestHeaders:s,contentType:"application/json",responseType:"json",payload:JSON.stringify({source:"tab",content:r,attachment:i,queue_ids:o}),calculateAttemptDelay:IS(),onSuccess:a,shouldRetry:function(e){return e>=500},onError:u})}({id:s.id,ongoingEngagement:t,message:n,attachment:r,queueIds:f.latestQueueIds,getRequestHeaders:o,onSuccess:function(){var t=function(e){return i(i({},e),{},{status:t_.prototype.STATUSES.DELIVERED})}(s);d.change(s.id,t),e(t)},onError:function(e){var t=function(e){return i(i({},e),{},{status:t_.prototype.STATUSES.FAILED})}(s);$u.warn("Failed to send message using message center",{error:e.response||{status:e.status}}),d.change(s.id,t),a(t)}})}))},markMessagesAsRead:function e(){var t=f,n=t.markAsReadCount,r=t.lastSeenMessageDuringMarkRead;f=i(i({},f),{},{markAsReadCount:n+1});var s=d.values()[0];if(s){if(0===n)return 0===f.unreadMessageCount?Promise.resolve():e();var a=d.valuesUntil(r.id);return I.all(n_,a)?Promise.resolve():(f=i(i({},f),{},{lastSeenMessageDuringMarkRead:s}),new Promise((function(e,t){Hf({url:"".concat(sm.conf.api_url,"/messaging/mark_chat_messages_read"),method:"POST",responseType:"json",getRequestHeaders:o,calculateAttemptDelay:IS(),onSuccess:function(){return e()},shouldRetry:function(e){return e>=500},onError:function(e){f=i(i({},f),{},{lastSeenMessageDuringMarkRead:NS.lastSeenMessageDuringMarkRead}),t(jE(e))}})})))}return Promise.resolve()},_stop:function(){a.unsubscribe(),u.stop()}}}var RS=function(e){return function(){return console.warn("Private API, do not use"),e.apply(this,arguments)}},CS=function(){function e(t){var n=this,r=t.statusObservable,i=t.cobraObservable,o=t.webRtcMode,a=t.enabledMediaLevel,u=t.statsClient,c=t.channelObservable,l=t.apiStart,f=t.visitorAppPublicInterface,p=t.pubsub,d=t.routingObservable,h=t.visitorMetadata,v=t.internalVisitorStateObservable,b=t.volatileNotifications,m=t.wsProxy,g=t.currentStatusObservable,y=t.operatorPresenceObservable,w=t.getVisitorPriority,E=t.queuesStateUpdatesObservable,O=t.dynamicImport,S=void 0===O?oc:O;s(this,e),this.willNavigate=this.willNavigate.bind(this),this.statsClient=u,this.visitorApp=new yS(f);var T,k=new Du.ReplaySubject(1);this.cobrowser=new rw({channelObservable:c,internalVisitorStateObservable:v,cobraObservable:i.pluck("cobraSource")}),this.setLocale=function(e){if(I.contains(e,I.keys(sm.conf.visitor_app_assets.locales)))return Wf({url:sm.conf.visitor_app_assets.locales[e],retryLimit:5,calculateAttemptDelay:M(1e3),assetKey:"locale-change",identifier:e,onSuccess:function(t){return $u.info("Locale updated",{locale:e}),k.next(t.response)}},this.statsClient),{};throw new yf({cause:this.ERRORS.INVALID_INPUT})},this.messageCenter=new MS({routingObservable:(T={internalVisitorStateObservable:v,pubsub:p,routingObservable:d,getRequestHeaders:this.getRequestHeaders}).routingObservable,getRequestHeaders:T.getRequestHeaders,pubsub:T.pubsub,internalVisitorStateObservable:T.internalVisitorStateObservable});var A=y.map((function(e){return e.values()})),x=y.bufferCount(2,1).flatMap((function(e){var t=_(e,2),n=t[0],r=t[1],i=[];return n.values().forEach((function(e){var t=r.get(e.id);if(t&&!I.equals(e,t))return i.push(t)})),Du.Observable.from(i)})),N=A,R=sc.vent.observable(sc.MSG.PUBLIC.ENGAGEMENT_START),C=sc.vent.observable(sc.MSG.PUBLIC.ENGAGEMENT_END),P=sc.vent.observable(sc.MSG.PUBLIC.ENGAGEMENT_ERROR),j=!1,L=function(e,t){return Wc.merge(e.pipe(Nt(I.always(!0))),t.pipe(Nt(I.always(!1)))).pipe(Yo(!1))}(R,C);L.subscribe((function(e){j=e})),this.isInEngagement=function(){return j};var q=new Du.ReplaySubject(1),U=function(e){var t=I.equals("engagement");return e.pipe(Nt((function(e){var n=e.interaction,r=e.visitor,i=e.engagement;return new hO({engaged:t(n)&&!J_(i),name:r&&r.name,email:r&&r.email})})))}(r),D=function(e){return e.connectedObservable.pipe(Nt((function(e){return new vO({connected:e})})))}(p);SS(p);var V=sm.conf.engagement.api_timeout_milliseconds||cf,F=sm.conf.omniq.api_retry_interval_milliseconds||1e3,B=sm.conf.omniq.api_max_retries||100,H=new gO({wsProxy:m,stats:this.statsClient,apiTimeoutMilliseconds:V}),W=new TO({wsProxy:m,stats:this.statsClient,apiTimeoutMilliseconds:V,visitorMetadata:h,internalVisitorStateObservable:v}),G=new ES({wsProxy:m,apiTimeoutMilliseconds:V,stats:this.statsClient}),z=bS({wsProxy:m,pubsub:p,routingObservable:d,engagementApi:H,engagementRequestApi:W,operatorsObservable:N,cobraObservable:i.pluck("cobraSource"),fetchEngagementDependencies:function(){return S("Comms")},channelObservable:c,communicationLib:sm.conf.communications.lib,statsClient:this.statsClient,apiTimeoutMilliseconds:V,apiRetryIntervalMilliseconds:F,apiMaxRetries:B,connectionStatusObservable:D,webRtcMode:o,enabledMediaLevel:a,visitorMetadata:h,conf:sm.conf,getRequestHeaders:this.getRequestHeaders,internalVisitorStateObservable:v,visitorAuthenticatedExternallyObservable:zu.asObservable().distinctUntilChanged(),volatileNotifications:b,statusObservable:r,queuesStateUpdatesObservable:E,cobrowser:this.cobrowser});this.queueForEngagement=z.queueForEngagement,this.getQueueWaitDuration=z.fetchWaitDuration,this.getQueues=z.getQueues;var J=z.aggregateQueueStateObservable;this.__queueForEngagement=z.oldQueueForEngagement,this.__setQueueReestablishListener=z.oldSetQueueReestablishListener,this.__fetchQueueWaitDuration=z.getQueueWaitDuration,this.subscribeToQueueStateUpdates=Mf({enabled:sm.conf.omniq.omniq_enabled,statsClient:this.statsClient,pubsub:p}).subscribe,this.requestEngagement=function(e,t){var s=zE({api:W,conf:sm.conf,operatorsObservable:N.take(1),media:e,options:t,statsClient:n.statsClient,cobraObservable:i.take(1).pluck("cobraSource"),channelObservable:c,engagementApi:H,webRtcMode:o,enabledMediaLevel:a,connectionStatusObservable:D,getRequestHeaders:n.getRequestHeaders,internalVisitorStateObservable:v,volatileNotifications:b,statusObservable:r,pubsub:p,wsProxy:m,dynamicImport:S,cobrowser:n.cobrowser});return function(e){var t=e.operatorObservable,n=e.engagementObservable,r=e.cancelEngagementRequest,i=e.engagementRequestTimeout;return new JE({timeout:i,engagementPromise:n.toPromise(),operatorPromise:t.toPromise(),cancel:r})}({operatorObservable:s.operatorObservable,engagementObservable:s.engagementObservable,cancelEngagementRequest:s.cancelEngagementRequest,engagementRequestTimeout:s.engagementRequestTimeout})};var Y=function(e){var t=e.internalVisitorStateObservable,n=e.webRtcMode,r=e.enabledMediaLevel,i=e.engagementRequestApi,o=e.statsClient,s=e.cobraObservable,a=e.channelObservable,u=e.engagementApi,c=e.connectionStatus,l=e.getRequestHeaders,f=e.volatileNotifications,p=e.statusObservable,d=e.pubsub,h=e.wsProxy,v=e.dynamicImport,b=e.cobrowser,m=1e3*sm.conf.engagement.proactive_call_timeout,g=I.compose(I.nth(0),I.filter((function(e){return I.any(I.propEq("id",sm.siteId),e.transferrable_sites)})),I.filter(I.propEq("outcome",null)),I.filter(I.propEq("type","proactive")),I.pathOr([],["engagement","requests"]));return t.map(g).filter(I.identity).distinctUntilChanged(null,I.prop("id")).map((function(e){var v=Xg({id:e.operator.id,name:e.operator.name,formattedName:e.operator.formatted_name,picture:{url:e.operator.picture_url},mediaType:e.operator.media_type,webRtcMode:n,enabledMediaType:r}),g=Xg({id:e.operator.id,name:e.operator.name,formattedName:e.operator.formatted_name,picture:{url:e.operator.picture_url},mediaType:e.offered_media_type,webRtcMode:n,enabledMediaType:r});return{incomingEngagementRequest:lO.create({api:i,id:e.id,operator:v,restrictedOperator:g,message:e.welcome_message,logoUrl:sm.conf.visitor_app.site_logo.url,platform:e.platform,timeout:m,statsClient:o,cobraObservable:s.take(1).pluck("cobraSource"),channelObservable:a,engagementApi:u,connectionStatusObservable:c,getRequestHeaders:l,internalVisitorStateObservable:t,volatileNotifications:f,statusObservable:p,pubsub:d,wsProxy:h,cobrowser:b}),platform:e.platform}})).switchMap((function(e){var t=e.incomingEngagementRequest,n=e.platform;return v("Comms").mapTo({incomingEngagementRequest:t,platform:n})}))}({dynamicImport:S,internalVisitorStateObservable:v,webRtcMode:o,enabledMediaLevel:a,engagementRequestApi:W,statsClient:this.statsClient,cobraObservable:i,channelObservable:c,engagementApi:H,connectionStatus:D,getRequestHeaders:this.getRequestHeaders,volatileNotifications:b,statusObservable:r,pubsub:p,wsProxy:m,cobrowser:this.cobrowser}),Q=new YE,K=Y.filter(I.propEq("platform",hf)).map(I.prop("incomingEngagementRequest"));this.setIncomingEngagementRequestHandler=function(e){Q.add(K.subscribe(e,$u.error))};var X=function(e){var t=e.reestablishObservable,n=e.defaultOmnicoreHandler,r=e.defaultOmnibrowseHandler,i=e.internalVisitorStateObservable,o=e.sessionStore||eg,s=e.timeout||15e3,a=t.publishReplay(1);a.connect();var u={replayedReestablishObservable:a.withLatestFrom(i,(function(e,t){return{source:e,visitorState:t}})).filter((function(e){var t=e.source,n=e.visitorState;return!!t.engagement.engagementId&&I.compose(I.find(I.propEq("id",t.engagement.engagementId)),I.pathOr([],["engagement","engagements"]))(n)})).map((function(e){return e.source})),sessionStore:o,timeout:s};return{setOmnicoreReestablishHandler:dO(I.merge(u,{defaultHandler:n,storeKey:"custom_reestablish_handler_set",platform:hf})),setOmnibrowseReestablishHandler:dO(I.merge(u,{defaultHandler:r,storeKey:"omnibrowse_custom_reestablish_handler_set",platform:vf}))}}({reestablishObservable:l.flatMap((function(){return pO({channelObservable:c,cobrowser:n.cobrowser,internalVisitorStateObservable:v,statusObservable:r,webRtcMode:o,enabledMediaLevel:a,statsClient:n.statsClient,cobraObservable:i,isEngagedObservable:L,engagementApi:H,connectionStatusObservable:D,getRequestHeaders:n.getRequestHeaders,volatileNotifications:b,pubsub:p,wsProxy:m,dynamicImport:S})})),defaultOmnicoreHandler:function(e){return $u.warn("Engagement reestablished without a reestablish handler in place")},defaultOmnibrowseHandler:function(e){return $u.warn("Phone-first (OmniBrowse) engagement reestablished without a reestablish handler in place")},internalVisitorStateObservable:v}),$=X.setOmnicoreReestablishHandler,Z=X.setOmnibrowseReestablishHandler;this.setEngagementReestablishHandler=$,this.requestAsset=function(e,t){t||(t={});return cO(e,(function(){return I.merge(n.getRequestHeaders(),t)})).toPromise()},this.omnibrowse=new KE({incomingEngagementRequestObservable:Y,setOmnibrowseReestablishHandler:Z,statsClient:this.statsClient,wsProxy:m}),this.overseer=new nO({operatorListReady:A.take(1),isOmniqEnabled:sm.conf.omniq.omniq_enabled,routingObservable:d,queueStateReady:J.take(1)}),this.omnicall=new iO,this.config=new aO,this.getBrowserContext=function(){return g.take(1).map((function(e){return{tab_id:sm.tabId,url:window.location.href,metadata:sm.conf.visitor_metadata,status:e}})).toPromise()},this.updateInformation=function(e){return g.take(1).flatMap((function(t){return RO(e,{createApiRequestObservable:function(e){return Bf({url:Gy("/sites/".concat(Gu(),"/visitors/").concat(Fu())),method:"PATCH",contentType:"application/json",payload:e})},serverResponseTimeout:cf,tabId:sm.tabId,visitorMetadata:sm.conf.visitor_metadata,status:t})})).toPromise()},this.createAuthenticationRequest=function(e){return $u.info("Create authentication request called",e),G.createAuthenticationRequest(e)},this.setupContactOperatorButton=function(e){return e||(e={}),$u.warn("setupContactOperatorButton is deprecated!"),q.next(e)};var ee=function(e){var t=e.internalVisitorStateObservable,n=e.authenticationApi,r=I.compose(I.find((function(e){return e.site_id===Gu()&&e.visitor_id===Fu()})),I.pathOr([],["authentication_requests"]));return t.pipe(Nt(r),Tn(I.identity),yi(I.equals),Nt((function(e){return I.construct(_S)({id:e.id,siteId:e.site_id,visitorId:e.visitor_id,url:e.url,authenticationApi:n})})))}({internalVisitorStateObservable:v,authenticationApi:G}),te=I.fromPairs([[this.EVENTS.ENGAGEMENT_START,R],[this.EVENTS.ENGAGEMENT_END,C],[this.EVENTS.ENGAGEMENT_ERROR,P],[this.EVENTS.VISITOR_STATUS_UPDATE,U],[this.EVENTS.OPERATOR_STATUS_UPDATE,x],[this.EVENTS.OPERATOR_LIST_UPDATE,A],[this.EVENTS.ENGAGEMENT_REQUEST,Y.map(I.always({}))],[this.EVENTS.CONNECTION_STATUS_UPDATE,D],[this.EVENTS.QUEUE_STATE_UPDATE,J],[this.EVENTS.AUTHENTICATION_REQUEST,ee],["contact_operator_button_configuration",q],["locale_change_requested",k]]),ne=Zf();ne.proxyAll(te),this.addEventListener=ne.addEventListener,this.removeEventListener=ne.removeEventListener,this.observable=function(e){return te[e]},function(e){var t,n=e.internalVisitorStateObservable,r=e.useOmniq,i=e.operatorListUpdate,o=e.queueStateUpdate,s=e.statsClient,a=e.staffingCheckDelayMs,u=void 0===a?1e4:a,c=e.recordingMaxTime,l=void 0===c?6e4:c,f=I.compose(I.length,I.filter(I.path(["state","available"]))),p=n.map((function(e){return Boolean(Y_(e))})).filter(I.equals(!0));t=r?o.map((function(e){return sm.conf.visitor_api.enable_staffing_logs&&$u.info("[staffing-logs] Recording queue state",{queue_state:e.state}),I.contains(e.state,[e.QUEUE_STATES.CAN_QUEUE,e.QUEUE_STATES.QUEUED])?"staffed":"general"})):i.map((function(e){return sm.conf.visitor_api.enable_staffing_logs&&$u.info("[staffing-logs] Recording operator state",{operator_count:f(e)}),f(e)>0?"staffed":"general"})),sm.conf.visitor_api.enable_staffing_logs&&$u.info("[staffing-logs] Starting recorder timer",{duration:u});var d=Du.Observable.create((function(e){var t=setTimeout((function(){e.next(null)}),u);return function(){return clearTimeout(t)}})),h=new Date,v=function(){return window.performance&&window.performance.now&&window.performance.now()},b=v();d.flatMapTo(t).take(1).takeUntil(p).subscribe((function(e){var t=new Date,n=v(),r=t-h+1e3<=u;r||t-h>l?$u.warn("Recording staffing failed due to browser timer issues",{type:e,early_recording:r,start_time:h.toISOString(),recording_time:t.toISOString(),accurate_start_time:b,accurate_recording_time:n,difference:t&&t-h,accurate_difference:n&&n-b}):s.increment("usage_metrics.visitor.reactive_tab_showed",["type:".concat(e),"source:desktop","site_id:".concat(Gu()),"visitor_id:".concat(Fu())])}),$u.error)}({internalVisitorStateObservable:v,useOmniq:sm.conf.omniq.omniq_enabled,operatorListUpdate:this.observable(this.EVENTS.OPERATOR_LIST_UPDATE),queueStateUpdate:this.observable(this.EVENTS.QUEUE_STATE_UPDATE),statsClient:this.statsClient});var re=jl();!function(e){var t=e.visitorIdleAfterTime,n=e.pubsub;t.subscribe((function(){sm.logger.info("Visitor was idle for too long, disconnecting"),n.disconnect(),OS=!0}))}({visitorIdleAfterTime:function(e,t){var n=e.activityObservable,r=e.engagementEndObservable,i=e.timeUntilIdle,o=e.maxIdleTime,s=e.isEngaged;return Du.Observable.merge(n,r).debounceTime(i+o,t).filter((function(){return!s()})).map((function(){}))}({activityObservable:re,engagementEndObservable:C,timeUntilIdle:1e3*sm.conf.engagement.visitor_time_to_inactive_sec,maxIdleTime:1e3*sm.conf.visitor_api.max_idle_time_seconds,isEngaged:function(){return j}}).filter((function(){return sm.conf.visitor_api.disconnect_idle_visitors})),pubsub:p}),function(e){var t=e.activityObservable,n=e.pubsub;t.filter((function(){return OS&&n.allowReconnection()})).subscribe((function(){sm.logger.info("Reconnecting idle visitor due to detected activity"),OS=!1,n.connect()}))}({activityObservable:re,pubsub:p}),this.getSessionContext=function(){var e={tab_id:sm.tabId,visitor_priority:w(),access_token:sm.accessToken};return encodeURIComponent(btoa(JSON.stringify(e)))},this.__pubsub__={reconnect:RS(p.reconnect),socket:RS((function(){return p.__socket__}))}}return u(e,[{key:"getRequestHeaders",value:function(){return{Accept:"application/vnd.salemove.v1+json",Authorization:"Bearer "+sm.accessToken}}},{key:"getVisitorId",value:function(){return Fu()}},{key:"getSiteId",value:function(){return Gu()}},{key:"leaveMessage",value:function(e){return uO(e,{createApiRequestObservable:function(e){return Bf({url:Gy("/visitor/offline_message"),method:"POST",contentType:"application/json",payload:e})},serverResponseTimeout:cf}).toPromise()}},{key:"leaveOperatorMessage",value:function(e){return function(e,t,n){e||(e={}),n||(n=Du.Scheduler.asap);var r=e.operatorId;return r?uO(I.merge({operator_id:r},e),t,["operator_id"],n):Du.Observable.throw({cause:uf.SALEMOVE.INVALID_INPUT,message:"operatorId must be specified"})}(e,{createApiRequestObservable:function(e){return Bf({url:Gy("/visitor/operator_message"),method:"POST",contentType:"application/json",payload:e})},serverResponseTimeout:cf}).toPromise()}},{key:"willNavigate",value:function(){return Promise.resolve({})}},{key:"changeElementAttributesForCobrowsing",value:function(e,t){if("function"!=typeof t)throw new yf({cause:this.ERRORS.INVALID_INPUT});return e.sm_change_element_attributes=Xf("Custom element attribute serializer threw error",df,t),function(e){e.setAttribute(bO,"0"===(e.getAttribute(bO)||"0")?"1":"0")}(e),null}}]),e}();CS.prototype.ERRORS={INVALID_INPUT:"invalid input",OPERATOR_UNAVAILABLE:"operator unavailable",INTERNAL_ERROR:"internal error",RESOURCE_NOT_FOUND:"not found",OPERATOR_DECLINED:"operator declined",DECLINE:"decline",CANCEL:"cancel",TIMEOUT:"timeout",NETWORK_TIMEOUT:"network timeout",CONNECTION_LOST:"connection lost",TOO_MANY_REQUESTS:"too many requests",FORBIDDEN:"forbidden",NOT_SUPPORTED:"not supported",DISABLED:"disabled",ALREADY_QUEUED:"already queued",ALREADY_ENGAGED:"already engaged",CONFLICT:"conflict",FILE_TOO_LARGE:"file too large",FILE_CONTENT_TYPE_NOT_ALLOWED:"file content type not allowed",DENIED_BY_PERMISSIONS_POLICY:"denied by permissions policy",DEVICE_ACCESS_ERROR:"device access error",DENIED_BY_SYSTEM:"denied by system"},CS.prototype.EVENTS={ENGAGEMENT_END:"sm:engagement:end",ENGAGEMENT_START:"sm:engagement:start",ENGAGEMENT_ERROR:"sm:engagement:error",VISITOR_STATUS_UPDATE:"sm:visitor_status:update",ENGAGEMENT_REQUEST:"sm:engagement:request",OPERATOR_LIST_UPDATE:"sm:operator_list:update",OPERATOR_STATUS_UPDATE:"sm:operator_status:update",CONNECTION_STATUS_UPDATE:"sm:connection_status:update",QUEUE_STATE_UPDATE:"sm:queue:update",AUTHENTICATION_REQUEST:"sm:authentication:request"};var PS="sm.app.visitor_api.send_capabilities",jS=function(){function e(t){var n=t.channelObservable,r=t.statsClient,i=t.getLocalCapabilities,o=void 0===i?ME:i;s(this,e),this.channelObservable=n,this.statsClient=r,this.getLocalCapabilities=o,this._receivePostMessage=this._receivePostMessage.bind(this),this._restoreLastUrl=this._restoreLastUrl.bind(this),this._subscription=new Du.Subscription,this.lastUrl=window.location.href}return u(e,[{key:"start",value:function(){return this._addListeners()}},{key:"capabilitiesRequestObservable",value:function(){return this.channelObservable.switchMap((function(e){var t=e.channel;return function(e){return sm.logger.log("Capabilities response, received request"),e.observable("capabilities:request")}(t).map((function(){return t}))}))}},{key:"_addListeners",value:function(){var e=this;sc.vent.observable("visit:restore_url").subscribe(this._restoreLastUrl,sm.logger.error),window.addEventListener("message",this._receivePostMessage,!1),this._subscription.add(this.capabilitiesRequestObservable().map((function(t){return{channel:t,localCapabilities:e.getLocalCapabilities()}})).do((function(){return e.statsClient.increment(PS,["action:succeeded"])})).do(null,(function(){return e.statsClient.increment(PS,["action:failed"])})).subscribe((function(e){var t=e.channel,n=e.localCapabilities;sm.logger.log("Sending local capabilities",n),t.emit("capabilities:response",n)}),sm.logger.warn.bind(sm.logger,"Failed to send visitor capabilities")))}},{key:"_receivePostMessage",value:function(e){try{var t=JSON.parse(e.data);t["sm-xdr-url"]&&(this.lastUrl=t["sm-xdr-url"])}catch(e){}}},{key:"_restoreLastUrl",value:function(){var e;null!==(e=sm.conf.visitor_api)&&void 0!==e&&e.use_buggy_iframe_reload?this._oldRestoreLastUrl():window.location.hash&&this.lastUrl.split("#")[0]===window.location.href.split("#")[0]?window.location.reload():window.location.href=this.lastUrl}},{key:"_oldRestoreLastUrl",value:function(){this.lastUrl&&this.lastUrl.split("#")===window.location.href.split("#")[0]?window.location.reload():window.location.href=this.lastUrl}}]),e}(),LS=["v1"],qS=new Promise((function(e,t){return sm._apiHandlers.push({resolve:e,options:{version:"v1"}})})),US=new Du.Subject,DS=Du.Observable.fromPromise(qS).flatMap((function(e){return Du.Observable.merge(e.observable(e.EVENTS.ENGAGEMENT_START),e.observable(e.EVENTS.ENGAGEMENT_END).map((function(){return null})))})).publishReplay(1);DS.connect();var VS=function(){function e(t){var n=t.element;s(this,e),this._empty=this._empty.bind(this),this._startOperatorMediaInElement=this._startOperatorMediaInElement.bind(this),this.element=n,this._subscription=new Du.Subscription;var r=_(DS.partition(I.identity),2);this.startMediaObservable=r[0],this.endMediaObservable=r[1]}return u(e,[{key:"start",value:function(){this._subscription.add(this.startMediaObservable.subscribe(this._startOperatorMediaInElement,$u.error)),this._subscription.add(this.endMediaObservable.subscribe(this._empty,$u.error))}},{key:"destroy",value:function(){this._subscription.unsubscribe()}},{key:"_empty",value:function(){this.element.innerHTML=""}},{key:"_startOperatorMediaInElement",value:function(e){var t=n.default.visitor_api?n.default.visitor_api.use_updated_webcomponents:void 0;e.communicationWidget.startOperatorMedia(this.element),$u.info("Starting operator media in widget",{engagement_id:e.engagementId,updated_webcomponents:t}),Zu.increment("sm.app.visitor.customElements",["action:succeeded","type:engaged_operator","updated_webcomponents:".concat(t)])}}]),e}(),FS=function(){if(sm.conf.visitor_api&&sm.conf.visitor_api.use_updated_webcomponents)return function(e){l(n,e);var t=m(n);function n(){return s(this,n),t.apply(this,arguments)}return u(n,[{key:"connectedCallback",value:function(){return this._controller=new VS({element:this}),this._controller.start()}},{key:"disconnectedCallback",value:function(){return this._controller.destroy()}}]),n}(v(HTMLElement));if(window.customElements){var e=function e(){return window.Reflect.construct(HTMLElement,[],e)};return Object.setPrototypeOf(e.prototype,HTMLElement.prototype),Object.setPrototypeOf(e,HTMLElement),e.prototype.connectedCallback=function(){return this._controller=new VS({element:this}),this._controller.start()},e.prototype.disconnectedCallback=function(){return this._controller.destroy()},e}var t={}.hasOwnProperty;return function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return function(e,n){var r;for(r in n)t.call(n,r)&&(e[r]=n[r]);function i(){this.constructor=e}i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype}(n,HTMLElement),n.prototype.attachedCallback=function(){return this._controller=new VS({element:this}),this._controller.start()},n.prototype.detachedCallback=function(){return this._controller.destroy()},n}()},BS=function(){var e=FS();if(window.customElements)try{customElements.get("sm-engaged-operator")||window.customElements.define("sm-engaged-operator",e)}catch(e){var t=n.default.visitor_api?n.default.visitor_api.use_updated_webcomponents:void 0;Zu.increment("sm.app.visitor.customElements",["action:failed","type:engaged_operator","updated_webcomponents:".concat(t)]),$u.error("Failed to initiate sm-engaged-operator",{error_message:e?e.message:void 0,updated_webcomponents:t})}else document.registerElement("sm-engaged-operator",e)},HS=function(){function e(t){var n=t.engagedVisitorElement,r=t.attributes;s(this,e),this._addListeners=this._addListeners.bind(this),this._empty=this._empty.bind(this),this._startVisitorMedia=this._startVisitorMedia.bind(this),this.engagedVisitorElement=n,this._subscription=new Du.Subscription,this._attributes=r}return u(e,[{key:"start",value:function(){return this._addListeners()}},{key:"destroy",value:function(){return this._subscription.unsubscribe()}},{key:"_addListeners",value:function(){var e=_(DS.partition(I.identity),2),t=e[0],n=e[1];return this._subscription.add(t.subscribe(this._startVisitorMedia,$u.error)),this._subscription.add(n.subscribe(this._empty,$u.error))}},{key:"_empty",value:function(){this.engagedVisitorElement.innerHTML=""}},{key:"_startVisitorMedia",value:function(e){var t=n.default.visitor_api?n.default.visitor_api.use_updated_webcomponents:void 0,r=document.createElement("div");this.engagedVisitorElement.appendChild(r),e.communicationWidget.startVisitorMedia(r,this._attributes),$u.info("Starting visitor media in widget",{engagement_id:e.engagementId,updated_webcomponents:t}),Zu.increment("sm.app.visitor.customElements",["action:succeeded","type:engaged_visitor","updated_webcomponents:".concat(t)])}}]),e}(),WS=function(){if(sm.conf.visitor_api&&sm.conf.visitor_api.use_updated_webcomponents)return function(e){l(n,e);var t=m(n);function n(){return s(this,n),t.apply(this,arguments)}return u(n,[{key:"connectedCallback",value:function(){this._controller=new HS({engagedVisitorElement:this,attributes:{translations:JSON.parse(this.getAttribute("translations"))||{}}}),this._controller.start()}},{key:"disconnectedCallback",value:function(){this._controller.destroy()}}]),n}(v(HTMLElement));if(window.customElements){var e=function e(){return window.Reflect.construct(HTMLElement,[],e)};return Object.setPrototypeOf(e.prototype,HTMLElement.prototype),Object.setPrototypeOf(e,HTMLElement),e.prototype.connectedCallback=function(){this._controller=new HS({engagedVisitorElement:this,attributes:{translations:JSON.parse(this.getAttribute("translations"))||{}}}),this._controller.start()},e.prototype.disconnectedCallback=function(){this._controller.destroy()},e}var t={}.hasOwnProperty;return function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return function(e,n){var r;for(r in n)t.call(n,r)&&(e[r]=n[r]);function i(){this.constructor=e}i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype}(n,HTMLElement),n.prototype.attachedCallback=function(){return this._controller=new HS({engagedVisitorElement:this,translations:this.getAttribute("translations")||{}}),this._controller.start()},n.prototype.detachedCallback=function(){return this._controller.destroy()},n}()},GS=function(){var e=WS();if(window.customElements)try{customElements.get("sm-engaged-visitor")||window.customElements.define("sm-engaged-visitor",e)}catch(e){var t=n.default.visitor_api?n.default.visitor_api.use_updated_webcomponents:void 0;Zu.increment("sm.app.visitor.customElements",["action:failed","type:engaged_visitor","updated_webcomponents:".concat(t)]),$u.error("Failed to initiate sm-engaged-visitor",{error_message:e?e.message:void 0,updated_webcomponents:t})}else document.registerElement("sm-engaged-visitor",e)},zS=!1,JS=!1,YS=[],QS=function e(){if(!JS){if(!document.body)return setTimeout(e,13);if(JS=!0,YS){for(var t,n=0;t=YS[n++];)t.call(document);YS=null}}},KS=function e(){document.removeEventListener("DOMContentLoaded",e,!1),QS()};function XS(e){!function(){if(!zS){if(zS=!0,"complete"===document.readyState||"interactive"===document.readyState)return QS();document.addEventListener("DOMContentLoaded",KS,!1),window.addEventListener("load",QS,!1)}}(),JS?e.call(document):YS&&YS.push(e)}sm.ready=XS;var $S=function(e){localStorage.setItem("sm.access_token",e)},ZS=function(e){var t=e.token,n=e.offset,r=void 0===n?-5e3:n,i=e.scheduler,o=void 0===i?Du.Scheduler.asap:i,s=e.getJwtExpMSFn,a=void 0===s?bg:s,u=e.startDate,c=void 0===u?Date.now():u;return Du.Observable.timer(a(t)+r-c,o)},eT=function(e){var t=e.accessTokenRenewalSignal,n=e.accessToken,r=e.getGliaContextObservable,i=void 0===r?hg:r,o=e.tokenExpirationObservable,s=void 0===o?ZS:o,a=e.isVisitorAuthenticatedExternallyFn,u=void 0===a?Ju:a;I.not(u)||i().switchMap((function(e){var t=e.idToken,r=function(e,t){return 3===e.split(".").length?e:t}(t,n);return s({offset:-5e3,token:r}).mapTo(t)})).switchMap((function(e){return i().map((function(t){var n=t.idToken;return[e,n]}))})).filter((function(e){var t=_(e,2);return t[0]===t[1]})).subscribe((function(){return t.next({expiringIdTokenRefresh:!0})}))};if(sm.conf.visitor_api.persist_visitor_session_in_url){sm.urlParams=wy({accessToken:/.+/,tabId:/.+/},{targetWindow:window,logger:$u})}else sm.urlParams={};if("show_visitor_code"===sm.conf.visitor_app.chat_link_visitor_consolidation){var tT=wy({showVisitorCode:/true/},{targetWindow:window,logger:$u});I.isEmpty(tT)||(sm.urlParams.showVisitorCode=!0)}var nT={setStatsClient:function(){},setLogger:function(){},ready:function(){}},rT=function(e){var t=sm.conf.visitor_app_assets,n="visitor_app";return new Promise((function(r,i){var o,s,a;-1!==["latest_new_app","latest_v2","latest_v2_plus"].indexOf(sm.conf.visitor_app_option)?(o=function(e){e.setAttribute("data-sm-visitor-app-asset",""),e.setAttribute("data-loaded-callback","sm.visitorAppLoaded"),sm.visitorAppLoaded=r},a=null):(o=function(e){return e.setAttribute("data-sm-visitor-app-asset","")},a=function(){return r(nT)}),t.js.forEach((function(t){s=t.substring(t.lastIndexOf("/")+1),L({integrity:j({versionedName:s}),fileUrl:t,beforeLoad:o,onAttempt:function(){e.increment("sm.assets.load",["action:attempted","asset:".concat(n,".js")])},onLoad:function(){e.increment("sm.assets.load",["action:succeeded","asset:".concat(n,".js")]),a&&a()},onError:function(){e.increment("sm.assets.load",["action:warning","asset:".concat(n,".js")])},onGiveUp:function(){e.increment("sm.assets.load",["action:failed","asset:".concat(n,".js")]),$u.warn(new Error("Failed to load visitor app JS asset"),{asset_url:t})}})})),t.css.forEach((function(t){s=t.substring(t.lastIndexOf("/")+1),q({integrity:j({versionedName:s}),fileUrl:t,onAttempt:function(){e.increment("sm.assets.load",["action:attempted","asset:".concat(n,".css")])},onError:function(){e.increment("sm.assets.load",["action:warning","asset:".concat(n,".css")])},onGiveUp:function(){e.increment("sm.assets.load",["action:failed","asset:".concat(n,".css")]),$u.warn(new Error("Failed to load visitor app CSS asset"),{asset_url:t})}})}))}))},iT=function(){return-1!==["latest_new_app","latest_v2","latest_v2_plus","custom","omnibrowse"].indexOf(sm.conf.visitor_app_option)},oT=function(e){var t=e.stats;return iT()?rT(t):Promise.resolve(nT)},sT=function(){return sm.conf.visitor_app.visitor_app_default_locale||""},aT={translations:{}},uT=function(e){return new Promise((function(t,n){var r=sT(),i=(sm.conf.visitor_app_assets.locales||{})[r];i?Wf({url:i,retryLimit:5,calculateAttemptDelay:M(1e3),assetKey:"locale",identifier:r,onSuccess:function(e){t({translations:e.response})},onError:function(){$u.warn("Fetching locale failed, using empty locale"),t(aT)}},e):(e.increment("sm.assets.load",["action:failed","asset:locale","reason:locale_missing"]),$u.warn("Locale is not present, starting with defaultMessages",{localeKey:r,localeUrl:i}),t(aT))}))},cT=function(e){return"en-US"===sT()?Promise.resolve(aT):iT()?uT(e):Promise.resolve(aT)},lT=function(e){var t=cy.extractLinkFromEvent(e);t&&function(e,t){"https:"!==t.protocol&&"http:"!==t.protocol||cy.isAllowedToNavigate(t.hostname)||(e.preventDefault(),window.open(t.href))}(e,t)},fT=function(){return Xm.unloadMaybeToPageCache.subscribe((function(){return eg.set(Vy,By(document))}))},pT=function(e){var t=e.getAccessToken,n=e.stats,r=e.pubsub,i=e.visitorPresenceChannel,o=e.internalVisitorStateObservable,s=e.volatileNotifications,a=e.wsProxy,u=e.operatorPresenceObservable,c=e.routingObservable;document.body.addEventListener("click",lT),fT(),function(e){var t=e.getAccessToken,n=e.stats,r=e.pubsub,i=e.visitorPresenceChannel,o=e.internalVisitorStateObservable,s=e.volatileNotifications,a=(e.wsProxy,e.operatorPresenceObservable),u=e.routingObservable;mp();var c=ip({channelObservable:Ly({internalVisitorStateObservable:o,getAccessToken:t,stats:n,visitorPresenceChannel:i,salemovePresentInParent:!0}).channelObservable,logger:$u}).cobraObservable,l=Mf({enabled:sm.conf.omniq.omniq_enabled,statsClient:n,pubsub:r});Kf({internalVisitorStateObservable:o,cobraObservable:c,volatileNotifications:s,stats:n,currentStatusObservable:rg(o),operatorPresenceObservable:a,queuesStateUpdatesObservable:l,routingObservable:u})}({getAccessToken:t,stats:n,pubsub:r,visitorPresenceChannel:i,internalVisitorStateObservable:o,volatileNotifications:s,wsProxy:a,operatorPresenceObservable:u,routingObservable:c}),fc(),ly()},dT={setup:function(){$S(sm.accessToken),$u.info("Visitor WebRTC mode",{webrtc_mode:Ug()}),sm.conf.visitor_app.theme=sm.conf.visitor_app.theme.desktop_css_url;var e=vy(),t=e.bestEffortXDomainStorage,n=e.windowNameStorage,r=e.xDomainUrlStorage,i=tg.setup(n,{sessionContext:sm._sessionContext,tabIdFromConfiguration:sm.tabId}),o=i.getId();sm.tabId=o;var s=new Du.Subject;!function(e,t){N=I.merge(N,{enabled:t}),e.take(1).subscribe((function(e){e.volatileChannelObservable.flatMap((function(e){return e.observable("system:visitor_retry_configuration")})).subscribe((function(e){N=e}))}))}(s,sm.conf.visitor_request_retries_enabled);var a=function(e){return e.getItem(sg)}(t)||og,u=function(){return a},c=I.pathOr(!1,["sm","conf","site_visitor_config","detect_visitor_by_external_session_token"])(window),l=I.pathOr(!1,["sm","conf","engagement_restart","skip_on_unauthentication"])(window),f=new Du.Subject,p=function(e){var t=e.fetchToken,n=void 0===t?yg:t,r=e.accessToken,i=e.scheduler,o=void 0===i?Du.Scheduler.asap:i,s=e.accessTokenRenewalSignal,a=void 0===s?Du.Observable.empty():s,u=e.backoffStrategy,c=void 0===u?M:u,l=e.getVisitorPriority,f=e.getVisitorTabId,p=void 0===f?function(){return sm.tabId}:f,d=e.detectVisitorByExternalSessionTokenEnabled,h=void 0!==d&&d,v=e.tabHandler,b=new Du.ReplaySubject(1),m=mg(r);b.next(m);var g=c(3e3),y=function(e){return function(e){return e&&e.consolidationSecret}(e)||function(e){return e&&e.newIdToken}(e)||function(e){return e&&e.expiringIdTokenRefresh}(e)};return b.switchMap((function(e){return Du.Observable.timer(e,o)})).merge(a.filter(I.complement(y))).throttleTime(6e4,o).merge(a.filter(y)).switchMap((function(e){var t={priority:l(),tabId:p(),detectVisitorByExternalSessionTokenEnabled:h,sessionTabIds:v.getSessionTabIds()};e&&e.consolidationSecret?t.consolidationSecret=e.consolidationSecret:e&&e.expiringIdTokenRefresh?t.includeIdToken=!1:t.accessToken=r,$u.info("Refreshing access token");var i=Du.Observable.defer((function(){return n(t)})).do(null,(function(e){503!==e.status&&429!==e.status||($u.warn("Visitor access token unavailable, switching to maximum backoff"),g.maximizeNextDelay()),$u.warn("Failed to fetch JWT token. Retrying...",e.responseText)}));return ul(i,{maxRetries:403200,calculateDelay:g,scheduler:o}).do((function(e){var t=e.accessToken;r=t;var n=mg(t);b.next(n),$u.info("Access token refresh succeeded",{interval_seconds:n/1e3})}))}))}({accessToken:sm.accessToken,accessTokenRenewalSignal:f,getVisitorPriority:u,detectVisitorByExternalSessionTokenEnabled:c,tabHandler:i}).share(),d=function(){return sm.accessToken};Ju()&&eT({accessTokenRenewalSignal:f,accessToken:sm.accessToken});var h=ad({server:sm.conf.pubsub_server,stats:Zu,logsEnabled:sm.conf.visitor_api.pubsub_logs_enabled,getAccessToken:d,renewAccessToken:function(e){return f.next(e),p.delay(1e3)},reconnectConf:{initialDelay:sm.conf.visitor_api.socket_connection_error_retry_delay,maxDelay:sm.conf.visitor_api.socket_connection_error_max_delay,delayFactor:sm.conf.visitor_api.socket_connection_error_delay_factor},getVisitorPriority:u});s.next(h),p.subscribe((function(e){var t,n,r,i,o,s=e.accessToken,a=e.visitorId,u=e.authenticatedExternally,c=bg(sm.accessToken)!==bg(s);sm.accessToken=s,$S(s),c&&u&&eT({accessTokenRenewalSignal:f,accessToken:sm.accessToken}),t={oldVisitorId:Fu(),newVisitorId:a,oldAuthenticatedExternally:Ju(),newAuthenticatedExternally:u},n=t.oldVisitorId,r=t.newVisitorId,i=t.oldAuthenticatedExternally,o=t.newAuthenticatedExternally,r!==n&&o!==i&&function(e){var t=e.visitorId,n=e.authenticatedExternally,r=e.pubsub,i=e.skipEngagementRestartOnUnauthentication,o=void 0!==i&&i,s=e.App,a=void 0===s?sc:s,u=e.setNewVisitorIdFn,c=void 0===u?Wu:u,l=e.setVisitorAuthenticatedExternallyFn,f=void 0===l?Yu:l;(n||!o)&&a.vent.trigger("engagement:prepare_for_restart"),f(n),r.disconnect((function(){c(t),r.connect()}))}({visitorId:a,authenticatedExternally:u,pubsub:h,skipEngagementRestartOnUnauthentication:l})})),hg().switchMap((function(e){var t=e.idToken;return function(e){var t=e.accessTokenObservable,n=e.timeInterval,r=void 0===n?1e3:n,i=e.scheduler,o=void 0===i?Du.Scheduler.asap:i,s=e.initialValue,a=e.getGliaContextAsObservable,u=void 0===a?hg:a,c=s;return Du.Observable.merge(t,Du.Observable.of(null)).switchMap((function(){return Du.Observable.timer(r,r,o).switchMap((function(){return u().filter((function(e){var t=e.idToken,n=t===c;return c=t,!n}))})).take(1)}))}({accessTokenObservable:p,initialValue:t})})).subscribe((function(){f.next({newIdToken:!0})}));var v=new ud(h,{tabId:sm.tabId,idleTimeoutSeconds:sm.conf.engagement.visitor_time_to_inactive_sec,visitorMetadata:sm.conf.visitor_metadata}),b=zm({pubsub:h,tabId:sm.tabId});(function(e,t){return e.map(lg).distinctUntilChanged().do((function(e){return t.setItem(sg,e)}))})(b,t).subscribe((function(e){a=e}));var m,g=h.volatileChannelObservable.flatMap((function(e){return(0,e.observable)("message")})),y=function(e){var t=e.pubsub,n=t.joinChannel("websocket_proxy").publishReplay(1);return n.connect(),{connectedObservable:t.connectedObservable,updateAccessToken:function(e){n.take(1).flatMap((function(t){return t.push("update_access_token",{token:e})})).subscribe()},request:function(e,t){return t||(t={}),"GET"===e.method&&null!==e.payload?(Jm.error("Request with GET method cannot have payload",{params:e}),Du.Observable.throw("Request with GET method cannot have payload")):n.flatMap((function(n){return n.push("request",e,t)})).flatMap(Ym).catch(Qm)}}}({pubsub:h});p.subscribe((function(e){var t=e.accessToken;y.updateAccessToken(t)})),m=sm.conf.visitor_api.use_updated_webcomponents?window.customElements&&window.customElements.define?"webcomponents_es5":"webcomponents":"legacy_webcomponents";var _=sm.BusinessRules.Controller.actionTriggers(g,sm.BusinessRules.ACTION_TYPES.SHOW_OPERATORS_IN_SELECTOR_V2).scan((function(e,t){var n=t.operator_team_id,r=t.rule_id,i=t.rule_name,o=t.clear_previous;return o?{team_ids:[n],rule_id:r,rule_name:i,clear_previous:o}:{team_ids:I.union(e.team_ids,[n]),rule_id:r,rule_name:i,clear_previous:o}}),{}).do((function(e){return $u.info("Business rule setting visible teams",{team_ids:e.team_ids,rule_id:e.rule_id,rule_name:e.rule_name,clear_previous:e.clear_previous})})).pluck("team_ids").publishReplay(1);_.connect();var w=function(e){var t=e.pubsub,n=e.visibleTeamsObservable,r=e.enabledMediaLevel,i=e.webRtcMode,o=t.joinChannel("site_operator_presence:".concat(sm.siteId)).map((function(e){var t=e.phoenixChannel;return new Gp(t)})).switchMap((function(e){return Du.Observable.create((function(t){return ey({presence:e,presenceMapper:$g({enabledMediaLevel:r,webRtcMode:i}),visibleTeamsObservable:n,onChange:function(e){return t.next(e)}})}))})).publishReplay(1);return(o=al(o)).sampleTime(300)}({pubsub:h,visibleTeamsObservable:_,enabledMediaLevel:sm.conf.communications.enabled_media_level,webRtcMode:Ug()}),E=sm.conf.engagement.default_queues||[],O=by({internalVisitorStateObservable:b,defaultQueues:E});oc(m).subscribe((function(){XS((function(){window!==window.top?dT.setupIFrame({getAccessToken:d,stats:Zu,pubsub:h,visitorPresenceChannel:v,internalVisitorStateObservable:b,volatileNotifications:g,wsProxy:y,bestEffortXDomainStorage:t,operatorPresenceObservable:w,xDomainUrlStorage:r,getVisitorPriority:u,routingObservable:O,tabId:o}):(sm.visitorPageNotifierSubscription={unsubscribe:hp(o)},vp(o),dT.setupApp({getAccessToken:d,stats:Zu,pubsub:h,visitorPresenceChannel:v,internalVisitorStateObservable:b,volatileNotifications:g,wsProxy:y,operatorPresenceObservable:w,bestEffortXDomainStorage:t,xDomainUrlStorage:r,getVisitorPriority:u,routingObservable:O}))}))}))},setupApp:function(e){var t=e.getAccessToken,n=e.stats,r=e.pubsub,i=e.visitorPresenceChannel,o=e.internalVisitorStateObservable,s=e.volatileNotifications,a=e.wsProxy,u=e.operatorPresenceObservable,c=e.xDomainUrlStorage,l=e.getVisitorPriority,f=e.routingObservable;BS(),GS();return Promise.all([oT({stats:n}),cT(n),gy({stats:n}),_y({stats:n})]).then((function(e){return"[0]"!==JSON.stringify([0])?(r.disconnect(),Promise.reject('Misimplemented array stringification: (JSON.stringify([0]) !== "[0]"')):e})).then((function(e){var t=_(e,2);return function(e){var t=e.visitorApp,r=e.locale;return void 0===t.setStatsClient&&$u.warn("Setting dependencies failed. visitorApp.setStatsClient was undefined.",{visitorApp:t}),t.setStatsClient(n),t.setLogger($u),t.ready({locale:r}),t}({visitorApp:t[0],locale:t[1]})})).then((function(e){c.setItem("tabId",sm.tabId),c.setItem("accessToken",sm.accessToken);var p=function(e){var t=e.getAccessToken,n=e.stats,r=e.visitorPresenceChannel,i=e.internalVisitorStateObservable;mp();var o=Ly({internalVisitorStateObservable:i,getAccessToken:t,stats:n,visitorPresenceChannel:r,salemovePresentInParent:!1}),s=o.channelObservable;return{channelObservable:s,statusObservable:o.statusObservable,cobraObservable:ip({channelObservable:s,logger:$u}).cobraObservable}}({getAccessToken:t,stats:n,pubsub:r,visitorPresenceChannel:i,internalVisitorStateObservable:o}),d=rg(o),h=Mf({enabled:sm.conf.omniq.omniq_enabled,statsClient:n,pubsub:r});!function(e){var t,n=e.statusObservable,r=e.cobraObservable,i=e.statsClient,o=e.channelObservable,s=e.visitorAppPublicInterface,a=e.pubsub,u=e.visitorMetadata,c=e.internalVisitorStateObservable,l=e.routingObservable,f=e.volatileNotifications,p=e.wsProxy,d=e.currentStatusObservable,h=e.operatorPresenceObservable,v=e.getVisitorPriority,b=e.queuesStateUpdatesObservable,m=Ug(),g=sm.conf.communications.enabled_media_level,y=new CS({statusObservable:n,webRtcMode:m,enabledMediaLevel:g,statsClient:i,cobraObservable:r,channelObservable:o,apiStart:US,visitorAppPublicInterface:s,pubsub:a,visitorMetadata:u,internalVisitorStateObservable:c,routingObservable:l,volatileNotifications:f,wsProxy:p,currentStatusObservable:d,operatorPresenceObservable:h,getVisitorPriority:v,queuesStateUpdatesObservable:b});sm._getApi=t=function(e){e||(e={});var t=e.version;return t?I.contains(t,LS)?Promise.resolve(y):($u.warn("getApi used with unsupported version ".concat(t," at ").concat(window.location.host)),Promise.reject(new Error("".concat(t," is not supported for Glia API. ")+"The supported versions are: ".concat(dw(LS))))):(console.warn("Requesting the Glia API without a version is deprecated. Provide the 'version' parameter to the sm.getApi function. Example: sm.getApi({version: 'v1'})"),$u.warn("getApi used without version at ".concat(window.location.host)),Promise.resolve(y))},I.forEach((function(e){t(e.options).then(e.resolve.bind(e))}),sm._apiHandlers),new jS({channelObservable:o,statsClient:i}).start(),US.next(),US.complete(),setTimeout((function(){sm.urlParams.showVisitorCode&&s&&(s.showVisitorCode?s.showVisitorCode():$u.info("showVisitorCode is undefined on visitorAppPublicInterface"))}))}({statusObservable:p.statusObservable,cobraObservable:p.cobraObservable,channelObservable:p.channelObservable,statsClient:n,visitorAppPublicInterface:e,pubsub:r,visitorMetadata:sm.conf.visitor_metadata,internalVisitorStateObservable:o,routingObservable:f,volatileNotifications:s,wsProxy:a,currentStatusObservable:d,operatorPresenceObservable:u,getVisitorPriority:l,queuesStateUpdatesObservable:h}),Kf({internalVisitorStateObservable:o,cobraObservable:p.cobraObservable,volatileNotifications:s,stats:n,currentStatusObservable:d,operatorPresenceObservable:u,queuesStateUpdatesObservable:h,routingObservable:f}),fc(),function(){var e=eg.get(Vy);if(e)eg.remove(Vy),Fy(document,e)}()})).catch((function(e){return $u.warn("Starting visitor app failed",{error:e})}))},setupIFrame:function(e){var t=e.getAccessToken,n=e.stats,r=e.pubsub,i=e.visitorPresenceChannel,o=e.internalVisitorStateObservable,s=e.volatileNotifications,a=e.wsProxy,u=e.bestEffortXDomainStorage,c=e.operatorPresenceObservable,l=e.xDomainUrlStorage,f=e.getVisitorPriority,p=e.routingObservable,d=e.tabId,h=new dp(d);h.start(),h.request(),sm.visitorPageNotifierSubscription={unsubscribe:hp(d)};var v=new bp(h,sm.conf),b=!1;return v.identityObservable().subscribe((function(e){if(b)$u.warn("Received iFrame identity after defaulting to unknown",{identity:e});else switch(b=!0,e){case v.IDENTITIES.NESTED_COBROWSABLE_IFRAME:fc(),function(e){var t=e.parentWindowMessenger,n=e.iframeContext,r=e.getAccessToken,i=e.stats;new Pm(t,n.nestedCobrowsableVisitorIframeChannelUrl,r,i).boot()}({getAccessToken:t,parentWindowMessenger:h.getParentWindowMessenger(),iframeContext:h.getCurrentContext(),stats:n});break;case v.IDENTITIES.ENGAGEMENT_IFRAME:h.stop(),pT({stats:n,pubsub:r,getAccessToken:t,visitorPresenceChannel:i,internalVisitorStateObservable:o,volatileNotifications:s,wsProxy:a,operatorPresenceObservable:c,routingObservable:p});break;default:sm.conf.visitor_api.allow_embedding?($u.info("Did not receive iFrame identity from parent, bootstrapping as top frame"),vp(d),dT.setupApp({stats:n,pubsub:r,getAccessToken:t,visitorPresenceChannel:i,internalVisitorStateObservable:o,volatileNotifications:s,wsProxy:a,operatorPresenceObservable:c,bestEffortXDomainStorage:u,xDomainUrlStorage:l,getVisitorPriority:f,routingObservable:p})):$u.warn("Starting base app failed. IFrame has unknown identity.                 Top frame likely does not have Glia scripts installed.",{identity:e})}}))}};sm.EventEmitter=x,sm.dynamicImport=oc,sm.R=I,sm.Rx=Du,sm.App=sc;var hT=Boolean(sm.Bootstrapper);sm.Bootstrapper={boot:function(){hT||sm.installed||(sm.installed=!0,dT.setup())}}}(sm.conf);
//# sourceMappingURL=bootstrapper-b69d123fb-c94131007.js.map
